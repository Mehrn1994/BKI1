<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>APN Ù…Ø§Ù„ÛŒ Config Generator</title>
  <style>
    body { font-family: sans-serif; background:#0f172a; padding:30px; color:#e2e8f0; }

    .top-bar {
      max-width:1200px; margin:0 auto 16px auto;
      display:flex; justify-content:space-between; align-items:center;
      background:#020617; padding:12px 20px; border-radius:12px;
      border:1px solid #1f2937;
    }
    .user-display {
      font-size:14px; color:#a0aec0;
    }
    .user-name {
      color:#38bdf8; font-weight:600; font-size:15px;
    }
    .logout-link {
      color:#f97373; text-decoration:none; font-size:13px;
    }
    .logout-link:hover { text-decoration:underline; }

    .app-title { max-width:1200px; margin:0 auto 20px auto; text-align:center; }
    .app-title h1 { font-size:26px; margin-bottom:6px; color:#10b981; }
    .app-title p { font-size:14px; color:#a0aec0; }

    .card { max-width:1200px; margin:0 auto; background:#020617;
            border-radius:16px; padding:24px 24px 28px 24px;
            box-shadow:0 25px 60px rgba(0,0,0,0.65);
            border:1px solid #1f2937; }

    .section-title { font-size:18px; margin-bottom:12px; color:#10b981; }

    .form-group { margin-bottom:18px; }
    label { font-size:14px; display:block; margin-bottom:6px; color:#e5e7eb; }
    .required { color:#f97373; }

    input, select {
      width:100%; padding:10px 12px; font-size:14px;
      border-radius:10px; border:1px solid #374151;
      background:#020617; color:#e5e7eb; box-sizing:border-box;
      outline:none; transition:all .2s ease;
    }
    input:focus, select:focus { border-color:#10b981; box-shadow:0 0 0 1px #10b981; }

    .auto-assigned {
      background:#065f46 !important;
      border-color:#10b981 !important;
      cursor: not-allowed;
      color:#6ee7b7 !important;
      font-weight:600;
    }

    .row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    @media (max-width: 900px) { .row { grid-template-columns:1fr; } }

    .btns { margin-top:10px; display:flex; gap:12px; flex-wrap:wrap; }
    button { padding:10px 18px; border:none; border-radius:999px; cursor:pointer;
             font-size:14px; font-weight:600; }
    .btn-generate { background:linear-gradient(135deg,#10b981,#059669); color:#fff; }
    .btn-reset { background:#111827; color:#e5e7eb; border:1px solid #374151; }

    .outputs-wrapper { margin-top:26px; display:grid; grid-template-columns:1fr; gap:18px; }
    @media (min-width: 960px) { .outputs-wrapper { grid-template-columns:repeat(2,1fr); } }

    .router-card {
      background:radial-gradient(circle at top,#1f2937 0,#020617 55%);
      border-radius:16px; padding:14px 14px 18px 14px;
      border:1px solid #10b981;
      box-shadow:0 20px 45px rgba(15,23,42,0.9);
      position:relative; overflow:hidden;
    }

    .router-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
    .router-title { font-size:15px; font-weight:700; color:#10b981; }
    .router-tag { font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid #10b981; color:#d1fae5; }

    .output {
      background:#020617; border-radius:10px; border:1px solid #111827;
      padding:10px 12px; white-space:pre; font-family:"Fira Code",monospace;
      font-size:12px; line-height:1.55; color:#bbf7d0;
      max-height:420px; overflow:auto; direction:ltr; text-align:left;
    }

    .copy-btn { position:absolute; top:10px; left:12px; font-size:11px;
                padding:4px 10px; border-radius:999px; border:1px solid #4b5563;
                background:#020617; color:#e5e7eb; cursor:pointer; z-index:2; }

    .info-badge {
      display:inline-block;
      background:#065f46;
      color:#6ee7b7;
      padding:2px 8px;
      border-radius:6px;
      font-size:11px;
      margin-right:8px;
      font-weight:600;
    }

    .auto-badge {
      background:#10b981;
      color:#fff;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      margin-right:6px;
      font-weight:700;
    }

    .help-text {
      font-size:12px;
      color:#94a3b8;
      margin-top:4px;
    }

    .section-divider {
      height:1px;
      background:linear-gradient(90deg, transparent, #374151, transparent);
      margin:24px 0;
    }

    .mali-badge {
      background:#065f46;
      color:#6ee7b7;
      padding:4px 12px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
    }

    .info-box {
      background:#0f172a;
      border:1px solid #10b981;
      border-radius:8px;
      padding:12px 16px;
      margin-bottom:20px;
      font-size:13px;
      color:#6ee7b7;
    }
  </style>
</head>
<body>

<div class="top-bar">
  <div style="display:flex; align-items:center; gap:16px;">
    <a href="/" style="background:#10b981; color:white; padding:8px 16px; border-radius:8px; text-decoration:none; font-size:13px; font-weight:600;">
      â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ Ø§ØµÙ„ÛŒ
    </a>
    <div class="user-display">
      ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ø§Ù„: <span class="user-name" id="currentUser">...</span>
    </div>
  </div>
  <a href="/login" class="logout-link" onclick="localStorage.clear(); sessionStorage.clear();">Ø®Ø±ÙˆØ¬</a>
</div>

<div class="app-title">
  <h1>APN Ù…Ø§Ù„ÛŒ <span class="mali-badge">Financial</span></h1>
  <p>ØªÙˆÙ„ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø´Ø¹Ø¨Ù‡ + HUB (ISR-APN-RO)</p>
</div>

<div class="card">
  <div class="info-box">
    âš¡ <strong>ØªØ®ØµÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø± IP:</strong> IP Ù‡Ø§ÛŒ APN Ùˆ Tunnel Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ (Ø§ÙˆÙ„ÛŒÙ† IP Ø¢Ø²Ø§Ø¯)
  </div>

  <!-- Base Config Checkbox -->
  <div class="base-config-option" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 182, 212, 0.05)); border: 2px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 16px 20px; margin-bottom: 20px;">
    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; font-size: 15px;">
      <input type="checkbox" id="includeBaseConfig" style="width: 20px; height: 20px; cursor: pointer; accent-color: #10b981;">
      <span style="color: #10b981; font-weight: 700;">ğŸ†• Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ (Base Config)</span>
      <span style="color: #94a3b8; font-size: 12px;">- Ø¨Ø±Ø§ÛŒ Ø±ÙˆØªØ±Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø± Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯</span>
    </label>
    <div style="margin-top: 8px; margin-right: 32px; font-size: 12px; color: #64748b;">
      Ø´Ø§Ù…Ù„: AAA/TACACS, SSH, SNMP, Access-Lists, Banner, NTP Ùˆ Ø³Ø§ÛŒØ± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø§ÛŒÙ‡
    </div>
  </div>

  <div class="section-title">ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§</div>

  <form id="configForm">

    <!-- Branch Selection -->
    <div class="row">
      <div class="form-group">
        <label for="branchName">
          <span class="info-badge">ğŸ“ Ø´Ø¹Ø¨Ù‡</span>
          Ù†Ø§Ù… Ø´Ø¹Ø¨Ù‡ (ÙØ§Ø±Ø³ÛŒ) - Ø§Ø®ØªÛŒØ§Ø±ÛŒ
        </label>
        <input id="branchName" type="text" list="branchList" placeholder="Ø¨Ø±Ø§ÛŒ Ø´Ø¹Ø¨Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" autocomplete="off">
        <datalist id="branchList">
          <option value="">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option>
        </datalist>
        <div class="help-text">ğŸ’¡ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø´Ø¹Ø¨Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯: Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø² Ù„ÛŒØ³Øª Ø¨Ø±Ø§ÛŒ Ù¾Ø± Ø´Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø± LAN IP | Ø¨Ø±Ø§ÛŒ Ø±ÙˆØªØ± Ø¬Ø¯ÛŒØ¯: Ø®Ø§Ù„ÛŒ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯</div>
      </div>

      <div class="form-group">
        <label for="branchNameEn">
          <span class="info-badge">ğŸ”¤ HUB</span>
          Ù†Ø§Ù… Ø´Ø¹Ø¨Ù‡ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ) <span class="required">*</span>
        </label>
        <input id="branchNameEn" type="text" placeholder="Ù…Ø«Ø§Ù„: TEH-Branch-Vanak" required>
        <div class="help-text">âš ï¸ Ø¨Ø±Ø§ÛŒ HUB Description - ÙÙ‚Ø· Ø­Ø±ÙˆÙ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ùˆ Ø§Ø¹Ø¯Ø§Ø¯</div>
      </div>
    </div>

    <!-- Hostname for Base Config (shown when checkbox is checked) -->
    <div class="form-group" id="hostnameGroup" style="display: none; background: rgba(16, 185, 129, 0.05); padding: 12px; border-radius: 10px; border: 1px dashed rgba(16, 185, 129, 0.3);">
      <label for="routerHostname">
        <span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Base Config</span>
        Hostname Ø±ÙˆØªØ± <span class="required">*</span>
      </label>
      <input id="routerHostname" type="text" placeholder="Ù…Ø«Ø§Ù„: GLS-Kiosk-Behshadafarin">
      <div class="help-text">ğŸ’¡ Ù†Ø§Ù… Ø±ÙˆØªØ± Ú©Ù‡ Ø¯Ø± hostname ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒØ´ÙˆØ¯ - ÙÙ‚Ø· Ø­Ø±ÙˆÙ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ Ø§Ø¹Ø¯Ø§Ø¯ Ùˆ Ø®Ø· ØªÛŒØ±Ù‡</div>
    </div>

    <div class="section-divider"></div>

    <!-- LAN IP Selection -->
    <div class="section-title">Ø§Ù†ØªØ®Ø§Ø¨ IP LAN (Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ OSPF Area Ùˆ Router-ID)</div>

    <div class="row">
      <div class="form-group">
        <label for="lanProvinceFilter">
          <span class="info-badge">ğŸ—ºï¸ Ø§Ø³ØªØ§Ù†</span>
          Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªØ§Ù†
        </label>
        <select id="lanProvinceFilter" required>
          <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
        </select>
      </div>

      <div class="form-group">
        <label for="freeLanIp">
          <span class="info-badge" id="lanFreeCount">0 Ø¢Ø²Ø§Ø¯</span>
          IP LAN <span class="required">*</span>
        </label>
        <select id="freeLanIp" disabled required>
          <option value="">Ø§Ø¨ØªØ¯Ø§ Ø§Ø³ØªØ§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
        </select>
        <div class="help-text">ğŸ¯ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ OSPF Area Ùˆ Router-ID</div>
      </div>
    </div>

    <div class="section-divider"></div>

    <!-- AUTO-ASSIGNED APN IP -->
    <div class="section-title">
      <span class="auto-badge">Ø®ÙˆØ¯Ú©Ø§Ø±</span> IP APN WAN (Ù…Ø­Ø¯ÙˆØ¯Ù‡: 10.250.45.0/21)
    </div>

    <div class="form-group">
      <label for="apnIpBranch">
        <span class="info-badge" id="maliFreeCount">0 Ø¢Ø²Ø§Ø¯</span>
        IP APN (Tunnel Source) - Ø§Ù†ØªØ®Ø§Ø¨ Ø®ÙˆØ¯Ú©Ø§Ø±
      </label>
      <input id="apnIpBranch" type="text" class="auto-assigned" readonly placeholder="Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ø®ÙˆØ¯Ú©Ø§Ø±..." required>
      <div class="help-text">âš¡ Ø§ÙˆÙ„ÛŒÙ† IP Ø¢Ø²Ø§Ø¯ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡ 10.250.45.0/21 Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
    </div>

    <div class="section-divider"></div>

    <!-- AUTO-ASSIGNED Tunnel Pair -->
    <div class="section-title">
      <span class="auto-badge">Ø®ÙˆØ¯Ú©Ø§Ø±</span> Tunnel IPs (/31 Pair)
    </div>

    <div class="form-group">
      <label for="tunnelPairDisplay">
        <span class="info-badge" id="tunnelFreeCount">0 Ø¢Ø²Ø§Ø¯</span>
        Tunnel IP Pair - Ø§Ù†ØªØ®Ø§Ø¨ Ø®ÙˆØ¯Ú©Ø§Ø±
      </label>
      <input id="tunnelPairDisplay" type="text" class="auto-assigned" readonly placeholder="Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ø®ÙˆØ¯Ú©Ø§Ø±..." required>
      <div class="help-text">ğŸ”„ Ø§ÙˆÙ„ÛŒÙ† Tunnel IP Pair Ø¢Ø²Ø§Ø¯ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
    </div>

    <!-- Manual HUB Tunnel Interface (BLANK - user must fill) -->
    <div class="form-group" style="margin-top:16px;">
      <label for="hubTunnelNumber">
        <span class="info-badge">ğŸ”§ HUB</span>
        Ø´Ù…Ø§Ø±Ù‡ Interface Tunnel Ø¨Ø±Ø§ÛŒ HUB <span class="required">*</span>
      </label>
      <div style="display: flex; align-items: center; gap: 0;">
        <span style="background: linear-gradient(135deg, #374151, #1f2937); color: #10b981; padding: 12px 16px; border-radius: 12px 0 0 12px; border: 1px solid rgba(16, 185, 129, 0.3); border-right: none; font-family: 'Courier New', monospace; font-weight: bold; font-size: 1rem;">Tunnel</span>
        <input id="hubTunnelNumber" type="text" placeholder="Ù…Ø«Ø§Ù„: 10158100170" required style="border-radius: 0 12px 12px 0; flex: 1; direction: ltr; text-align: left;">
      </div>
      <div class="help-text">âš ï¸ ÙÙ‚Ø· Ø´Ù…Ø§Ø±Ù‡ Tunnel Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø¨Ø¯ÙˆÙ† Ú©Ù„Ù…Ù‡ Tunnel)</div>
    </div>

    <!-- Hidden fields -->
    <input id="hubTunnelInterface" type="hidden">
    <input id="tunnelIpBranch" type="hidden" required>
    <input id="tunnelIpHub" type="hidden" required>
    <input id="tunnelNumber" type="hidden" required>
    <input id="ospfArea" type="hidden" value="">

    <div class="section-divider"></div>

    <!-- WAN Interface -->
    <div class="form-group">
      <label for="wanIface">Ù†Ø§Ù… Ø§ÛŒÙ†ØªØ±ÙÛŒØ³ WAN Ø±ÙˆÛŒ Ø´Ø¹Ø¨Ù‡ <span class="required">*</span></label>
      <input id="wanIface" type="text" value="FastEthernet0/1" required>
    </div>

    <!-- NEW: Base Config Checkbox -->
    <div class="section-divider"></div>
    
    <div class="form-group" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 146, 60, 0.05)); padding: 16px; border-radius: 12px; border: 1px solid rgba(245, 158, 11, 0.3);">
      <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; font-size: 15px;">
        <input type="checkbox" id="includeBaseConfig" style="width: 20px; height: 20px; cursor: pointer;">
        <span style="color: #fbbf24; font-weight: 600;">ğŸ†• Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ (First Time Setup)</span>
      </label>
      <div class="help-text" style="margin-top: 8px; color: #d97706;">
        âš ï¸ Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø±ÙˆØªØ±Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ú©Ù‡ Ø¨Ø±Ø§ÛŒ <strong>Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø±</strong> Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.
        <br>Ø´Ø§Ù…Ù„: AAA, TACACS+, SSH, Access-Lists, SNMP, NTP, Banner Ùˆ Ø³Ø§ÛŒØ± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø§ÛŒÙ‡
      </div>
    </div>
    
    <!-- Hostname for Base Config (shown only when checkbox is checked) -->
    <div id="hostnameSection" class="form-group" style="display: none; margin-top: 12px;">
      <label for="routerHostname">
        <span class="info-badge">ğŸ·ï¸ Hostname</span>
        Ù†Ø§Ù… Ø±ÙˆØªØ± (Hostname) <span class="required">*</span>
      </label>
      <input id="routerHostname" type="text" placeholder="Ù…Ø«Ø§Ù„: GLS-Kiosk-Behshadafarin">
      <div class="help-text">ğŸ’¡ Ù†Ø§Ù… Ø±ÙˆØªØ± Ú©Ù‡ Ø¯Ø± prompt Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
    </div>

    <div class="btns">
      <button type="submit" class="btn-generate"> ØªÙˆÙ„ÛŒØ¯ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ù…Ø§Ù„ÛŒ Ùˆ Ø±Ø²Ø±Ùˆ IP</button>
      <button type="reset" class="btn-reset">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
    </div>
  </form>

  <div id="outputs" class="outputs-wrapper" style="display:none;">
    <div class="router-card">
      <div style="position:relative;">
        <div class="router-header">
          <div class="router-title">Branch Router (Ù…Ø§Ù„ÛŒ)</div>
          <div class="router-tag">Spoke</div>
        </div>
        <button class="copy-btn" type="button" onclick="copyText('branchOut')">Copy</button>
        <div id="branchOut" class="output"></div>
      </div>
    </div>

    <div class="router-card">
      <div style="position:relative;">
        <div class="router-header">
          <div class="router-title">ISR-APN-RO (HUB)</div>
          <div class="router-tag">Hub</div>
        </div>
        <button class="copy-btn" type="button" onclick="copyText('hubOut')">Copy</button>
        <div id="hubOut" class="output"></div>
      </div>
    </div>
  </div>
</div>

<script>
// Auto-login check
const currentUsername = localStorage.getItem('currentUser') ||
localStorage.getItem('username') || sessionStorage.getItem('username');
if (!currentUsername) {
  alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø³ÛŒØ³ØªÙ… Ø´ÙˆÛŒØ¯');
  window.location.href = '/login';
} else {
  document.getElementById('currentUser').textContent = currentUsername;

// Toggle hostname field visibility based on checkbox
document.getElementById('includeBaseConfig').addEventListener('change', function() {
  const hostnameGroup = document.getElementById('hostnameGroup');
  const hostnameInput = document.getElementById('routerHostname');
  
  if (this.checked) {
    hostnameGroup.style.display = 'block';
    hostnameInput.required = true;
  } else {
    hostnameGroup.style.display = 'none';
    hostnameInput.required = false;
    hostnameInput.value = '';
  }
});
}

// Fixed values for Ù…Ø§Ù„ÛŒ
const FIXED_HUB_IP = '10.250.46.1';
const CRYPTO_KEY = 'G!l@n3tAcc3ss';
const OSPF_PROCESS = '2';

// Store all data
let allMaliBranches = [];

// Load branches
async function loadBranches() {
  try {
    const res = await fetch('/api/mali-branches');
    const branches = await res.json();

    allMaliBranches = branches;

    const datalist = document.getElementById('branchList');
    datalist.innerHTML = '';

    branches.forEach(b => {
      const opt = document.createElement('option');
      opt.value = `${b.name}|${b.province}|${b.lan_ip}`;
      datalist.appendChild(opt);
    });

    console.log(`âœ“ Loaded ${branches.length} branches`);
  } catch (err) {
    console.error('Failed to load branches:', err);
  }
}

// Load provinces
async function loadProvinces() {
  try {
    const res = await fetch('/api/provinces');
    const provinces = await res.json();

    const sel = document.getElementById('lanProvinceFilter');
    sel.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';

    provinces.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = p;
      sel.appendChild(opt);
    });
  } catch (err) {
    console.error('Failed to load provinces:', err);
  }
}

// Load free LAN IPs
async function loadFreeLanIps(province) {
  const sel = document.getElementById('freeLanIp');
  const counter = document.getElementById('lanFreeCount');

  if (!province) {
    sel.innerHTML = '<option value="">Ø§Ø¨ØªØ¯Ø§ Ø§Ø³ØªØ§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>';
    sel.disabled = true;
    counter.textContent = '0 Ø¢Ø²Ø§Ø¯';
    return;
  }

  try {
    sel.innerHTML = '<option value="">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option>';
    sel.disabled = true;

    const res = await fetch(`/api/free-lan-ips?province=${encodeURIComponent(province)}`);
    const ips = await res.json();

    sel.innerHTML = '<option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>';

    ips.forEach(ip => {
      const opt = document.createElement('option');
      opt.value = ip.ip;
      opt.textContent = ip.ip;
      sel.appendChild(opt);
    });

    sel.disabled = false;
    counter.textContent = `${ips.length} Ø¢Ø²Ø§Ø¯`;
  } catch (err) {
    console.error('Failed to load LAN IPs:', err);
    sel.innerHTML = '<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</option>';
  }
}

// AUTO-ASSIGN APN IP
async function autoAssignApnIp() {
  const field = document.getElementById('apnIpBranch');
  const counter = document.getElementById('maliFreeCount');

  try {
    field.value = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...';

    const res = await fetch('/api/mali-free-ips');
    const ips = await res.json();

    counter.textContent = `${ips.length} Ø¢Ø²Ø§Ø¯`;

    if (ips.length > 0) {
      const firstIp = ips[0].ip;
      field.value = `âœ… ${firstIp} (Ø®ÙˆØ¯Ú©Ø§Ø±)`;
      field.dataset.actualIp = firstIp;
      console.log(`âœ“ Auto-assigned APN IP: ${firstIp}`);
    } else {
      field.value = 'âŒ Ù‡ÛŒÚ† IP Ø¢Ø²Ø§Ø¯ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª';
      counter.textContent = '0 Ø¢Ø²Ø§Ø¯';
    }
  } catch (err) {
    console.error('Failed to auto-assign APN IP:', err);
    field.value = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ';
  }
}

// AUTO-ASSIGN Tunnel Pair (NO PRE-FILL for HUB Interface)
async function autoAssignTunnelPair() {
  const field = document.getElementById('tunnelPairDisplay');
  const counter = document.getElementById('tunnelFreeCount');

  try {
    field.value = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...';

    const res = await fetch('/api/free-tunnel-pairs');
    const tunnels = await res.json();

    counter.textContent = `${tunnels.length} Ø¢Ø²Ø§Ø¯`;

    if (tunnels.length > 0) {
      const firstTunnel = tunnels[0];

      field.value = `âœ… Tunnel ${firstTunnel.tunnel_number} - Branch: ${firstTunnel.tunnel_ip_branch} â†” HUB: ${firstTunnel.tunnel_ip_hub}`;

      document.getElementById('tunnelIpBranch').value = firstTunnel.tunnel_ip_branch;
      document.getElementById('tunnelIpHub').value = firstTunnel.tunnel_ip_hub;
      document.getElementById('tunnelNumber').value = firstTunnel.tunnel_number;

      // DO NOT pre-fill HUB interface - leave it BLANK for user to fill
      console.log(`âœ“ Auto-assigned Tunnel: ${firstTunnel.tunnel_number}`);
      console.log(`âš ï¸ HUB Interface must be filled by user`);
    } else {
      field.value = 'âŒ Ù‡ÛŒÚ† Tunnel Ø¢Ø²Ø§Ø¯ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª';
      counter.textContent = '0 Ø¢Ø²Ø§Ø¯';
    }
  } catch (err) {
    console.error('Failed to auto-assign Tunnel:', err);
    field.value = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ';
  }
}

// Auto-fill when existing branch is selected
document.getElementById('branchName').addEventListener('input', async function() {
  const inputValue = this.value.trim();

  if (inputValue.includes('|')) {
    const parts = inputValue.split('|');
    const branchName = parts[0];
    const province = parts[1];
    const lanIp = parts[2];

    this.value = branchName;

    try {
      const provinceSelect = document.getElementById('lanProvinceFilter');
      
      // Check if province exists in options, if not add it
      let provinceExists = false;
      for (let i = 0; i < provinceSelect.options.length; i++) {
        if (provinceSelect.options[i].value === province) {
          provinceExists = true;
          break;
        }
      }
      
      if (!provinceExists && province) {
        const newOpt = document.createElement('option');
        newOpt.value = province;
        newOpt.textContent = province;
        provinceSelect.appendChild(newOpt);
      }
      
      provinceSelect.value = province;

      await loadFreeLanIps(province);

      const lanSelect = document.getElementById('freeLanIp');

      let optionExists = false;
      for (let i = 0; i < lanSelect.options.length; i++) {
        if (lanSelect.options[i].value === lanIp) {
          optionExists = true;
          lanSelect.value = lanIp;
          break;
        }
      }

      if (!optionExists) {
        const existingOpt = document.createElement('option');
        existingOpt.value = lanIp;
        existingOpt.textContent = `${lanIp} (Ø´Ø¹Ø¨Ù‡ Ù…ÙˆØ¬ÙˆØ¯: ${branchName})`;
        existingOpt.style.color = '#fbbf24';
        existingOpt.style.fontWeight = '600';
        lanSelect.insertBefore(existingOpt, lanSelect.firstChild.nextSibling);
        lanSelect.value = lanIp;
      }

      const lanParts = lanIp.split('.');
      if (lanParts.length >= 2) {
        const ospfArea = lanParts[1];
        document.getElementById('ospfArea').value = ospfArea;
      }

      lanSelect.disabled = false;

    } catch (err) {
      console.error('Error loading branch data:', err);
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø¹Ø¨Ù‡');
    }
  }
});

// Auto-calculate OSPF Area from LAN IP
document.getElementById('freeLanIp').addEventListener('change', function() {
  const lanIp = this.value;

  if (lanIp) {
    const parts = lanIp.split('.');
    if (parts.length >= 2) {
      const ospfArea = parts[1];
      document.getElementById('ospfArea').value = ospfArea;
      console.log(`âœ“ OSPF Area: ${ospfArea}`);
    }
  }
});

document.getElementById('lanProvinceFilter').addEventListener('change', function() {
  loadFreeLanIps(this.value);
});

// Generate configs
document.getElementById('configForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const branchNameInput = document.getElementById('branchName').value.trim();
  const branchNameEn = document.getElementById('branchNameEn').value.trim();
  const branchName = branchNameInput || branchNameEn; // Use English name if Persian is empty

  // Base Config checkbox
  const includeBaseConfig = document.getElementById('includeBaseConfig').checked;
  const routerHostname = document.getElementById('routerHostname').value.trim();

  // Validate hostname if base config is selected
  if (includeBaseConfig && !routerHostname) {
    alert('âŒ Ù„Ø·ÙØ§Ù‹ Hostname Ø±ÙˆØªØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø¨Ø±Ø§ÛŒ Base Config)');
    document.getElementById('routerHostname').focus();
    return;
  }

  const lanIp = document.getElementById('freeLanIp').value;
  const apnIpField = document.getElementById('apnIpBranch');
  const apnIpBranch = apnIpField.dataset.actualIp || apnIpField.value.replace('âœ… ', '').replace(' (Ø®ÙˆØ¯Ú©Ø§Ø±)', '').trim();
  const tunnelIpBranch = document.getElementById('tunnelIpBranch').value.trim();
  const tunnelIpHub = document.getElementById('tunnelIpHub').value.trim();
  const hubTunnelNumber = document.getElementById('hubTunnelNumber').value.trim();
  const hubTunnelInterface = 'Tunnel' + hubTunnelNumber;
  const wanIface = document.getElementById('wanIface').value.trim();
  const ospfArea = document.getElementById('ospfArea').value;

  if (!ospfArea) {
    alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ IP LAN Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ (Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ OSPF Area)');
    return;
  }

  if (!branchNameEn) {
    alert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø´Ø¹Ø¨Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    return;
  }

  if (!hubTunnelNumber) {
    alert('âŒ Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Interface Tunnel Ø¨Ø±Ø§ÛŒ HUB Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\n\nÙ…Ø«Ø§Ù„: 10158100170');
    return;
  }

  // Validate that it's only numbers
  if (!/^\d+$/.test(hubTunnelNumber)) {
    alert('âŒ Ø´Ù…Ø§Ø±Ù‡ Tunnel Ø¨Ø§ÛŒØ¯ ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ø¯\n\nÙ…Ø«Ø§Ù„ ØµØ­ÛŒØ­: 10158100170');
    return;
  }
  
  const tunnelNumber = hubTunnelNumber;

  // Update hidden fields
  document.getElementById('tunnelNumber').value = tunnelNumber;
  document.getElementById('hubTunnelInterface').value = hubTunnelInterface;

  console.log(`âœ“ Tunnel Number: ${tunnelNumber}, Interface: ${hubTunnelInterface}`);

  if (!tunnelIpBranch || !tunnelIpHub) {
    alert('Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯ (Tunnel IP Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡)');
    return;
  }

  const lanParts = lanIp.split('.');
  const x = lanParts[1];
  const y = lanParts[2];

  const tunnelParts = tunnelIpBranch.split('.');
  const tunnelSecondOctet = tunnelParts[1];

  const routerId = `10.${tunnelSecondOctet}.${x}.${y}`;

  const data = {
    branchName,
    branchNameEn,
    lanIp,
    x, y,
    apnIpBranch,
    tunnelIpBranch,
    tunnelIpHub,
    tunnelNumber,
    hubTunnelInterface,
    wanIface,
    ospfArea,
    routerId,
    hubIp: FIXED_HUB_IP,
    cryptoKey: CRYPTO_KEY,
    ospfProcess: OSPF_PROCESS,
    includeBaseConfig,
    routerHostname
  };

  generateMaliConfigs(data);

  try {
    // Reserve tunnel
    const tunnelRes = await fetch('/api/reserve-tunnel', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        tunnelNumber: tunnelNumber,
        branchName: branchName,
        username: currentUsername
      })
    });

    const tunnelResult = await tunnelRes.json();
    console.log('Tunnel reservation:', tunnelResult);

    // Reserve APN IP
    const reserveRes = await fetch('/api/reserve-mali-ips', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        branchName: branchName,
        apnIp: apnIpBranch,
        tunnelIpBranch: tunnelIpBranch,
        tunnelIpHub: tunnelIpHub,
        tunnelNumber: tunnelNumber,
        username: currentUsername
      })
    });

    const result = await reserveRes.json();

    if (result.status === 'ok') {
      alert('âœ… Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯ Ùˆ IP Ù‡Ø§ Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù†Ø¯!\n\n' + result.message);

      // Reload auto-assigned IPs
      await autoAssignApnIp();
      await autoAssignTunnelPair();

      // Clear HUB Tunnel Interface for next use
      document.getElementById('hubTunnelNumber').value = '';
      document.getElementById('hubTunnelInterface').value = '';
    } else {
      alert('âš ï¸ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯ Ø§Ù…Ø§ Ø®Ø·Ø§ Ø¯Ø± Ø±Ø²Ø±Ùˆ IP:\n\n' + result.error);
    }
  } catch (err) {
    console.error('Error reserving IPs:', err);
    alert('âš ï¸ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯ Ø§Ù…Ø§ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
  }
});

function generateMaliConfigs(d) {
  // Check if base config should be included
  const includeBase = document.getElementById('includeBaseConfig').checked;
  const hostname = document.getElementById('routerHostname').value.trim() || d.branchNameEn;
  
  let branchCfg = '';
  
  // Generate Base Config if checkbox is checked
  if (includeBase) {
    branchCfg = `!
! ========================================================
! ===== BASE CONFIGURATION - First Time Setup =====
! ========================================================
!
service timestamps debug datetime msec
service timestamps log datetime msec
no service password-encryption
!
hostname ${hostname}
!
boot-start-marker
boot-end-marker
!
enable secret 5 $1$1kQA$TOB1eE4SmnYjXXjtxUXus0
!
aaa new-model
!
aaa authentication login CACS group tacacs+ local
aaa authentication enable default group tacacs+ enable
aaa authorization console
aaa authorization config-commands
aaa authorization exec CACS group tacacs+ local 
aaa authorization commands 0 CACS group tacacs+ local 
aaa authorization commands 1 CACS group tacacs+ local 
aaa authorization commands 2 CACS group tacacs+ local 
aaa authorization commands 3 CACS group tacacs+ local 
aaa authorization commands 15 CACS group tacacs+ local 
aaa accounting exec CACS start-stop group tacacs+
aaa accounting commands 0 CACS start-stop group tacacs+
aaa accounting commands 1 CACS start-stop group tacacs+
aaa accounting commands 2 CACS start-stop group tacacs+
aaa accounting commands 3 CACS start-stop group tacacs+
aaa accounting commands 15 CACS start-stop group tacacs+
!
aaa session-id common
clock timezone Tehran 3 30
ip cef
!
no ip domain lookup
ip domain name agri-bank.com
ip auth-proxy max-nodata-conns 3
ip admission max-nodata-conns 3
!
username bkiadmin privilege 15 secret 5 $1$y/X2$m2zhThmBZUcxNZ56uEQvA1
username wanuser privilege 3 secret 5 $1$uErG$Ire9qXq1SX4ugUKhuR0b50
!
ip ssh authentication-retries 2
ip ssh port 2001 rotary 1
ip ssh version 2
!
track 5 ip route 10.0.0.0 255.255.0.0 reachability
!
`;
  }
  
  // APN Ù…Ø§Ù„ÛŒ Config (always included)
  branchCfg += `!
! ===== Branch Router (${d.branchName}) - APN Ù…Ø§Ù„ÛŒ =====
!
crypto isakmp policy 10
 encr aes
 authentication pre-share
 group 2
crypto isakmp key ${d.cryptoKey} address ${d.hubIp}
crypto isakmp invalid-spi-recovery
!
crypto ipsec transform-set GILANETTS esp-aes esp-sha-hmac
!
crypto map GILANET 10 ipsec-isakmp
 set peer ${d.hubIp}
 set transform-set GILANETTS
 match address GILANET-ACL
!
interface Loopback0
 ip address 10.${d.x}.254.${d.y} 255.255.255.255
!
interface Tunnel156
 description ** Gilanet **
 ip address ${d.tunnelIpBranch} 255.255.255.254
 ip mtu 1460
 ip ospf hello-interval 100
 ip ospf dead-interval 300
 ip ospf priority 0
 tunnel source ${d.apnIpBranch}
 tunnel destination ${d.hubIp}
!`;
  
  // Add FastEthernet0/0 with HSRP if base config is included
  if (includeBase) {
    branchCfg += `
!
interface FastEthernet0/0
 description ** LAN **
 ip address 10.${d.x}.${d.y}.5 255.255.255.0
 ip access-group ETHERNET_IN in
 duplex auto
 speed auto
 standby 1 ip 10.${d.x}.${d.y}.1
 standby 1 timers 1 3
 standby 1 preempt
 standby 1 track 5 decrement 25
!`;
  }
  
  // WAN Interface
  branchCfg += `
interface ${d.wanIface}
 description ** Gilanet **
 ip address ${d.apnIpBranch} 255.255.248.0
 duplex auto
 speed auto
 crypto map GILANET
!
router ospf ${d.ospfProcess}
 router-id ${d.routerId}
 log-adjacency-changes
 passive-interface default
 no passive-interface Tunnel156
 network 10.${d.x}.${d.y}.5 0.0.0.0 area ${d.ospfArea}
 network 10.${d.x}.254.${d.y} 0.0.0.0 area ${d.ospfArea}
 network ${d.tunnelIpBranch} 0.0.0.0 area ${d.ospfArea}
 distribute-list OSPF-PERMIT in
!`;
  
  // Add full access-lists and remaining config if base config is included
  if (includeBase) {
    branchCfg += `
ip forward-protocol nd
!
no ip http server
no ip http secure-server
ip tacacs source-interface Loopback0
!
ip access-list standard OSPF-PERMIT
 permit 10.0.0.0 0.0.255.255
ip access-list standard SNMP-READ
 permit 10.0.50.0 0.0.1.255
ip access-list standard SNMP-WRITE
 permit 10.0.51.49
 permit 10.0.51.48
ip access-list standard TELNET_ACCESS
 permit 10.250.46.1
 permit 10.1.254.1
 permit 10.0.50.0 0.0.1.255
 permit 10.${d.x}.${d.y}.6 0.0.0.1
!
ip access-list extended ETHERNET_IN
 deny   tcp any any range 135 139
 deny   tcp any any eq 445
 deny   udp any any range 135 netbios-ss
 deny   udp any any eq 1434
 deny   udp any any eq 1433
 deny   tcp any any eq 1026
 deny   tcp any any eq 4444
 deny   udp any any eq 445
 permit ip 10.${d.x}.${d.y}.0 0.0.0.255 192.168.65.0 0.0.0.255
 permit ip 10.${d.x}.${d.y}.0 0.0.0.255 192.168.72.0 0.0.0.255
 permit udp 10.${d.x}.${d.y}.0 0.0.0.255 224.0.0.0 0.0.0.255
 permit ip 10.${d.x}.${d.y}.0 0.0.0.255 10.${d.x}.${d.y}.0 0.0.0.255
 permit ip 10.${d.x}.${d.y}.0 0.0.0.255 10.0.0.0 0.0.255.255
 permit ip 10.${d.x}.${d.y}.0 0.0.0.255 10.1.0.0 0.0.7.255
ip access-list extended GILANET-ACL
 permit gre host ${d.apnIpBranch} host ${d.hubIp}
!
logging 10.0.51.63
snmp-server group LMS v3 priv read myview write myview access SNMP-WRITE
snmp-server group NMS v3 priv access SNMP-READ
snmp-server view myview mib-2 included
snmp-server view myview system included
snmp-server view myview cisco included
snmp-server ifindex persist
!
tacacs-server host 10.0.51.56
tacacs-server host 10.0.51.57
tacacs-server directed-request
tacacs-server key 7 1324045C445D577A
!
control-plane
!
banner motd ^C
        ===
       -+ +-
       | | |
    <--\\ | /-->
   ##| ||||| |##
  ###| |+++| |###
 /____\\\\ | //____\\ ********************************************************
   <###\\|||/###>                  Keshavarzi Bank Network
    +====+====+     WARNING: Access is restricted to authorized users only.
    | WAN-BKI |     Unauthorized access is a violation of state , civil and
    +===+=+===+                       criminal laws.
        +=+        ********************************************************
^C
privilege interface level 3 shutdown
privilege interface level 3 no shutdown
privilege interface level 3 no
privilege configure level 3 interface
privilege exec level 3 traceroute
privilege exec level 3 ping
privilege exec level 3 configure terminal
privilege exec level 3 configure
privilege exec level 3 reload
privilege exec level 3 terminal monitor
privilege exec level 3 terminal
privilege exec all level 3 show running-config
privilege exec level 3 show
!
line con 0
 authorization exec CACS
 login authentication CACS
line aux 0
 no exec
line vty 0 4
 privilege level 15
 authorization exec CACS
 accounting exec CACS
 login authentication CACS
 transport input ssh
 transport output ssh
line vty 5 15
 privilege level 15
 authorization exec CACS
 accounting exec CACS
 login authentication CACS
 transport input ssh
 transport output ssh
!
scheduler allocate 20000 1000
ntp authenticate
ntp trusted-key 1
ntp clock-period 17178037
ntp source Loopback0
ntp update-calendar
ntp server 10.0.51.27
!
end`;
  } else {
    // Simple ending for APN-only config
    branchCfg += `
ip access-list standard OSPF-PERMIT
 permit 10.0.0.0 0.0.255.255
!
ip access-list extended GILANET-ACL
 permit gre host ${d.apnIpBranch} host ${d.hubIp}
!
end`;
  }

  const hubCfg = `!
! ===== ISR-APN-RO (HUB) - ${d.branchNameEn} =====
!
interface ${d.hubTunnelInterface}
 description ** Gilanet-${d.branchNameEn} **
 ip address ${d.tunnelIpHub} 255.255.255.254
 ip ospf dead-interval 300
 ip ospf hello-interval 100
 tunnel source ${d.hubIp}
 tunnel destination ${d.apnIpBranch}
!
router ospf ${d.ospfProcess}
 network ${d.tunnelIpHub} 0.0.0.0 area ${d.ospfArea}
!
end`;

  document.getElementById('branchOut').textContent = branchCfg;
  document.getElementById('hubOut').textContent = hubCfg;
  document.getElementById('outputs').style.display = 'grid';

  document.getElementById('outputs').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function copyText(elementId) {
  const el = document.getElementById(elementId);
  if (!el) {
    alert('âŒ Ø®Ø·Ø§: Ø¹Ù†ØµØ± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯');
    return;
  }
  
  const text = el.textContent || el.innerText;
  
  if (!text || text.trim() === '') {
    alert('âŒ Ø®Ø·Ø§: Ù…ØªÙ†ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
    return;
  }
  
  // Try modern clipboard API first
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      // Find the button and show success
      const btn = el.parentElement.querySelector('.copy-btn');
      if (btn) {
        const originalText = btn.textContent;
        btn.textContent = 'âœ… Ú©Ù¾ÛŒ Ø´Ø¯!';
        btn.style.background = '#10b981';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '';
        }, 2000);
      } else {
        alert('âœ… Ú©Ù¾ÛŒ Ø´Ø¯!');
      }
    }).catch(err => {
      console.error('Clipboard write failed:', err);
      fallbackCopyMali(text);
    });
  } else {
    fallbackCopyMali(text);
  }
}

// Fallback copy method for older browsers
function fallbackCopyMali(text) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.position = 'fixed';
  textArea.style.left = '-9999px';
  textArea.style.top = '0';
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  
  try {
    const successful = document.execCommand('copy');
    if (successful) {
      alert('âœ… Ú©Ù¾ÛŒ Ø´Ø¯!');
    } else {
      alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†');
    }
  } catch (err) {
    console.error('Fallback copy failed:', err);
    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†. Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯.');
  }
  
  document.body.removeChild(textArea);
}

// Init on page load - AUTO-ASSIGN IPs
loadBranches();
loadProvinces();
autoAssignApnIp();
autoAssignTunnelPair();
</script>

</body>
</html>