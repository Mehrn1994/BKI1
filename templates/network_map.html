<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نقشه شبکه بانک کشاورزی</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
:root{--bg:#080c18;--glass:rgba(12,18,36,0.7);--text:#e2e8f0;--t2:#94a3b8;--t3:#64748b;--brd:rgba(100,116,139,0.12);--brd2:rgba(100,116,139,0.2);--accent1:#22d3ee;--accent2:#818cf8;--accent3:#f472b6}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column}
.hdr{height:48px;background:var(--glass);backdrop-filter:blur(24px);border-bottom:1px solid var(--brd2);display:flex;align-items:center;padding:0 20px;gap:14px;z-index:100;flex-shrink:0}
.hdr::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(34,211,238,0.2),rgba(129,140,248,0.2),transparent)}
.hdr h1{font-size:14px;font-weight:700;background:linear-gradient(135deg,#22d3ee,#818cf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hdr .stats{display:flex;gap:14px;font-size:10px;color:var(--t2);margin-right:auto;font-weight:500}
.hdr .stats b{background:linear-gradient(135deg,#22d3ee,#818cf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:700}
.btn{padding:5px 12px;border-radius:6px;background:var(--glass);color:var(--text);font-size:10px;font-weight:600;border:1px solid var(--brd2);cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:4px;transition:all .2s}
.btn:hover{background:rgba(255,255,255,0.06)}
.filters{height:36px;background:rgba(12,18,36,0.5);border-bottom:1px solid var(--brd);display:flex;align-items:center;padding:0 20px;gap:8px;flex-shrink:0;z-index:50}
.filters label{font-size:9px;color:var(--t3);font-weight:600;letter-spacing:.5px;text-transform:uppercase}
.ft{padding:3px 10px;border-radius:14px;font-size:9px;cursor:pointer;border:1px solid var(--brd2);background:transparent;color:var(--t2);transition:all .2s;font-weight:500}
.ft.on{background:rgba(34,211,238,0.1);border-color:rgba(34,211,238,0.4);color:var(--accent1)}
#searchBox{background:rgba(255,255,255,0.04);border:1px solid var(--brd2);border-radius:6px;padding:3px 10px;color:var(--text);font-size:9px;width:180px;outline:none;font-family:inherit}
#searchBox:focus{border-color:rgba(34,211,238,0.4)}
.main{flex:1;display:flex;overflow:hidden;position:relative;z-index:1}
#canvasWrap{flex:1;position:relative;overflow:hidden;cursor:grab}
#canvasWrap.grabbing{cursor:grabbing}
canvas{display:block;width:100%;height:100%}
#tooltip{position:absolute;pointer-events:none;background:rgba(8,12,24,0.95);backdrop-filter:blur(16px);border:1px solid var(--brd2);border-radius:8px;padding:8px 12px;font-size:10px;color:var(--text);z-index:200;opacity:0;transition:opacity .12s;max-width:260px;box-shadow:0 8px 24px rgba(0,0,0,0.5)}
#tooltip.show{opacity:1}
#tooltip .tt-l{font-weight:700;font-size:11px;margin-bottom:2px}
#tooltip .tt-m{font-size:8px;color:var(--accent1);font-family:Consolas,monospace;direction:ltr;text-align:left}
#tooltip .tt-r{display:flex;gap:8px;font-size:8px;color:var(--t2);margin-top:3px}
#tooltip .tt-r b{color:var(--accent1)}
.legend{position:absolute;bottom:12px;left:12px;background:rgba(8,12,24,0.85);backdrop-filter:blur(16px);border:1px solid var(--brd2);border-radius:10px;padding:10px 14px;font-size:8px;z-index:50}
.legend .lr{display:flex;align-items:center;gap:6px;margin-bottom:4px;color:var(--t2)}
.legend .ld{width:8px;height:8px;border-radius:50%}
.legend .lt{font-weight:700;margin-bottom:6px;font-size:9px;background:linear-gradient(135deg,#22d3ee,#818cf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#panel{width:0;overflow:hidden;background:rgba(8,12,24,0.92);backdrop-filter:blur(24px);border-right:1px solid var(--brd2);transition:width .35s cubic-bezier(.25,.8,.25,1);flex-shrink:0;display:flex;flex-direction:column}
#panel.open{width:440px}
.ph{padding:14px 16px;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:8px;flex-shrink:0}
.ph h2{font-size:13px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:700}
.ph .badge{font-size:8px;padding:2px 6px;border-radius:4px;font-weight:700}
.pcl{width:24px;height:24px;border-radius:6px;border:1px solid var(--brd2);background:transparent;color:var(--t3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .2s}
.pcl:hover{background:rgba(244,63,94,0.15);color:#f472b6}
.ptabs{display:flex;border-bottom:1px solid var(--brd);flex-shrink:0;background:rgba(0,0,0,0.2)}
.ptab{flex:1;padding:8px;text-align:center;font-size:9px;cursor:pointer;color:var(--t3);border-bottom:2px solid transparent;font-weight:600;transition:all .2s}
.ptab.on{color:var(--accent1);border-bottom-color:var(--accent1)}
.pbody{flex:1;overflow-y:auto;padding:0}
.tc{display:none;padding:12px 16px}.tc.on{display:block}
.sc{background:rgba(255,255,255,0.02);border:1px solid var(--brd);border-radius:10px;padding:12px;margin-bottom:8px}
.st{font-size:10px;font-weight:700;margin-bottom:6px;background:linear-gradient(135deg,#22d3ee,#818cf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.sr{display:flex;align-items:center;gap:5px;padding:3px 0;font-size:9px;direction:ltr;text-align:left}
.sv{color:var(--t2);font-family:Consolas,monospace;font-size:9px}
.sb{display:inline-block;padding:1px 5px;border-radius:3px;font-size:7px;font-weight:700}
.b-in{background:rgba(52,211,153,0.12);color:#34d399;border:1px solid rgba(52,211,153,0.2)}
.b-out{background:rgba(244,114,182,0.12);color:#f472b6;border:1px solid rgba(244,114,182,0.2)}
.b-pool{background:rgba(129,140,248,0.12);color:#818cf8;border:1px solid rgba(129,140,248,0.2)}
.b-stat{background:rgba(251,191,36,0.12);color:#fbbf24;border:1px solid rgba(251,191,36,0.2)}
.fbox{background:rgba(255,255,255,0.015);border:1px solid var(--brd);border-radius:10px;padding:12px;margin-bottom:8px}
.fstep{display:flex;align-items:center;gap:8px;padding:6px 4px;cursor:pointer;border-radius:6px;transition:background .2s}
.fstep:hover{background:rgba(255,255,255,0.03)}
.ficon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.farr{color:var(--accent1);font-size:16px;text-align:center;padding:1px 0;width:32px;opacity:.5}
.ftxt{flex:1}.ftxt b{font-size:10px;display:block;font-weight:600}.ftxt small{font-size:8px;color:var(--t3);font-family:Consolas,monospace;direction:ltr;display:block}
.load{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:200;flex-direction:column;gap:10px}
.load .sp{width:36px;height:36px;border:2px solid var(--brd);border-top-color:var(--accent1);border-radius:50%;animation:spin .7s linear infinite}
.load span{font-size:10px;color:var(--t3)}
@keyframes spin{to{transform:rotate(360deg)}}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(148,163,184,0.15);border-radius:3px}
</style>
</head>
<body>
<div class="hdr">
    <h1>BKI Network Topology</h1>
    <div class="stats">
        <span>Devices: <b id="sT">0</b></span>
        <span>Core: <b id="sC">0</b></span>
        <span>Switch: <b id="sSw">0</b></span>
        <span>Provincial: <b id="sP">0</b></span>
        <span>Links: <b id="sL">0</b></span>
    </div>
    <button class="btn" onclick="resetAll()">&#8634; Reset</button>
    <a href="/" class="btn">&#8592; Home</a>
</div>
<div class="filters">
    <label>Filter:</label>
    <button class="ft on" data-f="all" onclick="setF('all',this)">All</button>
    <button class="ft" data-f="core-router" onclick="setF('core-router',this)">Core</button>
    <button class="ft" data-f="core-switch" onclick="setF('core-switch',this)">Switch</button>
    <button class="ft" data-f="provincial-router" onclick="setF('provincial-router',this)">Provincial</button>
    <span style="flex:1"></span>
    <input id="searchBox" placeholder="Search hostname..." oninput="doSearch(this.value)">
</div>
<div class="main">
<div id="canvasWrap">
    <canvas id="graphCanvas"></canvas>
    <div id="tooltip"></div>
    <div class="legend">
        <div class="lt">LEGEND</div>
        <div class="lr"><div class="ld" style="background:linear-gradient(135deg,#f472b6,#fb923c);box-shadow:0 0 6px #f472b6"></div>Core Router</div>
        <div class="lr"><div class="ld" style="background:linear-gradient(135deg,#818cf8,#c084fc);box-shadow:0 0 6px #818cf8"></div>Core Switch</div>
        <div class="lr"><div class="ld" style="background:linear-gradient(135deg,#22d3ee,#3b82f6);box-shadow:0 0 6px #22d3ee"></div>ASR1002X</div>
        <div class="lr"><div class="ld" style="background:linear-gradient(135deg,#34d399,#22d3ee);box-shadow:0 0 6px #34d399"></div>3845</div>
        <div class="lr"><div class="ld" style="background:linear-gradient(135deg,#fbbf24,#f97316);box-shadow:0 0 6px #fbbf24"></div>3825</div>
        <div style="font-size:7px;color:var(--t3);margin-top:6px;border-top:1px solid var(--brd);padding-top:4px">Click: Select | DblClick: Details<br>Scroll: Zoom | Drag: Pan</div>
    </div>
    <div class="load" id="loader"><div class="sp"></div><span>Loading topology...</span></div>
</div>
<div id="panel">
    <div class="ph"><h2 id="pTitle">-</h2><span class="badge" id="pBadge">-</span><button class="pcl" onclick="closeP()">&times;</button></div>
    <div class="ptabs">
        <div class="ptab on" data-t="ov" onclick="tab('ov',this)">Overview</div>
        <div class="ptab" data-t="nat" onclick="tab('nat',this)">NAT</div>
        <div class="ptab" data-t="rt" onclick="tab('rt',this)">Routes</div>
        <div class="ptab" data-t="fl" onclick="tab('fl',this)">Flow</div>
    </div>
    <div class="pbody">
        <div class="tc on" id="t-ov"></div>
        <div class="tc" id="t-nat"></div>
        <div class="tc" id="t-rt"></div>
        <div class="tc" id="t-fl"></div>
    </div>
</div>
</div>
<script>
const canvas=document.getElementById('graphCanvas'),ctx=canvas.getContext('2d'),wrap=document.getElementById('canvasWrap'),ttip=document.getElementById('tooltip');
let W,H,dpr,ND=[],LD=[],nodes=[],links=[],selected=null,hovered=null,filter='all',searchStr='';
let cam={x:0,y:0,z:1},tCam={x:0,y:0,z:1},savedCam=null;
let particles=[],dragging=false,dragS={x:0,y:0},camS={x:0,y:0};
const P={
    'core-router':{c:['#f472b6','#fb923c'],g:'#f472b6',r:20},
    'core-switch':{c:['#818cf8','#c084fc'],g:'#818cf8',r:14},
    'ASR1002X':{c:['#22d3ee','#3b82f6'],g:'#22d3ee',r:13},
    '3845':{c:['#34d399','#22d3ee'],g:'#34d399',r:12},
    '3825':{c:['#fbbf24','#f97316'],g:'#fbbf24',r:12},
    'default':{c:['#64748b','#475569'],g:'#64748b',r:11}
};
function gP(n){if(n.category==='core-router')return P['core-router'];if(n.category==='core-switch')return P['core-switch'];return P[n.model]||P['default'];}
function hex2(h,a){return`rgba(${parseInt(h.slice(1,3),16)},${parseInt(h.slice(3,5),16)},${parseInt(h.slice(5,7),16)},${a})`;}
function resize(){const r=wrap.getBoundingClientRect();dpr=devicePixelRatio||1;W=r.width;H=r.height;canvas.width=W*dpr;canvas.height=H*dpr;canvas.style.width=W+'px';canvas.style.height=H+'px';ctx.setTransform(dpr,0,0,dpr,0,0);}
function w2s(wx,wy){return{x:(wx-cam.x)*cam.z+W/2,y:(wy-cam.y)*cam.z+H/2};}
function s2w(sx,sy){return{x:(sx-W/2)/cam.z+cam.x,y:(sy-H/2)/cam.z+cam.y};}
window.addEventListener('resize',resize);

async function loadData(){
    try{
        const r=await fetch('/api/network-map/topology'),d=await r.json();
        ND=d.nodes||[];LD=d.links||[];
        document.getElementById('sT').textContent=d.total_routers;
        document.getElementById('sC').textContent=d.core_count||0;
        document.getElementById('sSw').textContent=d.switch_count||0;
        document.getElementById('sP').textContent=d.provincial_count||0;
        document.getElementById('sL').textContent=d.total_links;
        buildGraph();fitView();mkParticles();
        document.getElementById('loader').style.display='none';
        animate();
    }catch(e){document.getElementById('loader').innerHTML='<span style="color:#f472b6">Error loading</span>';}
}

function buildGraph(){
    const SX=10,SY=8;
    nodes=ND.map(n=>({...n,wx:n.x*SX,wy:n.y*SY,pal:gP(n),pulse:Math.random()*Math.PI*2}));
    // Spread overlapping nodes (core routers)
    const pm={};
    nodes.forEach(n=>{const k=Math.round(n.wx/5)+'_'+Math.round(n.wy/5);if(!pm[k])pm[k]=[];pm[k].push(n);});
    Object.values(pm).forEach(g=>{
        if(g.length>1){
            const step=Math.PI*2/g.length,sp=25+g.length*5;
            g.forEach((n,i)=>{n.wx+=Math.cos(step*i-Math.PI/2)*sp;n.wy+=Math.sin(step*i-Math.PI/2)*sp;});
        }
    });
    const nm={};nodes.forEach(n=>nm[n.id]=n);
    links=LD.map(l=>({...l,sn:nm[l.source],tn:nm[l.target]})).filter(l=>l.sn&&l.tn);
}

function mkParticles(){
    particles=[];
    links.forEach((l,i)=>{
        const cnt=l.type==='core'?4:l.sn.category==='core-router'||l.tn.category==='core-router'?2:1;
        for(let j=0;j<cnt;j++)particles.push({li:i,t:Math.random(),spd:.001+Math.random()*.003,sz:1+Math.random()*1.5,op:.3+Math.random()*.5});
    });
}

function fitView(){
    if(!nodes.length)return;
    let x1=1e9,x2=-1e9,y1=1e9,y2=-1e9;
    const vn=getVis();(vn.length?vn:nodes).forEach(n=>{if(n.wx<x1)x1=n.wx;if(n.wx>x2)x2=n.wx;if(n.wy<y1)y1=n.wy;if(n.wy>y2)y2=n.wy;});
    const pad=60,rx=x2-x1,ry=y2-y1;
    const z=Math.min(rx>0?(W-pad*2)/rx:2,ry>0?(H-pad*2)/ry:2,3.5);
    tCam={x:(x1+x2)/2,y:(y1+y2)/2,z};cam={...tCam};savedCam={...tCam};
}

function getVis(){return nodes.filter(n=>{if(filter!=='all'&&n.category!==filter)return false;if(searchStr){const q=searchStr.toLowerCase();if(!n.id.toLowerCase().includes(q)&&!n.label.includes(searchStr)&&!(n.abbr||'').toLowerCase().includes(q))return false;}return true;});}
function isNb(id){return selected?links.some(l=>(l.source===selected&&l.target===id)||(l.target===selected&&l.source===id)):false;}

// ── DRAWING ──
function drawBg(){
    ctx.fillStyle='#080c18';ctx.fillRect(0,0,W,H);
    // Ambient orbs
    [[0,0,350,'rgba(34,211,238,0.02)'],[500,400,400,'rgba(129,140,248,0.015)'],[200,600,300,'rgba(244,114,182,0.012)']].forEach(([x,y,r,c])=>{
        const s=w2s(x,y),gr=ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,r*cam.z);gr.addColorStop(0,c);gr.addColorStop(1,'transparent');ctx.fillStyle=gr;ctx.fillRect(s.x-r*cam.z,s.y-r*cam.z,r*2*cam.z,r*2*cam.z);
    });
    // Grid
    ctx.strokeStyle='rgba(100,116,139,0.03)';ctx.lineWidth=.5;
    const gs=80,tl=s2w(0,0),br=s2w(W,H);ctx.beginPath();
    for(let x=Math.floor(tl.x/gs)*gs;x<=br.x;x+=gs){const s=w2s(x,0);ctx.moveTo(s.x,0);ctx.lineTo(s.x,H);}
    for(let y=Math.floor(tl.y/gs)*gs;y<=br.y;y+=gs){const s=w2s(0,y);ctx.moveTo(0,s.y);ctx.lineTo(W,s.y);}
    ctx.stroke();
}

function drawLinks(vis,t){
    const vids=new Set(vis.map(n=>n.id));
    links.forEach(l=>{
        if(!vids.has(l.source)||!vids.has(l.target))return;
        const a=w2s(l.sn.wx,l.sn.wy),b=w2s(l.tn.wx,l.tn.wy);
        const isSel=selected&&(l.source===selected||l.target===selected);
        const dim=selected&&!isSel;
        const mx=(a.x+b.x)/2,my=(a.y+b.y)/2,dx=b.x-a.x,dy=b.y-a.y;
        const cx=mx+dy*.08,cy=my-dx*.08;

        if(isSel){
            // Bright glow - Fuselab style gradient line
            ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.quadraticCurveTo(cx,cy,b.x,b.y);
            ctx.strokeStyle='rgba(244,114,182,0.12)';ctx.lineWidth=8*cam.z;ctx.stroke();
            ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.quadraticCurveTo(cx,cy,b.x,b.y);
            const gr=ctx.createLinearGradient(a.x,a.y,b.x,b.y);
            gr.addColorStop(0,'#fb923c');gr.addColorStop(.5,'#f472b6');gr.addColorStop(1,'#818cf8');
            ctx.strokeStyle=gr;ctx.lineWidth=2.5*cam.z;ctx.stroke();
        }else if(dim){
            ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.quadraticCurveTo(cx,cy,b.x,b.y);
            ctx.strokeStyle='rgba(100,116,139,0.03)';ctx.lineWidth=.3;ctx.stroke();
        }else{
            ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.quadraticCurveTo(cx,cy,b.x,b.y);
            const gr=ctx.createLinearGradient(a.x,a.y,b.x,b.y);
            gr.addColorStop(0,'rgba(34,211,238,0.12)');gr.addColorStop(1,'rgba(129,140,248,0.12)');
            ctx.strokeStyle=gr;ctx.lineWidth=.8*cam.z;ctx.stroke();
        }
    });
}

function drawPart(vis,t){
    const vids=new Set(vis.map(n=>n.id));
    particles.forEach(p=>{
        const l=links[p.li];if(!l||!vids.has(l.source)||!vids.has(l.target))return;
        const dim=selected&&l.source!==selected&&l.target!==selected;if(dim)return;
        p.t+=p.spd;if(p.t>1)p.t-=1;
        const a=w2s(l.sn.wx,l.sn.wy),b=w2s(l.tn.wx,l.tn.wy);
        const mx=(a.x+b.x)/2,my=(a.y+b.y)/2,dx=b.x-a.x,dy=b.y-a.y;
        const cx=mx+dy*.08,cy=my-dx*.08;
        const tt=p.t,x=(1-tt)*(1-tt)*a.x+2*(1-tt)*tt*cx+tt*tt*b.x,y=(1-tt)*(1-tt)*a.y+2*(1-tt)*tt*cy+tt*tt*b.y;
        const isSel=selected&&(l.source===selected||l.target===selected);
        const sz=p.sz*cam.z*(isSel?1.8:1);
        // Glow
        const gr=ctx.createRadialGradient(x,y,0,x,y,sz*4);
        gr.addColorStop(0,isSel?'rgba(244,114,182,0.4)':'rgba(34,211,238,0.15)');gr.addColorStop(1,'transparent');
        ctx.fillStyle=gr;ctx.fillRect(x-sz*4,y-sz*4,sz*8,sz*8);
        ctx.beginPath();ctx.arc(x,y,sz,0,Math.PI*2);
        ctx.fillStyle=isSel?'#f472b6':'rgba(34,211,238,0.6)';ctx.globalAlpha=p.op*(isSel?1:.5);ctx.fill();ctx.globalAlpha=1;
    });
}

function drawNodes(vis,t){
    vis.forEach(n=>{
        const p=n.pal,s=w2s(n.wx,n.wy),r=p.r*cam.z;
        const isSel=selected===n.id,isHov=hovered===n.id,nb=isNb(n.id);
        const dim=selected&&!isSel&&!nb;
        if(dim){
            ctx.beginPath();ctx.arc(s.x,s.y,r*.6,0,Math.PI*2);ctx.fillStyle='rgba(100,116,139,0.05)';ctx.fill();
            if(cam.z>.4){ctx.fillStyle='rgba(100,116,139,0.12)';ctx.font=`${Math.max(6,7*cam.z)}px Inter`;ctx.textAlign='center';ctx.textBaseline='top';ctx.fillText(n.id,s.x,s.y+r*.6+4*cam.z);}
            return;
        }
        // Pulse ring for core
        if(n.category==='core-router'){
            const pu=Math.sin(t*2+n.pulse)*.5+.5;
            ctx.beginPath();ctx.arc(s.x,s.y,r*(1.8+pu*.6),0,Math.PI*2);ctx.strokeStyle=`rgba(244,114,182,${.04+pu*.06})`;ctx.lineWidth=1.5;ctx.stroke();
            ctx.beginPath();ctx.arc(s.x,s.y,r*(2.4+pu*.4),0,Math.PI*2);ctx.strokeStyle=`rgba(244,114,182,${.02+pu*.03})`;ctx.lineWidth=.8;ctx.stroke();
        }
        // Glow
        const glR=r*(isSel?3:isHov?2.5:1.8);
        const gl=ctx.createRadialGradient(s.x,s.y,r*.3,s.x,s.y,glR);
        gl.addColorStop(0,hex2(p.g,isSel?.3:isHov?.2:.08));gl.addColorStop(1,'transparent');
        ctx.fillStyle=gl;ctx.beginPath();ctx.arc(s.x,s.y,glR,0,Math.PI*2);ctx.fill();
        // Circle
        const cg=ctx.createRadialGradient(s.x-r*.3,s.y-r*.3,0,s.x,s.y,r);
        cg.addColorStop(0,p.c[0]);cg.addColorStop(1,p.c[1]);
        ctx.beginPath();ctx.arc(s.x,s.y,r,0,Math.PI*2);ctx.fillStyle=cg;ctx.globalAlpha=isSel||isHov?1:.85;ctx.fill();ctx.globalAlpha=1;
        // Selection ring
        if(isSel){ctx.beginPath();ctx.arc(s.x,s.y,r+3*cam.z,0,Math.PI*2);ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.stroke();}
        else if(isHov){ctx.beginPath();ctx.arc(s.x,s.y,r+2*cam.z,0,Math.PI*2);ctx.strokeStyle=p.g;ctx.lineWidth=1.5;ctx.stroke();}
        // Specular
        const sp=ctx.createRadialGradient(s.x-r*.25,s.y-r*.35,0,s.x,s.y,r);
        sp.addColorStop(0,'rgba(255,255,255,0.2)');sp.addColorStop(.5,'rgba(255,255,255,0.03)');sp.addColorStop(1,'transparent');
        ctx.beginPath();ctx.arc(s.x,s.y,r,0,Math.PI*2);ctx.fillStyle=sp;ctx.fill();
        // Hostname label (exact from config)
        ctx.fillStyle=isSel?'#fff':'rgba(226,232,240,0.85)';
        ctx.font=`${isSel?'bold ':''}${Math.max(7,(n.category==='core-router'?10:9)*cam.z)}px Inter`;
        ctx.textAlign='center';ctx.textBaseline='top';
        ctx.fillText(n.id,s.x,s.y+r+5*cam.z);
        // Province name subtitle
        if(n.label!==n.id&&cam.z>.5){
            ctx.fillStyle='rgba(100,116,139,0.6)';ctx.font=`${Math.max(6,7*cam.z)}px Inter`;
            ctx.fillText(n.label,s.x,s.y+r+(5+12)*cam.z);
        }
        // Badge
        if(n.tunnels_count>0&&cam.z>.5){
            const bx=s.x+r*.75,by=s.y-r*.75,br=Math.max(5,7*cam.z);
            ctx.beginPath();ctx.arc(bx,by,br,0,Math.PI*2);ctx.fillStyle=p.c[0];ctx.fill();
            ctx.strokeStyle='rgba(8,12,24,0.6)';ctx.lineWidth=1;ctx.stroke();
            ctx.fillStyle='#fff';ctx.font=`bold ${Math.max(5,6*cam.z)}px Inter`;ctx.textBaseline='middle';
            ctx.fillText(n.tunnels_count>999?'1k+':n.tunnels_count,bx,by);ctx.textBaseline='alphabetic';
        }
    });
}

function animate(){
    const t=performance.now()/1000;
    cam.x+=(tCam.x-cam.x)*.1;cam.y+=(tCam.y-cam.y)*.1;cam.z+=(tCam.z-cam.z)*.1;
    const vis=getVis();drawBg();drawLinks(vis,t);drawPart(vis,t);drawNodes(vis,t);
    requestAnimationFrame(animate);
}

// ── HIT TEST ──
function hit(sx,sy){const w=s2w(sx,sy);let best=null,bd=1e9;getVis().forEach(n=>{const dx=n.wx-w.x,dy=n.wy-w.y,d=Math.sqrt(dx*dx+dy*dy),hr=n.pal.r*1.5/cam.z;if(d<hr&&d<bd){best=n;bd=d;}});return best;}

// ── MOUSE ──
let clickT=null,lastCT=0;
wrap.addEventListener('mousedown',e=>{const r=canvas.getBoundingClientRect(),sx=e.clientX-r.left,sy=e.clientY-r.top;if(!hit(sx,sy)){dragging=true;dragS={x:e.clientX,y:e.clientY};camS={x:tCam.x,y:tCam.y};wrap.classList.add('grabbing');}});
window.addEventListener('mousemove',e=>{
    const r=canvas.getBoundingClientRect(),mx=e.clientX-r.left,my=e.clientY-r.top;
    if(dragging){tCam.x=camS.x-(e.clientX-dragS.x)/cam.z;tCam.y=camS.y-(e.clientY-dragS.y)/cam.z;return;}
    const h=hit(mx,my);hovered=h?h.id:null;canvas.style.cursor=h?'pointer':'grab';
    if(h){const s=w2s(h.wx,h.wy);ttip.innerHTML=`<div class="tt-l">${h.id}</div><div class="tt-m">${h.label} | ${h.model||h.category}</div><div class="tt-r"><span>IF:<b>${h.interfaces_count}</b></span><span>Tun:<b>${h.tunnels_count}</b></span><span>NAT:<b>${h.nat_count}</b></span></div>`;ttip.classList.add('show');let tx=s.x+18,ty=s.y-16;if(tx+240>W)tx=s.x-250;if(ty<5)ty=5;ttip.style.left=tx+'px';ttip.style.top=ty+'px';}
    else ttip.classList.remove('show');
});
window.addEventListener('mouseup',()=>{dragging=false;wrap.classList.remove('grabbing');});

canvas.addEventListener('click',e=>{
    const r=canvas.getBoundingClientRect(),sx=e.clientX-r.left,sy=e.clientY-r.top,h=hit(sx,sy);
    const now=Date.now();if(now-lastCT<350){clearTimeout(clickT);lastCT=now;return;}lastCT=now;
    clickT=setTimeout(()=>{
        if(h){
            if(selected===h.id){selected=null;if(savedCam)tCam={...savedCam};}
            else{if(!selected)savedCam={...tCam};selected=h.id;tCam={x:h.wx,y:h.wy,z:Math.max(cam.z,2.2)};}
        }else if(selected){selected=null;if(savedCam)tCam={...savedCam};closeP();}
    },220);
});
canvas.addEventListener('dblclick',e=>{e.preventDefault();const r=canvas.getBoundingClientRect(),h=hit(e.clientX-r.left,e.clientY-r.top);if(h){if(!selected)savedCam={...tCam};selected=h.id;tCam={x:h.wx,y:h.wy,z:Math.max(cam.z,2.2)};openP(h.id);}});
canvas.addEventListener('wheel',e=>{e.preventDefault();const f=e.deltaY>0?.92:1.08,nz=Math.max(.15,Math.min(6,tCam.z*f));const r=canvas.getBoundingClientRect(),mx=e.clientX-r.left,my=e.clientY-r.top;const wx=(mx-W/2)/cam.z+cam.x,wy=(my-H/2)/cam.z+cam.y;tCam.z=nz;tCam.x=wx-(mx-W/2)/nz;tCam.y=wy-(my-H/2)/nz;},{passive:false});

function setF(f,el){filter=f;document.querySelectorAll('.ft').forEach(b=>b.classList.remove('on'));el.classList.add('on');selected=null;}
function doSearch(v){searchStr=v;}
function resetAll(){selected=null;hovered=null;filter='all';searchStr='';document.getElementById('searchBox').value='';document.querySelectorAll('.ft').forEach(b=>b.classList.remove('on'));document.querySelector('.ft[data-f="all"]').classList.add('on');closeP();fitView();}

// ── PANEL ──
function closeP(){document.getElementById('panel').classList.remove('open');}
function openP(id){
    const n=ND.find(x=>x.id===id);if(!n)return;
    document.getElementById('panel').classList.add('open');
    document.getElementById('pTitle').textContent=n.id;
    const cm={'core-router':['Core Router','background:linear-gradient(135deg,rgba(244,114,182,0.2),rgba(251,146,60,0.2));color:#f472b6;border:1px solid rgba(244,114,182,0.3)'],'core-switch':['Switch','background:linear-gradient(135deg,rgba(129,140,248,0.2),rgba(192,132,252,0.2));color:#c4b5fd;border:1px solid rgba(129,140,248,0.3)'],'provincial-router':['Provincial','background:linear-gradient(135deg,rgba(34,211,238,0.2),rgba(59,130,246,0.2));color:#67e8f9;border:1px solid rgba(34,211,238,0.3)']};
    const c=cm[n.category]||['Other','background:rgba(100,116,139,0.15);color:#94a3b8'];
    document.getElementById('pBadge').textContent=c[0];document.getElementById('pBadge').style.cssText=c[1];
    renderOV(n);renderNAT(n);renderRT(n);renderFL(n);tab('ov',document.querySelector('.ptab[data-t="ov"]'));
}
function tab(t,el){document.querySelectorAll('.ptab').forEach(x=>x.classList.remove('on'));document.querySelectorAll('.tc').forEach(x=>x.classList.remove('on'));if(el)el.classList.add('on');document.getElementById('t-'+t).classList.add('on');}
function mc(l,v,g){return`<div style="background:rgba(255,255,255,0.02);border:1px solid var(--brd);border-radius:8px;padding:8px;text-align:center"><div style="font-size:20px;font-weight:800;background:${g};-webkit-background-clip:text;-webkit-text-fill-color:transparent">${v}</div><div style="font-size:7px;color:var(--t3);margin-top:1px;font-weight:600">${l}</div></div>`;}

function renderOV(n){
    let h='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px">';
    h+=mc('Interfaces',n.interfaces_count,'linear-gradient(135deg,#22d3ee,#3b82f6)');h+=mc('Tunnels',n.tunnels_count,'linear-gradient(135deg,#818cf8,#c084fc)');h+=mc('NAT',n.nat_count,'linear-gradient(135deg,#f472b6,#fb923c)');
    h+=mc('OSPF',n.ospf_count,'linear-gradient(135deg,#34d399,#22d3ee)');h+=mc('Routes',n.static_routes_count,'linear-gradient(135deg,#fbbf24,#f97316)');h+=mc('ACL',n.acl_count||0,'linear-gradient(135deg,#22d3ee,#818cf8)');
    h+='</div>';
    if(n.interfaces&&n.interfaces.length){h+='<div class="sc"><div class="st">Interfaces ('+n.interfaces_count+')</div>';n.interfaces.forEach(i=>{const nb=i.nat?`<span class="sb ${i.nat==='inside'?'b-in':'b-out'}">${i.nat}</span>`:'';h+=`<div class="sr"><span class="sv" style="min-width:100px">${i.name}</span><span class="sv" style="color:var(--accent1)">${i.ip||'-'}</span>${nb}</div>`;if(i.description)h+=`<div style="padding-left:108px;font-size:7px;color:var(--t3);margin-top:-2px">${i.description}</div>`;});h+='</div>';}
    if(n.tunnels&&n.tunnels.length){h+='<div class="sc"><div class="st">Tunnels ('+n.tunnels_count+')</div>';n.tunnels.slice(0,15).forEach(t=>{h+=`<div class="sr"><span class="sv" style="min-width:60px">${t.name}</span><span class="sv" style="color:var(--accent1)">${t.ip||''}</span><span style="color:var(--t3);font-size:7px">${t.tunnel_dst||''}</span></div>`;});if(n.tunnels.length>15)h+=`<div style="text-align:center;color:var(--t3);font-size:8px">+${n.tunnels.length-15} more</div>`;h+='</div>';}
    document.getElementById('t-ov').innerHTML=h;
}
function renderNAT(n){
    let h='';if(!n.nat_rules||!n.nat_rules.length){document.getElementById('t-nat').innerHTML='<div style="text-align:center;padding:20px;color:var(--t3)">No NAT rules</div>';return;}
    const dyn=n.nat_rules.filter(r=>r.type==='dynamic'),stat=n.nat_rules.filter(r=>r.type==='static'),pools=n.nat_rules.filter(r=>r.type==='pool');
    if(dyn.length){h+='<div class="sc"><div class="st">Dynamic NAT/PAT ('+dyn.length+')</div>';dyn.forEach(r=>{h+='<div style="display:flex;align-items:center;gap:5px;padding:4px 0;flex-wrap:wrap">';h+=`<span style="background:rgba(52,211,153,0.06);border:1px solid rgba(52,211,153,0.2);border-radius:4px;padding:2px 6px;font-size:8px;direction:ltr"><b style="color:#34d399">ACL:</b> ${r.acl||'?'}</span>`;h+='<span style="color:var(--accent1)">&#10132;</span>';if(r.pool)h+=`<span style="background:rgba(129,140,248,0.06);border:1px solid rgba(129,140,248,0.2);border-radius:4px;padding:2px 6px;font-size:8px;direction:ltr"><b style="color:#818cf8">Pool:</b> ${r.pool}</span>`;if(r.overload)h+='<span class="sb b-stat">PAT</span>';h+='</div>';});h+='</div>';}
    if(stat.length){h+='<div class="sc"><div class="st">Static NAT ('+stat.length+')</div>';stat.slice(0,15).forEach(r=>{h+=`<div class="sr" style="gap:3px"><span style="color:#34d399;font-size:8px">${r.inside_ip||'?'}</span><span style="color:var(--accent1)">&#10132;</span><span style="color:#f472b6;font-size:8px">${r.outside_ip||'?'}</span></div>`;});if(stat.length>15)h+=`<div style="font-size:7px;color:var(--t3);text-align:center">+${stat.length-15} more</div>`;h+='</div>';}
    if(pools.length){h+='<div class="sc"><div class="st">Pools</div>';pools.forEach(r=>{h+=`<div class="sr"><span class="sb b-pool">${r.name}</span><span class="sv" style="direction:ltr">${r.start} - ${r.end}</span></div>`;});h+='</div>';}
    document.getElementById('t-nat').innerHTML=h;
}
function renderRT(n){
    let h='';
    if(n.ospf&&n.ospf.length){h+='<div class="sc"><div class="st">OSPF</div>';n.ospf.forEach(o=>{h+=`<div style="margin-bottom:4px"><div style="font-size:9px;font-weight:700;color:#34d399;direction:ltr">Process ${o.process}${o.router_id?' ('+o.router_id+')':''}</div>`;if(o.networks)o.networks.slice(0,8).forEach(net=>{h+=`<div class="sr"><span class="sv">${net.net} ${net.wildcard}</span><span class="sb b-in">Area ${net.area}</span></div>`;});h+='</div>';});h+='</div>';}
    if(n.static_routes&&n.static_routes.length){h+=`<div class="sc"><div class="st">Static Routes (${n.static_routes_count})</div>`;n.static_routes.slice(0,20).forEach(r=>{h+=`<div class="sr" style="gap:2px"><span class="sv" style="color:var(--accent1)">${r.dest} ${r.mask}</span><span style="color:var(--t3)">&#10132;</span><span class="sv">${r.next_hop}</span></div>`;});if(n.static_routes_count>20)h+=`<div style="text-align:center;color:var(--t3);font-size:7px">+${n.static_routes_count-20} more</div>`;h+='</div>';}
    if(n.access_lists&&Object.keys(n.access_lists).length){h+='<div class="sc"><div class="st">Access Lists</div>';Object.entries(n.access_lists).forEach(([name,entries])=>{h+=`<div style="margin-bottom:4px"><div style="font-size:9px;font-weight:600;color:#818cf8;direction:ltr">${name} (${entries.length})</div>`;entries.slice(0,4).forEach(e=>{h+=`<div class="sr"><span class="sb ${e.action==='permit'?'b-in':'b-out'}">${e.action}</span><span class="sv" style="font-size:8px">${e.rule}</span></div>`;});h+='</div>';});h+='</div>';}
    if(!h)h='<div style="text-align:center;padding:20px;color:var(--t3)">No routes</div>';
    document.getElementById('t-rt').innerHTML=h;
}
function renderFL(n){
    let h=`<div style="font-size:9px;color:var(--t2);margin-bottom:8px">Path from <b style="color:var(--accent1)">${n.id}</b> to Core:</div>`;
    const path=bfs(n.id);
    if(!path||!path.length){if(n.category==='core-router')h+='<div class="fbox" style="text-align:center;padding:14px"><div style="font-size:24px;margin-bottom:4px">&#127919;</div><div style="font-size:12px;font-weight:700;color:#f472b6">Core Device</div></div>';else h+='<div style="text-align:center;padding:20px;color:var(--t3)">No path</div>';}
    else{h+='<div class="fbox">';path.forEach((s,i)=>{const sn=ND.find(x=>x.id===s.node);const p=sn?gP(sn):P['default'];const ic=sn&&sn.category==='core-router'?'&#128421;':sn&&sn.category==='core-switch'?'&#128433;':'&#128268;';h+=`<div class="fstep" onclick="selected='${s.node}';openP('${s.node}')"><div class="ficon" style="background:${hex2(p.g,.1)};border:1.5px solid ${p.g}">${ic}</div><div class="ftxt"><b>${s.node}</b><small>${sn?sn.label:''}</small></div></div>`;if(i<path.length-1)h+=`<div style="display:flex;align-items:center;gap:5px;padding:0 12px"><div class="farr">&#8595;</div><div style="font-size:7px;color:var(--t3);direction:ltr">${s.link?s.link.tunnel||'WAN':''}</div></div>`;});h+='</div>';}
    const nb=LD.filter(l=>l.source===n.id||l.target===n.id);
    if(nb.length){h+=`<div class="sc"><div class="st">Direct Links (${nb.length})</div>`;nb.slice(0,15).forEach(l=>{const peer=l.source===n.id?l.target:l.source;const pn=ND.find(x=>x.id===peer);const pc=pn?gP(pn):P['default'];h+=`<div class="sr" style="cursor:pointer;padding:2px;border-radius:3px" onclick="selected='${peer}';openP('${peer}')"><div style="width:6px;height:6px;border-radius:50%;background:${pc.g};box-shadow:0 0 4px ${hex2(pc.g,.4)};flex-shrink:0"></div><span class="sv" style="min-width:100px">${peer}</span><span style="font-size:7px;color:var(--t3);direction:ltr">${l.tunnel||'WAN'}</span></div>`;});h+='</div>';}
    document.getElementById('t-fl').innerHTML=h;
}
function bfs(start){const cores=new Set(ND.filter(n=>n.category==='core-router').map(n=>n.id));if(cores.has(start))return[];const adj={};LD.forEach(l=>{if(!adj[l.source])adj[l.source]=[];if(!adj[l.target])adj[l.target]=[];adj[l.source].push({p:l.target,l:l});adj[l.target].push({p:l.source,l:l});});const vis=new Set([start]),q=[{n:start,path:[{node:start,link:null}]}];while(q.length){const{n:cur,path}=q.shift();for(const{p,l}of(adj[cur]||[])){if(vis.has(p))continue;vis.add(p);const np=[...path,{node:p,link:l}];if(cores.has(p))return np;q.push({n:p,path:np});}}return null;}

resize();loadData();
</script>
</body>
</html>
