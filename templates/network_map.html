<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نقشه شبکه بانک کشاورزی</title>
<style>
:root{--bg:#050a15;--card:rgba(12,20,38,0.96);--text:#e2e8f0;--t2:#94a3b8;--t3:#64748b;
--brd:rgba(255,255,255,0.07);--blue:#3b82f6;--green:#10b981;--cyan:#06b6d4;
--red:#ef4444;--amber:#f59e0b;--purple:#8b5cf6;--pink:#ec4899}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column}

.hdr{height:44px;background:rgba(8,12,24,0.97);border-bottom:1px solid var(--brd);display:flex;align-items:center;padding:0 14px;gap:12px;z-index:100;flex-shrink:0}
.hdr h1{font-size:14px;white-space:nowrap;opacity:.9}
.hdr .stats{display:flex;gap:12px;font-size:11px;color:var(--t2);margin-right:auto}
.hdr .stats b{color:var(--cyan)}
.btn{padding:4px 10px;border-radius:5px;background:rgba(255,255,255,0.05);color:var(--text);font-size:10px;border:1px solid var(--brd);cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:3px}
.btn:hover{background:rgba(255,255,255,0.1)}
.btn.on{background:rgba(59,130,246,0.2);border-color:rgba(59,130,246,0.4);color:#93c5fd}

.filters{height:32px;background:rgba(8,12,24,0.85);border-bottom:1px solid var(--brd);display:flex;align-items:center;padding:0 14px;gap:6px;flex-shrink:0}
.filters label{font-size:10px;color:var(--t3)}
.ft{padding:2px 8px;border-radius:10px;font-size:9px;cursor:pointer;border:1px solid var(--brd);background:transparent;color:var(--t2)}
.ft:hover{border-color:rgba(255,255,255,0.2)}.ft.on{background:rgba(59,130,246,0.2);border-color:var(--blue);color:#93c5fd}
#searchBox{background:rgba(255,255,255,0.05);border:1px solid var(--brd);border-radius:5px;padding:2px 8px;color:var(--text);font-size:10px;width:160px;outline:none}

.main{flex:1;display:flex;overflow:hidden;position:relative}
#mapWrap{flex:1;position:relative;overflow:hidden;cursor:grab;perspective:1200px}
#mapWrap.grabbing{cursor:grabbing}
#mapInner{width:100%;height:100%;transform-style:preserve-3d;transition:transform .6s cubic-bezier(.25,.8,.25,1)}
#mapSvg{width:100%;height:100%}

/* 3D tilt */
.tilt-subtle #mapInner{transform:rotateX(8deg) rotateY(0deg) scale(0.95)}
.tilt-off #mapInner{transform:none}

/* Detail Panel */
#panel{width:0;overflow:hidden;background:rgba(8,14,28,0.98);border-right:1px solid var(--brd);transition:width .35s ease;flex-shrink:0;display:flex;flex-direction:column}
#panel.open{width:480px}
.ph{padding:12px 14px;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:8px;flex-shrink:0}
.ph h2{font-size:14px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ph .badge{font-size:9px;padding:2px 6px;border-radius:3px;font-weight:600}
.pcl{width:26px;height:26px;border-radius:5px;border:1px solid var(--brd);background:transparent;color:var(--t2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px}
.pcl:hover{background:rgba(255,255,255,0.1)}
.ptabs{display:flex;border-bottom:1px solid var(--brd);flex-shrink:0}
.ptab{flex:1;padding:7px;text-align:center;font-size:10px;cursor:pointer;color:var(--t3);border-bottom:2px solid transparent}
.ptab:hover{color:var(--text)}.ptab.on{color:var(--blue);border-bottom-color:var(--blue)}
.pbody{flex:1;overflow-y:auto;padding:0}
.tc{display:none;padding:12px 14px}.tc.on{display:block}

.sc{background:rgba(255,255,255,0.025);border:1px solid var(--brd);border-radius:7px;padding:10px;margin-bottom:8px}
.st{font-size:10px;font-weight:700;color:var(--cyan);margin-bottom:6px;display:flex;align-items:center;gap:5px}
.sr{display:flex;align-items:center;gap:6px;padding:3px 0;font-size:10px;direction:ltr;text-align:left}
.sv{color:var(--t2);font-family:Consolas,monospace}
.sb{display:inline-block;padding:1px 5px;border-radius:3px;font-size:8px;font-weight:600}
.b-in{background:rgba(16,185,129,0.15);color:#6ee7b7}
.b-out{background:rgba(239,68,68,0.15);color:#fca5a5}
.b-pool{background:rgba(139,92,246,0.15);color:#c4b5fd}
.b-stat{background:rgba(245,158,11,0.15);color:#fcd34d}
.b-cry{background:rgba(236,72,153,0.15);color:#f9a8d4}

.fbox{background:rgba(255,255,255,0.015);border:1px solid var(--brd);border-radius:8px;padding:12px;margin-bottom:8px}
.fstep{display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer;border-radius:4px}
.fstep:hover{background:rgba(255,255,255,0.03)}
.ficon{width:32px;height:32px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.farr{color:var(--blue);font-size:16px;text-align:center;padding:1px 0;width:32px}
.ftxt{flex:1}.ftxt b{font-size:11px;display:block;color:var(--text)}.ftxt small{font-size:9px;color:var(--t3);font-family:Consolas,monospace;direction:ltr}

.legend{position:absolute;bottom:10px;left:10px;background:var(--card);border:1px solid var(--brd);border-radius:8px;padding:10px 12px;font-size:9px;z-index:50}
.lr{display:flex;align-items:center;gap:5px;margin-bottom:3px}
.ld{width:8px;height:8px;border-radius:50%;flex-shrink:0}

.load{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:200}
.load .sp{width:36px;height:36px;border:3px solid var(--brd);border-top-color:var(--blue);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes flow{to{stroke-dashoffset:-24}}
@keyframes pulse{0%,100%{opacity:.5}50%{opacity:1}}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:4px}

/* Zoom hint */
.zoom-hint{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:#fff;padding:8px 16px;border-radius:8px;font-size:12px;pointer-events:none;opacity:0;transition:opacity .3s;z-index:150}
.zoom-hint.show{opacity:1}
</style>
</head>
<body>
<div class="hdr">
    <h1>&#127758; نقشه شبکه بانک کشاورزی</h1>
    <div class="stats">
        <span>تجهیزات: <b id="sT">0</b></span>
        <span>Core: <b id="sC">0</b></span>
        <span>Switch: <b id="sSw">0</b></span>
        <span>استانی: <b id="sP">0</b></span>
        <span>لینک: <b id="sL">0</b></span>
    </div>
    <button class="btn" id="btn3d" onclick="toggle3D()">3D</button>
    <button class="btn" onclick="resetAll()">&#8634; ریست</button>
    <a href="/" class="btn">&#8592; بازگشت</a>
</div>
<div class="filters">
    <label>نمایش:</label>
    <button class="ft on" data-f="all" onclick="setF('all',this)">همه</button>
    <button class="ft" data-f="core-router" onclick="setF('core-router',this)">Core</button>
    <button class="ft" data-f="core-switch" onclick="setF('core-switch',this)">Switch</button>
    <button class="ft" data-f="provincial-router" onclick="setF('provincial-router',this)">استانی</button>
    <span style="flex:1"></span>
    <input id="searchBox" placeholder="جستجو hostname / استان..." oninput="doSearch(this.value)">
</div>
<div class="main">
<div id="mapWrap" class="tilt-subtle">
    <div id="mapInner"><svg id="mapSvg" viewBox="0 0 1000 850"></svg></div>
    <div class="legend">
        <div style="font-weight:700;margin-bottom:4px;color:var(--blue);font-size:10px">راهنما</div>
        <div class="lr"><div class="ld" style="background:#ef4444"></div>Core Router</div>
        <div class="lr"><div class="ld" style="background:#8b5cf6"></div>Core Switch</div>
        <div class="lr"><div class="ld" style="background:#3b82f6"></div>ASR1002X</div>
        <div class="lr"><div class="ld" style="background:#10b981"></div>3845</div>
        <div class="lr"><div class="ld" style="background:#f59e0b"></div>3825</div>
        <div class="lr" style="font-size:8px;color:var(--t3);margin-top:4px">1-Click: فلو | 2-Click: جزئیات</div>
    </div>
    <div class="zoom-hint" id="zoomHint"></div>
    <div class="load" id="loader"><div class="sp"></div></div>
</div>
<div id="panel">
    <div class="ph"><h2 id="pTitle">-</h2><span class="badge" id="pBadge">-</span><button class="pcl" onclick="closeP()">&times;</button></div>
    <div class="ptabs">
        <div class="ptab on" data-t="ov" onclick="tab('ov',this)">خلاصه</div>
        <div class="ptab" data-t="nat" onclick="tab('nat',this)">NAT</div>
        <div class="ptab" data-t="rt" onclick="tab('rt',this)">مسیرها</div>
        <div class="ptab" data-t="fl" onclick="tab('fl',this)">فلو</div>
    </div>
    <div class="pbody">
        <div class="tc on" id="t-ov"></div>
        <div class="tc" id="t-nat"></div>
        <div class="tc" id="t-rt"></div>
        <div class="tc" id="t-fl"></div>
    </div>
</div>
</div>

<script>
const svg=document.getElementById('mapSvg'),mapWrap=document.getElementById('mapWrap');
let ND=[],LD=[],NM={},sel=null,filter='all',search='',is3d=true;
let vb={x:-50,y:-30,w:1100,h:920};

function nc(n){
    if(n.category==='core-router')return'#ef4444';
    if(n.category==='core-switch')return'#8b5cf6';
    if(n.model==='ASR1002X')return'#3b82f6';
    if(n.model==='3845')return'#10b981';
    if(n.model==='3825')return'#f59e0b';
    return'#64748b';
}
function nr(n){
    if(n.category==='core-router')return 14;
    if(n.category==='core-switch')return 10;
    return 11;
}

async function load(){
    try{
        const r=await fetch('/api/network-map/topology');
        const d=await r.json();
        ND=d.nodes||[];LD=d.links||[];
        document.getElementById('sT').textContent=d.total_routers;
        document.getElementById('sC').textContent=d.core_count||0;
        document.getElementById('sSw').textContent=d.switch_count||0;
        document.getElementById('sP').textContent=d.provincial_count||0;
        document.getElementById('sL').textContent=d.total_links;
        buildPos();draw();
    }catch(e){console.error(e)}
    document.getElementById('loader').style.display='none';
}

function buildPos(){
    NM={};
    // Scale positions - spread out more
    ND.forEach(n=>{
        NM[n.id]={x:n.x*11,y:n.y*9.5+30};
    });

    // Force-based spread for overlapping nodes
    for(let iter=0;iter<40;iter++){
        const ids=Object.keys(NM);
        for(let i=0;i<ids.length;i++){
            const a=NM[ids[i]];
            for(let j=i+1;j<ids.length;j++){
                const b=NM[ids[j]];
                let dx=a.x-b.x, dy=a.y-b.y;
                let dist=Math.sqrt(dx*dx+dy*dy);
                const na=ND.find(n=>n.id===ids[i]),nb=ND.find(n=>n.id===ids[j]);
                const minDist=(na&&na.category==='core-router'&&nb&&nb.category==='core-router')?55:
                    (na&&nb&&na.province===nb.province)?30:45;
                if(dist<minDist&&dist>0){
                    const force=(minDist-dist)/dist*0.3;
                    const fx=dx*force,fy=dy*force;
                    a.x+=fx;a.y+=fy;b.x-=fx;b.y-=fy;
                }else if(dist===0){
                    a.x+=Math.random()*20-10;a.y+=Math.random()*20-10;
                }
            }
        }
    }
}

function draw(){
    let s='';
    s+='<defs>';
    s+='<marker id="aB" markerWidth="6" markerHeight="5" refX="6" refY="2.5" orient="auto"><polygon points="0 0,6 2.5,0 5" fill="rgba(59,130,246,0.5)"/></marker>';
    s+='<marker id="aH" markerWidth="7" markerHeight="5" refX="7" refY="2.5" orient="auto"><polygon points="0 0,7 2.5,0 5" fill="#3b82f6"/></marker>';
    s+='<marker id="aG" markerWidth="6" markerHeight="5" refX="6" refY="2.5" orient="auto"><polygon points="0 0,6 2.5,0 5" fill="rgba(139,92,246,0.5)"/></marker>';
    s+='<filter id="gl"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>';
    s+='<filter id="gl2"><feGaussianBlur stdDeviation="6" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>';
    s+='<filter id="sh"><feDropShadow dx="0" dy="3" stdDeviation="4" flood-opacity="0.5"/></filter>';
    s+='<pattern id="gr" width="50" height="50" patternUnits="userSpaceOnUse"><path d="M50 0L0 0 0 50" fill="none" stroke="rgba(255,255,255,0.012)" stroke-width="0.5"/></pattern>';
    s+='</defs>';
    s+='<rect x="-300" y="-300" width="1600" height="1500" fill="url(#gr)"/>';

    const vis=getVis(),vids=new Set(vis.map(n=>n.id));

    // Links
    LD.forEach(lk=>{
        if(!vids.has(lk.source)||!vids.has(lk.target))return;
        const a=NM[lk.source],b=NM[lk.target];
        if(!a||!b)return;
        const hi=sel&&(lk.source===sel||lk.target===sel);
        const dx=b.x-a.x,dy=b.y-a.y;
        const cx=(a.x+b.x)/2+dy*0.08,cy=(a.y+b.y)/2-dx*0.08;
        if(hi){
            s+=`<path d="M${a.x},${a.y}Q${cx},${cy} ${b.x},${b.y}" fill="none" stroke="#3b82f6" stroke-width="2.5" opacity=".85" marker-end="url(#aH)"/>`;
            s+=`<path d="M${a.x},${a.y}Q${cx},${cy} ${b.x},${b.y}" fill="none" stroke="#60a5fa" stroke-width="1.5" stroke-dasharray="5 10" opacity=".7" style="animation:flow .8s linear infinite"/>`;
        }else if(sel){
            s+=`<path d="M${a.x},${a.y}Q${cx},${cy} ${b.x},${b.y}" fill="none" stroke="rgba(255,255,255,0.02)" stroke-width=".4"/>`;
        }else if(lk.type==='wan'){
            s+=`<path d="M${a.x},${a.y}Q${cx},${cy} ${b.x},${b.y}" fill="none" stroke="rgba(255,255,255,0.04)" stroke-width=".4" stroke-dasharray="3 5"/>`;
        }else if(lk.type==='lan'||lk.type==='subnet'){
            s+=`<path d="M${a.x},${a.y}Q${cx},${cy} ${b.x},${b.y}" fill="none" stroke="rgba(139,92,246,0.2)" stroke-width=".8" marker-end="url(#aG)"/>`;
        }else{
            s+=`<path d="M${a.x},${a.y}Q${cx},${cy} ${b.x},${b.y}" fill="none" stroke="rgba(59,130,246,0.18)" stroke-width=".8" marker-end="url(#aB)"/>`;
            s+=`<path d="M${a.x},${a.y}Q${cx},${cy} ${b.x},${b.y}" fill="none" stroke="rgba(59,130,246,0.2)" stroke-width=".5" stroke-dasharray="3 14" opacity=".4" style="animation:flow 2s linear infinite"/>`;
        }
    });

    // Nodes
    vis.forEach(n=>{
        const p=NM[n.id];if(!p)return;
        const c=nc(n),r=nr(n);
        const isSel=sel===n.id;
        const dim=sel&&!isSel&&!isNb(n.id);

        if(n.category==='core-router'&&!dim){
            s+=`<circle cx="${p.x}" cy="${p.y}" r="${r+10}" fill="${c}" opacity=".04" style="animation:pulse 3s ease infinite"/>`;
        }
        // Shadow for 3D
        if(!dim) s+=`<ellipse cx="${p.x+2}" cy="${p.y+4}" rx="${r}" ry="${r*.6}" fill="rgba(0,0,0,0.3)" filter="url(#sh)"/>`;
        // Glow
        s+=`<circle cx="${p.x}" cy="${p.y}" r="${r+4}" fill="${c}" opacity="${dim?.01:.08}"/>`;

        // Shape
        if(n.category==='core-router'){
            const z=r*1.3;
            s+=`<rect x="${p.x-z}" y="${p.y-z}" width="${z*2}" height="${z*2}" rx="4" fill="${c}" opacity="${dim?.1:.9}" stroke="${isSel?'#fff':c}" stroke-width="${isSel?2.5:1.5}" filter="url(#gl)" style="cursor:pointer" data-n="${n.id}"/>`;
        }else if(n.category==='core-switch'){
            const z=r*1.1;
            s+=`<polygon points="${p.x},${p.y-z} ${p.x+z},${p.y} ${p.x},${p.y+z} ${p.x-z},${p.y}" fill="${c}" opacity="${dim?.1:.8}" stroke="${isSel?'#fff':c}" stroke-width="${isSel?2.5:1}" filter="url(#gl)" style="cursor:pointer" data-n="${n.id}"/>`;
        }else{
            s+=`<circle cx="${p.x}" cy="${p.y}" r="${r}" fill="${c}" opacity="${dim?.1:.85}" stroke="${isSel?'#fff':c}" stroke-width="${isSel?2.5:1.5}" filter="url(#gl)" style="cursor:pointer" data-n="${n.id}"/>`;
        }

        if(!dim){
            const ly=p.y+r+11;
            const fs=n.category==='core-router'?9:8;
            s+=`<text x="${p.x}" y="${ly}" text-anchor="middle" fill="${isSel?'#fff':'var(--t2)'}" font-size="${fs}" font-weight="${n.category==='core-router'?700:500}" font-family="Segoe UI,Tahoma,sans-serif">${n.label}</text>`;
            s+=`<text x="${p.x}" y="${ly+10}" text-anchor="middle" fill="var(--t3)" font-size="6" font-family="Consolas,monospace">${n.id}</text>`;
            if(n.tunnels_count>0){
                s+=`<circle cx="${p.x+r-1}" cy="${p.y-r+1}" r="5.5" fill="${n.tunnels_count>50?'#ef4444':'#6366f1'}" stroke="var(--bg)" stroke-width="1"/>`;
                s+=`<text x="${p.x+r-1}" y="${p.y-r+3.5}" text-anchor="middle" fill="#fff" font-size="5" font-weight="700">${n.tunnels_count>999?'1k+':n.tunnels_count}</text>`;
            }
            if(n.nat_count>0){
                s+=`<circle cx="${p.x-r+1}" cy="${p.y-r+1}" r="4.5" fill="#f59e0b" stroke="var(--bg)" stroke-width="1"/>`;
                s+=`<text x="${p.x-r+1}" y="${p.y-r+3.5}" text-anchor="middle" fill="#000" font-size="4.5" font-weight="700">N</text>`;
            }
        }
    });

    svg.innerHTML=s;
    svg.setAttribute('viewBox',`${vb.x} ${vb.y} ${vb.w} ${vb.h}`);

    // Event handlers
    svg.querySelectorAll('[data-n]').forEach(el=>{
        el.addEventListener('click',e=>{e.stopPropagation();handleClick(el.getAttribute('data-n'))});
        el.addEventListener('dblclick',e=>{e.stopPropagation();e.preventDefault();handleDbl(el.getAttribute('data-n'))});
    });
}

function getVis(){
    return ND.filter(n=>{
        if(filter!=='all'&&n.category!==filter)return false;
        if(search){
            const q=search.toLowerCase();
            if(!n.id.toLowerCase().includes(q)&&!n.label.includes(search)&&!(n.abbr||'').toLowerCase().includes(q))return false;
        }
        return true;
    });
}
function isNb(id){
    if(!sel)return false;
    return LD.some(l=>(l.source===sel&&l.target===id)||(l.target===sel&&l.source===id));
}

// Single click = zoom to device + show flow
let clickTimer=null,lastClick=0;
function handleClick(id){
    const now=Date.now();
    if(now-lastClick<350){clearTimeout(clickTimer);lastClick=now;return;}
    lastClick=now;
    clickTimer=setTimeout(()=>{
        if(sel===id){sel=null;closeP();resetView();draw();return;}
        sel=id;
        zoomTo(id);
        draw();
        showHint('دبل‌کلیک برای جزئیات کامل');
    },300);
}
// Double click = open detail panel
function handleDbl(id){
    sel=id;
    zoomTo(id);
    draw();
    openP(id);
}

function zoomTo(id){
    const p=NM[id];if(!p)return;
    const sz=300;
    vb={x:p.x-sz/2,y:p.y-sz/2.5,w:sz,h:sz*0.85};
    svg.setAttribute('viewBox',`${vb.x} ${vb.y} ${vb.w} ${vb.h}`);
}
function resetView(){
    vb={x:-50,y:-30,w:1100,h:920};
    svg.setAttribute('viewBox',`${vb.x} ${vb.y} ${vb.w} ${vb.h}`);
}

function showHint(msg){
    const h=document.getElementById('zoomHint');
    h.textContent=msg;h.classList.add('show');
    setTimeout(()=>h.classList.remove('show'),2000);
}

// Panel
function closeP(){document.getElementById('panel').classList.remove('open');sel=null;resetView();draw();}
function openP(id){
    const n=ND.find(x=>x.id===id);if(!n)return;
    document.getElementById('panel').classList.add('open');
    document.getElementById('pTitle').textContent=n.label+' ('+n.id+')';
    const catMap={'core-router':['Core Router','rgba(239,68,68,0.15);color:#fca5a5'],'core-switch':['Switch','rgba(139,92,246,0.15);color:#c4b5fd'],'provincial-router':['استانی','rgba(59,130,246,0.15);color:#93c5fd']};
    const cm=catMap[n.category]||['سایر','rgba(100,116,139,0.15);color:#94a3b8'];
    document.getElementById('pBadge').textContent=cm[0];
    document.getElementById('pBadge').style.cssText='background:'+cm[1];
    renderOV(n);renderNAT(n);renderRT(n);renderFL(n);
    tab('ov',document.querySelector('.ptab[data-t="ov"]'));
}
function tab(t,el){
    document.querySelectorAll('.ptab').forEach(x=>x.classList.remove('on'));
    document.querySelectorAll('.tc').forEach(x=>x.classList.remove('on'));
    if(el)el.classList.add('on');
    document.getElementById('t-'+t).classList.add('on');
}

// Overview tab
function renderOV(n){
    let h='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px">';
    h+=mc('Interfaces',n.interfaces_count,'#3b82f6');h+=mc('Tunnels',n.tunnels_count,'#8b5cf6');h+=mc('NAT',n.nat_count,'#ef4444');
    h+=mc('OSPF',n.ospf_count,'#10b981');h+=mc('Routes',n.static_routes_count,'#f59e0b');h+=mc('ACL',n.acl_count,'#06b6d4');
    h+='</div>';
    if(n.interfaces&&n.interfaces.length){
        h+='<div class="sc"><div class="st">&#128268; اینترفیس‌ها ('+n.interfaces_count+')</div>';
        n.interfaces.forEach(i=>{
            const nb=i.nat?`<span class="sb ${i.nat==='inside'?'b-in':'b-out'}">${i.nat}</span>`:'';
            const cb=i.crypto_map?`<span class="sb b-cry">${i.crypto_map}</span>`:'';
            h+=`<div class="sr"><span class="sv" style="min-width:120px">${i.name}</span><span class="sv" style="color:var(--cyan)">${i.ip||'-'}${i.mask?'/'+i.mask:''}</span>${nb}${cb}</div>`;
            if(i.description)h+=`<div style="padding-left:128px;font-size:8px;color:var(--t3);margin-top:-2px">${i.description}</div>`;
        });
        h+='</div>';
    }
    if(n.tunnels&&n.tunnels.length){
        h+='<div class="sc"><div class="st">&#128384; تونل‌ها ('+n.tunnels_count+')</div>';
        n.tunnels.slice(0,15).forEach(t=>{
            const nb=t.nat?`<span class="sb ${t.nat==='inside'?'b-in':'b-out'}">${t.nat}</span>`:'';
            h+=`<div class="sr"><span class="sv" style="min-width:70px">${t.name}</span><span class="sv" style="color:var(--cyan)">${t.ip||''}</span><span style="color:var(--t3);font-size:8px">${t.tunnel_dst||''}</span>${nb}</div>`;
            if(t.description)h+=`<div style="padding-left:78px;font-size:8px;color:var(--t3);margin-top:-2px">${t.description}</div>`;
        });
        if(n.tunnels.length>15)h+=`<div style="text-align:center;color:var(--t3);font-size:9px;padding-top:4px">+${n.tunnels.length-15} تونل دیگر</div>`;
        h+='</div>';
    }
    if(n.crypto_maps&&n.crypto_maps.length){
        h+='<div class="sc"><div class="st">&#128274; Crypto Maps</div>';
        n.crypto_maps.forEach(c=>{h+=`<div class="sr"><span class="sb b-cry">${c}</span></div>`;});
        h+='</div>';
    }
    document.getElementById('t-ov').innerHTML=h;
}
function mc(l,v,c){return`<div style="background:rgba(255,255,255,0.025);border:1px solid var(--brd);border-radius:6px;padding:8px;text-align:center"><div style="font-size:18px;font-weight:800;color:${c}">${v}</div><div style="font-size:8px;color:var(--t3);margin-top:1px">${l}</div></div>`;}

// NAT tab
function renderNAT(n){
    let h='';
    if(!n.nat_rules||!n.nat_rules.length){h='<div style="text-align:center;padding:24px;color:var(--t3)">بدون NAT</div>';document.getElementById('t-nat').innerHTML=h;return;}
    if(n.nat_interfaces&&n.nat_interfaces.length){
        h+='<div class="sc"><div class="st">&#128256; NAT Boundary</div>';
        h+='<div style="display:flex;gap:12px;justify-content:center;align-items:center;padding:8px;flex-wrap:wrap">';
        const ins=n.nat_interfaces.filter(i=>i.side==='inside'),outs=n.nat_interfaces.filter(i=>i.side==='outside');
        h+='<div style="text-align:center"><div style="font-size:8px;color:var(--green);font-weight:700;margin-bottom:4px">INSIDE</div>';
        ins.forEach(i=>{h+=`<div style="background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.25);border-radius:4px;padding:2px 6px;margin:2px 0;font-size:9px;font-family:Consolas;direction:ltr">${i.name}</div>`;});
        h+='</div><div style="font-size:20px;color:var(--blue)">&#10132;</div>';
        h+=`<div style="padding:8px;border:2px solid ${nc(n)};border-radius:8px;text-align:center;min-width:60px"><div style="font-size:12px">&#128421;</div><div style="font-size:8px;font-weight:700">${n.id}</div></div>`;
        h+='<div style="font-size:20px;color:var(--red)">&#10132;</div>';
        h+='<div style="text-align:center"><div style="font-size:8px;color:var(--red);font-weight:700;margin-bottom:4px">OUTSIDE</div>';
        outs.forEach(i=>{h+=`<div style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.25);border-radius:4px;padding:2px 6px;margin:2px 0;font-size:9px;font-family:Consolas;direction:ltr">${i.name}</div>`;});
        h+='</div></div></div>';
    }
    const dyn=n.nat_rules.filter(r=>r.type==='dynamic'),stat=n.nat_rules.filter(r=>r.type==='static'),pools=n.nat_rules.filter(r=>r.type==='pool');
    if(dyn.length){
        h+='<div class="sc"><div class="st">&#128260; Dynamic NAT/PAT ('+dyn.length+')</div>';
        dyn.forEach(r=>{
            h+='<div style="display:flex;align-items:center;gap:6px;padding:4px 0;flex-wrap:wrap">';
            h+=`<div style="background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);border-radius:4px;padding:2px 6px;font-size:9px;direction:ltr"><b style="color:var(--green)">ACL:</b> ${r.acl||'?'}</div>`;
            h+='<span style="color:var(--blue);font-size:14px">&#10132;</span>';
            if(r.pool)h+=`<div style="background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.2);border-radius:4px;padding:2px 6px;font-size:9px;direction:ltr"><b style="color:var(--purple)">Pool:</b> ${r.pool}</div>`;
            else if(r.interface)h+=`<div style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:4px;padding:2px 6px;font-size:9px;direction:ltr"><b style="color:var(--red)">IF:</b> ${r.interface}</div>`;
            if(r.overload)h+='<span class="sb b-stat">PAT</span>';
            h+='</div>';
        });h+='</div>';
    }
    if(stat.length){
        h+='<div class="sc"><div class="st">&#128204; Static NAT ('+stat.length+')</div>';
        stat.slice(0,20).forEach(r=>{
            h+=`<div class="sr" style="gap:4px"><span style="background:rgba(16,185,129,0.08);border-radius:3px;padding:1px 5px;font-size:9px;direction:ltr;color:var(--green)">${r.inside_ip||'?'}</span><span style="color:var(--blue)">&#10132;</span><span style="background:rgba(239,68,68,0.08);border-radius:3px;padding:1px 5px;font-size:9px;direction:ltr;color:var(--red)">${r.outside_ip||'?'}</span></div>`;
        });
        if(stat.length>20)h+=`<div style="font-size:8px;color:var(--t3);text-align:center">+${stat.length-20} more</div>`;
        h+='</div>';
    }
    if(pools.length){
        h+='<div class="sc"><div class="st">&#127922; Pools ('+pools.length+')</div>';
        pools.forEach(r=>{h+=`<div class="sr"><span class="sb b-pool">${r.name}</span><span class="sv" style="direction:ltr">${r.start} - ${r.end}</span></div>`;});
        h+='</div>';
    }
    document.getElementById('t-nat').innerHTML=h;
}

// Routes tab
function renderRT(n){
    let h='';
    if(n.ospf&&n.ospf.length){
        h+='<div class="sc"><div class="st">&#128752; OSPF</div>';
        n.ospf.forEach(o=>{
            h+=`<div style="margin-bottom:6px"><div style="font-size:10px;font-weight:700;color:var(--green);direction:ltr">Process ${o.process}${o.router_id?' ('+o.router_id+')':''}</div>`;
            if(o.networks)o.networks.slice(0,10).forEach(net=>{h+=`<div class="sr"><span class="sv">${net.net} ${net.wildcard}</span><span class="sb b-in">Area ${net.area}</span></div>`;});
            if(o.networks&&o.networks.length>10)h+=`<div style="font-size:8px;color:var(--t3)">+${o.networks.length-10} more</div>`;
            if(o.redistribute)o.redistribute.forEach(r=>{h+=`<div class="sr"><span class="sb b-stat">redist</span><span class="sv">${r}</span></div>`;});
            h+='</div>';
        });h+='</div>';
    }
    if(n.static_routes&&n.static_routes.length){
        h+=`<div class="sc"><div class="st">&#128736; Static Routes (${n.static_routes_count})</div>`;
        n.static_routes.slice(0,30).forEach(r=>{
            h+=`<div class="sr" style="gap:3px"><span class="sv" style="min-width:110px;color:var(--cyan)">${r.dest} ${r.mask}</span><span style="color:var(--t3);font-size:9px">&#10132;</span><span class="sv">${r.next_hop}</span>`;
            if(r.name)h+=`<span style="font-size:8px;color:var(--amber)">${r.name}</span>`;
            h+='</div>';
        });
        if(n.static_routes_count>30)h+=`<div style="text-align:center;color:var(--t3);font-size:8px;padding-top:4px">+${n.static_routes_count-30} more</div>`;
        h+='</div>';
    }
    if(n.access_lists&&Object.keys(n.access_lists).length){
        h+='<div class="sc"><div class="st">&#128737; Access Lists</div>';
        Object.entries(n.access_lists).forEach(([name,entries])=>{
            h+=`<div style="margin-bottom:6px"><div style="font-size:10px;font-weight:600;color:var(--purple);direction:ltr;margin-bottom:2px">${name} (${entries.length})</div>`;
            entries.slice(0,5).forEach(e=>{h+=`<div class="sr" style="gap:3px"><span class="sb ${e.action==='permit'?'b-in':'b-out'}">${e.action}</span><span class="sv" style="font-size:9px">${e.rule}</span></div>`;});
            if(entries.length>5)h+=`<div style="font-size:8px;color:var(--t3)">+${entries.length-5} more</div>`;
            h+='</div>';
        });h+='</div>';
    }
    if(!h)h='<div style="text-align:center;padding:24px;color:var(--t3)">بدون مسیر</div>';
    document.getElementById('t-rt').innerHTML=h;
}

// Flow tab
function renderFL(n){
    let h=`<div style="font-size:10px;color:var(--t2);margin-bottom:10px">مسیر ترافیک <b style="color:var(--cyan)">${n.label}</b> تا Core:</div>`;
    const path=bfs(n.id);
    if(!path||!path.length){
        if(n.category==='core-router')h+='<div class="fbox" style="text-align:center;padding:14px"><div style="font-size:24px;margin-bottom:6px">&#127919;</div><div style="font-size:12px;font-weight:700;color:var(--red)">Core Device</div></div>';
        else h+='<div style="text-align:center;padding:24px;color:var(--t3)">مسیر پیدا نشد</div>';
    }else{
        h+='<div class="fbox">';
        path.forEach((s,i)=>{
            const sn=ND.find(x=>x.id===s.node);
            const c=sn?nc(sn):'#64748b';
            const ic=sn&&sn.category==='core-router'?'&#128421;':sn&&sn.category==='core-switch'?'&#128433;':'&#128268;';
            h+=`<div class="fstep" onclick="handleDbl('${s.node}')"><div class="ficon" style="background:${c}18;border:2px solid ${c}">${ic}</div><div class="ftxt"><b>${sn?sn.label:s.node}</b><small>${s.node}${s.via?' via '+s.via:''}</small>`;
            if(s.tunnel)h+=`<small style="color:var(--blue)">Tunnel: ${s.tunnel}</small>`;
            if(sn&&sn.nat_count>0)h+=`<div style="margin-top:2px"><span class="sb b-stat" style="font-size:7px">NAT: ${sn.nat_count} rules</span></div>`;
            h+='</div></div>';
            if(i<path.length-1){
                const lk=s.link;
                h+=`<div style="display:flex;align-items:center;gap:6px;padding:0 12px"><div class="farr">&#8595;</div>`;
                if(lk)h+=`<div style="font-size:8px;color:var(--t3);direction:ltr">${lk.tunnel||'WAN'} ${lk.src_ip?'('+lk.src_ip+')':''}</div>`;
                h+='</div>';
            }
        });h+='</div>';
    }
    // Neighbors
    const nb=LD.filter(l=>l.source===n.id||l.target===n.id);
    if(nb.length){
        h+=`<div class="sc"><div class="st">&#128279; اتصالات (${nb.length})</div>`;
        nb.slice(0,20).forEach(l=>{
            const peer=l.source===n.id?l.target:l.source;
            const pn=ND.find(x=>x.id===peer);
            const pc=pn?nc(pn):'#64748b';
            h+=`<div class="sr" style="cursor:pointer;padding:3px;border-radius:3px" onclick="handleDbl('${peer}')"><div style="width:7px;height:7px;border-radius:50%;background:${pc};flex-shrink:0"></div><span class="sv" style="min-width:110px">${pn?pn.label:peer}</span><span style="font-size:8px;color:var(--t3);direction:ltr">${l.tunnel||'WAN'}</span></div>`;
        });
        if(nb.length>20)h+=`<div style="text-align:center;font-size:8px;color:var(--t3)">+${nb.length-20} more</div>`;
        h+='</div>';
    }
    document.getElementById('t-fl').innerHTML=h;
}

function bfs(start){
    const cores=new Set(ND.filter(n=>n.category==='core-router').map(n=>n.id));
    if(cores.has(start))return[];
    const adj={};
    LD.forEach(l=>{if(!adj[l.source])adj[l.source]=[];if(!adj[l.target])adj[l.target]=[];adj[l.source].push({p:l.target,l:l});adj[l.target].push({p:l.source,l:l});});
    const vis=new Set([start]),q=[{n:start,path:[{node:start,via:'',tunnel:'',link:null}]}];
    while(q.length){
        const{n:cur,path}=q.shift();
        for(const{p,l}of(adj[cur]||[])){
            if(vis.has(p))continue;vis.add(p);
            const np=[...path,{node:p,via:l.src_ip||'',tunnel:l.tunnel||'',link:l}];
            if(cores.has(p))return np;
            q.push({n:p,path:np});
        }
    }
    return null;
}

// Filters
function setF(f,el){filter=f;document.querySelectorAll('.ft').forEach(b=>b.classList.remove('on'));el.classList.add('on');draw();}
function doSearch(v){search=v;draw();}
function toggle3D(){is3d=!is3d;mapWrap.className=is3d?'tilt-subtle':'tilt-off';document.getElementById('btn3d').classList.toggle('on',is3d);}

// Pan & zoom
let pan=false,ps={x:0,y:0};
mapWrap.addEventListener('mousedown',e=>{if(e.target.closest('[data-n]'))return;pan=true;ps={x:e.clientX,y:e.clientY};mapWrap.classList.add('grabbing');});
window.addEventListener('mousemove',e=>{if(!pan)return;const dx=(e.clientX-ps.x)*vb.w/mapWrap.clientWidth,dy=(e.clientY-ps.y)*vb.h/mapWrap.clientHeight;vb.x-=dx;vb.y-=dy;ps={x:e.clientX,y:e.clientY};svg.setAttribute('viewBox',`${vb.x} ${vb.y} ${vb.w} ${vb.h}`);});
window.addEventListener('mouseup',()=>{pan=false;mapWrap.classList.remove('grabbing');});
mapWrap.addEventListener('wheel',e=>{e.preventDefault();const s=e.deltaY>0?1.08:.92,mx=(e.clientX/mapWrap.clientWidth)*vb.w+vb.x,my=(e.clientY/mapWrap.clientHeight)*vb.h+vb.y;vb.w*=s;vb.h*=s;vb.x=mx-(e.clientX/mapWrap.clientWidth)*vb.w;vb.y=my-(e.clientY/mapWrap.clientHeight)*vb.h;svg.setAttribute('viewBox',`${vb.x} ${vb.y} ${vb.w} ${vb.h}`);});
mapWrap.addEventListener('click',e=>{if(!e.target.closest('[data-n]')&&sel){sel=null;closeP();resetView();draw();}});

function resetAll(){vb={x:-50,y:-30,w:1100,h:920};svg.setAttribute('viewBox',`${vb.x} ${vb.y} ${vb.w} ${vb.h}`);sel=null;closeP();filter='all';search='';document.getElementById('searchBox').value='';document.querySelectorAll('.ft').forEach(b=>b.classList.remove('on'));document.querySelector('.ft[data-f="all"]').classList.add('on');draw();}

load();
</script>
</body>
</html>
