<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±Ø²Ø±Ùˆ IP LAN</title>
    <style>
/* ========== THEME SYSTEM ========== */
:root {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-card: rgba(30, 41, 59, 0.8);
    --bg-header: rgba(30, 41, 59, 0.9);
    --text-primary: #e2e8f0;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --border-color: rgba(255, 255, 255, 0.1);
    --shadow-color: rgba(0, 0, 0, 0.3);
    --input-bg: rgba(15, 23, 42, 0.8);
    --input-border: rgba(255, 255, 255, 0.2);
    --card-hover: rgba(255, 255, 255, 0.05);
}


[data-theme="light"] {
    --bg-primary: #f8fafc;
    --bg-secondary: #f1f5f9;
    --bg-card: #ffffff;
    --bg-header: #ffffff;
    --text-primary: #0f172a;
    --text-secondary: #334155;
    --text-muted: #475569;
    --border-color: rgba(0, 0, 0, 0.15);
    --shadow-color: rgba(0, 0, 0, 0.1);
    --input-bg: #ffffff;
    --input-border: rgba(0, 0, 0, 0.2);
    --card-hover: rgba(0, 0, 0, 0.05);
}

body { transition: background 0.3s ease, color 0.3s ease; }

[data-theme="light"] body {
    background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%) !important;
    color: var(--text-primary) !important;
}

[data-theme="light"] .header, [data-theme="light"] header,
[data-theme="light"] .top-bar, [data-theme="light"] .navbar {
    background: var(--bg-header) !important;
    border-color: var(--border-color) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
}

[data-theme="light"] .card, [data-theme="light"] .form-section,
[data-theme="light"] .config-section, [data-theme="light"] .result-section,
[data-theme="light"] .section, [data-theme="light"] .panel,
[data-theme="light"] .main-card, [data-theme="light"] .box {
    background: var(--bg-card) !important;
    border-color: var(--border-color) !important;
    color: var(--text-primary) !important;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06) !important;
}

[data-theme="light"] input, [data-theme="light"] select, [data-theme="light"] textarea {
    background: var(--input-bg) !important;
    border: 1px solid var(--input-border) !important;
    color: #0f172a !important;
}

[data-theme="light"] input::placeholder { color: #64748b !important; }
[data-theme="light"] select option { background: #fff; color: #0f172a; }

[data-theme="light"] label, [data-theme="light"] .form-label,
[data-theme="light"] h1, [data-theme="light"] h2, [data-theme="light"] h3, [data-theme="light"] h4,
[data-theme="light"] .section-title, [data-theme="light"] .title,
[data-theme="light"] .app-title h1, [data-theme="light"] .app-title p {
    color: #0f172a !important;
}

[data-theme="light"] p, [data-theme="light"] span:not(.badge):not(.tag), 
[data-theme="light"] div:not(.btn):not(.badge) {
    color: inherit;
}

[data-theme="light"] .hint, [data-theme="light"] .info-text, [data-theme="light"] small,
[data-theme="light"] .description, [data-theme="light"] .help-text,
[data-theme="light"] .form-hint, [data-theme="light"] .note {
    color: #334155 !important;
}

[data-theme="light"] .user-display, [data-theme="light"] .user-info,
[data-theme="light"] .user-name, [data-theme="light"] #currentUser {
    color: #0f172a !important;
}

[data-theme="light"] .badge, [data-theme="light"] .tag, [data-theme="light"] .count {
    color: #fff !important;
}

[data-theme="light"] a:not(.btn):not(button):not(.back-btn):not(.logout-link) {
    color: #2563eb !important;
}

[data-theme="light"] .back-btn, [data-theme="light"] .logout-link {
    color: #dc2626 !important;
}

[data-theme="light"] pre, [data-theme="light"] code, [data-theme="light"] .config-output,
[data-theme="light"] .output-box, [data-theme="light"] .code-block {
    background: #1e293b !important;
    color: #e2e8f0 !important;
}

[data-theme="light"] table { border-color: var(--border-color) !important; }
[data-theme="light"] th, [data-theme="light"] td { 
    border-color: var(--border-color) !important;
    color: #0f172a !important;
}
[data-theme="light"] th { background: #f1f5f9 !important; color: #0f172a !important; }
[data-theme="light"] tr:hover { background: #f8fafc !important; }

[data-theme="light"] .success, [data-theme="light"] .alert-success,
[data-theme="light"] .success-box, [data-theme="light"] .ip-reserved {
    background: #dcfce7 !important;
    color: #166534 !important;
    border-color: #86efac !important;
}

[data-theme="light"] .error, [data-theme="light"] .alert-error,
[data-theme="light"] .error-box {
    background: #fee2e2 !important;
    color: #991b1b !important;
    border-color: #fca5a5 !important;
}

[data-theme="light"] .warning, [data-theme="light"] .alert-warning {
    background: #fef3c7 !important;
    color: #92400e !important;
    border-color: #fcd34d !important;
}

[data-theme="light"] .info-box, [data-theme="light"] .notice,
[data-theme="light"] .auto-ip-info {
    background: #eff6ff !important;
    color: #1e40af !important;
    border-color: #93c5fd !important;
}

[data-theme="light"] .btn-primary, [data-theme="light"] button[type="submit"] {
    background: #2563eb !important;
    color: #fff !important;
}

[data-theme="light"] .btn-secondary {
    background: #64748b !important;
    color: #fff !important;
}

[data-theme="light"] .free-count { color: #059669 !important; font-weight: bold; }
[data-theme="light"] .used-count { color: #dc2626 !important; font-weight: bold; }

/* Router boxes for intranet */
[data-theme="light"] .router-box, [data-theme="light"] .device-box {
    background: #fff !important;
    border: 1px solid #e2e8f0 !important;
    color: #0f172a !important;
}

[data-theme="light"] .router-header, [data-theme="light"] .device-box-header {
    color: #0f172a !important;
}

/* Stats cards */
[data-theme="light"] .stat-card {
    background: #fff !important;
    border: 1px solid #e2e8f0 !important;
}

[data-theme="light"] .stat-card .value {
    color: #2563eb !important;
}

[data-theme="light"] .stat-card .label {
    color: #475569 !important;
}

.theme-toggle {
    background: var(--bg-card, rgba(30,41,59,0.8));
    border: 1px solid var(--border-color, rgba(255,255,255,0.1));
    border-radius: 50%;
    width: 36px;
    height: 36px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    margin-left: 10px;
}
.theme-toggle:hover { transform: scale(1.1); }
/* ========== END THEME ========== */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazir', Tahoma, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            font-size: 16px;
            color: #333;
        }

        .back-btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background: #5568d3;
        }

        .main-card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1, h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .help-text {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        .required {
            color: #e74c3c;
        }

        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #28a745;
            color: white;
        }

        .btn-primary:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-reserved {
            background: #fff3cd;
            color: #856404;
        }

        .status-used {
            background: #d4edda;
            color: #155724;
        }

        .btn-release {
            background: #dc3545;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-release:hover {
            background: #c82333;
        }

        .ip-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }

        .ip-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .ip-item:hover {
            background: #e7f3ff;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .ip-item.selected {
            background: #667eea;
            color: white;
            border-color: #5568d3;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #888;
        }

        /* Email Card Modal Styles */
        .email-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .email-modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .email-modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 700px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .email-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .email-modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
        }

        .close-modal-btn {
            background: #ef4444;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal-btn:hover {
            background: #dc2626;
        }

        /* Email Card Table - Professional Style */
        .email-card-table {
            width: 100%;
            border-collapse: collapse;
            direction: rtl;
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            margin-bottom: 20px;
            border: 2px solid #2563eb;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
        }

        .email-card-table thead {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .email-card-table th {
            color: white;
            padding: 16px 14px;
            font-weight: 700;
            font-size: 14px;
            text-align: center;
            border-left: 1px solid rgba(255,255,255,0.2);
            letter-spacing: 0.5px;
        }

        .email-card-table th:last-child {
            border-left: none;
        }

        .email-card-table td {
            padding: 16px 14px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 1px solid #e5e7eb;
            border-left: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #1e293b;
        }

        .email-card-table td:last-child {
            border-left: none;
        }

        .email-card-table tr:last-child td {
            border-bottom: none;
        }

        .email-card-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .copy-card-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .copy-card-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .copy-success {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4) !important;
        }

        .new-reserve-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
        }

        .new-reserve-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        }

        .email-instructions {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #92400e;
        }

        .email-instructions strong {
            color: #b45309;
        }
    


    
/* ========== BETTER FONTS ========== */
body {
    font-size: 16px !important;
    line-height: 1.6 !important;
}

h1 { font-size: 1.8rem !important; font-weight: 700 !important; }
h2 { font-size: 1.4rem !important; font-weight: 700 !important; }
h3 { font-size: 1.2rem !important; font-weight: 600 !important; }
h4 { font-size: 1.1rem !important; font-weight: 600 !important; }

label, .form-label {
    font-size: 15px !important;
    font-weight: 600 !important;
    color: var(--text-primary, inherit) !important;
}

input, select, textarea {
    font-size: 15px !important;
    padding: 12px 14px !important;
}

.section-title, .title {
    font-size: 1.15rem !important;
    font-weight: 700 !important;
}

.hint, .info-text, .help-text, .form-hint, small, .note, .description {
    font-size: 14px !important;
    font-weight: 500 !important;
}

.btn, button:not(.theme-toggle) {
    font-size: 15px !important;
    font-weight: 600 !important;
}

table { font-size: 15px !important; }
th { font-weight: 700 !important; }
th, td { padding: 12px 14px !important; }

.info-box, .notice, .alert, .success-box, .error-box, .auto-ip-info, .ip-reserved {
    font-size: 15px !important;
    font-weight: 500 !important;
    padding: 14px 18px !important;
}

.badge, .tag, .count {
    font-size: 13px !important;
    font-weight: 600 !important;
    padding: 5px 12px !important;
}

.user-display, .user-info, .user-name {
    font-size: 15px !important;
    font-weight: 600 !important;
}

pre, code, .config-output, .output-box {
    font-size: 14px !important;
    line-height: 1.5 !important;
}

.app-title h1 { font-size: 1.8rem !important; font-weight: 700 !important; }
.app-title p { font-size: 15px !important; font-weight: 500 !important; }

/* Light theme text improvements */
[data-theme="light"] label, 
[data-theme="light"] .form-label,
[data-theme="light"] .section-title, 
[data-theme="light"] .title,
[data-theme="light"] h1, 
[data-theme="light"] h2, 
[data-theme="light"] h3 {
    color: #0f172a !important;
}

[data-theme="light"] .hint, 
[data-theme="light"] small,
[data-theme="light"] .info-text, 
[data-theme="light"] .description,
[data-theme="light"] .help-text {
    color: #334155 !important;
}

[data-theme="light"] input,
[data-theme="light"] select,
[data-theme="light"] textarea {
    color: #0f172a !important;
    background: #fff !important;
    border: 1px solid rgba(0,0,0,0.2) !important;
}

[data-theme="light"] input::placeholder {
    color: #64748b !important;
}
/* ========== END BETTER FONTS ========== */

    </style>

<script>
// Theme System - runs immediately
(function() {
    var theme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', theme);
})();

function toggleTheme() {
    var current = document.documentElement.getAttribute('data-theme') || 'dark';
    var next = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    var icon = document.getElementById('themeIcon');
    if (icon) icon.textContent = next === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
}

document.addEventListener('DOMContentLoaded', function() {
    var icon = document.getElementById('themeIcon');
    if (icon) {
        var theme = localStorage.getItem('theme') || 'dark';
        icon.textContent = theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
    }
});
</script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info">
                ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ø§Ù„: <strong id="currentUser">...</strong>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <button class="theme-toggle" onclick="toggleTheme()" title="ØªØºÛŒÛŒØ± ØªÙ…"><span id="themeIcon">ğŸŒ™</span></button>
                <a href="/" class="back-btn">â† Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ</a>
                <a href="/login" class="logout-link" onclick="localStorage.clear(); sessionStorage.clear();" style="background:#ef4444; color:white; padding:6px 14px; border-radius:8px; text-decoration:none; font-size:13px; font-weight:600;">Ø®Ø±ÙˆØ¬</a>
            </div>
        </div>

        <div class="main-card">
            <h1>ğŸ”– Ø±Ø²Ø±Ùˆ IP LAN</h1>
            <p style="color: #666; margin-bottom: 20px;">Ø±Ø²Ø±Ùˆ IP Ø¨Ø±Ø§ÛŒ Ù†Ù‚Ø§Ø· Ø¬Ø¯ÛŒØ¯ (Ù‚Ø¨Ù„ Ø§Ø² Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ)</p>

            <h2>ÙØ±Ù… Ø±Ø²Ø±Ùˆ IP</h2>
            <form id="reserveForm">
                <div class="form-group">
                    <label for="provinceSelect">Ø§Ø³ØªØ§Ù† <span class="required">*</span></label>
                    <select id="provinceSelect" required>
                        <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>
                    </select>
                    <div class="help-text">ğŸ“ Ø§Ø³ØªØ§Ù† Ù…Ø­Ù„ Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ù†Ù‚Ø·Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
                </div>

                <div class="form-group">
                    <label>IP LAN Ø¢Ø²Ø§Ø¯ <span class="required">*</span></label>
                    <div class="help-text" style="margin-bottom: 10px;">ğŸŒ IP LAN Ø¢Ø²Ø§Ø¯ Ø§Ø² Ø§Ø³ØªØ§Ù† Ø§Ù†ØªØ®Ø§Ø¨ÛŒ - Ø±ÙˆÛŒ IP Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</div>
                    <div id="freeIpsList" class="ip-list" style="display: none;"></div>
                    <input type="hidden" id="lanIpSelect" required>
                </div>

                <div class="form-group">
                    <label for="pointName">Ù†Ø§Ù… Ù†Ù‚Ø·Ù‡ (ÙØ§Ø±Ø³ÛŒ) <span class="required">*</span></label>
                    <input type="text" id="pointName" required placeholder="Ù…Ø«Ø§Ù„: Ø´Ø¹Ø¨Ù‡ Ù…Ø±Ú©Ø²ÛŒ ØªÙ‡Ø±Ø§Ù†">
                    <div class="help-text">ğŸ“ Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ù†Ù‚Ø·Ù‡ ÛŒØ§ Ù…Ø­Ù„ Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø±Ø§ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
                </div>

                <div class="form-group">
                    <label for="requestNumber">Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª <span class="required">*</span></label>
                    <input type="text" id="requestNumber" required placeholder="Ù…Ø«Ø§Ù„: 12345-6789-000">
                    <div class="help-text">ğŸ”¢ Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÛŒØ§ ØªÛŒÚ©Øª</div>
                </div>

                <div class="form-group">
                    <label for="mehrgestarCode">Ú©Ø¯ Ù…Ù‡Ø±Ú¯Ø³ØªØ±</label>
                    <input type="text" id="mehrgestarCode" placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ">
                    <div class="help-text">ğŸ·ï¸ Ú©Ø¯ Ù…Ù‡Ø±Ú¯Ø³ØªØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</div>
                </div>

                <div class="form-group">
                    <label for="pointType">Ù†ÙˆØ¹ Ù†Ù‚Ø·Ù‡ <span class="required">*</span></label>
                    <select id="pointType" required>
                        <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>
                        <option value="KIOSK">Ú©ÛŒÙˆØ³Ú© (Kiosk)</option>
                        <option value="ATM">Ø®ÙˆØ¯Ù¾Ø±Ø¯Ø§Ø² (ATM)</option>
                        <option value="BRANCH">Ø´Ø¹Ø¨Ù‡ (Branch)</option>
                        <option value="COUNTER">Ø¨Ø§Ø¬Ù‡ (Counter)</option>
                        <option value="MOCK">ØªØ³Øª (MOCK)</option>
                    </select>
                    <div class="help-text">ğŸ¦ Ù†ÙˆØ¹ Ø¯Ø³ØªÚ¯Ø§Ù‡ ÛŒØ§ Ù†Ù‚Ø·Ù‡</div>
                </div>

                <div class="info-box">
                    <strong>â± ØªÙˆØ¬Ù‡:</strong> Ø§ÛŒÙ† IP Ø¨Ù‡ Ù…Ø¯Øª <strong>60 Ø±ÙˆØ²</strong> Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø±Ø²Ø±Ùˆ Ù…ÛŒØ´ÙˆØ¯. 
                    Ø§Ú¯Ø± ØªØ§ 60 Ø±ÙˆØ² Ø§Ø² Ø¢Ù† Ø¯Ø± Ø³ÛŒØ³ØªÙ…Ù‡Ø§ÛŒ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ (IntranetØŒ APN Ù…Ø§Ù„ÛŒØŒ APN ØºÛŒØ±Ù…Ø§Ù„ÛŒ) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ú©Ù†ÛŒØ¯ØŒ 
                    Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¢Ø²Ø§Ø¯ Ù…ÛŒØ´ÙˆØ¯.
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">âœ… Ø±Ø²Ø±Ùˆ IP</button>
                    <button type="reset" class="btn btn-secondary">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
                </div>

                <div class="spinner" id="spinner">
                    <div>â³ Ø¯Ø± Ø­Ø§Ù„ Ø±Ø²Ø±Ùˆ...</div>
                </div>
            </form>
        </div>

        <div class="main-card">
            <h2>Ù„ÛŒØ³Øª IP Ù‡Ø§ÛŒ Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡</h2>
            <div id="loadingReservations" class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
            <div id="reservationsTable" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>IP LAN</th>
                            <th>Ø§Ø³ØªØ§Ù†</th>
                            <th>Ù†Ø§Ù… Ù†Ù‚Ø·Ù‡</th>
                            <th>Ù†ÙˆØ¹</th>
                            <th>Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</th>
                            <th>Ø±Ø²Ø±Ùˆ Ú©Ù†Ù†Ø¯Ù‡</th>
                            <th>ØªØ§Ø±ÛŒØ® Ø±Ø²Ø±Ùˆ</th>
                            <th>Ø§Ù†Ù‚Ø¶Ø§</th>
                            <th>ÙˆØ¶Ø¹ÛŒØª</th>
                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="reservationsBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- NEW: Active Branches Section (Used IPs that can be released) -->
        <div class="main-card" style="margin-top: 20px; border: 2px solid #f59e0b;">
            <h2 style="color: #f59e0b;">
                ğŸ¢ Ø´Ø¹Ø¨/Ù†Ù‚Ø§Ø· ÙØ¹Ø§Ù„ (IP Ù‡Ø§ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡)
                <span id="usedIpCount" style="font-size: 14px; background: #fef3c7; color: #92400e; padding: 4px 12px; border-radius: 20px; margin-right: 10px;">0</span>
            </h2>
            <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                âš ï¸ Ø§ÛŒÙ† Ù„ÛŒØ³Øª Ø´Ø§Ù…Ù„ IP Ù‡Ø§ÛŒÛŒ Ø§Ø³Øª Ú©Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ùˆ Ù†Ø§Ù… Ø´Ø¹Ø¨Ù‡ Ø¯Ø§Ø±Ù†Ø¯. 
                Ø¨Ø±Ø§ÛŒ Ø´Ø¹Ø¨ Ø­Ø°Ù Ø´Ø¯Ù‡ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ IP Ø±Ø§ Ø¢Ø²Ø§Ø¯ Ú©Ù†ÛŒØ¯.
            </p>
            
            <!-- Search/Filter -->
            <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="text" id="searchUsedIps" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ù†Ø§Ù… Ø´Ø¹Ø¨Ù‡ ÛŒØ§ IP..." 
                       style="flex: 1; min-width: 200px; padding: 10px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                <select id="filterUsedProvince" style="padding: 10px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    <option value="">Ù‡Ù…Ù‡ Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§</option>
                </select>
                <button onclick="loadUsedIPs()" style="padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    ğŸ”„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯
                </button>
            </div>
            
            <div id="loadingUsedIps" class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
            <div id="usedIpsTable" style="display: none; max-height: 500px; overflow-y: auto;">
                <table>
                    <thead style="position: sticky; top: 0; background: #1e293b;">
                        <tr>
                            <th>IP LAN</th>
                            <th>Ø§Ø³ØªØ§Ù†</th>
                            <th>Ù†Ø§Ù… Ø´Ø¹Ø¨Ù‡/Ù†Ù‚Ø·Ù‡</th>
                            <th>Loopback0</th>
                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="usedIpsBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // FIX: Get username from sessionStorage (set during login)
        // ============================================================================
        const username = localStorage.getItem('currentUser') || sessionStorage.getItem('username') || localStorage.getItem('username') || 'Unknown';
        document.getElementById('currentUser').textContent = username;

        // Check if user is logged in
        if (!localStorage.getItem('currentUser') && !sessionStorage.getItem('username') && !localStorage.getItem('username')) {
            // Redirect to login if no username found
            console.warn('No username found, redirecting to login...');
            // Uncomment to enable redirect: window.location.href = '/login';
        }

        let selectedProvince = '';
        let selectedIp = '';

        // ============================================================================
        // FEATURE 1: PING CHECK WHEN IP IS SELECTED
        // ============================================================================

        function selectIP(ip) {
            // Update hidden input
            document.getElementById('lanIpSelect').value = ip;
            selectedIp = ip;

            // Visual feedback - highlight selected IP
            document.querySelectorAll('.ip-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.classList.add('selected');

            // Automatically ping the .1 IP of this range
            pingLanIP(ip);
        }

        // NEW function to ping LAN IP
        async function pingLanIP(lanIp) {
            try {
                const response = await fetch('/api/ping-lan-ip', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ lan_ip: lanIp })
                });

                const result = await response.json();

                if (result.reachable) {
                    // Show warning alert if IP responds
                    showAlert('warning', 
                        `âš ï¸ Ù‡Ø´Ø¯Ø§Ø±: ${result.message}\n\n` +
                        `IP Ø§Ù†ØªØ®Ø§Ø¨ÛŒ: ${lanIp}\n` +
                        `IP Ù¾ÛŒÙ†Ú¯ Ø´Ø¯Ù‡: ${result.pinged_ip}\n\n` +
                        `Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§ÛŒÙ† Ø±Ù†Ø¬ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¨Ø§Ø´Ø¯. Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`,
                        8000
                    );
                } else {
                    // Show brief success message if IP doesn't respond (good sign)
                    console.log(`âœ… Ping check passed: ${result.pinged_ip} is not reachable`);
                    showAlert('success', `âœ… ${result.message}`, 3000);
                }
            } catch (error) {
                console.error('Ping check error:', error);
                // Don't block the user, just log the error
            }
        }

        // ============================================================================
        // FEATURE 2: CHECK DUPLICATE REQUEST NUMBER
        // ============================================================================

        // Add event listener for request number field
        document.addEventListener('DOMContentLoaded', function() {
            const requestNumberField = document.getElementById('requestNumber');

            if (requestNumberField) {
                // Add debounced check when user types
                let checkTimeout;
                requestNumberField.addEventListener('input', function() {
                    clearTimeout(checkTimeout);
                    const requestNumber = this.value.trim();

                    if (requestNumber.length > 0) {
                        checkTimeout = setTimeout(() => {
                            checkDuplicateRequestNumber(requestNumber);
                        }, 500); // Wait 500ms after user stops typing
                    } else {
                        // Clear warning styling if field is empty
                        requestNumberField.style.borderColor = '';
                        requestNumberField.style.backgroundColor = '';
                    }
                });
            }
        });

        // NEW function to check if request number is duplicate
        async function checkDuplicateRequestNumber(requestNumber) {
            try {
                const response = await fetch(`/api/check-request-number?request_number=${encodeURIComponent(requestNumber)}`);
                const result = await response.json();

                const requestNumberField = document.getElementById('requestNumber');

                if (result.duplicate) {
                    // Show warning but don't block submission
                    requestNumberField.style.borderColor = '#ff9800'; // Orange border
                    requestNumberField.style.backgroundColor = '#fff3e0'; // Light orange background

                    showAlert('warning', 
                        `âš ï¸ Ù‡Ø´Ø¯Ø§Ø±: Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªÚ©Ø±Ø§Ø±ÛŒ!\n\n` +
                        `Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª: ${result.request_number}\n` +
                        `Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ø±Ø§ÛŒ: ${result.point_name}\n` +
                        `IP: ${result.existing_ip}\n` +
                        `ØªÙˆØ³Ø·: ${result.reserved_by}\n` +
                        `ØªØ§Ø±ÛŒØ®: ${result.reserved_date}\n` +
                        `ÙˆØ¶Ø¹ÛŒØª: ${result.status}\n\n` +
                        `âš ï¸ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯ Ø§Ù…Ø§ Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.`,
                        10000
                    );
                } else {
                    // Clear warning styling
                    requestNumberField.style.borderColor = '';
                    requestNumberField.style.backgroundColor = '';
                }
            } catch (error) {
                console.error('Error checking request number:', error);
            }
        }

        // ============================================================================
        // HELPER FUNCTION: SHOW ALERTS
        // ============================================================================

        function showAlert(type, message, duration = 5000) {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 500px;
                font-family: 'Vazir', Tahoma, sans-serif;
                font-size: 14px;
                line-height: 1.6;
                animation: slideIn 0.3s ease-out;
                white-space: pre-line;
            `;

            // Set colors based on type
            if (type === 'warning') {
                alertDiv.style.backgroundColor = '#fff3cd';
                alertDiv.style.borderLeft = '4px solid #ff9800';
                alertDiv.style.color = '#856404';
            } else if (type === 'success') {
                alertDiv.style.backgroundColor = '#d4edda';
                alertDiv.style.borderLeft = '4px solid #28a745';
                alertDiv.style.color = '#155724';
            } else if (type === 'error') {
                alertDiv.style.backgroundColor = '#f8d7da';
                alertDiv.style.borderLeft = '4px solid #dc3545';
                alertDiv.style.color = '#721c24';
            }

            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);

            // Auto remove after duration
            setTimeout(() => {
                alertDiv.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => alertDiv.remove(), 300);
            }, duration);
        }

        // Add CSS animations
        if (!document.getElementById('custom-alert-animations')) {
            const style = document.createElement('style');
            style.id = 'custom-alert-animations';
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }

                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }

        // ============================================================================
        // EXISTING FUNCTIONS (Load provinces, Load free IPs, etc.)
        // ============================================================================

        // Load provinces on page load
        async function loadProvinces() {
            try {
                const response = await fetch('/api/provinces');
                const provinces = await response.json();

                const select = document.getElementById('provinceSelect');
                select.innerHTML = '<option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>';

                provinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province;
                    option.textContent = province;
                    select.appendChild(option);
                });

                console.log(`âœ“ Loaded ${provinces.length} provinces`);
            } catch (error) {
                console.error('Error loading provinces:', error);
                showAlert('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§');
            }
        }

        // Load free IPs when province is selected
        document.getElementById('provinceSelect').addEventListener('change', async function(e) {
            selectedProvince = e.target.value;
            const freeIpsList = document.getElementById('freeIpsList');
            selectedIp = ''; // Reset selected IP
            document.getElementById('lanIpSelect').value = '';

            if (!selectedProvince) {
                freeIpsList.style.display = 'none';
                return;
            }

            try {
                freeIpsList.innerHTML = '<div class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>';
                freeIpsList.style.display = 'block';

                const response = await fetch(`/api/free-lan-ips?province=${selectedProvince}`);
                const ips = await response.json();

                if (ips.length === 0) {
                    freeIpsList.innerHTML = '<div style="text-align: center; color: #999;">IP Ø¢Ø²Ø§Ø¯ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
                    return;
                }

                freeIpsList.innerHTML = '';

                ips.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'ip-item';
                    div.textContent = item.ip;
                    div.onclick = (e) => selectIP(item.ip);
                    freeIpsList.appendChild(div);
                });

                console.log(`âœ“ Loaded ${ips.length} free IPs for ${selectedProvince}`);
            } catch (error) {
                console.error('Error loading free IPs:', error);
                freeIpsList.innerHTML = '<div style="text-align: center; color: #e74c3c;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</div>';
                showAlert('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ IP Ù‡Ø§ÛŒ Ø¢Ø²Ø§Ø¯');
            }
        });

        // Handle form submission
        document.getElementById('reserveForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const lanIp = document.getElementById('lanIpSelect').value;
            const pointName = document.getElementById('pointName').value;
            const requestNumber = document.getElementById('requestNumber').value;
            const mehrgestarCode = document.getElementById('mehrgestarCode').value;
            const pointType = document.getElementById('pointType').value;

            if (!lanIp || !pointName || !requestNumber || !pointType || !selectedProvince) {
                showAlert('error', 'âŒ Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
                return;
            }

            const spinner = document.getElementById('spinner');
            const submitBtn = document.querySelector('.btn-primary');

            spinner.style.display = 'block';
            submitBtn.disabled = true;

            try {
                const response = await fetch('/api/reserve-lan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lan_ip: lanIp,
                        province: selectedProvince,
                        point_name_persian: pointName,
                        request_number: requestNumber,
                        mehrgestar_code: mehrgestarCode,
                        point_type: pointType,
                        reserved_by: username
                    })
                });

                const result = await response.json();

                if (result.status === 'ok') {
                    showAlert('success', `âœ… ${result.message}`);
                    
                    // Show email card modal with reservation data
                    showEmailCardModal({
                        province: selectedProvince,
                        point_name: pointName,
                        lan_ip: lanIp,
                        request_number: requestNumber
                    });
                    
                    document.getElementById('reserveForm').reset();
                    document.getElementById('freeIpsList').style.display = 'none';
                    selectedIp = '';
                    loadReservations();
                } else {
                    showAlert('error', `âŒ ${result.message}`);
                }
            } catch (error) {
                console.error('Error reserving IP:', error);
                showAlert('error', 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø±Ø²Ø±Ùˆ IP');
            } finally {
                spinner.style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        // Load reservations table
        async function loadReservations() {
            try {
                const response = await fetch('/api/reserved-ips');
                const reservations = await response.json();

                const loadingDiv = document.getElementById('loadingReservations');
                const tableDiv = document.getElementById('reservationsTable');
                const tbody = document.getElementById('reservationsBody');

                loadingDiv.style.display = 'none';
                tableDiv.style.display = 'block';

                if (reservations.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #999;">Ù‡ÛŒÚ† Ø±Ø²Ø±ÙˆÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                reservations.forEach(res => {
                    const tr = document.createElement('tr');

                    const statusClass = res.status === 'RESERVED' ? 'status-reserved' : 'status-used';
                    const statusText = res.status === 'RESERVED' ? 'Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡' : 'Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡';

                    const releaseBtn = res.status === 'RESERVED' 
                        ? `<button class="btn-release" onclick="releaseIP('${res.lan_ip}')">Ø¢Ø²Ø§Ø¯Ø³Ø§Ø²ÛŒ</button>`
                        : '-';

                    tr.innerHTML = `
                        <td><strong>${res.lan_ip}</strong></td>
                        <td>${res.province}</td>
                        <td>${res.point_name_persian}</td>
                        <td>${res.point_type}</td>
                        <td>${res.request_number}</td>
                        <td>${res.reserved_by}</td>
                        <td>${formatDateTime(res.reserved_date)}</td>
                        <td>${formatDateTime(res.expiry_date)}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${releaseBtn}</td>
                    `;

                    tbody.appendChild(tr);
                });

                console.log(`âœ“ Loaded ${reservations.length} reservations`);
            } catch (error) {
                console.error('Error loading reservations:', error);
                showAlert('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ø±Ø²Ø±ÙˆÙ‡Ø§');
            }
        }

        // Release IP function
        async function releaseIP(lanIp) {
            if (!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ IP ${lanIp} Ø±Ø§ Ø¢Ø²Ø§Ø¯ Ú©Ù†ÛŒØ¯ØŸ`)) {
                return;
            }

            try {
                const response = await fetch('/api/release-lan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lan_ip: lanIp,
                        username: username
                    })
                });

                const result = await response.json();

                if (result.status === 'ok') {
                    showAlert('success', `âœ… ${result.message}`);
                    loadReservations();
                } else {
                    showAlert('error', `âŒ ${result.message}`);
                }
            } catch (error) {
                console.error('Error releasing IP:', error);
                showAlert('error', 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¢Ø²Ø§Ø¯Ø³Ø§Ø²ÛŒ IP');
            }
        }

        // Format datetime helper
        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('fa-IR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Initialize on page load
        loadProvinces();
        loadReservations();
        loadUsedIPs();

        // ============================================================================
        // FEATURE: LOAD AND RELEASE USED IPs (Active Branches)
        // ============================================================================
        
        let allUsedIPs = []; // Store all used IPs for filtering
        
        async function loadUsedIPs() {
            try {
                const response = await fetch('/api/used-lan-ips');
                const usedIPs = await response.json();
                
                allUsedIPs = usedIPs; // Store for filtering
                
                const loadingDiv = document.getElementById('loadingUsedIps');
                const tableDiv = document.getElementById('usedIpsTable');
                const countSpan = document.getElementById('usedIpCount');
                
                loadingDiv.style.display = 'none';
                tableDiv.style.display = 'block';
                countSpan.textContent = usedIPs.length;
                
                // Populate province filter
                populateUsedProvinceFilter(usedIPs);
                
                // Display the data
                displayUsedIPs(usedIPs);
                
                console.log(`âœ“ Loaded ${usedIPs.length} used IPs`);
            } catch (error) {
                console.error('Error loading used IPs:', error);
                showAlert('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ø´Ø¹Ø¨ ÙØ¹Ø§Ù„');
            }
        }
        
        function populateUsedProvinceFilter(usedIPs) {
            const filterSelect = document.getElementById('filterUsedProvince');
            const provinces = [...new Set(usedIPs.map(ip => ip.province))].sort();
            
            filterSelect.innerHTML = '<option value="">Ù‡Ù…Ù‡ Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§</option>';
            provinces.forEach(prov => {
                const option = document.createElement('option');
                option.value = prov;
                option.textContent = prov;
                filterSelect.appendChild(option);
            });
        }
        
        function displayUsedIPs(usedIPs) {
            const tbody = document.getElementById('usedIpsBody');
            
            if (usedIPs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">Ù‡ÛŒÚ† Ø´Ø¹Ø¨Ù‡/Ù†Ù‚Ø·Ù‡ ÙØ¹Ø§Ù„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            usedIPs.forEach(ip => {
                const tr = document.createElement('tr');
                const lanIp = `10.${ip.octet2}.${ip.octet3}.0`;
                const loopback = `10.${ip.octet2}.254.${ip.octet3}`;
                
                tr.innerHTML = `
                    <td><strong>${lanIp}</strong></td>
                    <td>${ip.province}</td>
                    <td>${ip.branch_name || '-'}</td>
                    <td style="color: #06b6d4;">${loopback}</td>
                    <td>
                        <button class="btn-release" onclick="releaseUsedIP('${lanIp}', '${ip.province}', '${ip.branch_name || ''}')" 
                                style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                            ğŸ—‘ï¸ Ø¢Ø²Ø§Ø¯Ø³Ø§Ø²ÛŒ
                        </button>
                        <button class="btn-release" onclick="pingLoopback('${loopback}')" 
                                style="background: linear-gradient(135deg, #06b6d4, #0891b2); margin-right: 5px;">
                            ğŸ“ Ping
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Filter used IPs based on search and province
        document.getElementById('searchUsedIps').addEventListener('input', filterUsedIPs);
        document.getElementById('filterUsedProvince').addEventListener('change', filterUsedIPs);
        
        function filterUsedIPs() {
            const searchTerm = document.getElementById('searchUsedIps').value.toLowerCase();
            const provinceFilter = document.getElementById('filterUsedProvince').value;
            
            let filtered = allUsedIPs;
            
            if (provinceFilter) {
                filtered = filtered.filter(ip => ip.province === provinceFilter);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(ip => {
                    const lanIp = `10.${ip.octet2}.${ip.octet3}.0`;
                    const branchName = (ip.branch_name || '').toLowerCase();
                    return lanIp.includes(searchTerm) || branchName.includes(searchTerm);
                });
            }
            
            document.getElementById('usedIpCount').textContent = filtered.length;
            displayUsedIPs(filtered);
        }
        
        // Ping Loopback0 function
        async function pingLoopback(loopbackIp) {
            try {
                showAlert('info', `ğŸ“ Ø¯Ø± Ø­Ø§Ù„ Ù¾ÛŒÙ†Ú¯ ${loopbackIp}...`, 2000);
                
                const response = await fetch('/api/ping-loopback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ loopback_ip: loopbackIp })
                });
                
                const result = await response.json();
                
                if (result.reachable) {
                    showAlert('success', `âœ… ${loopbackIp} Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ - Ø´Ø¹Ø¨Ù‡ ÙØ¹Ø§Ù„ Ø§Ø³Øª`, 5000);
                } else {
                    showAlert('warning', `âš ï¸ ${loopbackIp} Ù¾Ø§Ø³Ø® Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ - Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ø´Ø¹Ø¨Ù‡ Ø­Ø°Ù Ø´Ø¯Ù‡`, 5000);
                }
            } catch (error) {
                console.error('Ping error:', error);
                showAlert('error', 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾ÛŒÙ†Ú¯');
            }
        }
        
        // Release used IP function
        async function releaseUsedIP(lanIp, province, branchName) {
            const confirmMsg = `Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ IP Ø²ÛŒØ± Ø±Ø§ Ø¢Ø²Ø§Ø¯ Ú©Ù†ÛŒØ¯ØŸ\n\nIP: ${lanIp}\nØ§Ø³ØªØ§Ù†: ${province}\nØ´Ø¹Ø¨Ù‡: ${branchName}\n\nâš ï¸ Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª!`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            try {
                const response = await fetch('/api/release-used-lan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lan_ip: lanIp,
                        username: username
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'ok') {
                    showAlert('success', `âœ… ${result.message}`);
                    loadUsedIPs(); // Reload the list
                    loadProvinces(); // Reload free IPs count
                } else {
                    showAlert('error', `âŒ ${result.message}`);
                }
            } catch (error) {
                console.error('Error releasing used IP:', error);
                showAlert('error', 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¢Ø²Ø§Ø¯Ø³Ø§Ø²ÛŒ IP');
            }
        }

        // ============================================================================
        // EMAIL CARD MODAL FUNCTIONS
        // ============================================================================

        // Show email card modal after successful reservation
        function showEmailCardModal(data) {
            // Convert dates to Persian calendar format
            const creationDate = formatPersianDate(new Date());
            const expiryDate = formatPersianDate(new Date(Date.now() + 60 * 24 * 60 * 60 * 1000)); // +60 days

            // Build the table HTML
            const tableHtml = `
                <table class="email-card-table" id="emailCardTable">
                    <thead>
                        <tr>
                            <th>Ø±Ø¯ÛŒÙ</th>
                            <th>Ù…Ø¯ÛŒØ±ÛŒØª</th>
                            <th>Ù…Ø­Ù„ Ø§Ø³ØªÙ‚Ø±Ø§Ø±</th>
                            <th>IP</th>
                            <th>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯</th>
                            <th>ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>${data.province}</td>
                            <td>${data.point_name}</td>
                            <td style="direction:ltr; font-family:monospace; font-weight:bold;">${data.lan_ip}/24</td>
                            <td>${creationDate}</td>
                            <td>${expiryDate}</td>
                        </tr>
                    </tbody>
                </table>
            `;

            // Create modal if not exists
            let modal = document.getElementById('emailCardModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'emailCardModal';
                modal.className = 'email-modal';
                modal.innerHTML = `
                    <div class="email-modal-content">
                        <div class="email-modal-header">
                            <span class="email-modal-title">ğŸ“§ Ú©Ø§Ø±Øª Ø±Ø²Ø±Ùˆ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ…ÛŒÙ„</span>
                            <button class="close-modal-btn" onclick="closeEmailCardModal()">Ã—</button>
                        </div>
                        <div class="email-instructions">
                            <strong>ğŸ“Œ Ø±Ø§Ù‡Ù†Ù…Ø§:</strong> Ø¬Ø¯ÙˆÙ„ Ø²ÛŒØ± Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯Ø± Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Paste Ú©Ù†ÛŒØ¯. Ø§ÛŒÙ† Ø¬Ø¯ÙˆÙ„ Ø­Ø§ÙˆÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø²Ø±Ùˆ IP Ø§Ø³Øª.
                        </div>
                        <div id="emailCardContent"></div>
                        <div class="email-card-actions">
                            <button class="copy-card-btn" onclick="copyEmailCard()">
                                ğŸ“‹ Ú©Ù¾ÛŒ Ø¬Ø¯ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ…ÛŒÙ„
                            </button>
                            <button class="new-reserve-btn" onclick="closeEmailCardModal()">
                                âœ… Ø¨Ø³ØªÙ† Ùˆ Ø±Ø²Ø±Ùˆ Ø¬Ø¯ÛŒØ¯
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Update content and show modal
            document.getElementById('emailCardContent').innerHTML = tableHtml;
            modal.classList.add('active');
        }

        // Close email card modal
        function closeEmailCardModal() {
            const modal = document.getElementById('emailCardModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // Copy email card to clipboard
        async function copyEmailCard() {
            const table = document.getElementById('emailCardTable');
            const copyBtn = document.querySelector('.copy-card-btn');
            
            if (!table) {
                showAlert('error', 'âŒ Ø¬Ø¯ÙˆÙ„ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯');
                return;
            }
            
            // Build tab-separated text for copying
            const rows = table.querySelectorAll('tr');
            let textContent = '';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                const rowText = Array.from(cells).map(cell => cell.textContent.trim()).join('\t');
                textContent += rowText + '\n';
            });
            
            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(textContent);
                    
                    // Show success
                    copyBtn.innerHTML = 'âœ… Ú©Ù¾ÛŒ Ø´Ø¯! Ø¯Ø± Ø§ÛŒÙ…ÛŒÙ„ Paste Ú©Ù†ÛŒØ¯';
                    copyBtn.classList.add('copy-success');
                    
                    setTimeout(() => {
                        copyBtn.innerHTML = 'ğŸ“‹ Ú©Ù¾ÛŒ Ø¬Ø¯ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ…ÛŒÙ„';
                        copyBtn.classList.remove('copy-success');
                    }, 3000);
                    return;
                } catch (err) {
                    console.error('Clipboard API failed:', err);
                }
            }
            
            // Fallback: Use execCommand
            try {
                const textArea = document.createElement('textarea');
                textArea.value = textContent;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                textArea.style.top = '0';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    copyBtn.innerHTML = 'âœ… Ú©Ù¾ÛŒ Ø´Ø¯! Ø¯Ø± Ø§ÛŒÙ…ÛŒÙ„ Paste Ú©Ù†ÛŒØ¯';
                    copyBtn.classList.add('copy-success');
                    
                    setTimeout(() => {
                        copyBtn.innerHTML = 'ğŸ“‹ Ú©Ù¾ÛŒ Ø¬Ø¯ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ…ÛŒÙ„';
                        copyBtn.classList.remove('copy-success');
                    }, 3000);
                } else {
                    showAlert('error', 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†');
                }
            } catch (fallbackErr) {
                console.error('Fallback copy failed:', fallbackErr);
                showAlert('error', 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†. Ù„Ø·ÙØ§Ù‹ Ø¬Ø¯ÙˆÙ„ Ø±Ø§ Ø¯Ø³ØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯.');
            }
        }

        // Format date to Persian calendar (approximate)
        function formatPersianDate(date) {
            try {
                return new Intl.DateTimeFormat('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).format(date);
            } catch (e) {
                // Fallback format
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}/${m}/${d}`;
            }
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEmailCardModal();
            }
        });

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('emailCardModal');
            if (modal && e.target === modal) {
                closeEmailCardModal();
            }
        });
    </script>
</body>
</html>
