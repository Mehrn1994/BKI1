<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-container {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        .logo { text-align: center; margin-bottom: 30px; }
        .logo .icon { font-size: 4rem; }
        .logo h1 { font-size: 1.8rem; color: #1e293b; margin-top: 10px; }
        .users-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .user-btn {
            display: flex; align-items: center; gap: 15px;
            padding: 15px 20px; background: #f8fafc;
            border: 2px solid #e2e8f0; border-radius: 12px;
            cursor: pointer; transition: all 0.3s ease;
        }
        .user-btn:hover { border-color: #667eea; background: #eef2ff; transform: translateX(-5px); }
        .user-btn .avatar {
            width: 50px; height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; color: white; font-size: 1.3rem; font-weight: bold;
        }
        .user-btn .name { font-size: 1.1rem; font-weight: 600; color: #1e293b; }
        .user-btn .status { font-size: 0.85rem; color: #64748b; margin-top: 3px; }
        .user-btn .status.new { color: #f59e0b; }
        .password-section { display: none; }
        .password-section.show { display: block; }
        .selected-user {
            display: flex; align-items: center; gap: 15px;
            padding: 20px; background: #f1f5f9;
            border-radius: 12px; margin-bottom: 20px;
        }
        .selected-user .avatar {
            width: 60px; height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; color: white; font-size: 1.5rem; font-weight: bold;
        }
        .selected-user .info h3 { color: #1e293b; font-size: 1.3rem; }
        .selected-user .info p { color: #64748b; font-size: 0.9rem; }
        .selected-user .change-user {
            margin-right: auto; background: none;
            border: none; color: #667eea; cursor: pointer;
            font-size: 0.9rem; padding: 8px 12px;
        }
        .selected-user .change-user:hover { text-decoration: underline; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #334155; font-weight: 600; }
        .form-group input {
            width: 100%; padding: 14px 18px;
            border: 2px solid #e2e8f0; border-radius: 10px;
            font-size: 1rem; transition: all 0.3s ease;
        }
        .form-group input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .btn {
            width: 100%; padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 10px;
            font-size: 1.1rem; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102,126,234,0.3); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .error-msg {
            background: #fee2e2; color: #dc2626;
            padding: 12px 16px; border-radius: 8px;
            margin-bottom: 15px; display: none;
            border: 1px solid #fca5a5;
        }
        .error-msg.show { display: block; }
        .info-box {
            background: #dbeafe; color: #1e40af;
            padding: 12px 16px; border-radius: 8px;
            margin-bottom: 20px; border: 1px solid #93c5fd;
        }
        .loading {
            display: inline-block;
            width: 20px; height: 20px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .debug-panel {
            margin-top: 20px;
            padding: 15px;
            background: #1e293b;
            border-radius: 10px;
            font-size: 12px;
            color: #94a3b8;
            display: none;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
        }
        .debug-panel.show { display: block; }
        .debug-panel .log { margin: 4px 0; padding: 4px 0; border-bottom: 1px solid #334155; }
        .debug-panel .error { color: #ef4444; }
        .debug-panel .success { color: #10b981; }
        .debug-panel .info { color: #3b82f6; }
        .retry-btn {
            margin-top: 15px; padding: 10px 20px;
            background: #667eea; color: white;
            border: none; border-radius: 8px; cursor: pointer;
        }
        .retry-btn:hover { background: #5a67d8; }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo">
            <span class="icon">ğŸŒ</span>
            <h1>Ù¾ÙˆØ±ØªØ§Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ø¨Ú©Ù‡</h1>
        </div>
        
        <div id="userSelection">
            <p style="text-align: center; color: #64748b; margin-bottom: 20px;">Ú©Ø§Ø±Ø¨Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
            <div class="users-grid" id="usersGrid">
                <div style="text-align: center; padding: 30px; color: #64748b;">
                    <div class="loading" style="border-color: #667eea; border-top-color: transparent; width: 30px; height: 30px;"></div>
                    <p style="margin-top: 15px;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                </div>
            </div>
        </div>
        
        <div id="passwordSection" class="password-section">
            <div class="selected-user">
                <div class="avatar" id="selectedAvatar">Y</div>
                <div class="info">
                    <h3 id="selectedName">Yarian</h3>
                    <p id="selectedStatus">ÙˆØ±ÙˆØ¯</p>
                </div>
                <button class="change-user" onclick="changeUser()">ØªØºÛŒÛŒØ± Ú©Ø§Ø±Ø¨Ø±</button>
            </div>
            
            <div class="error-msg" id="errorMsg"></div>
            
            <div id="registerForm" style="display: none;">
                <div class="info-box">ğŸ” Ø§ÙˆÙ„ÛŒÙ† ÙˆØ±ÙˆØ¯ - Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ØªØ¹ÛŒÛŒÙ† Ú©Ù†ÛŒØ¯</div>
                <div class="form-group">
                    <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯</label>
                    <input type="password" id="newPassword" placeholder="Ø­Ø¯Ø§Ù‚Ù„ 4 Ú©Ø§Ø±Ø§Ú©ØªØ±">
                </div>
                <div class="form-group">
                    <label>ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                    <input type="password" id="confirmPassword" placeholder="ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
                </div>
                <button class="btn" id="registerBtn" onclick="register()">Ø«Ø¨Øª Ø±Ù…Ø² Ùˆ ÙˆØ±ÙˆØ¯</button>
            </div>
            
            <div id="loginForm" style="display: none;">
                <div class="form-group">
                    <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                    <input type="password" id="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
                </div>
                <button class="btn" id="loginBtn" onclick="login()">ÙˆØ±ÙˆØ¯</button>
            </div>
        </div>
        
        <div class="debug-panel" id="debugPanel"></div>
    </div>

    <script>
        let selectedUser = null;
        
        // Debug logging
        function log(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            const panel = document.getElementById('debugPanel');
            const time = new Date().toLocaleTimeString();
            panel.innerHTML += `<div class="log ${type}">[${time}] ${message}</div>`;
            panel.scrollTop = panel.scrollHeight;
        }

        // Toggle debug panel (triple-click logo)
        let clickCount = 0;
        document.querySelector('.logo').addEventListener('click', () => {
            clickCount++;
            setTimeout(() => clickCount = 0, 500);
            if (clickCount >= 3) {
                document.getElementById('debugPanel').classList.toggle('show');
            }
        });

        // Page load
        document.addEventListener('DOMContentLoaded', function() {
            log('ØµÙØ­Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯', 'info');
            loadUsers();
        });

        // Load users
        async function loadUsers() {
            log('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†...', 'info');
            
            try {
                const response = await fetch('/api/users');
                log(`Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }
                
                const data = await response.json();
                log(`${data.users?.length || 0} Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯`, 'success');
                
                if (!data.users || data.users.length === 0) {
                    throw new Error('Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø®Ø§Ù„ÛŒ Ø§Ø³Øª');
                }
                
                document.getElementById('usersGrid').innerHTML = data.users.map(user => `
                    <div class="user-btn" onclick="selectUser('${user.name}', ${user.registered})">
                        <div class="avatar">${user.name[0]}</div>
                        <div>
                            <div class="name">${user.name}</div>
                            <div class="status ${user.registered ? '' : 'new'}">${user.registered ? 'âœ“ Ø«Ø¨Øª Ø´Ø¯Ù‡' : 'â— Ø¬Ø¯ÛŒØ¯'}</div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                log(`Ø®Ø·Ø§: ${error.message}`, 'error');
                document.getElementById('usersGrid').innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #dc2626;">
                        <p style="font-size: 2rem; margin-bottom: 10px;">âŒ</p>
                        <p><strong>Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±</strong></p>
                        <p style="font-size: 0.85rem; margin-top: 10px; color: #64748b;">${error.message}</p>
                        <button class="retry-btn" onclick="loadUsers()">ğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯</button>
                    </div>
                `;
            }
        }

        // Select user
        function selectUser(username, hasPassword) {
            log(`Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯: ${username}`, 'info');
            selectedUser = username;
            
            document.getElementById('userSelection').style.display = 'none';
            document.getElementById('passwordSection').classList.add('show');
            document.getElementById('selectedAvatar').textContent = username[0];
            document.getElementById('selectedName').textContent = username;
            document.getElementById('errorMsg').classList.remove('show');
            
            if (hasPassword) {
                document.getElementById('selectedStatus').textContent = 'ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…';
                document.getElementById('registerForm').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('password').value = '';
                setTimeout(() => document.getElementById('password').focus(), 100);
            } else {
                document.getElementById('selectedStatus').textContent = 'Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ - ØªØ¹ÛŒÛŒÙ† Ø±Ù…Ø²';
                document.getElementById('registerForm').style.display = 'block';
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                setTimeout(() => document.getElementById('newPassword').focus(), 100);
            }
        }

        // Change user
        function changeUser() {
            document.getElementById('userSelection').style.display = 'block';
            document.getElementById('passwordSection').classList.remove('show');
            document.getElementById('errorMsg').classList.remove('show');
            selectedUser = null;
        }

        // Show error
        function showError(msg) {
            log(`Ø®Ø·Ø§: ${msg}`, 'error');
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.classList.add('show');
        }

        // Loading state
        function setLoading(btnId, loading) {
            const btn = document.getElementById(btnId);
            if (loading) {
                btn.disabled = true;
                btn.dataset.originalText = btn.innerHTML;
                btn.innerHTML = 'Ù„Ø·ÙØ§ ØµØ¨Ø± Ú©Ù†ÛŒØ¯... <span class="loading"></span>';
            } else {
                btn.disabled = false;
                btn.innerHTML = btn.dataset.originalText || btn.innerHTML;
            }
        }

        // Register
        async function register() {
            const p1 = document.getElementById('newPassword').value;
            const p2 = document.getElementById('confirmPassword').value;
            
            if (p1.length < 4) { showError('Ø±Ù…Ø² Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ 4 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯'); return; }
            if (p1 !== p2) { showError('Ø±Ù…Ø²Ù‡Ø§ Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ù†Ø¯'); return; }
            
            setLoading('registerBtn', true);
            
            try {
                log('Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø«Ø¨Øª Ù†Ø§Ù…...', 'info');
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: selectedUser, password: p1 })
                });
                
                const data = await response.json();
                log(`Ù†ØªÛŒØ¬Ù‡: ${JSON.stringify(data)}`, data.success ? 'success' : 'error');
                
                if (data.success) {
                    localStorage.setItem('currentUser', selectedUser);
                    window.location.href = '/';
                } else {
                    showError(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†Ø§Ù…');
                }
            } catch (error) {
                log(`Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: ${error.message}`, 'error');
                showError('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±: ' + error.message);
            } finally {
                setLoading('registerBtn', false);
            }
        }

        // Login
        async function login() {
            const password = document.getElementById('password').value;
            
            if (!password) { showError('Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            
            setLoading('loginBtn', true);
            
            try {
                log('Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆØ±ÙˆØ¯...', 'info');
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: selectedUser, password: password })
                });
                
                const data = await response.json();
                log(`Ù†ØªÛŒØ¬Ù‡: ${JSON.stringify(data)}`, data.success ? 'success' : 'error');
                
                if (data.success) {
                    localStorage.setItem('currentUser', selectedUser);
                    window.location.href = '/';
                } else {
                    showError(data.message || 'Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
                }
            } catch (error) {
                log(`Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: ${error.message}`, 'error');
                showError('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±: ' + error.message);
            } finally {
                setLoading('loginBtn', false);
            }
        }

        // Enter key
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (document.getElementById('loginForm').style.display !== 'none') {
                    login();
                } else if (document.getElementById('registerForm').style.display !== 'none') {
                    register();
                }
            }
        });
    </script>
</body>
</html>
