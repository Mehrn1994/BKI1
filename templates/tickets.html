<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… ØªÛŒÚ©Øª - Ù¾ÙˆØ±ØªØ§Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ø¨Ú©Ù‡</title>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: rgba(30, 41, 59, 0.8);
            --bg-header: rgba(30, 41, 59, 0.95);
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: rgba(255, 255, 255, 0.1);
            --accent-green: #10b981;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-orange: #f59e0b;
            --input-bg: rgba(15, 23, 42, 0.8);
            --input-border: rgba(255, 255, 255, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('/static/background.jpg') center/cover no-repeat;
            opacity: 0.5;
            z-index: -2;
        }
        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.55), rgba(15, 23, 42, 0.45));
            z-index: -1;
        }

        .header {
            background: var(--bg-header);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .header-right img { height: 56px; }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .header-left button, .header-left a {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            text-decoration: none;
        }
        .header-left button:hover, .header-left a:hover { background: rgba(255,255,255,0.05); }
        .logout-btn { background: rgba(239, 68, 68, 0.15) !important; color: #ef4444 !important; border-color: rgba(239, 68, 68, 0.3) !important; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px 30px; }

        .page-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 4px;
            border: 1px solid var(--border-color);
        }
        .tab {
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
            border: none;
            background: transparent;
        }
        .tab:hover { color: var(--text-primary); background: rgba(255,255,255,0.05); }
        .tab.active { background: var(--accent-blue); color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Email & Ticket Cards */
        .card-grid { display: flex; flex-direction: column; gap: 12px; }

        .email-card, .ticket-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 18px 22px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .email-card:hover, .ticket-card:hover {
            border-color: var(--accent-blue);
            background: rgba(30, 41, 59, 0.95);
        }
        .email-card.used { opacity: 0.5; cursor: default; }
        .email-card .email-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .email-card .subject { font-weight: 600; font-size: 15px; }
        .email-card .sender { color: var(--text-muted); font-size: 12px; }
        .email-card .date { color: var(--text-muted); font-size: 12px; }
        .email-card .body-preview { color: var(--text-secondary); font-size: 13px; margin-top: 6px; line-height: 1.5; white-space: pre-line; max-height: 60px; overflow: hidden; }

        /* Ticket card */
        .ticket-card .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .ticket-card .ticket-id { font-weight: 700; color: var(--accent-blue); font-size: 14px; }
        .ticket-card .ticket-subject { font-weight: 600; font-size: 15px; margin-bottom: 4px; }
        .ticket-card .ticket-meta { display: flex; gap: 16px; font-size: 12px; color: var(--text-muted); }

        /* Stage badges */
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-new { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .badge-ip { background: rgba(245,158,11,0.15); color: #f59e0b; }
        .badge-config { background: rgba(139,92,246,0.15); color: #8b5cf6; }
        .badge-replied { background: rgba(16,185,129,0.15); color: #10b981; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 800px;
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            padding: 0;
        }
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 { font-size: 17px; }
        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 22px;
            cursor: pointer;
            padding: 4px;
        }
        .modal-body { padding: 24px; }
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Steps indicator */
        .steps {
            display: flex;
            gap: 0;
            margin-bottom: 24px;
            position: relative;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 12px 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            position: relative;
            border-bottom: 3px solid var(--border-color);
        }
        .step.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
        .step.done { color: var(--accent-green); border-bottom-color: var(--accent-green); }
        .step-num {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            border-radius: 50%;
            background: var(--border-color);
            color: var(--text-muted);
            font-size: 12px;
            margin-left: 6px;
        }
        .step.active .step-num { background: var(--accent-blue); color: white; }
        .step.done .step-num { background: var(--accent-green); color: white; }

        /* Form elements */
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--accent-blue);
            outline: none;
        }
        .form-group select option { background: var(--bg-secondary); color: var(--text-primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

        /* Buttons */
        .btn {
            padding: 10px 22px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: var(--accent-green); color: white; }
        .btn-success:hover { background: #059669; }
        .btn-secondary { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); }
        .btn-secondary:hover { background: rgba(255,255,255,0.05); }
        .btn-orange { background: var(--accent-orange); color: white; }
        .btn-purple { background: var(--accent-purple); color: white; }

        /* IP grid */
        .ip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
            padding: 4px;
        }
        .ip-item {
            padding: 8px 12px;
            background: rgba(16,185,129,0.1);
            border: 1px solid rgba(16,185,129,0.2);
            border-radius: 8px;
            font-size: 13px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-family: monospace;
        }
        .ip-item:hover { background: rgba(16,185,129,0.25); border-color: var(--accent-green); }
        .ip-item.selected { background: var(--accent-green); color: white; border-color: var(--accent-green); }

        /* Config output */
        .config-box {
            background: #0d1117;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            direction: ltr;
            text-align: left;
            color: #c9d1d9;
            max-height: 400px;
            overflow-y: auto;
        }

        /* Email preview in modal */
        .email-preview {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .email-preview .ep-subject { font-weight: 700; font-size: 16px; margin-bottom: 8px; }
        .email-preview .ep-meta { font-size: 12px; color: var(--text-muted); margin-bottom: 10px; display: flex; gap: 16px; }
        .email-preview .ep-body { font-size: 14px; line-height: 1.7; white-space: pre-line; color: var(--text-secondary); }

        /* Reply preview */
        .reply-preview {
            background: rgba(16,185,129,0.05);
            border: 1px solid rgba(16,185,129,0.2);
            border-radius: 10px;
            padding: 16px;
        }
        .reply-preview h4 { margin-bottom: 10px; color: var(--accent-green); font-size: 14px; }

        /* Info box */
        .info-box {
            background: rgba(59,130,246,0.08);
            border: 1px solid rgba(59,130,246,0.2);
            border-radius: 10px;
            padding: 14px 18px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
        .empty-state .text { font-size: 15px; }

        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 12px;
        }

        /* Choice cards */
        .choice-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-bottom: 20px;
        }
        .choice-card {
            background: rgba(255,255,255,0.03);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .choice-card:hover { border-color: var(--accent-blue); background: rgba(59,130,246,0.05); }
        .choice-card.selected { border-color: var(--accent-blue); background: rgba(59,130,246,0.1); }
        .choice-card .cc-icon { font-size: 32px; margin-bottom: 8px; }
        .choice-card .cc-title { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
        .choice-card .cc-desc { font-size: 12px; color: var(--text-muted); }

        /* Branch list for existing points */
        .branch-search {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 10px;
        }
        .branch-search:focus { border-color: var(--accent-blue); outline: none; }
        .branch-list {
            max-height: 350px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .branch-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .branch-item:hover { border-color: var(--accent-blue); background: rgba(59,130,246,0.05); }
        .branch-item.selected { border-color: var(--accent-green); background: rgba(16,185,129,0.1); }
        .branch-item .bi-name { font-weight: 600; font-size: 14px; }
        .branch-item .bi-province { font-size: 12px; color: var(--accent-purple); margin-top: 2px; }
        .branch-item .bi-ip { font-family: monospace; font-size: 13px; color: var(--accent-green); font-weight: 600; }
        .branch-item .bi-type { font-size: 11px; color: var(--text-muted); }

        .demo-banner {
            background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(245,158,11,0.05));
            border: 1px solid rgba(245,158,11,0.3);
            border-radius: 12px;
            padding: 14px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            color: var(--accent-orange);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-right">
            <img src="/static/logo.png" alt="Logo" style="mix-blend-mode: screen;">
            <div>
                <div style="font-weight: 700; font-size: 15px;">Ø³ÛŒØ³ØªÙ… ØªÛŒÚ©Øª</div>
                <div style="font-size: 11px; color: var(--text-muted);">Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ø¨Ú©Ù‡</div>
            </div>
        </div>
        <div class="header-left">
            <span>ğŸ‘¤ <span id="currentUser">Ú©Ø§Ø±Ø¨Ø±</span></span>
            <a href="/">ğŸ  Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
            <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <div class="container">
        <div class="demo-banner">
            <span style="font-size: 24px;">ğŸ§ª</span>
            <div>
                <strong>Ø­Ø§Ù„Øª Ø¯Ù…Ùˆ</strong> - Ø§ÛŒÙ…ÛŒÙ„â€ŒÙ‡Ø§ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯. Ø¯Ø± Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒØŒ Ø§ÛŒÙ…ÛŒÙ„â€ŒÙ‡Ø§ Ø§Ø² ÙÙˆÙ„Ø¯Ø± Outlook Ø§Ø² Ø·Ø±ÛŒÙ‚ Microsoft Graph API Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
            </div>
        </div>

        <div class="page-title">ğŸ“¨ Ø³ÛŒØ³ØªÙ… ØªÛŒÚ©Øª Ø´Ø¨Ú©Ù‡</div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('inbox')">ğŸ“¥ ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ±ÙˆØ¯ÛŒ</button>
            <button class="tab" onclick="switchTab('tickets')">ğŸ« ØªÛŒÚ©Øªâ€ŒÙ‡Ø§</button>
        </div>

        <!-- Tab 1: Inbox -->
        <div id="inboxTab" class="tab-content active">
            <div class="card-grid" id="emailList">
                <div class="empty-state">
                    <div class="icon">ğŸ“­</div>
                    <div class="text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÛŒÙ…ÛŒÙ„â€ŒÙ‡Ø§...</div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Tickets -->
        <div id="ticketsTab" class="tab-content">
            <div class="card-grid" id="ticketList">
                <div class="empty-state">
                    <div class="icon">ğŸ«</div>
                    <div class="text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ticket Detail Modal -->
    <div class="modal-overlay" id="ticketModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">ØªÛŒÚ©Øª</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>ğŸ¢ Network Configuration Portal - Ticket System (Demo)</p>
    </footer>

    <script>
        // ============ AUTH ============
        const currentUser = localStorage.getItem('currentUser') || localStorage.getItem('username') || sessionStorage.getItem('username');
        if (!currentUser) {
            window.location.href = '/login';
        } else {
            document.getElementById('currentUser').textContent = currentUser;
        }

        function logout() {
            localStorage.clear();
            sessionStorage.clear();
            location.href = '/login';
        }

        // ============ STATE ============
        let currentTicket = null;
        let selectedIp = null;
        let provincesCache = [];

        // ============ TABS ============
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            if (tab === 'inbox') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('inboxTab').classList.add('active');
                loadEmails();
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('ticketsTab').classList.add('active');
                loadTickets();
            }
        }

        // ============ LOAD EMAILS ============
        async function loadEmails() {
            try {
                const res = await fetch('/api/tickets/emails');
                const emails = await res.json();
                const container = document.getElementById('emailList');

                if (emails.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><div class="text">Ø§ÛŒÙ…ÛŒÙ„ÛŒ Ø¯Ø± ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ±ÙˆØ¯ÛŒ Ù†ÛŒØ³Øª</div></div>';
                    return;
                }

                container.innerHTML = emails.map(e => `
                    <div class="email-card ${e.has_ticket ? 'used' : ''}" onclick="${e.has_ticket ? '' : `createTicket('${e.id}')`}">
                        <div class="email-header">
                            <div class="subject">${e.has_ticket ? 'âœ…' : 'ğŸ“©'} ${e.subject}</div>
                            <div class="date">${e.date}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div class="sender">Ø§Ø²: ${e.sender}</div>
                            ${e.has_ticket ? '<span class="badge badge-ip">ØªÛŒÚ©Øª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡</span>' : '<span style="font-size:12px; color: var(--accent-blue);">Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ ØªÛŒÚ©Øª &larr;</span>'}
                        </div>
                        <div class="body-preview">${e.body}</div>
                    </div>
                `).join('');
            } catch (err) {
                document.getElementById('emailList').innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><div class="text">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</div></div>';
            }
        }

        // ============ CREATE TICKET ============
        async function createTicket(emailId) {
            const emails = await (await fetch('/api/tickets/emails')).json();
            const email = emails.find(e => e.id === emailId);
            if (!email) return;

            try {
                const res = await fetch('/api/tickets', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email_id: email.id,
                        email_subject: email.subject,
                        email_sender: email.sender,
                        email_body: email.body,
                        email_date: email.date,
                        assigned_user: currentUser
                    })
                });
                const data = await res.json();
                if (data.success) {
                    switchTab('tickets');
                    setTimeout(() => openTicket(data.ticket_id), 300);
                } else {
                    alert(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ØªÛŒÚ©Øª');
                }
            } catch (err) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        // ============ LOAD TICKETS ============
        async function loadTickets() {
            try {
                const res = await fetch('/api/tickets');
                const tickets = await res.json();
                const container = document.getElementById('ticketList');

                if (tickets.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ«</div><div class="text">Ù‡Ù†ÙˆØ² ØªÛŒÚ©ØªÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯Ù‡. Ø§Ø² ØªØ¨ ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ±ÙˆØ¯ÛŒ Ø±ÙˆÛŒ Ø§ÛŒÙ…ÛŒÙ„ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.</div></div>';
                    return;
                }

                container.innerHTML = tickets.map(t => {
                    const badgeClass = t.stage === 'new' ? 'badge-new' : t.stage === 'ip_assigned' ? 'badge-ip' : t.stage === 'config_generated' ? 'badge-config' : 'badge-replied';
                    const badgeText = t.stage === 'new' ? 'Ø¬Ø¯ÛŒØ¯' : t.stage === 'ip_assigned' ? 'IP Ø§Ø®ØªØµØ§Øµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯' : t.stage === 'config_generated' ? 'Ú©Ø§Ù†ÙÛŒÚ¯ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯' : 'Ù¾Ø§Ø³Ø® Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯';
                    return `
                        <div class="ticket-card" onclick="openTicket(${t.id})">
                            <div class="ticket-header">
                                <div class="ticket-id">#${t.id}</div>
                                <span class="badge ${badgeClass}">${badgeText}</span>
                            </div>
                            <div class="ticket-subject">${t.email_subject || 'Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¶ÙˆØ¹'}</div>
                            <div class="ticket-meta">
                                <span>ğŸ“§ ${t.email_sender || '-'}</span>
                                <span>ğŸ“… ${t.created_at || '-'}</span>
                                ${t.assigned_ip ? `<span>ğŸŒ ${t.assigned_ip}</span>` : ''}
                                ${t.config_type ? `<span>âš™ï¸ ${t.config_type === 'apn_int' ? 'APN ØºÛŒØ±Ù…Ø§Ù„ÛŒ' : 'APN Ù…Ø§Ù„ÛŒ'}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                document.getElementById('ticketList').innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><div class="text">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</div></div>';
            }
        }

        // ============ OPEN TICKET ============
        async function openTicket(ticketId) {
            try {
                const res = await fetch(`/api/tickets/${ticketId}`);
                currentTicket = await res.json();
                renderTicketModal();
            } catch (err) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÛŒÚ©Øª');
            }
        }

        function closeModal() {
            document.getElementById('ticketModal').classList.remove('active');
            currentTicket = null;
            selectedIp = null;
            loadTickets();
            loadEmails();
        }

        // ============ RENDER MODAL ============
        function renderTicketModal() {
            const t = currentTicket;
            document.getElementById('modalTitle').textContent = `ØªÛŒÚ©Øª #${t.id} - ${t.email_subject || ''}`;
            document.getElementById('ticketModal').classList.add('active');

            const body = document.getElementById('modalBody');

            // Steps indicator
            const stageIndex = {'new': 0, 'ip_assigned': 1, 'config_generated': 2, 'replied': 3};
            const si = stageIndex[t.stage] || 0;

            let html = `
                <div class="steps">
                    <div class="step ${si === 0 ? 'active' : (si > 0 ? 'done' : '')}">
                        <span class="step-num">${si > 0 ? 'âœ“' : '1'}</span>
                        Ø§ÛŒØ¬Ø§Ø¯ ØªÛŒÚ©Øª
                    </div>
                    <div class="step ${si === 1 ? 'active' : (si > 1 ? 'done' : '')}">
                        <span class="step-num">${si > 1 ? 'âœ“' : '2'}</span>
                        Ø§Ø®ØªØµØ§Øµ IP
                    </div>
                    <div class="step ${si === 2 ? 'active' : (si > 2 ? 'done' : '')}">
                        <span class="step-num">${si > 2 ? 'âœ“' : '3'}</span>
                        ØªÙˆÙ„ÛŒØ¯ Ú©Ø§Ù†ÙÛŒÚ¯
                    </div>
                    <div class="step ${si === 3 ? 'active' : ''}">
                        <span class="step-num">${si >= 3 ? 'âœ“' : '4'}</span>
                        Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®
                    </div>
                </div>
            `;

            // Email preview
            html += `
                <div class="email-preview">
                    <div class="ep-subject">ğŸ“§ ${t.email_subject}</div>
                    <div class="ep-meta">
                        <span>Ø§Ø²: ${t.email_sender}</span>
                        <span>ØªØ§Ø±ÛŒØ®: ${t.email_date}</span>
                    </div>
                    <div class="ep-body">${t.email_body}</div>
                </div>
            `;

            // Stage-specific content
            if (t.stage === 'new') {
                html += renderStageNew();
            } else if (t.stage === 'ip_assigned') {
                html += renderStageIpAssigned();
            } else if (t.stage === 'config_generated') {
                html += renderStageConfigGenerated();
            } else if (t.stage === 'replied') {
                html += renderStageReplied();
            }

            body.innerHTML = html;

            // Post-render setup
            if (t.stage === 'new') {
                loadProvincesForTicket();
            }
        }

        // ============ STAGE: NEW ============
        function renderStageNew() {
            return `
                <h4 style="margin-bottom: 14px;">Ù†ÙˆØ¹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</h4>
                <div class="choice-cards">
                    <div class="choice-card" id="choiceNew" onclick="selectChoice('new')">
                        <div class="cc-icon">ğŸ†•</div>
                        <div class="cc-title">Ù†Ù‚Ø·Ù‡ / Ø´Ø¹Ø¨Ù‡ Ø¬Ø¯ÛŒØ¯</div>
                        <div class="cc-desc">Ù‡Ù†ÙˆØ² IP Ø§Ø®ØªØµØ§Øµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯Ù‡</div>
                    </div>
                    <div class="choice-card" id="choiceExisting" onclick="selectChoice('existing')">
                        <div class="cc-icon">ğŸ”„</div>
                        <div class="cc-title">Ù†Ù‚Ø·Ù‡ Ù…ÙˆØ¬ÙˆØ¯</div>
                        <div class="cc-desc">IP Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø®ØªØµØ§Øµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡</div>
                    </div>
                </div>

                <div id="newPointForm" style="display:none;">
                    <div class="info-box">
                        ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø±Ø²Ø±Ùˆ IP Ø¬Ø¯ÛŒØ¯ Ù¾Ø± Ú©Ù†ÛŒØ¯. Ù¾Ø³ Ø§Ø² Ø«Ø¨ØªØŒ IP Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø±Ø²Ø±Ùˆ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø§Ø³ØªØ§Ù† *</label>
                            <select id="ticketProvince" onchange="loadFreeIpsForTicket()">
                                <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ù†ÙˆØ¹ Ù†Ù‚Ø·Ù‡ *</label>
                            <select id="ticketPointType">
                                <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>
                                <option value="BRANCH">Ø´Ø¹Ø¨Ù‡ (Branch)</option>
                                <option value="ATM">Ø®ÙˆØ¯Ù¾Ø±Ø¯Ø§Ø² (ATM)</option>
                                <option value="KIOSK">Ú©ÛŒÙˆØ³Ú© (Kiosk)</option>
                                <option value="COUNTER">Ø¨Ø§Ø¬Ù‡ (Counter)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ù†Ø§Ù… Ù†Ù‚Ø·Ù‡ (ÙØ§Ø±Ø³ÛŒ) *</label>
                            <input type="text" id="ticketBranchName" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø¹Ø¨Ù‡ Ù…Ø±Ú©Ø²ÛŒ ØªÙ‡Ø±Ø§Ù†">
                        </div>
                        <div class="form-group">
                            <label>Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª *</label>
                            <input type="text" id="ticketRequestNum" placeholder="Ù…Ø«Ø§Ù„: REQ-2026-001">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ú©Ø¯ Ù…Ù‡Ø±Ú¯Ø³ØªØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                        <input type="text" id="ticketMehrCode" placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ">
                    </div>

                    <div class="form-group">
                        <label>IP LAN Ø¢Ø²Ø§Ø¯ * (ÛŒÚ© IP Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯)</label>
                        <div id="ticketFreeIps" class="ip-grid" style="min-height: 60px;">
                            <div style="color: var(--text-muted); font-size: 13px; grid-column: 1/-1; text-align: center; padding: 20px;">Ø§Ø¨ØªØ¯Ø§ Ø§Ø³ØªØ§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="assignIpToTicket()" style="width:100%; margin-top:10px;">
                        âœ… Ø«Ø¨Øª Ùˆ Ø§Ø®ØªØµØ§Øµ IP
                    </button>
                </div>

                <div id="existingPointInfo" style="display:none;">
                    <div class="info-box">
                        Ø´Ø¹Ø¨Ù‡ ÛŒØ§ Ù†Ù‚Ø·Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ø±Ø§ Ø§Ø² Ù„ÛŒØ³Øª Ø²ÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯. Ø§Ø·Ù„Ø§Ø¹Ø§Øª IP Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                    </div>
                    <input type="text" class="branch-search" id="branchSearch" placeholder="ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ù†Ø§Ù… Ø´Ø¹Ø¨Ù‡ ÛŒØ§ Ø§Ø³ØªØ§Ù†..." oninput="filterBranches()">
                    <div class="branch-list" id="branchList">
                        <div style="text-align: center; padding: 30px; color: var(--text-muted);">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                    </div>
                    <button class="btn btn-success" id="btnSelectExisting" onclick="assignExistingToTicket()" style="width:100%; margin-top:12px; display:none;">
                        âœ… Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ Ø§Ø¯Ø§Ù…Ù‡
                    </button>
                </div>
            `;
        }

        let allBranches = [];
        let selectedBranch = null;

        function selectChoice(choice) {
            document.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected'));
            if (choice === 'new') {
                document.getElementById('choiceNew').classList.add('selected');
                document.getElementById('newPointForm').style.display = 'block';
                document.getElementById('existingPointInfo').style.display = 'none';
            } else {
                document.getElementById('choiceExisting').classList.add('selected');
                document.getElementById('newPointForm').style.display = 'none';
                document.getElementById('existingPointInfo').style.display = 'block';
                loadBranchesForTicket();
            }
        }

        async function loadBranchesForTicket() {
            try {
                const res = await fetch('/api/branches');
                const branches = await res.json();
                branches.sort((a, b) => {
                    if (a.province !== b.province) return a.province.localeCompare(b.province);
                    return a.name.localeCompare(b.name);
                });
                allBranches = branches;
                selectedBranch = null;
                document.getElementById('btnSelectExisting').style.display = 'none';
                renderBranchList(allBranches);
            } catch (err) {
                document.getElementById('branchList').innerHTML = '<div style="text-align:center; padding:30px; color:#ef4444;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ø´Ø¹Ø¨</div>';
            }
        }

        function renderBranchList(branches) {
            const container = document.getElementById('branchList');
            if (branches.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:30px; color:var(--text-muted);">Ø´Ø¹Ø¨Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
                return;
            }
            container.innerHTML = branches.map((b, i) => `
                <div class="branch-item" data-idx="${i}" onclick="selectBranchItem(this, ${b.x}, ${b.y}, '${(b.name || '').replace(/'/g, "\\'")}', '${(b.province || '').replace(/'/g, "\\'")}')">
                    <div>
                        <div class="bi-name">${b.name}</div>
                        <div class="bi-province">ğŸ“ ${b.province}</div>
                    </div>
                    <div style="text-align: left;">
                        <div class="bi-ip">${b.lan_ip}</div>
                        <div class="bi-type">${b.type === 'reserved' ? 'ğŸ”– Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡' : 'âœ… ÙØ¹Ø§Ù„'}</div>
                    </div>
                </div>
            `).join('');
        }

        function filterBranches() {
            const q = document.getElementById('branchSearch').value.trim().toLowerCase();
            if (!q) {
                renderBranchList(allBranches);
                return;
            }
            const filtered = allBranches.filter(b =>
                (b.name || '').toLowerCase().includes(q) ||
                (b.province || '').toLowerCase().includes(q) ||
                (b.lan_ip || '').includes(q)
            );
            renderBranchList(filtered);
        }

        function selectBranchItem(el, o2, o3, name, province) {
            document.querySelectorAll('.branch-item').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');
            selectedBranch = { octet2: o2, octet3: o3, name: name, province: province };
            document.getElementById('btnSelectExisting').style.display = 'block';
        }

        async function assignExistingToTicket() {
            if (!selectedBranch) {
                alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø´Ø¹Ø¨Ù‡ Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }
            try {
                const res = await fetch(`/api/tickets/${currentTicket.id}/assign-existing`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        province: selectedBranch.province,
                        branch_name: selectedBranch.name,
                        octet2: selectedBranch.octet2,
                        octet3: selectedBranch.octet3,
                        username: currentUser
                    })
                });
                const data = await res.json();
                if (data.success) {
                    const tres = await fetch(`/api/tickets/${currentTicket.id}`);
                    currentTicket = await tres.json();
                    renderTicketModal();
                } else {
                    alert(data.error || 'Ø®Ø·Ø§');
                }
            } catch (err) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        async function loadProvincesForTicket() {
            try {
                const res = await fetch('/api/provinces');
                provincesCache = await res.json();
                const select = document.getElementById('ticketProvince');
                if (!select) return;
                provincesCache.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p;
                    opt.textContent = p;
                    select.appendChild(opt);
                });
            } catch (err) {
                console.error('Error loading provinces:', err);
            }
        }

        async function loadFreeIpsForTicket() {
            const province = document.getElementById('ticketProvince').value;
            const container = document.getElementById('ticketFreeIps');
            if (!province) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px; grid-column: 1/-1; text-align: center; padding: 20px;">Ø§Ø¨ØªØ¯Ø§ Ø§Ø³ØªØ§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>';
                return;
            }

            container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px; grid-column: 1/-1; text-align: center; padding: 20px;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>';

            try {
                const res = await fetch(`/api/free-lan-ips?province=${province}`);
                const ips = await res.json();

                if (ips.length === 0) {
                    container.innerHTML = '<div style="color: #ef4444; font-size: 13px; grid-column: 1/-1; text-align: center; padding: 20px;">IP Ø¢Ø²Ø§Ø¯ Ø¯Ø± Ø§ÛŒÙ† Ø§Ø³ØªØ§Ù† Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</div>';
                    return;
                }

                selectedIp = null;
                container.innerHTML = ips.slice(0, 50).map(ip => `
                    <div class="ip-item" data-octet2="${ip.octet2}" data-octet3="${ip.octet3}" onclick="selectIp(this, ${ip.octet2}, ${ip.octet3})">
                        10.${ip.octet2}.${ip.octet3}.0/24
                    </div>
                `).join('');
            } catch (err) {
                container.innerHTML = '<div style="color: #ef4444; font-size: 13px; grid-column: 1/-1; text-align: center; padding: 20px;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</div>';
            }
        }

        function selectIp(el, o2, o3) {
            document.querySelectorAll('.ip-item').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');
            selectedIp = { octet2: o2, octet3: o3 };
        }

        async function assignIpToTicket() {
            const province = document.getElementById('ticketProvince').value;
            const branchName = document.getElementById('ticketBranchName').value;
            const pointType = document.getElementById('ticketPointType').value;
            const requestNum = document.getElementById('ticketRequestNum').value;
            const mehrCode = document.getElementById('ticketMehrCode').value;

            if (!province || !branchName || !pointType || !requestNum) {
                alert('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ (*) Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
                return;
            }
            if (!selectedIp) {
                alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© IP Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }

            try {
                const res = await fetch(`/api/tickets/${currentTicket.id}/assign-ip`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        province, branch_name: branchName, point_type: pointType,
                        request_number: requestNum, mehregostar_code: mehrCode,
                        octet2: selectedIp.octet2, octet3: selectedIp.octet3,
                        username: currentUser
                    })
                });
                const data = await res.json();
                if (data.success) {
                    // Reload ticket
                    const tres = await fetch(`/api/tickets/${currentTicket.id}`);
                    currentTicket = await tres.json();
                    renderTicketModal();
                } else {
                    alert(data.error || 'Ø®Ø·Ø§');
                }
            } catch (err) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        // ============ STAGE: IP ASSIGNED ============
        // Auto-assigned resources cache
        let autoApnIp = null;
        let autoTunnel200 = null;
        let autoMaliIp = null;
        let autoTunnelPair = null;

        function renderStageIpAssigned() {
            const t = currentTicket;
            return `
                <div class="info-box" style="border-color: rgba(16,185,129,0.3); background: rgba(16,185,129,0.08);">
                    âœ… <strong>IP Ø§Ø®ØªØµØ§Øµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯:</strong> ${t.assigned_ip} | Ø§Ø³ØªØ§Ù†: ${t.province} | Ù†Ù‚Ø·Ù‡: ${t.branch_name} (${t.point_type})
                </div>

                <h4 style="margin-bottom: 14px;">Ù†ÙˆØ¹ Ú©Ø§Ù†ÙÛŒÚ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</h4>
                <div class="choice-cards">
                    <div class="choice-card" onclick="showConfigForm('apn_int')">
                        <div class="cc-icon">ğŸŸ£</div>
                        <div class="cc-title">APN ØºÛŒØ±Ù…Ø§Ù„ÛŒ</div>
                        <div class="cc-desc">APN-INT to HUB ASR + Tunnel200</div>
                    </div>
                    <div class="choice-card" onclick="showConfigForm('apn_mali')">
                        <div class="cc-icon">ğŸŸ¢</div>
                        <div class="cc-title">APN Ù…Ø§Ù„ÛŒ</div>
                        <div class="cc-desc">ISR-APN-RO + Financial APN</div>
                    </div>
                </div>

                <div id="configFormArea" style="display:none;">
                    <!-- Filled dynamically -->
                </div>
            `;
        }

        async function showConfigForm(type) {
            document.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected'));
            event.target.closest('.choice-card').classList.add('selected');

            const area = document.getElementById('configFormArea');
            area.style.display = 'block';
            const t = currentTicket;
            const x = t.octet2;
            const y = t.octet3;

            if (type === 'apn_int') {
                area.innerHTML = `
                    <h4 style="margin: 16px 0 12px;">âš™ï¸ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ APN ØºÛŒØ±Ù…Ø§Ù„ÛŒ</h4>
                    <div class="info-box">ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ØªØ®ØµÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.</div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ğŸŒ APN IP (Ø®ÙˆØ¯Ú©Ø§Ø±)</label>
                            <input type="text" id="cfgApnIp" readonly style="opacity:0.7; cursor:not-allowed;" value="â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...">
                        </div>
                        <div class="form-group">
                            <label>ğŸ”— Tunnel200 HUB IP (Ø®ÙˆØ¯Ú©Ø§Ø±)</label>
                            <input type="text" id="cfgTun200Hub" readonly style="opacity:0.7; cursor:not-allowed;" value="â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ğŸ”— Tunnel200 Branch IP (Ø®ÙˆØ¯Ú©Ø§Ø±)</label>
                            <input type="text" id="cfgTun200Branch" readonly style="opacity:0.7; cursor:not-allowed;" value="â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...">
                        </div>
                        <div class="form-group">
                            <label>ğŸ“‹ OSPF Area (Ø®ÙˆØ¯Ú©Ø§Ø±)</label>
                            <input type="text" id="cfgOspfArea" readonly style="opacity:0.7; cursor:not-allowed;" value="${x}">
                        </div>
                    </div>

                    <hr style="border-color: var(--border-color); margin: 16px 0;">

                    <div class="form-row">
                        <div class="form-group">
                            <label>ğŸ“‹ Node Type</label>
                            <select id="cfgNodeType">
                                <option value="Branch">ğŸ¢ Ø´Ø¹Ø¨Ù‡ (Branch)</option>
                                <option value="ATM">ğŸ’³ ATM</option>
                                <option value="Kiosk">ğŸ–¥ï¸ Ú©ÛŒÙˆØ³Ú© (Kiosk)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ğŸ”¤ Route Name (English) *</label>
                            <input type="text" id="cfgRouteName" placeholder="e.g. Tehran-Vanak-01" value="">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ğŸ”Œ WAN Interface *</label>
                            <input type="text" id="cfgWanIface" value="FastEthernet0/1">
                        </div>
                        <div class="form-group">
                            <label>ğŸ”¢ Ø´Ù…Ø§Ø±Ù‡ Tunnel Ø±ÙˆÛŒ HUB *</label>
                            <input type="text" id="cfgHubTunnelId" placeholder="Ù…Ø«Ø§Ù„: 10158100170">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ğŸ“ HUB Tunnel Description *</label>
                        <input type="text" id="cfgHubDesc" placeholder="e.g. Gilanet-Tehran-Vanak-01">
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="cfgSecondary" style="width:auto;">
                        <label for="cfgSecondary" style="margin:0; cursor:pointer;">âš ï¸ IP Ø¨Ù‡ ØµÙˆØ±Øª Secondary (Ø´Ø¹Ø¨Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ APN Ù…Ø§Ù„ÛŒ Ø¯Ø§Ø±Ø¯)</label>
                    </div>

                    <button class="btn btn-purple" onclick="generateApnIntConfig()" style="width:100%; margin-top: 10px;">
                        âš™ï¸ ØªÙˆÙ„ÛŒØ¯ Ú©Ø§Ù†ÙÛŒÚ¯ APN ØºÛŒØ±Ù…Ø§Ù„ÛŒ
                    </button>
                `;
                // Auto-assign APN IP and Tunnel200
                autoAssignForApnInt();

            } else {
                area.innerHTML = `
                    <h4 style="margin: 16px 0 12px;">âš™ï¸ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ APN Ù…Ø§Ù„ÛŒ</h4>
                    <div class="info-box">ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ØªØ®ØµÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.</div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ğŸŒ APN Ù…Ø§Ù„ÛŒ IP (Ø®ÙˆØ¯Ú©Ø§Ø±)</label>
                            <input type="text" id="cfgMaliIp" readonly style="opacity:0.7; cursor:not-allowed;" value="â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...">
                        </div>
                        <div class="form-group">
                            <label>ğŸ”— Tunnel Pair (Ø®ÙˆØ¯Ú©Ø§Ø±)</label>
                            <input type="text" id="cfgTunnelPairDisplay" readonly style="opacity:0.7; cursor:not-allowed;" value="â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ğŸ“‹ OSPF Area (Ø®ÙˆØ¯Ú©Ø§Ø±)</label>
                            <input type="text" id="cfgOspfArea" readonly style="opacity:0.7; cursor:not-allowed;" value="${x}">
                        </div>
                        <div class="form-group">
                            <label>ğŸ“‹ Node Type</label>
                            <select id="cfgNodeType">
                                <option value="Branch">ğŸ¢ Ø´Ø¹Ø¨Ù‡ (Branch)</option>
                                <option value="Kiosk">ğŸ–¥ï¸ Ú©ÛŒÙˆØ³Ú© (Kiosk)</option>
                                <option value="ATM">ğŸ’³ ATM</option>
                            </select>
                        </div>
                    </div>

                    <hr style="border-color: var(--border-color); margin: 16px 0;">

                    <div class="form-row">
                        <div class="form-group">
                            <label>ğŸ”¤ Ù†Ø§Ù… Ø´Ø¹Ø¨Ù‡ (English) *</label>
                            <input type="text" id="cfgBranchNameEn" placeholder="e.g. TEH-Branch-Vanak">
                        </div>
                        <div class="form-group">
                            <label>ğŸ”Œ WAN Interface *</label>
                            <input type="text" id="cfgWanIface" value="FastEthernet0/1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ğŸ”¢ Ø´Ù…Ø§Ø±Ù‡ Tunnel Ø±ÙˆÛŒ HUB *</label>
                        <input type="text" id="cfgHubTunnelNum" placeholder="Ù…Ø«Ø§Ù„: 10158100170">
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="cfgIncludeBase" style="width:auto;">
                        <label for="cfgIncludeBase" style="margin:0; cursor:pointer;">ğŸ“¦ Ø´Ø§Ù…Ù„ Base Configuration (Ú©Ø§Ù†ÙÛŒÚ¯ Ù¾Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡)</label>
                    </div>
                    <div id="baseConfigFields" style="display:none;">
                        <div class="form-group">
                            <label>ğŸ·ï¸ Router Hostname *</label>
                            <input type="text" id="cfgRouterHostname" placeholder="e.g. GLS-Kiosk-Behshadafarin">
                        </div>
                    </div>

                    <button class="btn btn-success" onclick="generateApnMaliConfig()" style="width:100%; margin-top: 10px;">
                        âš™ï¸ ØªÙˆÙ„ÛŒØ¯ Ú©Ø§Ù†ÙÛŒÚ¯ APN Ù…Ø§Ù„ÛŒ
                    </button>
                `;
                // Auto-assign APN Mali IP and Tunnel pair
                autoAssignForApnMali();
                // Toggle base config fields
                document.getElementById('cfgIncludeBase').addEventListener('change', function() {
                    document.getElementById('baseConfigFields').style.display = this.checked ? 'block' : 'none';
                });
            }
        }

        // ============ AUTO-ASSIGN RESOURCES ============
        async function autoAssignForApnInt() {
            // APN IP
            try {
                const res = await fetch('/api/apn-ips');
                const ips = await res.json();
                const field = document.getElementById('cfgApnIp');
                if (ips.length > 0) {
                    autoApnIp = ips[0].ip;
                    field.value = 'âœ… ' + autoApnIp + ' (Ø®ÙˆØ¯Ú©Ø§Ø±)';
                } else {
                    field.value = 'âŒ IP Ø¢Ø²Ø§Ø¯ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª';
                }
            } catch(e) { document.getElementById('cfgApnIp').value = 'âŒ Ø®Ø·Ø§'; }

            // Tunnel200
            try {
                const res = await fetch('/api/tunnel200-ips');
                const pairs = await res.json();
                const hubField = document.getElementById('cfgTun200Hub');
                const brField = document.getElementById('cfgTun200Branch');
                if (pairs.length > 0) {
                    autoTunnel200 = pairs[0];
                    hubField.value = 'âœ… ' + autoTunnel200.hub_ip + ' (Ø®ÙˆØ¯Ú©Ø§Ø±)';
                    brField.value = 'âœ… ' + autoTunnel200.branch_ip + ' (Ø®ÙˆØ¯Ú©Ø§Ø±)';
                } else {
                    hubField.value = 'âŒ IP Ø¢Ø²Ø§Ø¯ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª';
                    brField.value = 'âŒ IP Ø¢Ø²Ø§Ø¯ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª';
                }
            } catch(e) {
                document.getElementById('cfgTun200Hub').value = 'âŒ Ø®Ø·Ø§';
                document.getElementById('cfgTun200Branch').value = 'âŒ Ø®Ø·Ø§';
            }
        }

        async function autoAssignForApnMali() {
            // Mali APN IP
            try {
                const res = await fetch('/api/mali-free-ips');
                const ips = await res.json();
                const field = document.getElementById('cfgMaliIp');
                if (ips.length > 0) {
                    autoMaliIp = ips[0].ip;
                    field.value = 'âœ… ' + autoMaliIp + ' (Ø®ÙˆØ¯Ú©Ø§Ø±)';
                } else {
                    field.value = 'âŒ IP Ø¢Ø²Ø§Ø¯ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª';
                }
            } catch(e) { document.getElementById('cfgMaliIp').value = 'âŒ Ø®Ø·Ø§'; }

            // Tunnel pair
            try {
                const res = await fetch('/api/free-tunnel-pairs');
                const tunnels = await res.json();
                const field = document.getElementById('cfgTunnelPairDisplay');
                if (tunnels.length > 0) {
                    autoTunnelPair = tunnels[0];
                    field.value = 'âœ… Tunnel ' + autoTunnelPair.tunnel_number + ' - Branch: ' + autoTunnelPair.tunnel_ip_branch + ' â†” HUB: ' + autoTunnelPair.tunnel_ip_hub;
                } else {
                    field.value = 'âŒ Tunnel Ø¢Ø²Ø§Ø¯ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª';
                }
            } catch(e) { document.getElementById('cfgTunnelPairDisplay').value = 'âŒ Ø®Ø·Ø§'; }
        }

        // ============ CONFIG GENERATORS (Exact match with APN pages) ============

        function lanNetwork(x, y) { return '10.' + x + '.' + y + '.0'; }

        function generateApnIntConfig() {
            const t = currentTicket;
            const x = t.octet2;
            const y = t.octet3;
            const routeName = document.getElementById('cfgRouteName').value.trim();
            const wanIface = document.getElementById('cfgWanIface').value.trim();
            const hubTunnelId = document.getElementById('cfgHubTunnelId').value.trim();
            const hubDescription = document.getElementById('cfgHubDesc').value.trim();
            const isSecondary = document.getElementById('cfgSecondary').checked;
            const ospfArea = x;

            if (!routeName) { alert('Ù„Ø·ÙØ§Ù‹ Route Name Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            if (!wanIface) { alert('Ù„Ø·ÙØ§Ù‹ WAN Interface Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            if (!hubTunnelId) { alert('Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Tunnel Ø±ÙˆÛŒ HUB Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            if (!hubDescription) { alert('Ù„Ø·ÙØ§Ù‹ HUB Tunnel Description Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            if (!autoApnIp) { alert('APN IP ØªØ®ØµÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯Ù‡. ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.'); return; }
            if (!autoTunnel200) { alert('Tunnel200 IP ØªØ®ØµÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯Ù‡. ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.'); return; }

            const FIXED_HUB_APN_IP = '10.250.66.1';
            const FIXED_ASR_NEXTHOP = '10.0.151.4';
            const FIXED_OSPF_PROCESS = '200';
            const branchApnIp = autoApnIp;
            const hubApnIp = FIXED_HUB_APN_IP;
            const tun200Hub = autoTunnel200.hub_ip;
            const tun200Branch = autoTunnel200.branch_ip;
            const branchName = t.branch_name;
            const loop2 = '10.210.' + x + '.' + y;
            const lanNet = lanNetwork(x, y);

            const secondaryNote = isSecondary ? '\n! âš ï¸ ØªÙˆØ¬Ù‡: IP Ø¨Ù‡ ØµÙˆØ±Øª SECONDARY Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ (Ø´Ø¹Ø¨Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ APN Ù…Ø§Ù„ÛŒ Ø¯Ø§Ø±Ø¯)\n! âš ï¸ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Crypto Ø§Ø² Ù‚Ø¨Ù„ Ø±ÙˆÛŒ Ø±ÙˆØªØ± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ Ùˆ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù†ÛŒØ³Øª\n!' : '';

            const cryptoConfig = isSecondary ? `!
! âš ï¸ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø§Ø² Ù‚Ø¨Ù„ Ø±ÙˆÛŒ Ø±ÙˆØªØ± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯ (APN Ù…Ø§Ù„ÛŒ) - Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ø§Ø¹Ù…Ø§Ù„ Ù…Ø¬Ø¯Ø¯ Ù†ÛŒØ³Øª
! crypto isakmp policy 101
! crypto isakmp key ... (already exists)
! crypto ipsec transform-set GILANETTS (already exists)
! crypto map GILANET (already exists)
!` : `!
crypto isakmp policy 101
 encr aes
 authentication pre-share
 group 2
!
crypto isakmp key G!l@n3tIntr@n3t address ${hubApnIp}
!
crypto ipsec transform-set GILANETTS esp-aes esp-sha-hmac
!
crypto map GILANET 10 ipsec-isakmp
 set peer ${hubApnIp}
 set transform-set GILANETTS
 match address GILANET-ACL
!`;

            const gilanetAcl = isSecondary ? `!
! âš ï¸ GILANET-ACL Ø§Ø² Ù‚Ø¨Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ - ÙÙ‚Ø· Ø§ÛŒÙ† Ø®Ø· Ø±Ø§ Ø¨Ù‡ Ø¢Ù† Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯:
! (config)# ip access-list extended GILANET-ACL
!          permit gre host ${branchApnIp} host ${hubApnIp}
!` : `!
ip access-list extended GILANET-ACL
 permit gre host ${branchApnIp} host ${hubApnIp}
!`;

            const branchCfg = `!
! ===== Branch Router (${branchName}) - APN ØºÛŒØ±Ù…Ø§Ù„ÛŒ =====${secondaryNote}
${cryptoConfig}
interface Loopback2
 ip address ${loop2} 255.255.255.255
!
interface Tunnel200
 description ** APN-INT-HUB **
 ip address ${tun200Branch} 255.255.255.254
 ip mtu 1460
 ip nat outside
 ip virtual-reassembly
 ip tcp adjust-mss 1420
 ip ospf hello-interval 100
 ip ospf dead-interval 300
 tunnel source ${branchApnIp}
 tunnel destination ${hubApnIp}
!${isSecondary ? '\n! âš ï¸ IP Ø²ÛŒØ± Ø¨Ù‡ ØµÙˆØ±Øª secondary Ø§Ø³Øª Ú†ÙˆÙ† Ø´Ø¹Ø¨Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ APN Ù…Ø§Ù„ÛŒ Ø¯Ø§Ø±Ø¯' : ''}
interface ${wanIface}
 ip address ${branchApnIp} 255.255.255.0${isSecondary ? ' secondary' : ''}
 ip virtual-reassembly
 crypto map GILANET
!
router ospf ${FIXED_OSPF_PROCESS}
 router-id ${loop2}
 log-adjacency-changes
 network ${tun200Branch} 0.0.0.0 area ${ospfArea}
 network ${loop2} 0.0.0.0 area ${ospfArea}
!
ip nat inside source list intnat interface Loopback2 overload
${gilanetAcl}
ip access-list extended intnat
 permit ip ${lanNet} 0.0.0.255 10.0.54.0 0.0.0.255
 permit ip ${lanNet} 0.0.0.255 10.0.55.0 0.0.0.255
 permit ip ${lanNet} 0.0.0.255 10.0.68.0 0.0.0.255
 permit ip ${lanNet} 0.0.0.255 10.0.76.0 0.0.0.255
 permit ip ${lanNet} 0.0.0.255 10.0.89.0 0.0.0.255
 permit ip ${lanNet} 0.0.0.255 host 10.0.97.26
 permit ip ${lanNet} 0.0.0.255 host 10.0.192.206
 permit ip ${lanNet} 0.0.0.255 host 10.42.8.129
 permit ip ${lanNet} 0.0.0.255 host 10.42.19.129
!`;

            const hubGilanetAcl = isSecondary ? `!
! âš ï¸ GILANET-AccessList Ø§Ø² Ù‚Ø¨Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ - ÙÙ‚Ø· Ø§ÛŒÙ† Ø®Ø· Ø±Ø§ Ø¨Ù‡ Ø¢Ù† Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯:
! (config)# ip access-list extended GILANET-AccessList
!          permit gre host ${hubApnIp} host ${branchApnIp}
!` : `!
ip access-list extended GILANET-AccessList
 permit gre host ${hubApnIp} host ${branchApnIp}
!`;

            const hubCfg = `!
! ===== APN-INT-HUB Router =====${isSecondary ? '\n! âš ï¸ Ø´Ø¹Ø¨Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ APN Ù…Ø§Ù„ÛŒ Ø¯Ø§Ø±Ø¯ - ÙÙ‚Ø· ACL entry Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯' : ''}
!
interface Tunnel${hubTunnelId}
 description ** ${hubDescription} **
 ip address ${tun200Hub} 255.255.255.254
 ip mtu 1460
 ip virtual-reassembly
 ip tcp adjust-mss 1420
 ip ospf hello-interval 100
 ip ospf dead-interval 300
 ip ospf mtu-ignore
 tunnel source ${hubApnIp}
 tunnel destination ${branchApnIp}
!
router ospf ${FIXED_OSPF_PROCESS}
 network ${tun200Hub} 0.0.0.0 area ${ospfArea}
${hubGilanetAcl}`;

            const asrCfg = `!
! ===== ASR1006-WAN-MB =====
ip route ${loop2} 255.255.255.255 ${FIXED_ASR_NEXTHOP} name ${routeName}-APN-INT
!`;

            const fullConfig = branchCfg + '\n\n' + hubCfg + '\n\n' + asrCfg;
            saveAndShowConfig('apn_int', fullConfig);
        }

        function generateApnMaliConfig() {
            const t = currentTicket;
            const x = t.octet2;
            const y = t.octet3;
            const branchNameEn = document.getElementById('cfgBranchNameEn').value.trim();
            const wanIface = document.getElementById('cfgWanIface').value.trim();
            const hubTunnelNum = document.getElementById('cfgHubTunnelNum').value.trim();
            const includeBase = document.getElementById('cfgIncludeBase').checked;
            const routerHostname = includeBase ? (document.getElementById('cfgRouterHostname').value.trim() || branchNameEn) : '';
            const ospfArea = x;

            if (!branchNameEn) { alert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø´Ø¹Ø¨Ù‡ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            if (!wanIface) { alert('Ù„Ø·ÙØ§Ù‹ WAN Interface Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            if (!hubTunnelNum) { alert('Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Tunnel Ø±ÙˆÛŒ HUB Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            if (!autoMaliIp) { alert('APN Ù…Ø§Ù„ÛŒ IP ØªØ®ØµÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯Ù‡. ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.'); return; }
            if (!autoTunnelPair) { alert('Tunnel pair ØªØ®ØµÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯Ù‡. ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.'); return; }

            const FIXED_HUB_IP = '10.250.46.1';
            const CRYPTO_KEY = 'G!l@n3tAcc3ss';
            const OSPF_PROCESS = '2';
            const apnIpBranch = autoMaliIp;
            const tunnelIpBranch = autoTunnelPair.tunnel_ip_branch;
            const tunnelIpHub = autoTunnelPair.tunnel_ip_hub;
            const hubTunnelInterface = 'Tunnel' + hubTunnelNum;
            const branchName = t.branch_name;

            // Calculate Router-ID
            const tunnelParts = tunnelIpBranch.split('.');
            const tunnelSecondOctet = tunnelParts[1] || '250';
            const routerId = '10.' + tunnelSecondOctet + '.' + x + '.' + y;

            let branchCfg = '';

            // Base Config
            if (includeBase) {
                branchCfg = `!
! ========================================================
! ===== BASE CONFIGURATION - First Time Setup =====
! ========================================================
!
service timestamps debug datetime msec
service timestamps log datetime msec
no service password-encryption
!
hostname ${routerHostname}
!
boot-start-marker
boot-end-marker
!
enable secret 5 $1$1kQA$TOB1eE4SmnYjXXjtxUXus0
!
aaa new-model
!
aaa authentication login CACS group tacacs+ local
aaa authentication enable default group tacacs+ enable
aaa authorization console
aaa authorization config-commands
aaa authorization exec CACS group tacacs+ local
aaa authorization commands 0 CACS group tacacs+ local
aaa authorization commands 1 CACS group tacacs+ local
aaa authorization commands 2 CACS group tacacs+ local
aaa authorization commands 3 CACS group tacacs+ local
aaa authorization commands 15 CACS group tacacs+ local
aaa accounting exec CACS start-stop group tacacs+
aaa accounting commands 0 CACS start-stop group tacacs+
aaa accounting commands 1 CACS start-stop group tacacs+
aaa accounting commands 2 CACS start-stop group tacacs+
aaa accounting commands 3 CACS start-stop group tacacs+
aaa accounting commands 15 CACS start-stop group tacacs+
!
aaa session-id common
clock timezone Tehran 3 30
ip cef
!
no ip domain lookup
ip domain name agri-bank.com
ip ssh time-out 120
ip ssh version 2
ip ssh port 2001 rotary 1
crypto key generate rsa
768
!
ip ssh authentication-retries 2
!
!
username bkiadmin privilege 15 secret 5 $1$y/X2$m2zhThmBZUcxNZ56uEQvA1
!
track 5 ip route 10.0.0.0 255.255.0.0 reachability
!
`;
            }

            // APN Mali Config
            branchCfg += `!
! ===== Branch Router (${branchName}) - APN Ù…Ø§Ù„ÛŒ =====
!
crypto isakmp policy 10
 encr aes
 authentication pre-share
 group 2
crypto isakmp key ${CRYPTO_KEY} address ${FIXED_HUB_IP}
crypto isakmp invalid-spi-recovery
!
crypto ipsec transform-set GILANETTS esp-aes esp-sha-hmac
!
crypto map GILANET 10 ipsec-isakmp
 set peer ${FIXED_HUB_IP}
 set transform-set GILANETTS
 match address GILANET-ACL
!
interface Loopback0
 ip address 10.${x}.254.${y} 255.255.255.255
!
interface Tunnel156
 description ** Gilanet **
 ip address ${tunnelIpBranch} 255.255.255.254
 ip ospf hello-interval 100
 ip ospf dead-interval 300
 ip ospf priority 0
 tunnel source ${apnIpBranch}
 tunnel destination ${FIXED_HUB_IP}
!`;

            if (includeBase) {
                branchCfg += `
!
interface FastEthernet0/0
 description ** LAN **
 ip address 10.${x}.${y}.5 255.255.255.0
 ip access-group ETHERNET_IN in
 duplex auto
 speed auto
 standby 1 ip 10.${x}.${y}.1
 standby 1 timers 1 3
 standby 1 preempt
 standby 1 track 5 decrement 25
!`;
            }

            branchCfg += `
interface ${wanIface}
 description ** Gilanet **
 ip address ${apnIpBranch} 255.255.248.0
 duplex auto
 speed auto
 crypto map GILANET
!
router ospf ${OSPF_PROCESS}
 router-id ${routerId}
 log-adjacency-changes
 passive-interface default
 no passive-interface Tunnel156
 network 10.${x}.${y}.5 0.0.0.0 area ${ospfArea}
 network 10.${x}.254.${y} 0.0.0.0 area ${ospfArea}
 network ${tunnelIpBranch} 0.0.0.0 area ${ospfArea}
 distribute-list OSPF-PERMIT in
!`;

            if (includeBase) {
                branchCfg += `
ip forward-protocol nd
!
no ip http server
no ip http secure-server
ip tacacs source-interface Loopback0
!
ip access-list standard OSPF-PERMIT
 permit 10.0.0.0 0.0.255.255
ip access-list standard SNMP-READ
 permit 10.0.50.0 0.0.1.255
ip access-list standard SNMP-WRITE
 permit 10.0.51.49
 permit 10.0.51.48
ip access-list standard TELNET_ACCESS
 permit 10.250.46.1
 permit 10.0.50.0 0.0.1.255
 permit 10.${x}.${y}.6 0.0.0.1
!
ip access-list extended ETHERNET_IN
 deny   tcp any any range 135 139
 deny   tcp any any eq 445
 deny   udp any any range 135 netbios-ss
 deny   udp any any eq 1434
 deny   udp any any eq 1433
 deny   tcp any any eq 1026
 deny   tcp any any eq 4444
 deny   udp any any eq 445
 permit ip 10.${x}.${y}.0 0.0.0.255 192.168.65.0 0.0.0.255
 permit ip 10.${x}.${y}.0 0.0.0.255 192.168.72.0 0.0.0.255
 permit udp 10.${x}.${y}.0 0.0.0.255 224.0.0.0 0.0.0.255
 permit ip 10.${x}.${y}.0 0.0.0.255 10.${x}.${y}.0 0.0.0.255
 permit ip 10.${x}.${y}.0 0.0.0.255 10.0.0.0 0.0.255.255
 permit ip 10.${x}.${y}.0 0.0.0.255 10.${x}.0.0 0.0.7.255
ip access-list extended GILANET-ACL
 permit gre host ${apnIpBranch} host ${FIXED_HUB_IP}
!
logging 10.0.51.63
snmp-server group LMS v3 priv read myview write myview access SNMP-WRITE
snmp-server group NMS v3 priv access SNMP-READ
snmp-server view myview mib-2 included
snmp-server view myview system included
snmp-server view myview cisco included
snmp-server ifindex persist
!
tacacs-server host 10.0.51.56
tacacs-server host 10.0.51.57
tacacs-server directed-request
tacacs-server key 7 1324045C445D577A
!
control-plane
!
banner motd ^C
        ===
       -+ +-
       | | |
    <--\\\\ | /-->
   ##| ||||| |##
  ###| |+++| |###
 /____\\\\\\\\ | //____\\\\ ********************************************************
   <###\\\\|||/###>                  Keshavarzi Bank Network
    +====+====+     WARNING: Access is restricted to authorized users only.
    | WAN-BKI |     Unauthorized access is a violation of state , civil and
    +===+=+===+                       criminal laws.
        +=+        ********************************************************
^C
privilege interface level 3 shutdown
privilege interface level 3 no shutdown
privilege interface level 3 no
privilege configure level 3 interface
privilege exec level 3 traceroute
privilege exec level 3 ping
privilege exec level 3 configure terminal
privilege exec level 3 configure
privilege exec level 3 reload
privilege exec level 3 terminal monitor
privilege exec level 3 terminal
privilege exec all level 3 show running-config
privilege exec level 3 show
!
line con 0
 authorization exec CACS
 login authentication CACS
line aux 0
 no exec
line vty 0 4
 privilege level 15
 authorization exec CACS
 accounting exec CACS
 login authentication CACS
 transport input ssh
 transport output ssh
line vty 5 15
 privilege level 15
 authorization exec CACS
 accounting exec CACS
 login authentication CACS
 transport input ssh
 transport output ssh
!
scheduler allocate 20000 1000
ntp authenticate
ntp trusted-key 1
ntp clock-period 17178037
ntp source Loopback0
ntp update-calendar
ntp server 10.0.51.27
!
end`;
            } else {
                branchCfg += `
ip access-list standard OSPF-PERMIT
 permit 10.0.0.0 0.0.255.255
!
ip access-list extended GILANET-ACL
 permit gre host ${apnIpBranch} host ${FIXED_HUB_IP}
!
end`;
            }

            const hubCfg = `!
! ===== ISR-APN-RO (HUB) - ${branchNameEn} =====
!
interface ${hubTunnelInterface}
 description ** Gilanet-${branchNameEn} **
 ip address ${tunnelIpHub} 255.255.255.254
 ip ospf dead-interval 300
 ip ospf hello-interval 100
 tunnel source ${FIXED_HUB_IP}
 tunnel destination ${apnIpBranch}
!
router ospf ${OSPF_PROCESS}
 network ${tunnelIpHub} 0.0.0.0 area ${ospfArea}
!
end`;

            const fullConfig = branchCfg + '\n\n' + hubCfg;
            saveAndShowConfig('apn_mali', fullConfig);
        }

        async function saveAndShowConfig(configType, configOutput) {
            // Save to server
            try {
                const res = await fetch(`/api/tickets/${currentTicket.id}/generate-config`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        config_type: configType,
                        config_output: configOutput,
                        username: currentUser
                    })
                });
                const data = await res.json();
                if (data.success) {
                    const tres = await fetch(`/api/tickets/${currentTicket.id}`);
                    currentTicket = await tres.json();
                    renderTicketModal();
                } else {
                    alert(data.error || 'Ø®Ø·Ø§');
                }
            } catch (err) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        // ============ STAGE: CONFIG GENERATED ============
        function renderStageConfigGenerated() {
            const t = currentTicket;
            const configTypeLabel = t.config_type === 'apn_int' ? 'APN ØºÛŒØ±Ù…Ø§Ù„ÛŒ' : 'APN Ù…Ø§Ù„ÛŒ';

            return `
                <div class="info-box" style="border-color: rgba(16,185,129,0.3); background: rgba(16,185,129,0.08);">
                    âœ… IP: ${t.assigned_ip} | Ù†Ù‚Ø·Ù‡: ${t.branch_name} | Ù†ÙˆØ¹ Ú©Ø§Ù†ÙÛŒÚ¯: ${configTypeLabel}
                </div>

                <h4 style="margin-bottom: 12px;">âš™ï¸ Ú©Ø§Ù†ÙÛŒÚ¯ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡:</h4>
                <div class="config-box">${t.config_output}</div>

                <div style="display: flex; gap: 10px; margin-top: 16px;">
                    <button class="btn btn-secondary" onclick="copyConfig()" style="flex:1;">ğŸ“‹ Ú©Ù¾ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯</button>
                    <button class="btn btn-success" onclick="sendReply()" style="flex:1;">ğŸ“§ Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø® (Ø±ÛŒÙ¾Ù„Ø§ÛŒ Ø§ÛŒÙ…ÛŒÙ„)</button>
                </div>

                <div id="replyPreviewArea" style="display:none; margin-top: 16px;">
                    <div class="reply-preview">
                        <h4>ğŸ“§ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø±ÛŒÙ¾Ù„Ø§ÛŒ:</h4>
                        <div style="margin-top: 10px; font-size: 13px; line-height: 1.8; color: var(--text-secondary);">
                            <div><strong>To:</strong> ${t.email_sender}</div>
                            <div><strong>Subject:</strong> Re: ${t.email_subject}</div>
                            <hr style="border-color: var(--border-color); margin: 10px 0;">
                            <div style="direction: rtl;">
                                Ø³Ù„Ø§Ù… Ùˆ Ø§Ø­ØªØ±Ø§Ù…<br><br>
                                IP Ø§Ø®ØªØµØ§Øµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡: <strong>${t.assigned_ip}</strong><br>
                                Ù†ÙˆØ¹ Ú©Ø§Ù†ÙÛŒÚ¯: <strong>${configTypeLabel}</strong><br>
                                Ù†Ù‚Ø·Ù‡: <strong>${t.branch_name}</strong> (${t.province})<br><br>
                                Ú©Ø§Ù†ÙÛŒÚ¯ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ Ø¨Ù‡ Ù¾ÛŒÙˆØ³Øª Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.<br><br>
                                Ø¨Ø§ ØªØ´Ú©Ø±<br>
                                ÙˆØ§Ø­Ø¯ Ø´Ø¨Ú©Ù‡
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="confirmSendReply()" style="width:100%; margin-top: 12px;">
                        âœ… ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„
                    </button>
                </div>
            `;
        }

        function copyConfig() {
            navigator.clipboard.writeText(currentTicket.config_output).then(() => {
                alert('Ú©Ø§Ù†ÙÛŒÚ¯ Ú©Ù¾ÛŒ Ø´Ø¯');
            });
        }

        function sendReply() {
            document.getElementById('replyPreviewArea').style.display = 'block';
        }

        async function confirmSendReply() {
            try {
                const res = await fetch(`/api/tickets/${currentTicket.id}/send-reply`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: currentUser })
                });
                const data = await res.json();
                if (data.success) {
                    const tres = await fetch(`/api/tickets/${currentTicket.id}`);
                    currentTicket = await tres.json();
                    renderTicketModal();
                } else {
                    alert(data.error || 'Ø®Ø·Ø§');
                }
            } catch (err) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        // ============ STAGE: REPLIED ============
        function renderStageReplied() {
            const t = currentTicket;
            const configTypeLabel = t.config_type === 'apn_int' ? 'APN ØºÛŒØ±Ù…Ø§Ù„ÛŒ' : 'APN Ù…Ø§Ù„ÛŒ';

            return `
                <div class="info-box" style="border-color: rgba(16,185,129,0.3); background: rgba(16,185,129,0.08);">
                    âœ… <strong>ØªÛŒÚ©Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡</strong> - Ù¾Ø§Ø³Ø® Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 16px;">
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); border-radius: 10px; padding: 14px;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">IP Ø§Ø®ØªØµØ§Øµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--accent-green); font-family: monospace;">${t.assigned_ip}</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); border-radius: 10px; padding: 14px;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Ù†ÙˆØ¹ Ú©Ø§Ù†ÙÛŒÚ¯</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--accent-purple);">${configTypeLabel}</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); border-radius: 10px; padding: 14px;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Ù†Ù‚Ø·Ù‡</div>
                        <div style="font-size: 14px; font-weight: 600;">${t.branch_name} (${t.point_type})</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); border-radius: 10px; padding: 14px;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Ø§Ø³ØªØ§Ù†</div>
                        <div style="font-size: 14px; font-weight: 600;">${t.province}</div>
                    </div>
                </div>

                <h4 style="margin-bottom: 10px;">âš™ï¸ Ú©Ø§Ù†ÙÛŒÚ¯:</h4>
                <div class="config-box" style="max-height: 250px;">${t.config_output}</div>
                <button class="btn btn-secondary" onclick="copyConfig()" style="width: 100%; margin-top: 10px;">ğŸ“‹ Ú©Ù¾ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯</button>
            `;
        }

        // ============ INIT ============
        loadEmails();
    </script>
</body>
</html>