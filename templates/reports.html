<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>گزارش سرویس نقاط شبکه</title>
<style>
:root {
    --bg-primary: #0a0e1a; --bg-secondary: #111827; --bg-card: rgba(17,24,39,0.85);
    --text-primary: #e2e8f0; --text-secondary: #94a3b8; --text-muted: #64748b;
    --border-color: rgba(255,255,255,0.08); --input-bg: rgba(15,23,42,0.8);
    --input-border: rgba(255,255,255,0.2); --accent-blue: #3b82f6; --accent-green: #10b981;
}
[data-theme="light"] {
    --bg-primary: #f1f5f9; --bg-secondary: #e2e8f0; --bg-card: #ffffff;
    --text-primary: #0f172a; --text-secondary: #334155; --text-muted: #475569;
    --border-color: rgba(0,0,0,0.12); --input-bg: #fff; --input-border: rgba(0,0,0,0.2);
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
    color: var(--text-primary); min-height: 100vh;
}
.header {
    background: rgba(10,14,26,0.95); backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border-color); padding: 12px 24px;
    display: flex; align-items: center; justify-content: space-between;
}
.header h1 { font-size: 18px; display: flex; align-items: center; gap: 10px; }
.back-btn {
    display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px;
    border-radius: 8px; text-decoration: none; background: rgba(255,255,255,0.06);
    color: var(--text-primary); font-size: 13px; border: 1px solid var(--border-color);
}
.container { max-width: 1200px; margin: 24px auto; padding: 0 20px; }
.card {
    background: var(--bg-card); border: 1px solid var(--border-color);
    border-radius: 16px; padding: 24px; margin-bottom: 20px; backdrop-filter: blur(10px);
}
.card-title { font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
.filters {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;
}
.filter-group label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; font-weight: 600; }
.filter-group select, .filter-group input {
    width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--input-border);
    background: var(--input-bg); color: var(--text-primary); font-size: 13px;
}
.btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
.btn {
    padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;
    font-size: 13px; font-weight: 700; transition: all 0.2s;
    display: inline-flex; align-items: center; gap: 6px;
}
.btn-primary { background: var(--accent-blue); color: #fff; }
.btn-primary:hover { background: #2563eb; }
.btn-success { background: var(--accent-green); color: #fff; }
.btn-success:hover { background: #059669; }
.btn-outline {
    background: transparent; border: 1px solid var(--border-color); color: var(--text-primary);
}
.stats-row { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
.stat-chip {
    background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2);
    border-radius: 8px; padding: 8px 14px; font-size: 13px; display: flex; align-items: center; gap: 6px;
}
.stat-chip .num { font-weight: 700; color: var(--accent-blue); }
.results-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.results-table thead { background: rgba(59,130,246,0.1); }
.results-table th {
    padding: 10px 8px; text-align: right; font-weight: 700; font-size: 11px;
    color: var(--accent-blue); border-bottom: 2px solid rgba(59,130,246,0.2);
    white-space: nowrap;
}
.results-table td {
    padding: 8px; border-bottom: 1px solid var(--border-color); vertical-align: middle;
}
.results-table tr:hover { background: rgba(255,255,255,0.03); }
.svc-badge {
    display: inline-block; padding: 2px 8px; border-radius: 4px;
    font-size: 10px; font-weight: 700; white-space: nowrap;
}
.svc-mpls { background: rgba(139,92,246,0.2); color: #a78bfa; }
.svc-intranet { background: rgba(6,182,212,0.2); color: #22d3ee; }
.svc-apn { background: rgba(16,185,129,0.2); color: #34d399; }
.svc-ptmp { background: rgba(245,158,11,0.2); color: #fbbf24; }
.loading { text-align: center; padding: 40px; color: var(--text-muted); }
.empty { text-align: center; padding: 40px; color: var(--text-muted); font-size: 14px; }
.table-wrap { overflow-x: auto; }
.pagination {
    display: flex; justify-content: center; gap: 6px; margin-top: 16px; flex-wrap: wrap;
}
.pagination button {
    padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-color);
    background: rgba(255,255,255,0.05); color: var(--text-primary); cursor: pointer;
    font-size: 12px; transition: all 0.2s;
}
.pagination button.active { background: var(--accent-blue); color: #fff; border-color: var(--accent-blue); font-weight: 700; }
.theme-toggle {
    background: none; border: 1px solid var(--border-color); color: var(--text-primary);
    padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 14px;
}
</style>
</head>
<body>
<div class="header">
    <h1>&#128202; گزارش سرویس نقاط شبکه</h1>
    <div style="display:flex; align-items:center; gap:10px;">
        <button class="theme-toggle" onclick="toggleTheme()">&#127763;</button>
        <a href="/" class="back-btn">&#8592; صفحه اصلی</a>
    </div>
</div>

<div class="container">
    <!-- Filters -->
    <div class="card">
        <div class="card-title">&#128270; فیلترهای گزارش</div>
        <div class="filters">
            <div class="filter-group">
                <label>استان</label>
                <select id="filterProvince"><option value="">همه استان‌ها</option></select>
            </div>
            <div class="filter-group">
                <label>نوع سرویس</label>
                <select id="filterService">
                    <option value="all">همه سرویس‌ها</option>
                    <option value="MPLS/VPLS">MPLS / VPLS</option>
                    <option value="Intranet">Intranet</option>
                    <option value="APN">APN (مالی + غیرمالی)</option>
                    <option value="PTMP">PTMP Serial</option>
                </select>
            </div>
            <div class="filter-group">
                <label>نوع نقطه</label>
                <select id="filterPointType">
                    <option value="">همه نقاط</option>
                    <option value="شعبه">شعبه</option>
                    <option value="ATM">ATM / خودپرداز</option>
                    <option value="باجه">باجه</option>
                    <option value="کیوسک">کیوسک</option>
                    <option value="24 ساعته">24 ساعته</option>
                    <option value="VSAT">VSAT</option>
                </select>
            </div>
        </div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="runQuery()">&#128269; جستجو و تولید گزارش</button>
            <button class="btn btn-success" onclick="exportExcel()">&#128196; خروجی Excel</button>
            <button class="btn btn-outline" onclick="clearFilters()">&#128260; پاک کردن فیلترها</button>
        </div>
    </div>

    <!-- Results -->
    <div class="card" id="resultsCard" style="display:none;">
        <div class="card-title">&#128203; نتایج گزارش</div>
        <div class="stats-row" id="statsRow"></div>
        <div class="table-wrap">
            <table class="results-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>سرویس</th>
                        <th>استان</th>
                        <th>نام نقطه</th>
                        <th>نوع</th>
                        <th>IP</th>
                        <th>WAN IP</th>
                        <th>Tunnel</th>
                        <th>کاربر</th>
                        <th>تاریخ</th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>
        </div>
        <div class="pagination" id="pagination"></div>
    </div>
</div>

<script>
// Theme
function toggleTheme() {
    const c = document.documentElement.getAttribute('data-theme');
    document.documentElement.setAttribute('data-theme', c === 'light' ? '' : 'light');
    localStorage.setItem('theme', c === 'light' ? 'dark' : 'light');
}
(function(){ if(localStorage.getItem('theme')==='light') document.documentElement.setAttribute('data-theme','light'); })();

let allResults = [];
let rPage = 1;
const PER_PAGE = 20;

// Load provinces
async function loadProvinces() {
    try {
        const res = await fetch('/api/reports/provinces');
        const provinces = await res.json();
        const sel = document.getElementById('filterProvince');
        provinces.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p; opt.textContent = p;
            sel.appendChild(opt);
        });
    } catch(e) { console.error(e); }
}

function getQueryParams() {
    return new URLSearchParams({
        province: document.getElementById('filterProvince').value,
        service_type: document.getElementById('filterService').value,
        point_type: document.getElementById('filterPointType').value
    });
}

async function runQuery() {
    const card = document.getElementById('resultsCard');
    const body = document.getElementById('resultsBody');
    card.style.display = 'block';
    body.innerHTML = '<tr><td colspan="10" class="loading">در حال جستجو...</td></tr>';
    document.getElementById('statsRow').innerHTML = '';
    document.getElementById('pagination').innerHTML = '';

    try {
        const params = getQueryParams();
        const res = await fetch('/api/reports/query?' + params.toString());
        const data = await res.json();
        allResults = data.results || [];
        rPage = 1;

        // Stats
        const stats = {};
        allResults.forEach(r => { stats[r.service] = (stats[r.service]||0)+1; });
        let statsHtml = `<div class="stat-chip">&#128203; مجموع: <span class="num">${allResults.length}</span></div>`;
        Object.entries(stats).forEach(([k,v]) => {
            statsHtml += `<div class="stat-chip">${k}: <span class="num">${v}</span></div>`;
        });
        document.getElementById('statsRow').innerHTML = statsHtml;

        renderResultsPage();
    } catch(e) {
        body.innerHTML = `<tr><td colspan="10" class="empty">خطا: ${e.message}</td></tr>`;
    }
}

function svcBadgeClass(svc) {
    if (svc.includes('MPLS') || svc.includes('VPLS')) return 'svc-mpls';
    if (svc.includes('Intranet')) return 'svc-intranet';
    if (svc.includes('APN')) return 'svc-apn';
    if (svc.includes('PTMP')) return 'svc-ptmp';
    return '';
}

function renderResultsPage() {
    const body = document.getElementById('resultsBody');
    const start = (rPage-1)*PER_PAGE;
    const page = allResults.slice(start, start+PER_PAGE);

    if (allResults.length === 0) {
        body.innerHTML = '<tr><td colspan="10" class="empty">نتیجه‌ای یافت نشد</td></tr>';
        document.getElementById('pagination').innerHTML = '';
        return;
    }

    body.innerHTML = page.map((r, i) => `
        <tr>
            <td>${start+i+1}</td>
            <td><span class="svc-badge ${svcBadgeClass(r.service)}">${esc(r.service)}</span></td>
            <td>${esc(r.province)}</td>
            <td style="font-weight:600;">${esc(r.branch_name)}</td>
            <td>${esc(r.point_type)}</td>
            <td style="direction:ltr;font-family:monospace;font-size:11px;">${esc(r.ip)}</td>
            <td style="direction:ltr;font-family:monospace;font-size:11px;">${esc(r.wan_ip)}</td>
            <td style="font-size:11px;">${esc(r.tunnel_name)}</td>
            <td>${esc(r.username)}</td>
            <td style="font-size:11px;">${esc(r.date)}</td>
        </tr>
    `).join('');

    // Pagination
    const totalPages = Math.ceil(allResults.length / PER_PAGE);
    let pagHtml = '';
    if (totalPages > 1) {
        pagHtml += `<button onclick="goPage(${rPage-1})" ${rPage===1?'disabled':''}>&#9664;</button>`;
        for (let i = 1; i <= totalPages; i++) {
            if (totalPages > 10 && i > 3 && i < totalPages - 1 && Math.abs(i-rPage) > 1) {
                if (i === 4 || i === totalPages-2) pagHtml += '<span style="color:var(--text-muted);">...</span>';
                continue;
            }
            pagHtml += `<button class="${i===rPage?'active':''}" onclick="goPage(${i})">${i}</button>`;
        }
        pagHtml += `<button onclick="goPage(${rPage+1})" ${rPage===totalPages?'disabled':''}>&#9654;</button>`;
    }
    document.getElementById('pagination').innerHTML = pagHtml;
}

function goPage(p) {
    const totalPages = Math.ceil(allResults.length / PER_PAGE);
    if (p < 1 || p > totalPages) return;
    rPage = p;
    renderResultsPage();
}

function exportExcel() {
    const params = getQueryParams();
    window.open('/api/reports/export/excel?' + params.toString(), '_blank');
}

function clearFilters() {
    document.getElementById('filterProvince').value = '';
    document.getElementById('filterService').value = 'all';
    document.getElementById('filterPointType').value = '';
}

function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

loadProvinces();
</script>
</body>
</html>
