<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ویزارد پیکربندی شبکه</title>
  <style>
/* ========== THEME VARIABLES ========== */
:root {
    --bg-primary: #0a0e1a;
    --bg-secondary: #111827;
    --bg-card: rgba(17, 24, 39, 0.85);
    --bg-header: rgba(10, 14, 26, 0.95);
    --text-primary: #e2e8f0;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --border-color: rgba(255, 255, 255, 0.08);
    --shadow-color: rgba(0, 0, 0, 0.4);
    --accent-green: #10b981;
    --accent-blue: #3b82f6;
    --accent-purple: #8b5cf6;
    --accent-orange: #f59e0b;
    --accent-pink: #ec4899;
    --accent-cyan: #06b6d4;
    --card-hover: rgba(255, 255, 255, 0.04);
    --input-bg: rgba(15, 23, 42, 0.8);
    --input-border: rgba(255, 255, 255, 0.2);
}
[data-theme="light"] {
    --bg-primary: #f1f5f9;
    --bg-secondary: #e2e8f0;
    --bg-card: rgba(255, 255, 255, 0.9);
    --bg-header: rgba(255, 255, 255, 0.95);
    --text-primary: #0f172a;
    --text-secondary: #1e293b;
    --text-muted: #334155;
    --border-color: rgba(0, 0, 0, 0.1);
    --shadow-color: rgba(0, 0, 0, 0.08);
    --accent-green: #059669;
    --accent-blue: #2563eb;
    --accent-purple: #7c3aed;
    --accent-orange: #d97706;
    --accent-pink: #db2777;
    --accent-cyan: #0891b2;
    --card-hover: rgba(0, 0, 0, 0.03);
    --input-bg: #ffffff;
    --input-border: rgba(0, 0, 0, 0.2);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: var(--bg-primary);
    min-height: 100vh;
    color: var(--text-primary);
    font-size: 16px;
    line-height: 1.6;
    overflow-x: hidden;
}

/* ========== ANIMATED BACKGROUND ========== */
.bg-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
.bg-animation::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('/static/background.jpg'); background-size: cover; background-position: center; opacity: 0.3; }
.bg-animation::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, rgba(10,14,26,0.7) 0%, rgba(17,24,39,0.9) 100%); }
[data-theme="light"] .bg-animation::before { opacity: 0.4; }
[data-theme="light"] .bg-animation::after { background: linear-gradient(180deg, rgba(241,245,249,0.8) 0%, rgba(226,232,240,0.9) 100%); }

.orb { position: fixed; border-radius: 50%; filter: blur(80px); opacity: 0.15; pointer-events: none; z-index: -1; }
.orb-1 { width: 600px; height: 600px; background: radial-gradient(circle, #3b82f6, transparent 70%); top: -200px; right: -100px; animation: orbFloat1 20s ease-in-out infinite; }
.orb-2 { width: 500px; height: 500px; background: radial-gradient(circle, #8b5cf6, transparent 70%); bottom: -150px; left: -100px; animation: orbFloat2 25s ease-in-out infinite; }
[data-theme="light"] .orb { opacity: 0.08; }
@keyframes orbFloat1 { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(-80px, 60px) scale(1.1); } 66% { transform: translate(40px, -40px) scale(0.9); } }
@keyframes orbFloat2 { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(60px, -80px) scale(1.15); } 66% { transform: translate(-50px, 30px) scale(0.85); } }

/* ========== HEADER ========== */
.header { background: var(--bg-header); backdrop-filter: blur(24px); padding: 12px 32px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 40px rgba(0,0,0,0.2); }
[data-theme="light"] .header { box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
.logo { display: flex; align-items: center; gap: 12px; }
.logo h1 { font-size: 1.4rem; font-weight: 700; color: var(--text-primary); }
.header-actions { display: flex; align-items: center; gap: 12px; }
.theme-toggle { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: all 0.3s ease; }
.theme-toggle:hover { transform: scale(1.1) rotate(15deg); }
.user-info { display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: rgba(59, 130, 246, 0.1); border-radius: 25px; font-size: 14px; font-weight: 600; }
.back-btn { padding: 8px 18px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; text-decoration: none; transition: all 0.3s ease; }
.back-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4); }
.logout-btn { padding: 8px 18px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.3s ease; }

/* ========== CONTAINER ========== */
.container { max-width: 900px; margin: 0 auto; padding: 32px 24px; }

/* ========== TITLE ========== */
.wizard-title { text-align: center; margin-bottom: 32px; animation: fadeInUp 0.5s ease forwards; }
.wizard-title h2 { font-size: 1.8rem; font-weight: 800; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 8px; }
.wizard-title p { color: var(--text-secondary); font-size: 15px; }

/* ========== BREADCRUMB STEPPER ========== */
.breadcrumb-stepper {
    display: flex; align-items: center; justify-content: center; flex-wrap: wrap;
    gap: 6px; margin-bottom: 32px; padding: 16px 20px;
    background: var(--bg-card); border: 1px solid var(--border-color);
    border-radius: 16px; animation: fadeInUp 0.5s ease 0.1s forwards; opacity: 0;
}
.bc-item {
    display: flex; align-items: center; gap: 6px;
    padding: 6px 14px; border-radius: 10px; font-size: 13px; font-weight: 600;
    transition: all 0.3s ease;
}
.bc-item.completed { background: rgba(16, 185, 129, 0.1); color: var(--accent-green); }
.bc-item.active { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); border: 1px solid rgba(59, 130, 246, 0.3); }
.bc-item.pending { color: var(--text-muted); opacity: 0.5; }
.bc-arrow { color: var(--text-muted); font-size: 14px; opacity: 0.4; }
.bc-check { color: var(--accent-green); }

/* ========== WIZARD CARD ========== */
.wizard-card {
    background: var(--bg-card); backdrop-filter: blur(20px);
    border-radius: 24px; border: 1px solid var(--border-color); overflow: hidden;
    box-shadow: 0 20px 60px var(--shadow-color);
    animation: cardSlideIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    opacity: 0; animation-delay: 0.2s;
}
[data-theme="light"] .wizard-card { box-shadow: 0 4px 24px rgba(0,0,0,0.08); }
@keyframes cardSlideIn { from { opacity: 0; transform: translateY(30px) scale(0.97); } to { opacity: 1; transform: translateY(0) scale(1); } }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

.wizard-card-header { padding: 24px 32px; border-bottom: 1px solid var(--border-color); background: rgba(255,255,255,0.015); }
.wizard-card-header h3 { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
.wizard-card-header p { font-size: 14px; color: var(--text-secondary); margin-top: 4px; }
.wizard-card-body { padding: 32px; }

/* ========== OPTION CARDS ========== */
.options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; }
@media (max-width: 500px) { .options-grid { grid-template-columns: 1fr; } }

.option-card {
    background: var(--bg-secondary); border: 2px solid var(--border-color);
    border-radius: 16px; padding: 24px 16px; text-align: center;
    cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative; overflow: hidden;
}
.option-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; opacity: 0; transition: opacity 0.3s; }
.option-card:hover { transform: translateY(-6px) scale(1.02); border-color: rgba(59, 130, 246, 0.4); box-shadow: 0 16px 40px rgba(59, 130, 246, 0.1); }
.option-card.selected { border-color: var(--accent-blue); background: rgba(59, 130, 246, 0.08); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15), 0 16px 40px rgba(59, 130, 246, 0.12); }
.option-card.selected::before { opacity: 1; background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple)); }
.option-card.disabled { opacity: 0.45; cursor: not-allowed; pointer-events: none; }

.option-icon { font-size: 2.8rem; margin-bottom: 10px; display: block; transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
.option-card:hover .option-icon { transform: scale(1.15) translateY(-4px); }
.option-title { font-size: 15px; font-weight: 700; margin-bottom: 4px; color: var(--text-primary); }
.option-desc { font-size: 12px; color: var(--text-muted); line-height: 1.5; }
.option-badge { display: inline-block; margin-top: 8px; padding: 3px 10px; border-radius: 999px; font-size: 11px; font-weight: 600; }
.option-badge.coming-soon { background: rgba(245, 158, 11, 0.15); color: var(--accent-orange); border: 1px solid rgba(245, 158, 11, 0.3); }
.option-badge.active { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); border: 1px solid rgba(16, 185, 129, 0.3); }
.option-badge.info { background: rgba(59, 130, 246, 0.12); color: var(--accent-blue); border: 1px solid rgba(59, 130, 246, 0.3); }
.option-badge.serial { background: rgba(139, 92, 246, 0.12); color: var(--accent-purple); border: 1px solid rgba(139, 92, 246, 0.3); }

/* ========== AUTO-INFO BOX ========== */
.auto-info {
    margin-top: 20px; padding: 16px 20px; border-radius: 12px;
    background: rgba(16, 185, 129, 0.08); border: 1px solid rgba(16, 185, 129, 0.2);
    color: var(--accent-green); font-size: 14px; font-weight: 500;
    display: flex; align-items: center; gap: 10px;
}

/* ========== SUMMARY ========== */
.summary-box { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 14px; padding: 20px; margin-top: 20px; }
.summary-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
.summary-item:last-child { border-bottom: none; }
.summary-label { font-size: 14px; color: var(--text-muted); font-weight: 500; }
.summary-value { font-size: 15px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 6px; }

/* ========== NAVIGATION ========== */
.wizard-nav { display: flex; justify-content: space-between; align-items: center; padding: 24px 32px; border-top: 1px solid var(--border-color); background: rgba(255,255,255,0.01); }
.nav-btn { padding: 12px 28px; border: none; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: 600; font-family: inherit; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
.nav-btn.prev { background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-color); }
.nav-btn.prev:hover { background: var(--card-hover); border-color: var(--text-muted); color: var(--text-primary); }
.nav-btn.next { background: linear-gradient(135deg, var(--accent-blue), #2563eb); color: white; box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3); }
.nav-btn.next:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4); }
.nav-btn.next:disabled, .nav-btn.finish:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
.nav-btn.finish { background: linear-gradient(135deg, var(--accent-green), #059669); color: white; box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3); padding: 14px 36px; font-size: 16px; }
.nav-btn.finish:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4); }

/* ========== STEP TRANSITION ========== */
.step-content { display: none; }
.step-content.active { display: block; animation: stepFadeIn 0.35s ease forwards; }
@keyframes stepFadeIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

/* ========== SCROLLBAR ========== */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }

.footer { text-align: center; padding: 24px; color: var(--text-muted); font-size: 12px; margin-top: 40px; }
  </style>
<script>
(function() { var t = localStorage.getItem('theme') || 'dark'; document.documentElement.setAttribute('data-theme', t); })();
</script>
</head>
<body>
    <div class="bg-animation"></div>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>

    <header class="header">
        <div class="logo">
            <img src="/static/logo.png" alt="Logo" style="height: 48px; margin-left: 10px;">
            <h1>ویزارد پیکربندی</h1>
        </div>
        <div class="header-actions">
            <button class="theme-toggle" onclick="toggleTheme()" title="تغییر تم"><span id="themeIcon">&#127769;</span></button>
            <div class="user-info"><span>&#128100;</span> <span id="currentUser">کاربر</span></div>
            <a href="/" class="back-btn">بازگشت به داشبورد</a>
            <button class="logout-btn" onclick="logout()">خروج</button>
        </div>
    </header>

    <div class="container">
        <div class="wizard-title">
            <h2>پیکربندی سرویس شبکه</h2>
            <p>مراحل زیر را برای تولید پیکربندی مورد نظر طی کنید</p>
        </div>

        <!-- Dynamic Breadcrumb Stepper -->
        <div class="breadcrumb-stepper" id="breadcrumb"></div>

        <!-- Wizard Card -->
        <div class="wizard-card">
            <div id="stepContainer"></div>

            <!-- Navigation -->
            <div class="wizard-nav">
                <button class="nav-btn prev" id="prevBtn" onclick="prevStep()" style="visibility:hidden;">&#8594; مرحله قبل</button>
                <div id="stepIndicator" style="font-size:13px; color:var(--text-muted); font-weight:600;"></div>
                <button class="nav-btn next" id="nextBtn" onclick="nextStep()" disabled>مرحله بعد &#8592;</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>Network Configuration Portal &mdash; Wizard v2.0</p>
    </footer>

<script>
// ============ Theme ============
function toggleTheme() {
    var c = document.documentElement.getAttribute('data-theme') || 'dark';
    var n = c === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', n);
    localStorage.setItem('theme', n);
    document.getElementById('themeIcon').textContent = n === 'dark' ? '\u{1F319}' : '\u{2600}\u{FE0F}';
}
document.addEventListener('DOMContentLoaded', function() {
    var t = localStorage.getItem('theme') || 'dark';
    document.getElementById('themeIcon').textContent = t === 'dark' ? '\u{1F319}' : '\u{2600}\u{FE0F}';
});

// ============ Auth ============
(function() {
    var s = localStorage.getItem('sessionStart');
    if (s && (Date.now() - parseInt(s)) > 8*3600000) { localStorage.clear(); location.href = '/login'; }
    var u = localStorage.getItem('currentUser') || localStorage.getItem('username') || sessionStorage.getItem('username');
    if (!u) { location.href = '/login'; return; }
    document.getElementById('currentUser').textContent = u;
})();
function logout() { localStorage.clear(); sessionStorage.clear(); location.href = '/login'; }

// ============================================================
//  DYNAMIC WIZARD ENGINE
// ============================================================

// All step definitions
const STEPS = {
    // ---- COMMON ----
    device_type: {
        id: 'device_type',
        title: '&#127970; نوع نقطه را انتخاب کنید',
        subtitle: 'پیکربندی برای چه نوع نقطه‌ای تولید می‌شود؟',
        label: 'نوع نقطه',
        options: [
            { value: 'شعبه', icon: '&#127970;', title: 'شعبه', desc: 'شعبات بانک کشاورزی' },
            { value: 'باجه', icon: '&#128451;', title: 'باجه', desc: 'باجه‌های بانکی' },
            { value: 'خودپرداز', icon: '&#128179;', title: 'خودپرداز (کیوسک)', desc: 'ATM و دستگاه‌های کیوسک' }
        ]
    },
    platform: {
        id: 'platform',
        title: '&#128225; بستر ارتباطی را انتخاب کنید',
        subtitle: 'ارتباط از طریق چه بستری برقرار می‌شود؟',
        label: 'بستر ارتباطی',
        options: [
            { value: 'APN', icon: '&#128225;', title: 'APN', desc: 'شبکه خصوصی مجازی از طریق APN', badge: 'active', badgeText: 'فعال' },
            { value: 'سیم مسی', icon: '&#128268;', title: 'سیم مسی', desc: 'ارتباط از طریق خط مسی (Copper)', badge: 'active', badgeText: 'فعال' },
            { value: 'فیبر', icon: '&#128171;', title: 'فیبر نوری', desc: 'ارتباط از طریق فیبر نوری', badge: 'active', badgeText: 'فعال' }
        ]
    },

    // ---- APN PATH ----
    apn_isp: {
        id: 'apn_isp',
        title: '&#127760; ارائه‌دهنده سرویس (ISP)',
        subtitle: 'سرویس APN از طریق کدام پروایدر ارائه می‌شود؟',
        label: 'ISP',
        options: [
            { value: 'گیلانت', icon: '&#127760;', title: 'گیلانت', desc: 'Gilanet - ارائه‌دهنده فعلی', badge: 'active', badgeText: 'فعال' },
            { value: 'سایر', icon: '&#128279;', title: 'سایر پروایدرها', desc: 'در صورت اضافه شدن', badge: 'coming-soon', badgeText: 'به زودی', disabled: true }
        ]
    },
    apn_service: {
        id: 'apn_service',
        title: '&#9881; نوع سرویس APN',
        subtitle: 'چه نوع سرویسی برای این نقطه نیاز دارید؟',
        label: 'نوع سرویس',
        isFinal: true,
        options: [
            { value: 'مالی', icon: '&#128181;', title: 'مالی', desc: 'ISR-APN-RO + Financial Tunnel' },
            { value: 'غیرمالی', icon: '&#128421;', title: 'غیرمالی', desc: 'APN-INT + Tunnel200' },
            { value: 'هردو', icon: '&#128640;', title: 'هردو (مالی + غیرمالی)', desc: 'پیکربندی هر دو سرویس' }
        ]
    },

    // ---- COPPER PATH ----
    copper_protocol: {
        id: 'copper_protocol',
        title: '&#128225; نوع سرویس بستر سیم مسی',
        subtitle: 'سرویس بستر ارتباطی را انتخاب کنید',
        label: 'پروتکل',
        options: [
            { value: 'PTMP', icon: '&#128225;', title: 'PTMP', desc: 'Point-to-MultiPoint (سریال)', badge: 'active', badgeText: 'مالی' },
            { value: 'MPLS', icon: '&#128279;', title: 'MPLS', desc: 'Multi-Protocol Label Switching (مالی)', badge: 'active', badgeText: 'مالی' },
            { value: 'VPLS', icon: '&#127760;', title: 'VPLS', desc: 'Virtual Private LAN Service (مالی)', badge: 'active', badgeText: 'مالی' },
            { value: 'Intranet', icon: '&#128421;', title: 'Intranet', desc: 'سرویس اینترانت (غیرمالی)', badge: 'info', badgeText: 'غیرمالی' }
        ]
    },
    // PTMP goes directly to summary (auto: H-Wic T-2, Serial)
    copper_ptmp_summary: {
        id: 'copper_ptmp_summary',
        title: '&#9989; PTMP - خلاصه پیکربندی',
        subtitle: 'تنظیمات PTMP به صورت خودکار مشخص شد',
        label: 'خلاصه',
        isFinal: true,
        autoInfo: 'PTMP از طریق H-Wic T-2 (اسلات Serial) پیکربندی می‌شود. نوع سرویس: مالی',
        options: [
            { value: 'ptmp_confirm', icon: '&#9989;', title: 'تایید و ادامه', desc: 'H-Wic T-2 | Serial | مالی' }
        ]
    },
    // MPLS/VPLS/Intranet connection type
    copper_connection: {
        id: 'copper_connection',
        title: '&#128268; نوع اتصال را انتخاب کنید',
        subtitle: 'تجهیز از چه طریقی به روتر متصل است؟',
        label: 'نوع اتصال',
        options: [
            { value: 'Modem', icon: '&#128225;', title: 'مودم (Modem)', desc: 'اتصال مودم به پورت روتر یا ماژول 4ESW' },
            { value: 'Module', icon: '&#128187;', title: 'ماژول (Module)', desc: 'ماژول داخلی روتر (G.SHDSL / 1ADSL / 4ESW)' }
        ]
    },
    // Module type selection
    copper_module_type: {
        id: 'copper_module_type',
        title: '&#128187; نوع ماژول را انتخاب کنید',
        subtitle: 'کدام ماژول روی روتر نصب است؟',
        label: 'نوع ماژول',
        isFinal: true,
        options: [
            { value: 'G.SHDSL', icon: '&#128268;', title: 'G.SHDSL', desc: 'ماژول G.SHDSL روی روتر' },
            { value: '1ADSL', icon: '&#128225;', title: '1ADSL', desc: 'ماژول ADSL روی روتر' },
            { value: '4ESW', icon: '&#128187;', title: '4ESW', desc: 'ماژول سوئیچ 4 پورت (4ESW)' }
        ]
    },
    // Modem connection sub-type
    copper_modem_type: {
        id: 'copper_modem_type',
        title: '&#128225; نحوه اتصال مودم به روتر',
        subtitle: 'مودم چگونه به روتر متصل شده است؟',
        label: 'اتصال مودم',
        isFinal: true,
        options: [
            { value: '4ESW_VLAN', icon: '&#128187;', title: 'از طریق ماژول 4ESW', desc: 'مودم به پورت ماژول 4ESW وصل است (نیاز به ساخت VLAN)' },
            { value: 'Direct_Port', icon: '&#128268;', title: 'مستقیم به پورت روتر', desc: 'مودم مستقیم به پورت فیزیکی روتر وصل است (Fa/Gi - کانفیگ Layer 3)' }
        ]
    },

    // ---- FIBER PATH ----
    fiber_type: {
        id: 'fiber_type',
        title: '&#128171; نوع ارتباط فیبر',
        subtitle: 'فیبر نوری از چه نوعی است؟',
        label: 'نوع فیبر',
        options: [
            { value: 'FTTH', icon: '&#127968;', title: 'FTTH', desc: 'Fiber To The Home' },
            { value: 'SFP', icon: '&#128171;', title: 'SFP', desc: 'Small Form-factor Pluggable' },
            { value: 'Switch 2960', icon: '&#128433;', title: 'سوییچ 2960', desc: 'Cisco Catalyst 2960 Switch' }
        ]
    },
    fiber_service: {
        id: 'fiber_service',
        title: '&#9881; نوع سرویس فیبر',
        subtitle: 'چه نوع سرویسی روی فیبر نیاز دارید؟',
        label: 'نوع سرویس',
        isFinal: true,
        options: [
            { value: 'مالی', icon: '&#128181;', title: 'مالی', desc: 'سرویس مالی روی فیبر' },
            { value: 'غیرمالی', icon: '&#128421;', title: 'غیرمالی', desc: 'سرویس غیرمالی روی فیبر' }
        ]
    }
};

// Step routing: given current step + selection, what's next?
function getNextStepId(currentStepId, selectedValue) {
    switch (currentStepId) {
        case 'device_type': return 'platform';
        case 'platform':
            if (selectedValue === 'APN') return 'apn_isp';
            if (selectedValue === 'سیم مسی') return 'copper_protocol';
            if (selectedValue === 'فیبر') return 'fiber_type';
            return null;
        // APN
        case 'apn_isp': return 'apn_service';
        case 'apn_service': return null; // final
        // Copper
        case 'copper_protocol':
            if (selectedValue === 'PTMP') return 'copper_ptmp_summary';
            return 'copper_connection'; // MPLS, VPLS, Intranet
        case 'copper_ptmp_summary': return null; // final
        case 'copper_connection':
            if (selectedValue === 'Module') return 'copper_module_type';
            if (selectedValue === 'Modem') return 'copper_modem_type';
            return null;
        case 'copper_module_type': return null; // final
        case 'copper_modem_type': return null; // final
        // Fiber
        case 'fiber_type': return 'fiber_service';
        case 'fiber_service': return null; // final
        default: return null;
    }
}

// ============ STATE ============
let stepPath = ['device_type']; // stack of step IDs
let selections = {}; // stepId -> value

function currentStepId() { return stepPath[stepPath.length - 1]; }
function currentStepIndex() { return stepPath.length - 1; }

// ============ RENDER ============
function renderStep(stepId) {
    const step = STEPS[stepId];
    if (!step) return '';

    let html = '<div class="step-content active" id="step-' + stepId + '">';
    html += '<div class="wizard-card-header">';
    html += '<h3>' + step.title + '</h3>';
    html += '<p>' + step.subtitle + '</p>';
    html += '</div>';
    html += '<div class="wizard-card-body">';

    if (step.autoInfo) {
        html += '<div class="auto-info">&#9889; ' + step.autoInfo + '</div>';
        html += '<div style="height:16px"></div>';
    }

    const cols = step.options.length;
    html += '<div class="options-grid" style="grid-template-columns: repeat(' + Math.min(cols, 4) + ', 1fr);">';

    step.options.forEach(function(opt) {
        const sel = selections[stepId] === opt.value ? ' selected' : '';
        const dis = opt.disabled ? ' disabled' : '';
        html += '<div class="option-card' + sel + dis + '" data-value="' + opt.value + '" onclick="selectOption(\'' + stepId + '\', this)">';
        html += '<span class="option-icon">' + opt.icon + '</span>';
        html += '<div class="option-title">' + opt.title + '</div>';
        html += '<div class="option-desc">' + opt.desc + '</div>';
        if (opt.badge) {
            html += '<span class="option-badge ' + opt.badge + '">' + opt.badgeText + '</span>';
        }
        html += '</div>';
    });

    html += '</div>'; // options-grid

    // Show summary on final steps
    if (step.isFinal && selections[stepId]) {
        html += renderSummary();
    }

    html += '</div>'; // wizard-card-body
    html += '</div>'; // step-content

    return html;
}

function renderSummary() {
    let html = '<div class="summary-box" id="summaryBox">';
    for (let i = 0; i < stepPath.length; i++) {
        const sid = stepPath[i];
        const step = STEPS[sid];
        const val = selections[sid];
        if (!step || !val) continue;
        html += '<div class="summary-item">';
        html += '<span class="summary-label">' + step.label + '</span>';
        html += '<span class="summary-value">' + val + '</span>';
        html += '</div>';
    }
    html += '</div>';
    return html;
}

function renderBreadcrumb() {
    const bc = document.getElementById('breadcrumb');
    let html = '';

    for (let i = 0; i < stepPath.length; i++) {
        const sid = stepPath[i];
        const step = STEPS[sid];
        if (!step) continue;

        const isActive = (i === stepPath.length - 1);
        const isCompleted = (i < stepPath.length - 1);
        const cls = isActive ? 'active' : (isCompleted ? 'completed' : 'pending');

        if (i > 0) html += '<span class="bc-arrow">&#8592;</span>';

        html += '<div class="bc-item ' + cls + '">';
        if (isCompleted) {
            html += '<span class="bc-check">&#10003;</span> ';
            html += step.label + ': <strong>' + (selections[sid] || '') + '</strong>';
        } else {
            html += step.label;
        }
        html += '</div>';
    }

    bc.innerHTML = html;
}

function updateUI() {
    const sid = currentStepId();
    const step = STEPS[sid];

    // Render current step
    document.getElementById('stepContainer').innerHTML = renderStep(sid);

    // Render breadcrumb
    renderBreadcrumb();

    // Update nav buttons
    document.getElementById('prevBtn').style.visibility = stepPath.length > 1 ? 'visible' : 'hidden';

    const nextBtn = document.getElementById('nextBtn');
    if (step && step.isFinal && selections[sid]) {
        nextBtn.className = 'nav-btn finish';
        nextBtn.innerHTML = 'رفتن به صفحه پیکربندی &#8592;';
        nextBtn.onclick = finishWizard;
        nextBtn.disabled = false;
    } else {
        nextBtn.className = 'nav-btn next';
        nextBtn.innerHTML = 'مرحله بعد \u2190';
        nextBtn.onclick = nextStep;
        nextBtn.disabled = !selections[sid];
    }

    // Update indicator
    document.getElementById('stepIndicator').innerHTML = 'مرحله ' + stepPath.length;
}

// ============ ACTIONS ============
function selectOption(stepId, cardEl) {
    const parent = cardEl.parentElement;
    parent.querySelectorAll('.option-card').forEach(function(c) { c.classList.remove('selected'); });
    cardEl.classList.add('selected');

    // If selection changed, clear future path
    const oldVal = selections[stepId];
    const newVal = cardEl.dataset.value;
    selections[stepId] = newVal;

    if (oldVal !== newVal) {
        // Remove steps after this one
        const idx = stepPath.indexOf(stepId);
        if (idx >= 0) {
            const removed = stepPath.splice(idx + 1);
            removed.forEach(function(s) { delete selections[s]; });
        }
    }

    const step = STEPS[stepId];
    if (step && step.isFinal) {
        // Re-render to show summary
        document.getElementById('stepContainer').innerHTML = renderStep(stepId);
        updateUI();
    } else {
        updateUI();
        // Auto-advance to next step after brief visual feedback
        setTimeout(function() {
            nextStep();
        }, 350);
    }
}

function nextStep() {
    const sid = currentStepId();
    const val = selections[sid];
    if (!val) return;

    const nextId = getNextStepId(sid, val);
    if (!nextId) return;

    stepPath.push(nextId);
    updateUI();
}

function prevStep() {
    if (stepPath.length <= 1) return;
    const removed = stepPath.pop();
    delete selections[removed];
    updateUI();
}

function finishWizard() {
    const wizardData = {};
    stepPath.forEach(function(sid) {
        wizardData[sid] = selections[sid];
    });
    localStorage.setItem('wizardConfig', JSON.stringify(wizardData));

    const platform = selections['platform'];

    // ---- APN ----
    if (platform === 'APN') {
        switch (selections['apn_service']) {
            case 'مالی': window.location.href = '/apn-mali'; return;
            case 'غیرمالی': window.location.href = '/apn-int'; return;
            case 'هردو': window.location.href = '/config-both'; return;
        }
    }

    // ---- COPPER ----
    if (platform === 'سیم مسی') {
        const protocol = selections['copper_protocol'];

        if (protocol === 'PTMP') {
            // PTMP -> مالی, H-Wic T-2
            alert('پیکربندی PTMP (H-Wic T-2 / Serial) - مالی\n\nصفحه پیکربندی PTMP به زودی اضافه می‌شود.');
            return;
        }

        if (protocol === 'Intranet') {
            // Intranet -> غیرمالی -> existing intranet page
            window.location.href = '/intranet';
            return;
        }

        // MPLS / VPLS -> مالی
        // For now placeholder
        alert('پیکربندی ' + protocol + ' (سیم مسی - مالی)\n\nاتصال: ' + (selections['copper_connection'] || '') +
              '\n' + (selections['copper_module_type'] ? 'ماژول: ' + selections['copper_module_type'] : '') +
              (selections['copper_modem_type'] ? 'نوع مودم: ' + selections['copper_modem_type'] : '') +
              '\n\nصفحه پیکربندی به زودی اضافه می‌شود.');
        return;
    }

    // ---- FIBER ----
    if (platform === 'فیبر') {
        const fiberType = selections['fiber_type'];

        const fiberService = selections['fiber_service'];
        alert('پیکربندی فیبر (' + fiberType + ') - ' + fiberService +
              '\n\nصفحه پیکربندی فیبر به زودی اضافه می‌شود.');
        return;
    }
}

// ============ INIT ============
updateUI();
</script>

{% include 'chat_widget.html' %}
</body>
</html>
