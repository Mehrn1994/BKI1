<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Router Config Generator</title>
    <style>
/* ========== THEME SYSTEM ========== */
:root {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-card: rgba(30, 41, 59, 0.8);
    --bg-header: rgba(30, 41, 59, 0.9);
    --text-primary: #e2e8f0;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --border-color: rgba(255, 255, 255, 0.1);
    --shadow-color: rgba(0, 0, 0, 0.3);
    --input-bg: rgba(15, 23, 42, 0.8);
    --input-border: rgba(255, 255, 255, 0.2);
    --card-hover: rgba(255, 255, 255, 0.05);
}


[data-theme="light"] {
    --bg-primary: #f8fafc;
    --bg-secondary: #f1f5f9;
    --bg-card: #ffffff;
    --bg-header: #ffffff;
    --text-primary: #0f172a;
    --text-secondary: #334155;
    --text-muted: #475569;
    --border-color: rgba(0, 0, 0, 0.15);
    --shadow-color: rgba(0, 0, 0, 0.1);
    --input-bg: #ffffff;
    --input-border: rgba(0, 0, 0, 0.2);
    --card-hover: rgba(0, 0, 0, 0.05);
}

body { transition: background 0.3s ease, color 0.3s ease; }

[data-theme="light"] body {
    background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%) !important;
    color: var(--text-primary) !important;
}

[data-theme="light"] .header, [data-theme="light"] header,
[data-theme="light"] .top-bar, [data-theme="light"] .navbar {
    background: var(--bg-header) !important;
    border-color: var(--border-color) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
}

[data-theme="light"] .card, [data-theme="light"] .form-section,
[data-theme="light"] .config-section, [data-theme="light"] .result-section,
[data-theme="light"] .section, [data-theme="light"] .panel,
[data-theme="light"] .main-card, [data-theme="light"] .box {
    background: var(--bg-card) !important;
    border-color: var(--border-color) !important;
    color: var(--text-primary) !important;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06) !important;
}

[data-theme="light"] input, [data-theme="light"] select, [data-theme="light"] textarea {
    background: var(--input-bg) !important;
    border: 1px solid var(--input-border) !important;
    color: #0f172a !important;
}

[data-theme="light"] input::placeholder { color: #64748b !important; }
[data-theme="light"] select option { background: #fff; color: #0f172a; }

[data-theme="light"] label, [data-theme="light"] .form-label,
[data-theme="light"] h1, [data-theme="light"] h2, [data-theme="light"] h3, [data-theme="light"] h4,
[data-theme="light"] .section-title, [data-theme="light"] .title,
[data-theme="light"] .app-title h1, [data-theme="light"] .app-title p {
    color: #0f172a !important;
}

[data-theme="light"] p, [data-theme="light"] span:not(.badge):not(.tag), 
[data-theme="light"] div:not(.btn):not(.badge) {
    color: inherit;
}

[data-theme="light"] .hint, [data-theme="light"] .info-text, [data-theme="light"] small,
[data-theme="light"] .description, [data-theme="light"] .help-text,
[data-theme="light"] .form-hint, [data-theme="light"] .note {
    color: #334155 !important;
}

[data-theme="light"] .user-display, [data-theme="light"] .user-info,
[data-theme="light"] .user-name, [data-theme="light"] #currentUser {
    color: #0f172a !important;
}

[data-theme="light"] .badge, [data-theme="light"] .tag, [data-theme="light"] .count {
    color: #fff !important;
}

[data-theme="light"] a:not(.btn):not(button):not(.back-btn):not(.logout-link) {
    color: #2563eb !important;
}

[data-theme="light"] .back-btn, [data-theme="light"] .logout-link {
    color: #dc2626 !important;
}

[data-theme="light"] pre, [data-theme="light"] code, [data-theme="light"] .config-output,
[data-theme="light"] .output-box, [data-theme="light"] .code-block {
    background: #1e293b !important;
    color: #e2e8f0 !important;
}

[data-theme="light"] table { border-color: var(--border-color) !important; }
[data-theme="light"] th, [data-theme="light"] td { 
    border-color: var(--border-color) !important;
    color: #0f172a !important;
}
[data-theme="light"] th { background: #f1f5f9 !important; color: #0f172a !important; }
[data-theme="light"] tr:hover { background: #f8fafc !important; }

[data-theme="light"] .success, [data-theme="light"] .alert-success,
[data-theme="light"] .success-box, [data-theme="light"] .ip-reserved {
    background: #dcfce7 !important;
    color: #166534 !important;
    border-color: #86efac !important;
}

[data-theme="light"] .error, [data-theme="light"] .alert-error,
[data-theme="light"] .error-box {
    background: #fee2e2 !important;
    color: #991b1b !important;
    border-color: #fca5a5 !important;
}

[data-theme="light"] .warning, [data-theme="light"] .alert-warning {
    background: #fef3c7 !important;
    color: #92400e !important;
    border-color: #fcd34d !important;
}

[data-theme="light"] .info-box, [data-theme="light"] .notice,
[data-theme="light"] .auto-ip-info {
    background: #eff6ff !important;
    color: #1e40af !important;
    border-color: #93c5fd !important;
}

[data-theme="light"] .btn-primary, [data-theme="light"] button[type="submit"] {
    background: #2563eb !important;
    color: #fff !important;
}

[data-theme="light"] .btn-secondary {
    background: #64748b !important;
    color: #fff !important;
}

[data-theme="light"] .free-count { color: #059669 !important; font-weight: bold; }
[data-theme="light"] .used-count { color: #dc2626 !important; font-weight: bold; }

/* Router boxes for intranet */
[data-theme="light"] .router-box, [data-theme="light"] .device-box {
    background: #fff !important;
    border: 1px solid #e2e8f0 !important;
    color: #0f172a !important;
}

[data-theme="light"] .router-header, [data-theme="light"] .device-box-header {
    color: #0f172a !important;
}

/* Stats cards */
[data-theme="light"] .stat-card {
    background: #fff !important;
    border: 1px solid #e2e8f0 !important;
}

[data-theme="light"] .stat-card .value {
    color: #2563eb !important;
}

[data-theme="light"] .stat-card .label {
    color: #475569 !important;
}

.theme-toggle {
    background: var(--bg-card, rgba(30,41,59,0.8));
    border: 1px solid var(--border-color, rgba(255,255,255,0.1));
    border-radius: 50%;
    width: 36px;
    height: 36px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    margin-left: 10px;
}
.theme-toggle:hover { transform: scale(1.1); }
/* ========== END THEME ========== */

/* Auto-fill fields styling */
.auto-fields-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}
.auto-field-item {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 8px;
    padding: 8px 12px;
}
.auto-field-label {
    display: block;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted, #64748b);
    margin-bottom: 3px;
}
.auto-field-value {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary, #e2e8f0);
    font-family: 'Consolas', 'JetBrains Mono', monospace;
}
[data-theme="light"] .auto-field-item {
    background: rgba(0,0,0,0.03);
    border-color: rgba(0,0,0,0.08);
}
[data-theme="light"] .auto-field-value {
    color: #0f172a;
}

        body {
            font-family: monospace;
            background: #f5faff;
            color: #1e293b;
            margin: 0;
        }
        header {
            padding: 0;
            margin: 0;
        }
        h1 {
            margin: 0;
            font-size: 20px;
            font-weight: bold;
            color: #0f172a;
        }
        .ascii-banner {
            text-align: center;
            font-size: 14px;
            line-height: 1.2;
            white-space: pre;
            color: #0284c7;
            margin: 12px 0;
            font-family: monospace;
        }
        main {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 16px;
            padding: 16px;
        }
        .card {
            background: #ffffff;
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            padding: 16px;
        }
        label {
            display: block;
            margin-top: 10px;
            font-size: 12px;
            font-weight: bold;
            color: #334155;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            border-radius: 6px;
            border: 1px solid #94a3b8;
            background: #f1f5f9;
            color: #0f172a;
            box-sizing: border-box;
        }
        button {
            margin-top: 12px;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
        button.primary {
            background: #0284c7;
            color: #fff;
        }
        button.primary:hover {
            background: #0369a1;
        }
        button.primary:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .reload-btn {
            background: #64748b;
            color: #fff;
            padding: 6px 12px;
            font-size: 11px;
        }
        pre, textarea {
            background: #f8fafc;
            border: 1px dashed #94a3b8;
            border-radius: 8px;
            padding: 14px;
            white-space: pre;
            overflow-x: auto;
            max-height: 60vh;
            font-size: 12px;
            color: #1e293b;
            width: 100%;
            box-sizing: border-box;
            font-family: Consolas, monospace;
        }
        textarea {
            resize: vertical;
            min-height: 160px;
        }
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            font-size: 13px;
        }
        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .user-info {
            background: #dbeafe;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 12px;
            color: #1e40af;
            font-weight: bold;
        }
        .tunnel-info {
            background: #fef3c7;
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 11px;
            color: #92400e;
        }
        .device-box {
            margin-bottom: 20px;
        }
        .device-box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .device-title {
            font-size: 13px;
            font-weight: bold;
            color: #0f172a;
        }
        .copy-btn {
            background: #10b981;
            color: #ecfdf5;
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 11px;
            margin-top: 0;
        }
        .copy-btn:hover {
            background: #059669;
        }
    


    
/* ========== BETTER FONTS ========== */
body {
    font-size: 16px !important;
    line-height: 1.6 !important;
}

h1 { font-size: 1.8rem !important; font-weight: 700 !important; }
h2 { font-size: 1.4rem !important; font-weight: 700 !important; }
h3 { font-size: 1.2rem !important; font-weight: 600 !important; }
h4 { font-size: 1.1rem !important; font-weight: 600 !important; }

label, .form-label {
    font-size: 15px !important;
    font-weight: 600 !important;
    color: var(--text-primary, inherit) !important;
}

input, select, textarea {
    font-size: 15px !important;
    padding: 12px 14px !important;
}

.section-title, .title {
    font-size: 1.15rem !important;
    font-weight: 700 !important;
}

.hint, .info-text, .help-text, .form-hint, small, .note, .description {
    font-size: 14px !important;
    font-weight: 500 !important;
}

.btn, button:not(.theme-toggle) {
    font-size: 15px !important;
    font-weight: 600 !important;
}

table { font-size: 15px !important; }
th { font-weight: 700 !important; }
th, td { padding: 12px 14px !important; }

.info-box, .notice, .alert, .success-box, .error-box, .auto-ip-info, .ip-reserved {
    font-size: 15px !important;
    font-weight: 500 !important;
    padding: 14px 18px !important;
}

.badge, .tag, .count {
    font-size: 13px !important;
    font-weight: 600 !important;
    padding: 5px 12px !important;
}

.user-display, .user-info, .user-name {
    font-size: 15px !important;
    font-weight: 600 !important;
}

pre, code, .config-output, .output-box {
    font-size: 14px !important;
    line-height: 1.5 !important;
}

.app-title h1 { font-size: 1.8rem !important; font-weight: 700 !important; }
.app-title p { font-size: 15px !important; font-weight: 500 !important; }

/* Light theme text improvements */
[data-theme="light"] label, 
[data-theme="light"] .form-label,
[data-theme="light"] .section-title, 
[data-theme="light"] .title,
[data-theme="light"] h1, 
[data-theme="light"] h2, 
[data-theme="light"] h3 {
    color: #0f172a !important;
}

[data-theme="light"] .hint, 
[data-theme="light"] small,
[data-theme="light"] .info-text, 
[data-theme="light"] .description,
[data-theme="light"] .help-text {
    color: #334155 !important;
}

[data-theme="light"] input,
[data-theme="light"] select,
[data-theme="light"] textarea {
    color: #0f172a !important;
    background: #fff !important;
    border: 1px solid rgba(0,0,0,0.2) !important;
}

[data-theme="light"] input::placeholder {
    color: #64748b !important;
}
/* ========== END BETTER FONTS ========== */

    </style>

<script>
// Theme System - runs immediately
(function() {
    var theme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', theme);
})();

function toggleTheme() {
    var current = document.documentElement.getAttribute('data-theme') || 'dark';
    var next = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    var icon = document.getElementById('themeIcon');
    if (icon) icon.textContent = next === 'dark' ? 'üåô' : '‚òÄÔ∏è';
}

document.addEventListener('DOMContentLoaded', function() {
    var icon = document.getElementById('themeIcon');
    if (icon) {
        var theme = localStorage.getItem('theme') || 'dark';
        icon.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }
});
</script>
</head>
<body>
    <header>
        <!-- Top bar with user info and return button -->
        <div style="
            max-width:1200px;
            margin:0 auto;
            padding:10px 16px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            background:var(--bg-header, #e2e8f0);
            border-bottom:1px solid var(--border-color, #cbd5e1);
        ">
            <div>
                <span style="font-size:14px; color:var(--text-secondary, #475569);">üë§ User: </span>
                <span id="currentUser" style="font-size:14px; font-weight:bold; color:var(--text-primary, #0f172a);">Loading...</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <button class="theme-toggle" onclick="toggleTheme()" title="ÿ™ÿ∫€å€åÿ± ÿ™ŸÖ"><span id="themeIcon">üåô</span></button>
                <a href="/"
                   style="
                     padding:6px 14px;
                     border-radius:6px;
                     background:#ef4444;
                     color:#ffffff;
                     text-decoration:none;
                     font-size:13px;
                     font-weight:bold;
                   "
                   onmouseover="this.style.background='#dc2626'"
                   onmouseout="this.style.background='#ef4444'">
                  Back to Menu
                </a>
            </div>
        </div>

        <!-- Title section -->
        <div style="text-align:center; padding:10px 16px; background:var(--bg-header, #e2e8f0);">
            <h1 style="color:var(--text-primary, inherit);">Intranet Config Generator</h1>
            <div class="ascii-banner">
                <pre>Keshavarzi Bank Network - WAN</pre>
            </div>
        </div>
    </header>

    <main>
        <section class="card">
            <h2>Inputs</h2>

            <div class="user-info" id="userInfo" style="display:none;">
                üë§ User: <span id="currentUser2">Loading...</span>
            </div>

            <!-- Branch Selection -->
            <label>Select Branch</label>
            <input id="branchName" type="text" list="branchList"
                   placeholder="Type branch name or select from list..."
                   autocomplete="off">
            <datalist id="branchList"></datalist>

            <!-- Auto-filled fields panel -->
            <div id="autoFieldsPanel" style="display:none; margin:12px 0 16px 0; background:rgba(59,130,246,0.06); border:1px solid rgba(59,130,246,0.2); border-radius:10px; padding:14px 16px;">
                <div style="font-size:11px; text-transform:uppercase; letter-spacing:0.5px; color:#3b82f6; font-weight:700; margin-bottom:10px;">Auto-filled from branch</div>
                <div class="auto-fields-grid">
                    <div class="auto-field-item">
                        <span class="auto-field-label">Province</span>
                        <span class="auto-field-value" id="autoProvince">-</span>
                    </div>
                    <div class="auto-field-item">
                        <span class="auto-field-label">Loopback IP (Branch)</span>
                        <span class="auto-field-value" id="autoLoopback">-</span>
                    </div>
                    <div class="auto-field-item">
                        <span class="auto-field-label">intnat Subnet</span>
                        <span class="auto-field-value" id="autoIntnat">-</span>
                    </div>
                    <div class="auto-field-item">
                        <span class="auto-field-label">Branch OSPF Area</span>
                        <span class="auto-field-value" id="autoOspf">-</span>
                    </div>
                    <div class="auto-field-item">
                        <span class="auto-field-label">WAN-INTR Tunnel Name</span>
                        <span class="auto-field-value" id="autoTunnelName">-</span>
                    </div>
                </div>
            </div>
            <!-- Hidden inputs to keep same IDs for config generation -->
            <input type="hidden" id="loopbackip">
            <input type="hidden" id="intnatsubnet">
            <input type="hidden" id="ospfareabranch">
            <input type="hidden" id="wantunnelname">
            <input type="hidden" id="province">

            <label>Choose a FREE /31 range</label>
            <select id="tunnelSelect"></select>
            <div class="tunnel-info">
                ‚úì First free tunnel auto-selected
            </div>
            <button class="reload-btn" onclick="loadTunnels()">üîÑ Reload list</button>

            <label>Branch Tunnel Source</label>
            <input type="text" id="tunnelsourcebranch" placeholder="e.g. 10.126.5.125">

            <!-- Branch name in English for tunnel description -->
            <label>Branch Name (English)</label>
            <input type="text" id="branchNameEn" placeholder="e.g. KhomeyniShahr" oninput="updateTunnelDesc()">
            <div id="autoDescPanel" style="display:none; margin:8px 0 16px 0; background:rgba(139,92,246,0.06); border:1px solid rgba(139,92,246,0.2); border-radius:10px; padding:12px 16px;">
                <div style="font-size:11px; text-transform:uppercase; letter-spacing:0.5px; color:#8b5cf6; font-weight:700; margin-bottom:6px;">WAN-INTR Tunnel Description</div>
                <span class="auto-field-value" id="autoTunnelDesc" style="color:#c4b5fd;">-</span>
            </div>
            <input type="hidden" id="wantunneldesc">

            <div id="statusMessage"></div>

            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:6px;">
              <button class="primary" id="generateBtn">Generate Configs</button>
              <div style="width:1px; height:28px; background:var(--border-color, rgba(255,255,255,0.15)); margin:0 4px;"></div>
              <button type="button" onclick="openRemoteModal('ssh')" style="background:linear-gradient(135deg,#3b82f6,#2563eb); color:#fff; border:none; border-radius:8px; padding:8px 14px; font-size:12px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:5px; font-family:inherit;">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
                SSH / Telnet
              </button>
              <button type="button" onclick="openRemoteModal('rdp')" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed); color:#fff; border:none; border-radius:8px; padding:8px 14px; font-size:12px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:5px; font-family:inherit;">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                RDP
              </button>
            </div>
        </section>

        <!-- Deploy Config to Device Panel -->
        <div id="deployPanel" style="display:none; margin-top:20px; background:linear-gradient(135deg,rgba(59,130,246,0.08),rgba(99,102,241,0.05)); border:1px solid rgba(59,130,246,0.3); border-radius:14px; padding:18px 20px;">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:14px;">
            <div style="display:flex; align-items:center; gap:8px; color:#3b82f6; font-weight:700; font-size:15px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>
              Deploy Config to Device
            </div>
            <span id="deployStatus" style="font-size:12px; color:#94a3b8;">Terminal not connected</span>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <select id="configSelect" style="flex:1; min-width:200px; padding:9px 12px; background:#020617; border:1px solid #374151; border-radius:8px; color:#e5e7eb; font-size:13px;">
              <option value="">-- Select Config --</option>
              <option value="branchConfig">Branch Router</option>
              <option value="wan1Config">WAN-INTR1 Router</option>
              <option value="wan2Config">WAN-INTR2 Router</option>
            </select>
            <button type="button" onclick="sendConfigToTerminal()" style="background:linear-gradient(135deg,#3b82f6,#2563eb); color:#fff; border:none; border-radius:999px; padding:10px 20px; display:flex; align-items:center; gap:6px; font-weight:600; cursor:pointer; font-family:inherit;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
              Send to Device
            </button>
          </div>
        </div>

        <section class="card">
            <h2>Generated Config</h2>

            <div class="device-box">
                <div class="device-box-header">
                    <span class="device-title">Branch Router</span>
                    <button class="copy-btn" onclick="copyConfig('branchConfig')">Copy</button>
                </div>
                <textarea id="branchConfig" readonly>Branch configuration will appear here...</textarea>
            </div>

            <div class="device-box">
                <div class="device-box-header">
                    <span class="device-title">WAN-INTR1 Router</span>
                    <button class="copy-btn" onclick="copyConfig('wan1Config')">Copy</button>
                </div>
                <textarea id="wan1Config" readonly>WAN-INTR1 configuration will appear here...</textarea>
            </div>

            <div class="device-box">
                <div class="device-box-header">
                    <span class="device-title">WAN-INTR2 Router</span>
                    <button class="copy-btn" onclick="copyConfig('wan2Config')">Copy</button>
                </div>
                <textarea id="wan2Config" readonly>WAN-INTR2 configuration will appear here...</textarea>
            </div>
        </section>
    </main>

    <script>
        // Session timeout: 8 hours
        const SESSION_TIMEOUT = 8 * 60 * 60 * 1000;
        (function() {
            const sessionStart = localStorage.getItem('sessionStart');
            if (sessionStart && (Date.now() - parseInt(sessionStart)) > SESSION_TIMEOUT) {
                localStorage.clear(); sessionStorage.clear();
                alert('ÿ¨ŸÑÿ≥Ÿá ÿ¥ŸÖÿß ŸÖŸÜŸÇÿ∂€å ÿ¥ÿØŸá ÿßÿ≥ÿ™. ŸÑÿ∑ŸÅÿßŸã ÿØŸàÿ®ÿßÿ±Ÿá Ÿàÿßÿ±ÿØ ÿ¥Ÿà€åÿØ.');
                location.href = '/login';
            }
        })();

        // Get username from storage
        let currentUsername = localStorage.getItem('currentUser') ||
                              localStorage.getItem('username') ||
                              sessionStorage.getItem('username') ||
                              'unknown';

        document.getElementById('currentUser').textContent = currentUsername;

        if (currentUsername === 'unknown') {
            console.warn('No username found in storage. User may need to login again.');
            location.href = '/login';
        }

        function copyConfig(id) {
            const el = document.getElementById(id);
            el.select();
            document.execCommand('copy');
        }

        // Show status message
        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = 'status-message ' + (isError ? 'status-error' : 'status-success');
            statusDiv.textContent = message;
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 5000);
        }

        // Load free tunnels
        async function loadTunnels() {
            try {
                let res = await fetch('/tunnels');
                let data = await res.json();
                let sel = document.getElementById('tunnelSelect');
                sel.innerHTML = '';

                if (data.length === 0) {
                    sel.innerHTML += '<option value="">‚ö† No free tunnels available</option>';
                    showStatus('No free tunnels available!', true);
                    return;
                }

                data.forEach((r, index) => {
                    let o = document.createElement('option');
                    o.value = JSON.stringify(r);
                    o.text = `${r['IP Address']} ${index === 0 ? '‚Üê Selected' : ''}`;
                    sel.add(o);
                });

                if (data.length > 0) {
                    sel.selectedIndex = 0;
                    console.log(`‚úì Auto-selected first tunnel: ${data[0]['IP Address']}`);
                }

                console.log(`‚úì Loaded ${data.length} free tunnels`);
            } catch (err) {
                console.error('Error loading tunnels:', err);
                showStatus('Failed to load tunnels: ' + err.message, true);
            }
        }

        // ==================== PROVINCE MAPPING ====================
        const provinceMapping = {
            'ÿ™Ÿáÿ±ÿßŸÜ ÿ®ÿ≤ÿ±⁄Ø': { en: 'Tehran', abbr: 'TEHB' },
            'ÿ™Ÿáÿ±ÿßŸÜ': { en: 'Tehran', abbr: 'TEH' },
            'ÿßŸÑÿ®ÿ±ÿ≤': { en: 'Alborz', abbr: 'KRJ' },
            'ÿ¢ÿ∞ÿ±ÿ®ÿß€åÿ¨ÿßŸÜ ÿ¥ÿ±ŸÇ€å': { en: 'East Azerbaijan', abbr: 'AZSH' },
            'ÿ¢ÿ∞ÿ±ÿ®ÿß€åÿ¨ÿßŸÜ ÿ∫ÿ±ÿ®€å': { en: 'West Azerbaijan', abbr: 'AZGH' },
            '⁄©ÿ±ÿØÿ≥ÿ™ÿßŸÜ': { en: 'Kurdistan', abbr: 'KRD' },
            'ÿßÿµŸÅŸáÿßŸÜ': { en: 'Isfahan', abbr: 'ESF' },
            'ÿÆÿ±ÿßÿ≥ÿßŸÜ ÿ±ÿ∂Ÿà€å': { en: 'Razavi Khorasan', abbr: 'KHR' },
            'ŸÅÿßÿ±ÿ≥': { en: 'Fars', abbr: 'FRS' },
            '⁄©ÿ±ŸÖÿßŸÜ': { en: 'Kerman', abbr: 'KRM' },
            'ÿÆŸàÿ≤ÿ≥ÿ™ÿßŸÜ': { en: 'Khuzestan', abbr: 'KHZ' },
            'ŸÑÿ±ÿ≥ÿ™ÿßŸÜ': { en: 'Lorestan', abbr: 'LOR' },
            '⁄Ø€åŸÑÿßŸÜ': { en: 'Gilan', abbr: 'GIL' },
            '⁄ØŸÑÿ≥ÿ™ÿßŸÜ': { en: 'Golestan', abbr: 'GLS' },
            'ŸÖÿßÿ≤ŸÜÿØÿ±ÿßŸÜ': { en: 'Mazandaran', abbr: 'MAZ' },
            'ÿ≥€åÿ≥ÿ™ÿßŸÜ Ÿà ÿ®ŸÑŸà⁄Üÿ≥ÿ™ÿßŸÜ': { en: 'Sistan and Baluchestan', abbr: 'SNB' },
            '€åÿ≤ÿØ': { en: 'Yazd', abbr: 'YZD' },
            'ÿ≤ŸÜÿ¨ÿßŸÜ': { en: 'Zanjan', abbr: 'ZNJ' },
            'ÿ≥ŸÖŸÜÿßŸÜ': { en: 'Semnan', abbr: 'SMN' },
            'ŸÖÿ±⁄©ÿ≤€å': { en: 'Markazi', abbr: 'MRZ' },
            'ŸáŸÖÿØÿßŸÜ': { en: 'Hamadan', abbr: 'HMD' },
            'ŸÇÿ≤Ÿà€åŸÜ': { en: 'Qazvin', abbr: 'QZV' },
            'ŸÇŸÖ': { en: 'Qom', abbr: 'QOM' },
            'ÿßÿ±ÿØÿ®€åŸÑ': { en: 'Ardabil', abbr: 'ARD' },
            'ÿß€åŸÑÿßŸÖ': { en: 'Ilam', abbr: 'ILM' },
            'ÿ®Ÿàÿ¥Ÿáÿ±': { en: 'Bushehr', abbr: 'BSH' },
            '⁄ÜŸáÿßÿ±ŸÖÿ≠ÿßŸÑ Ÿà ÿ®ÿÆÿ™€åÿßÿ±€å': { en: 'Chaharmahal and Bakhtiari', abbr: 'CHB' },
            'Ÿáÿ±ŸÖÿ≤⁄ØÿßŸÜ': { en: 'Hormozgan', abbr: 'HMZ' },
            '⁄©ÿ±ŸÖÿßŸÜÿ¥ÿßŸá': { en: 'Kermanshah', abbr: 'KRMSH' },
            '⁄©Ÿá⁄Ø€åŸÑŸà€åŸá Ÿà ÿ®Ÿà€åÿ±ÿßÿ≠ŸÖÿØ': { en: 'Kohgiluyeh and Boyer-Ahmad', abbr: 'KHB' },
            'ÿÆÿ±ÿßÿ≥ÿßŸÜ ÿ¥ŸÖÿßŸÑ€å': { en: 'North Khorasan', abbr: 'KHSH' },
            'ÿÆÿ±ÿßÿ≥ÿßŸÜ ÿ¨ŸÜŸàÿ®€å': { en: 'South Khorasan', abbr: 'KHRJ' }
        };

        // Selected branch data
        let selectedBranchData = null;

        // ==================== LOAD BRANCHES ====================
        async function loadBranches() {
            try {
                const res = await fetch('/api/branches');
                const branches = await res.json();
                const datalist = document.getElementById('branchList');
                datalist.innerHTML = '';
                branches.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = `${b.name} - [${b.province}] (10.${b.x}.${b.y}.0)`;
                    opt.setAttribute('data-x', b.x);
                    opt.setAttribute('data-y', b.y);
                    opt.setAttribute('data-province', b.province);
                    opt.setAttribute('data-name', b.name);
                    datalist.appendChild(opt);
                });
                console.log(`‚úì Loaded ${branches.length} branches`);
            } catch (err) {
                console.error('Error loading branches:', err);
            }
        }

        // ==================== BRANCH SELECTION HANDLER ====================
        document.getElementById('branchName').addEventListener('input', function() {
            const val = this.value.trim();
            // Match pattern: NAME - [PROVINCE] (10.X.Y.0)
            const match = val.match(/\[([^\]]+)\]\s*\(10\.(\d+)\.(\d+)\.0\)/);
            if (match) {
                const provincePersian = match[1];
                const x = match[2];
                const y = match[3];

                const prov = provinceMapping[provincePersian] || { en: provincePersian, abbr: provincePersian };

                selectedBranchData = { x, y, provincePersian, provinceEn: prov.en, provinceAbbr: prov.abbr };

                // Auto-fill values
                const loopback = `10.210.${x}.${y}`;
                const intnat = `10.${x}.${y}.0`;
                const ospfArea = x;
                const tunnelName = `Tunnel${x}${y}`;

                // Set hidden inputs (same IDs used by config generation)
                document.getElementById('loopbackip').value = loopback;
                document.getElementById('intnatsubnet').value = intnat;
                document.getElementById('ospfareabranch').value = ospfArea;
                document.getElementById('wantunnelname').value = tunnelName;
                document.getElementById('province').value = prov.en;

                // Display auto-filled values
                document.getElementById('autoProvince').textContent = prov.en + ' (' + prov.abbr + ')';
                document.getElementById('autoLoopback').textContent = loopback;
                document.getElementById('autoIntnat').textContent = intnat;
                document.getElementById('autoOspf').textContent = ospfArea;
                document.getElementById('autoTunnelName').textContent = tunnelName;

                // Show panel
                document.getElementById('autoFieldsPanel').style.display = 'block';

                // Update tunnel description if branch name is already entered
                updateTunnelDesc();
            }
        });

        // ==================== TUNNEL DESCRIPTION ====================
        function updateTunnelDesc() {
            const branchNameEn = document.getElementById('branchNameEn').value.trim();
            if (!selectedBranchData || !branchNameEn) {
                document.getElementById('autoDescPanel').style.display = 'none';
                document.getElementById('wantunneldesc').value = '';
                return;
            }

            const desc = `** ${selectedBranchData.provinceAbbr}-${branchNameEn} **`;
            document.getElementById('wantunneldesc').value = desc;
            document.getElementById('autoTunnelDesc').textContent = desc;
            document.getElementById('autoDescPanel').style.display = 'block';
        }

        // Generate config button handler
        document.getElementById('generateBtn').addEventListener('click', async () => {
            const generateBtn = document.getElementById('generateBtn');

            const tunnelSelectValue = document.getElementById('tunnelSelect').value;
            if (!tunnelSelectValue) {
                showStatus('‚ö† Please select a tunnel first!', true);
                return;
            }

            let tunnelData;
            try {
                tunnelData = JSON.parse(tunnelSelectValue);
            } catch (e) {
                showStatus('‚ö† Invalid tunnel selection!', true);
                return;
            }

            let loopback = document.getElementById('loopbackip').value.trim();
            let srcBranch = document.getElementById('tunnelsourcebranch').value.trim();
            let intnat = document.getElementById('intnatsubnet').value.trim();
            let area = document.getElementById('ospfareabranch').value.trim();
            let wanName = document.getElementById('wantunnelname').value.trim();
            let wanDesc = document.getElementById('wantunneldesc').value.trim();
            let province = document.getElementById('province').value;

            if (!loopback || !intnat || !area || !wanName || !province) {
                showStatus('‚ö† Please select a branch first!', true);
                return;
            }
            if (!srcBranch) {
                showStatus('‚ö† Please enter Branch Tunnel Source!', true);
                return;
            }
            if (!wanDesc) {
                showStatus('‚ö† Please enter Branch Name (English) for tunnel description!', true);
                return;
            }

            if (currentUsername === 'unknown') {
                showStatus('‚ö† Please login first!', true);
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                return;
            }

            generateBtn.disabled = true;
            generateBtn.textContent = '‚è≥ Reserving tunnel...';

            try {
                console.log('Reserving tunnel:', tunnelData['IP Address']);

                const response = await fetch('/reserve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        'IP Address': tunnelData['IP Address'],
                        'Tunnel Name': wanName,
                        'IP LAN': intnat,
                        'IP Intranet': srcBranch,
                        'Description': wanDesc,
                        'Province': province,
                        'by': currentUsername
                    })
                });

                const result = await response.json();

                if (result.status === 'ok') {
                    showStatus(`‚úÖ Tunnel ${tunnelData['IP Address']} reserved successfully by ${currentUsername}!`);
                    console.log('‚úì Tunnel reserved successfully');
                    await loadTunnels();
                } else {
                    showStatus(`‚ùå Failed to reserve: ${result.error || 'Unknown error'}`, true);
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Generate Configs';
                    return;
                }

            } catch (err) {
                showStatus(`‚ùå Error: ${err.message}`, true);
                console.error('Reservation error:', err);
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate Configs';
                return;
            }

            let wanIp = tunnelData['IP Address'].split('/')[0];
            let mask = '255.255.255.254';

            function mirror200to201(ip) {
                let p = ip.split('.');
                if (p[0] === '10' && p[1] === '200') p[1] = '201';
                return p.join('.');
            }

            let t200wan = wanIp;
            let t201wan = mirror200to201(wanIp);

            let base = wanIp.split('.');
            base[3] = (parseInt(base[3]) + 1).toString();
            let t200br = base.join('.');
            let t201br = mirror200to201(t200br);

            // Branch Router Config
            const branchCfg = `
crypto isakmp policy 102
 encryption aes
 hash sha
 authentication pre-share
 group 2
crypto isakmp key N3w1ntr@n3t address 10.30.42.200
crypto isakmp key N3w1ntr@n3t address 10.30.42.201
!
crypto ipsec transform-set BK!-TR esp-aes 256 esp-sha-hmac
!
crypto ipsec transform-set INTR1 esp-aes 256 esp-sha-hmac 
 mode tunnel
crypto ipsec transform-set INTR2 esp-aes 256 esp-sha-hmac 
 mode tunnel
!
ip access-list extended INTR1ACL
 permit gre host ${srcBranch} host 10.30.42.200
ip access-list extended INTR2ACL
 permit gre host ${srcBranch} host 10.30.42.201
!
crypto map BKI-MAP-INT 1 ipsec-isakmp
 set peer 10.30.42.2
 set transform-set BK!-TR
 match address INTRANET-CRYPTO
!
crypto map BKI-MAP-INT 2 ipsec-isakmp
 set peer 10.30.42.200
 set transform-set INTR1
 match address INTR1ACL
crypto map BKI-MAP-INT 3 ipsec-isakmp
 set peer 10.30.42.201
 set transform-set INTR2
 match address INTR2ACL
!
interface Loopback2
 ip address ${loopback} 255.255.255.255
!
interface Tunnel200
 description Intranet - R1
 bandwidth 2000
 ip address ${t200br} ${mask}
 ip mtu 1360
 ip nat outside
 ip virtual-reassembly
 ip tcp adjust-mss 1320
 ip ospf cost 200
 keepalive 10 3
 tunnel source ${srcBranch}
 tunnel destination 10.30.42.200
!
interface Tunnel201
 description Intranet - R2
 bandwidth 2000
 ip address ${t201br} ${mask}
 ip mtu 1360
 ip nat outside
 ip virtual-reassembly
 ip tcp adjust-mss 1320
 ip ospf cost 400
 keepalive 10 3
 tunnel source ${srcBranch}
 tunnel destination 10.30.42.201
!
router ospf 200
 router-id ${loopback}
 network ${t200br} 0.0.0.0 area ${area}
 network ${t201br} 0.0.0.0 area ${area}
 network ${loopback} 0.0.0.0 area ${area}
!
ip access-list extended intnat
 permit ip ${intnat} 0.0.0.255 10.0.0.0 0.0.255.255
!
ip nat inside source list intnat interface Loopback2 overload
!
do wr
`.trim();

            // WAN-INTR1 Config
            const wan1Cfg = `
interface ${wanName}
 description ${wanDesc}
 ip address ${t200wan} ${mask}
 ip mtu 1360
 ip nat inside
 ip tcp adjust-mss 1320
 keepalive 10 3
 tunnel source 10.30.42.200
 tunnel destination ${srcBranch}
!
router ospf 200
 network ${t200wan} 0.0.0.0 area ${area}
!
do wr
`.trim();

            // WAN-INTR2 Config
            const wan2Cfg = `
interface ${wanName}
 description ${wanDesc}
 ip address ${t201wan} ${mask}
 ip mtu 1360
 ip nat inside
 ip tcp adjust-mss 1320
 keepalive 10 3
 tunnel source 10.30.42.201
 tunnel destination ${srcBranch}
!
router ospf 200
 network ${t201wan} 0.0.0.0 area ${area}
!
do wr
`.trim();

            // Put configs into three separate boxes
            document.getElementById('branchConfig').value = branchCfg;
            document.getElementById('wan1Config').value   = wan1Cfg;
            document.getElementById('wan2Config').value   = wan2Cfg;

            generateBtn.disabled = false;
            generateBtn.textContent = 'Generate Configs';

            console.log('‚úì Configuration generated successfully');
        });

        // Load tunnels and branches on page load
        loadTunnels();
        loadBranches();

        // Warn before leaving page with unsaved form data
        let formModified = false;
        document.querySelectorAll('input, select, textarea').forEach(el => {
            el.addEventListener('change', () => { formModified = true; });
            el.addEventListener('input', () => { formModified = true; });
        });
        window.addEventListener('beforeunload', function(e) {
            if (formModified) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>

<!-- ========== REMOTE CONNECTION MODAL ========== -->
<style>
.rc-overlay {
    position:fixed; inset:0; z-index:9999;
    background:rgba(0,0,0,0.6); backdrop-filter:blur(6px);
    display:none; align-items:center; justify-content:center;
}
.rc-overlay.show { display:flex; }
.rc-modal {
    background:var(--bg-card, #111827); border:1px solid var(--border-color, rgba(255,255,255,0.1));
    border-radius:16px; padding:28px; width:90%; max-width:420px;
    box-shadow:0 25px 60px rgba(0,0,0,0.5);
}
.rc-modal h3 {
    font-size:18px; font-weight:700; margin-bottom:4px;
    display:flex; align-items:center; gap:8px;
}
.rc-modal h3.ssh-title { color:#3b82f6; }
.rc-modal h3.rdp-title { color:#8b5cf6; }
.rc-modal .rc-sub { font-size:12px; color:var(--text-muted,#64748b); margin-bottom:20px; }
.rc-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.rc-group { margin-bottom:14px; }
.rc-group label { display:block; font-size:11px; font-weight:600; color:var(--text-muted,#64748b); margin-bottom:5px; text-transform:uppercase; letter-spacing:0.5px; }
.rc-group input, .rc-group select {
    width:100%; padding:9px 12px; background:var(--input-bg,#0f172a);
    border:1px solid var(--input-border,rgba(255,255,255,0.2)); border-radius:8px;
    color:var(--text-primary,#e2e8f0); font-size:13px; font-family:'JetBrains Mono',monospace; outline:none;
}
.rc-group input:focus, .rc-group select:focus {
    border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,0.15);
}
.rc-group select { cursor:pointer; }
.rc-btns { display:flex; gap:10px; margin-top:6px; }
.rc-btn-connect {
    flex:1; padding:10px; border:none; border-radius:10px; font-size:13px;
    font-weight:600; cursor:pointer; font-family:inherit; color:#fff;
    display:flex; align-items:center; justify-content:center; gap:6px;
}
.rc-btn-connect.ssh-btn { background:linear-gradient(135deg,#3b82f6,#2563eb); }
.rc-btn-connect.rdp-btn { background:linear-gradient(135deg,#8b5cf6,#7c3aed); }
.rc-btn-connect:hover { filter:brightness(1.1); transform:translateY(-1px); }
.rc-btn-cancel {
    padding:10px 18px; background:transparent; border:1px solid var(--border-color,rgba(255,255,255,0.1));
    border-radius:10px; color:var(--text-secondary,#94a3b8); font-size:13px;
    cursor:pointer; font-family:inherit;
}
.rc-btn-cancel:hover { background:rgba(255,255,255,0.05); }
.rc-ping-btn {
    padding:7px 14px; background:rgba(16,185,129,0.15); border:1px solid rgba(16,185,129,0.3);
    border-radius:8px; color:#34d399; font-size:12px; font-weight:600; cursor:pointer;
    font-family:inherit; display:flex; align-items:center; gap:5px;
}
.rc-ping-btn:hover { background:rgba(16,185,129,0.25); }
.rc-ping-result {
    margin-top:-4px; margin-bottom:14px; padding:8px 12px; border-radius:8px; font-size:12px; display:none;
}
.rc-ping-result.show { display:flex; align-items:center; gap:8px; }
.rc-ping-result.ok { background:rgba(16,185,129,0.12); color:#6ee7b7; border:1px solid rgba(16,185,129,0.2); }
.rc-ping-result.fail { background:rgba(239,68,68,0.12); color:#fca5a5; border:1px solid rgba(239,68,68,0.2); }
.rc-ping-result.loading { background:rgba(251,191,36,0.1); color:#fcd34d; border:1px solid rgba(251,191,36,0.2); }
</style>

<div class="rc-overlay" id="rcOverlay" onclick="if(event.target===this)closeRemoteModal()">
  <div class="rc-modal">
    <div id="rcSSH" style="display:none">
      <h3 class="ssh-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
        SSH / Telnet Terminal
      </h3>
      <p class="rc-sub">Connect to a network device via SSH or Telnet</p>
      <div class="rc-row">
        <div class="rc-group">
          <label>Protocol</label>
          <select id="rcProtocol" onchange="document.getElementById('rcPort').value=this.value==='ssh'?'22':'23'">
            <option value="ssh">SSH</option>
            <option value="telnet">Telnet</option>
          </select>
        </div>
        <div class="rc-group">
          <label>Port</label>
          <input type="number" id="rcPort" value="22">
        </div>
      </div>
      <div class="rc-group">
        <label>Host / IP Address</label>
        <div style="display:flex; gap:8px;">
          <input type="text" id="rcHost" placeholder="e.g. 10.250.1.1" style="flex:1;">
          <button type="button" class="rc-ping-btn" onclick="pingHost('rcHost','sshPingResult')">üì° Ping</button>
        </div>
      </div>
      <div class="rc-ping-result" id="sshPingResult"></div>
      <div class="rc-row">
        <div class="rc-group">
          <label>Username</label>
          <input type="text" id="rcUser" placeholder="admin">
        </div>
        <div class="rc-group">
          <label>Password</label>
          <input type="password" id="rcPass" placeholder="Password">
        </div>
      </div>
      <div class="rc-btns">
        <button class="rc-btn-connect ssh-btn" onclick="connectSSH()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
          Connect
        </button>
        <button class="rc-btn-cancel" onclick="closeRemoteModal()">Cancel</button>
      </div>
    </div>
    <div id="rcRDP" style="display:none">
      <h3 class="rdp-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
        Remote Desktop (RDP)
      </h3>
      <p class="rc-sub">Generate and download an .rdp file to connect via Windows Remote Desktop</p>
      <div class="rc-group">
        <label>Host / IP Address</label>
        <div style="display:flex; gap:8px;">
          <input type="text" id="rdpHost" placeholder="e.g. 192.168.1.100" style="flex:1;">
          <button type="button" class="rc-ping-btn" onclick="pingHost('rdpHost','rdpPingResult')">üì° Ping</button>
        </div>
      </div>
      <div class="rc-ping-result" id="rdpPingResult"></div>
      <div class="rc-row">
        <div class="rc-group">
          <label>Username (optional)</label>
          <input type="text" id="rdpUser" placeholder="Administrator">
        </div>
        <div class="rc-group">
          <label>Port</label>
          <input type="number" id="rdpPort" value="3389">
        </div>
      </div>
      <div class="rc-group">
        <label>Domain (optional)</label>
        <input type="text" id="rdpDomain" placeholder="DOMAIN">
      </div>
      <div class="rc-btns">
        <button class="rc-btn-connect rdp-btn" onclick="connectRDP()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          Download .rdp
        </button>
        <button class="rc-btn-cancel" onclick="closeRemoteModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
let terminalWindow = null;
let terminalConnected = false;

function openRemoteModal(type) {
    document.getElementById('rcOverlay').classList.add('show');
    document.getElementById('rcSSH').style.display = type === 'ssh' ? 'block' : 'none';
    document.getElementById('rcRDP').style.display = type === 'rdp' ? 'block' : 'none';
    if (type === 'ssh') document.getElementById('rcHost').focus();
    else document.getElementById('rdpHost').focus();
}
function closeRemoteModal() {
    document.getElementById('rcOverlay').classList.remove('show');
}

// Ping
async function pingHost(inputId, resultId) {
    const host = document.getElementById(inputId).value.trim();
    if (!host) { document.getElementById(inputId).focus(); return; }
    const el = document.getElementById(resultId);
    el.className = 'rc-ping-result show loading';
    el.innerHTML = '‚è≥ Pinging ' + host + '...';
    try {
        const res = await fetch('/api/ping', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({host: host})
        });
        const data = await res.json();
        if (data.reachable) {
            el.className = 'rc-ping-result show ok';
            el.innerHTML = '‚úÖ ' + host + ' is reachable' + (data.avg_ms ? ' (avg: ' + data.avg_ms + 'ms)' : '');
        } else {
            el.className = 'rc-ping-result show fail';
            el.innerHTML = '‚ùå ' + host + ' is unreachable';
        }
    } catch (e) {
        el.className = 'rc-ping-result show fail';
        el.innerHTML = '‚ùå Ping failed: ' + e.message;
    }
}

async function connectSSH() {
    const host = document.getElementById('rcHost').value.trim();
    if (!host) { document.getElementById('rcHost').focus(); return; }
    const params = {
        host: host,
        port: parseInt(document.getElementById('rcPort').value) || 22,
        protocol: document.getElementById('rcProtocol').value,
        username: document.getElementById('rcUser').value.trim(),
        password: document.getElementById('rcPass').value
    };
    try {
        const res = await fetch('/api/remote/session', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(params)
        });
        if (!res.ok) {
            alert('SSH/Telnet module is not available on the server.\nInstall: python -m pip install flask-socketio paramiko eventlet');
            return;
        }
        const data = await res.json();
        if (data.token) {
            terminalWindow = window.open('/terminal?token=' + data.token, 'terminalWindow',
                'width=1000,height=600,menubar=no,toolbar=no,location=no,status=no');
            closeRemoteModal();
            showDeployPanel();
        } else if (data.error) {
            alert('Error: ' + data.error);
        }
    } catch (e) { alert('Error: ' + e.message); }
}

async function connectRDP() {
    const host = document.getElementById('rdpHost').value.trim();
    if (!host) { document.getElementById('rdpHost').focus(); return; }
    try {
        const res = await fetch('/api/remote/rdp', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                host: host,
                port: parseInt(document.getElementById('rdpPort').value) || 3389,
                username: document.getElementById('rdpUser').value.trim(),
                domain: document.getElementById('rdpDomain').value.trim()
            })
        });
        if (!res.ok) {
            alert('RDP module is not available on the server.\nInstall: python -m pip install flask-socketio paramiko eventlet');
            return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = host.replace(/:/g, '_') + '.rdp';
        a.click();
        URL.revokeObjectURL(url);
        closeRemoteModal();
    } catch (e) { alert('Error: ' + e.message); }
}

// Deploy panel
function showDeployPanel() {
    document.getElementById('deployPanel').style.display = 'block';
    updateDeployStatus();
}

function updateDeployStatus() {
    const el = document.getElementById('deployStatus');
    if (terminalWindow && !terminalWindow.closed) {
        el.innerHTML = '<span style="color:#10b981;">‚óè Terminal open</span>';
    } else {
        el.innerHTML = '<span style="color:#94a3b8;">‚óã Terminal not connected</span>';
        terminalConnected = false;
    }
}

// Listen for terminal state messages
window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'terminal_state') {
        terminalConnected = event.data.state === 'connected';
        updateDeployStatus();
    }
});

function sendConfigToTerminal() {
    const selectEl = document.getElementById('configSelect');
    const configId = selectEl.value;
    if (!configId) { alert('Please select a config to send'); return; }
    if (!terminalWindow || terminalWindow.closed) {
        alert('Terminal is not open. Please connect via SSH/Telnet first.');
        return;
    }
    const configEl = document.getElementById(configId);
    if (!configEl) return;
    const text = configEl.value || configEl.textContent || configEl.innerText;
    if (!text || text.trim() === '' || text.trim() === 'Branch configuration will appear here...' || text.trim() === 'WAN-INTR1 configuration will appear here...' || text.trim() === 'WAN-INTR2 configuration will appear here...') {
        alert('Config is empty. Generate config first.');
        return;
    }
    const title = selectEl.options[selectEl.selectedIndex].text;
    terminalWindow.postMessage({ type: 'paste_config', text: text, title: title }, '*');
    terminalWindow.focus();
}

// Periodically check terminal window status
setInterval(updateDeployStatus, 3000);

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('rcOverlay').classList.contains('show')) {
        closeRemoteModal();
    }
});
document.querySelectorAll('#rcSSH input').forEach(el => {
    el.addEventListener('keypress', function(e) { if (e.key === 'Enter') connectSSH(); });
});
document.querySelectorAll('#rcRDP input').forEach(el => {
    el.addEventListener('keypress', function(e) { if (e.key === 'Enter') connectRDP(); });
});
</script>

</body>
</html>
