<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>APN-INT Config Generator</title>
  <style>
    body { font-family: sans-serif; background:#0f172a; padding:30px; color:#e2e8f0; }

    .top-bar {
      max-width:1200px; margin:0 auto 16px auto;
      display:flex; justify-content:space-between; align-items:center;
      background:#020617; padding:12px 20px; border-radius:12px;
      border:1px solid #1f2937;
    }
    .user-display {
      font-size:14px; color:#a0aec0;
    }
    .user-name {
      color:#38bdf8; font-weight:600; font-size:15px;
    }
    .logout-link {
      color:#f97373; text-decoration:none; font-size:13px;
    }
    .logout-link:hover { text-decoration:underline; }

    .app-title { max-width:1200px; margin:0 auto 20px auto; text-align:center; }
    .app-title h1 { font-size:26px; margin-bottom:6px; }
    .app-title p { font-size:14px; color:#a0aec0; }

    .card { max-width:1200px; margin:0 auto; background:#020617;
            border-radius:16px; padding:24px 24px 28px 24px;
            box-shadow:0 25px 60px rgba(0,0,0,0.65);
            border:1px solid #1f2937; }

    .section-title { font-size:18px; margin-bottom:12px; color:#e5e7eb; }

    .form-group { margin-bottom:18px; }
    label { font-size:14px; display:block; margin-bottom:6px; color:#e5e7eb; }
    .required { color:#f97373; }

    input, select {
      width:100%; padding:10px 12px; font-size:14px;
      border-radius:10px; border:1px solid #374151;
      background:#020617; color:#e5e7eb; box-sizing:border-box;
      outline:none; transition:all .2s ease;
    }
    input:focus, select:focus { border-color:#38bdf8; box-shadow:0 0 0 1px #38bdf8; }
    
    input:read-only {
      background:#111827;
      border-color:#4b5563;
      cursor:not-allowed;
      color:#9ca3af;
    }

    .branch-select {
      max-height:180px;
      overflow-y:auto;
    }

    .row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    @media (max-width: 900px) { .row { grid-template-columns:1fr; } }

    .row-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; }
    @media (max-width: 900px) { .row-3 { grid-template-columns:1fr; } }

    .btns { margin-top:10px; display:flex; gap:12px; flex-wrap:wrap; }
    button { padding:10px 18px; border:none; border-radius:999px; cursor:pointer;
             font-size:14px; font-weight:600; }
    .btn-generate { background:linear-gradient(135deg,#38bdf8,#6366f1); color:#0b1120; }
    .btn-reset { background:#111827; color:#e5e7eb; border:1px solid #374151; }

    .outputs-wrapper { margin-top:26px; display:grid; grid-template-columns:1fr; gap:18px; }
    @media (min-width: 960px) { .outputs-wrapper { grid-template-columns:repeat(3,1fr); } }

    .router-card {
      background:radial-gradient(circle at top,#1f2937 0,#020617 55%);
      border-radius:16px; padding:14px 14px 18px 14px;
      border:1px solid #4b5563;
      box-shadow:0 20px 45px rgba(15,23,42,0.9);
      position:relative; overflow:hidden;
    }
    .router-card::before {
      content:""; position:absolute; inset:-40%;
      background:radial-gradient(circle at top,#38bdf8 0,transparent 55%);
      opacity:0.10; pointer-events:none;
    }

    .router-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; position:relative; z-index:1; }
    .router-title { font-size:15px; font-weight:700; color:#f9fafb; }
    .router-tag { font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid #38bdf8; color:#e0f2fe; }

    .router-sub { font-size:12px; color:#9ca3af; margin-bottom:8px; position:relative; z-index:1; }

    .output {
      position:relative; z-index:1;
      background:#020617; border-radius:10px; border:1px solid #111827;
      padding:10px 12px; white-space:pre; font-family:"Fira Code",monospace;
      font-size:12px; line-height:1.55; color:#bbf7d0;
      max-height:420px; overflow:auto; direction:ltr; text-align:left;
    }

    .copy-btn { position:absolute; top:10px; left:12px; font-size:11px;
                padding:4px 10px; border-radius:999px; border:1px solid #4b5563;
                background:#020617; color:#e5e7eb; cursor:pointer; z-index:2; }

    .router-card-inner { position:relative; }

    .loading { color:#38bdf8; font-size:13px; }

    .info-badge {
      display:inline-block;
      background:#065f46;
      color:#6ee7b7;
      padding:2px 8px;
      border-radius:6px;
      font-size:11px;
      margin-right:8px;
      font-weight:600;
    }

    .help-text {
      font-size:12px;
      color:#94a3b8;
      margin-top:4px;
    }

    .province-filter {
      border:1px solid #f59e0b !important;
      background:#1f2937 !important;
    }

    .lan-ip-select {
      border:1px solid #10b981 !important;
      background:#1f2937 !important;
    }

    .apn-ip-display {
      border:1px solid #8b5cf6 !important;
      background:#1f2937 !important;
    }

    .section-divider {
      height:1px;
      background:linear-gradient(90deg, transparent, #374151, transparent);
      margin:24px 0;
    }

    .warning-badge {
      display:inline-block;
      background:#7c2d12;
      color:#fca5a5;
      padding:2px 8px;
      border-radius:6px;
      font-size:11px;
      margin-right:8px;
      font-weight:600;
    }
    
    .success-badge {
      display:inline-block;
      background:#065f46;
      color:#6ee7b7;
      padding:2px 8px;
      border-radius:6px;
      font-size:11px;
      margin-right:8px;
      font-weight:600;
    }

    .error-message {
      background:#7f1d1d;
      color:#fca5a5;
      padding:12px;
      border-radius:8px;
      margin-top:10px;
      font-size:13px;
    }
    
    .success-message {
      background:#065f46;
      color:#6ee7b7;
      padding:12px;
      border-radius:8px;
      margin-top:10px;
      font-size:13px;
    }

    .new-branch-indicator {
      display:inline-block;
      background:#065f46;
      color:#6ee7b7;
      padding:4px 10px;
      border-radius:6px;
      font-size:12px;
      margin-top:8px;
      font-weight:600;
    }

    .existing-branch-indicator {
      display:inline-block;
      background:#1e40af;
      color:#93c5fd;
      padding:4px 10px;
      border-radius:6px;
      font-size:12px;
      margin-top:8px;
      font-weight:600;
    }

    /* Style for English Route Name field */
    .route-name-field {
      border:2px solid #f59e0b !important;
      background:#1f2937 !important;
    }

    #routeNameGroup {
      display:none;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity:0; transform:translateY(-10px); }
      to { opacity:1; transform:translateY(0); }
    }
  </style>
</head>
<body>

<!-- Top bar showing logged in user -->
<div class="top-bar">
  <div style="display:flex; align-items:center; gap:16px;">
    <a href="/" style="background:#3b82f6; color:white; padding:8px 16px; border-radius:8px; text-decoration:none; font-size:13px; font-weight:600;">
      â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ Ø§ØµÙ„ÛŒ
    </a>
    <div class="user-display">
      ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ø§Ù„: <span class="user-name" id="currentUser">...</span>
    </div>
  </div>
  <a href="/login" class="logout-link" onclick="localStorage.clear(); sessionStorage.clear();">Ø®Ø±ÙˆØ¬</a>
</div>

<div class="app-title">
  <h1>APN-INT (ØºÛŒØ±Ù…Ø§Ù„ÛŒ)</h1>
  <p>ØªÙˆÙ„ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø´Ø¹Ø¨Ù‡ + HUB + ASR</p>
</div>

<div class="card">
  <div class="section-title">ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§</div>

  <form id="configForm">
    <!-- Branch name - MANDATORY -->
    <div class="form-group">
      <label for="branchName">
        <span class="required">*</span>
        Ù†Ø§Ù… Ø´Ø¹Ø¨Ù‡ (Province - Branch Name)
      </label>
      <input id="branchName" 
             type="text" 
             list="branchList" 
             placeholder="Ù†Ø§Ù… Ø´Ø¹Ø¨Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯"
             autocomplete="off"
             required>
      <datalist id="branchList">
        <option value="">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option>
      </datalist>
      <div class="help-text">
        ğŸ’¡ <strong>Ø¨Ø±Ø§ÛŒ Ø´Ø¹Ø¨Ø§Øª Ù…ÙˆØ¬ÙˆØ¯:</strong> Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ | 
        <strong>Ø¨Ø±Ø§ÛŒ Ù†Ù‚Ø§Ø· Ø¬Ø¯ÛŒØ¯:</strong> Ù†Ø§Ù… Ø±Ø§ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯
      </div>
    </div>

    <!-- Route Name Field (appears only for existing branches) -->
    <div class="form-group" id="routeNameGroup">
      <label for="routeName">
        <span class="warning-badge">ğŸ”¤ Ø§Ø¬Ø¨Ø§Ø±ÛŒ</span>
        <span class="required">*</span>
        Route Name (English) - for ASR routing
      </label>
      <input id="routeName" 
             type="text" 
             class="route-name-field"
             placeholder="Example: Tehran-Branch-01, Mashhad-Central, etc."
             autocomplete="off">
      <div class="help-text">
        âš ï¸ <strong>Ù†Ø§Ù… ÙØ§Ø±Ø³ÛŒ Ø¯Ø± Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª!</strong> Ù„Ø·ÙØ§Ù‹ Ù…Ø¹Ø§Ø¯Ù„ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ù†Ø§Ù… Ø´Ø¹Ø¨Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯
      </div>
    </div>

    <div class="section-divider"></div>

    <!-- LAN IP Selection Section -->
    <div class="section-title">Ø§Ù†ØªØ®Ø§Ø¨ IP LAN (Ø§Ø² Ø§Ø³ØªØ§Ù† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±)</div>

    <div class="row">
      <div class="form-group">
        <label for="lanProvinceFilter">
          <span class="info-badge">ğŸ—ºï¸ Ø§Ø³ØªØ§Ù†</span>
          <span class="required">*</span> Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªØ§Ù† Ø¨Ø±Ø§ÛŒ IP LAN
        </label>
        <select id="lanProvinceFilter" class="province-filter" required>
          <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>
        </select>
        <div class="help-text">ğŸ“ Ø§Ø³ØªØ§Ù† Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† IP Ù‡Ø§ÛŒ LAN Ø¢Ø²Ø§Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ (Ø§Ø¬Ø¨Ø§Ø±ÛŒ)</div>
      </div>

      <div class="form-group">
        <label for="freeLanIp">
          <span class="info-badge" id="lanFreeCount">0 Ø¢Ø²Ø§Ø¯</span>
          <span class="required">*</span> IP LAN
        </label>
        <select id="freeLanIp" class="lan-ip-select" disabled required>
          <option value="">Ø§Ø¨ØªØ¯Ø§ Ø§Ø³ØªØ§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
        </select>
        <div class="help-text">ğŸŒ IP LAN Ø¢Ø²Ø§Ø¯ Ø§Ø² Ø§Ø³ØªØ§Ù† Ø§Ù†ØªØ®Ø§Ø¨ÛŒ (Ø§Ø¬Ø¨Ø§Ø±ÛŒ)</div>
      </div>
    </div>

    <div class="section-divider"></div>

    <!-- APN IP Section - AUTO-ASSIGNED -->
    <div class="section-title">IP APN (10.250.66.x - ØºÛŒØ±Ù…Ø§Ù„ÛŒ) - Ø±Ø²Ø±Ùˆ Ø®ÙˆØ¯Ú©Ø§Ø±</div>

    <div class="form-group">
      <label for="autoApnIp">
        <span class="success-badge">âœ… Ø®ÙˆØ¯Ú©Ø§Ø±</span>
        <span class="info-badge" id="freeCount">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
        IP APN ØªØ®ØµÛŒØµ ÛŒØ§ÙØªÙ‡
      </label>
      <input id="autoApnIp" 
             type="text" 
             class="apn-ip-display" 
             readonly 
             placeholder="Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§ÙˆÙ„ÛŒÙ† IP Ø¢Ø²Ø§Ø¯...">
      <div class="help-text">
        âœ¨ Ø§ÙˆÙ„ÛŒÙ† IP Ø¢Ø²Ø§Ø¯ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø±Ø²Ø±Ùˆ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (IP HUB: 10.250.66.1)
      </div>
      <div id="apn-error" class="error-message" style="display:none;"></div>
      <div id="apn-success" class="success-message" style="display:none;"></div>
    </div>

    <div class="section-divider"></div>

    <!-- Tunnel200 IPs - AUTO-ASSIGNED -->
    <div class="section-title">Tunnel200 IPs (/31) - Ø±Ø²Ø±Ùˆ Ø®ÙˆØ¯Ú©Ø§Ø±</div>

    <div class="row">
      <div class="form-group">
        <label for="autoTun200Hub">
          <span class="success-badge">âœ… Ø®ÙˆØ¯Ú©Ø§Ø±</span>
          IP HUB Ø±ÙˆÛŒ Tunnel200
        </label>
        <input id="autoTun200Hub" 
               type="text" 
               class="apn-ip-display" 
               readonly 
               placeholder="Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...">
        <div class="help-text">âœ¨ IP Ø³Ù…Øª HUB Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ®ØµÛŒØµ Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯</div>
      </div>

      <div class="form-group">
        <label for="autoTun200Branch">
          <span class="success-badge">âœ… Ø®ÙˆØ¯Ú©Ø§Ø±</span>
          IP Ø´Ø¹Ø¨Ù‡ Ø±ÙˆÛŒ Tunnel200
        </label>
        <input id="autoTun200Branch" 
               type="text" 
               class="apn-ip-display" 
               readonly 
               placeholder="Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...">
        <div class="help-text">âœ¨ IP Ø³Ù…Øª Branch Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ®ØµÛŒØµ Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯</div>
      </div>
    </div>

    <div class="form-group">
      <span class="info-badge" id="tunnel200Count">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
      <span style="font-size:13px; color:#94a3b8;">Ø¬ÙØª /31 Ø¢Ø²Ø§Ø¯ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª</span>
    </div>

    <div id="tunnel200-error" class="error-message" style="display:none;"></div>
    <div id="tunnel200-success" class="success-message" style="display:none;"></div>

    <div class="section-divider"></div>

    <!-- Configuration Fields -->
    <div class="row">
      <div class="form-group">
        <label for="wanIface">Ù†Ø§Ù… Ø§ÛŒÙ†ØªØ±ÙÛŒØ³ WAN Ø±ÙˆÛŒ Ø´Ø¹Ø¨Ù‡ <span class="required">*</span></label>
        <input id="wanIface" type="text" value="FastEthernet0/1" required>
        <div class="help-text">Ù…Ø«Ø§Ù„: FastEthernet0/1 ÛŒØ§ GigabitEthernet0/0</div>
      </div>

      <div class="form-group">
        <label for="hubTunnelId">
          <span class="required">*</span>
          Ø´Ù…Ø§Ø±Ù‡ Ø§ÛŒÙ†ØªØ±ÙÛŒØ³ Tunnel Ø±ÙˆÛŒ HUB
        </label>
        <input id="hubTunnelId" 
               type="number" 
               placeholder="Ù…Ø«Ø§Ù„: 9157" 
               required>
        <div class="help-text">âš ï¸ Ø´Ù…Ø§Ø±Ù‡ ÛŒÚ©ØªØ§ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ØªÙˆÙ†Ù„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
      </div>
    </div>

    <div class="form-group">
      <label for="hubDescription">
        <span class="info-badge">ğŸ“ HUB</span>
        Tunnel Description for HUB Router (English) <span class="required">*</span>
      </label>
      <input id="hubDescription" 
             type="text" 
             placeholder="Example: APN-INT-Tehran-Branch-01" 
             required>
      <div class="help-text">ğŸ¯ Ø§ÛŒÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Tunnel Ø±ÙˆÛŒ HUB Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ù†Ù‡ Branch)</div>
    </div>

    <!-- HIDDEN FIELDS -->
    <input id="ospfProcess" type="hidden" value="200">
    <input id="ospfArea" type="hidden" value="">

    <div class="btns">
      <button type="submit" class="btn-generate"> ØªÙˆÙ„ÛŒØ¯ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ùˆ Ø±Ø²Ø±Ùˆ IP</button>
      <button type="reset" class="btn-reset">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
    </div>
  </form>

  <div id="outputs" class="outputs-wrapper" style="display:none;">
    <div class="router-card">
      <div class="router-card-inner">
        <div class="router-header">
          <div class="router-title">Branch Router</div>
          <div class="router-tag">Spoke</div>
        </div>
        <div class="router-sub" id="branchSub">Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø´Ø¹Ø¨Ù‡</div>
        <button class="copy-btn" type="button" onclick="copyText('branchOut')">Copy</button>
        <div id="branchOut" class="output"></div>
      </div>
    </div>

    <div class="router-card">
      <div class="router-card-inner">
        <div class="router-header">
          <div class="router-title">APN-INT-HUB Router</div>
          <div class="router-tag">Hub</div>
        </div>
        <div class="router-sub" id="hubSub">Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ ØªÙˆÙ†Ù„ HUB</div>
        <button class="copy-btn" type="button" onclick="copyText('hubOut')">Copy</button>
        <div id="hubOut" class="output"></div>
      </div>
    </div>

    <div class="router-card">
      <div class="router-card-inner">
        <div class="router-header">
          <div class="router-title">ASR1006-WAN-MB</div>
          <div class="router-tag">Core</div>
        </div>
        <div class="router-sub" id="asrSub">Route towards APN-INT</div>
        <button class="copy-btn" type="button" onclick="copyText('asrOut')">Copy</button>
        <div id="asrOut" class="output"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ========== AUTO-LOGIN CHECK ==========
const currentUsername = localStorage.getItem('currentUser') ||
localStorage.getItem('username') || sessionStorage.getItem('username');

if (!currentUsername) {
  alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø³ÛŒØ³ØªÙ… Ø´ÙˆÛŒØ¯');
  window.location.href = '/login';
} else {
  document.getElementById('currentUser').textContent = currentUsername;
  console.log(`âœ“ Logged in as: ${currentUsername}`);
}

let allBranches = [];
let autoAssignedApnIp = null;
let autoAssignedTunnel200 = null;
let selectedBranchData = null;

// Fixed values
const FIXED_HUB_APN_IP = '10.250.66.1';
const FIXED_ASR_NEXTHOP = '10.0.151.4';
const FIXED_OSPF_PROCESS = '200';

// ========== AUTO-ASSIGN FIRST FREE APN IP ==========
async function autoAssignApnIp() {
  const inputField = document.getElementById('autoApnIp');
  const counter = document.getElementById('freeCount');
  const errorDiv = document.getElementById('apn-error');
  const successDiv = document.getElementById('apn-success');

  try {
    console.log('ğŸ” Auto-assigning first free APN IP...');
    
    inputField.value = 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...';
    counter.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...';
    
    const res = await fetch('/api/apn-ips');

    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }

    const ips = await res.json();
    console.log(`âœ“ Received ${ips.length} free APN IPs from server`);

    if (ips.length === 0) {
      inputField.value = 'âŒ Ù‡ÛŒÚ† IP Ø¢Ø²Ø§Ø¯ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª';
      counter.textContent = '0 Ø¢Ø²Ø§Ø¯';
      errorDiv.textContent = 'âš ï¸ Ù‡ÛŒÚ† IP APN Ø¢Ø²Ø§Ø¯ÛŒ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ… ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.';
      errorDiv.style.display = 'block';
      successDiv.style.display = 'none';
      autoAssignedApnIp = null;
      return;
    }

    // Auto-assign the FIRST free IP
    autoAssignedApnIp = ips[0].ip;
    inputField.value = autoAssignedApnIp;
    counter.textContent = `${ips.length} Ø¢Ø²Ø§Ø¯`;
    
    successDiv.textContent = `âœ… Ø§ÙˆÙ„ÛŒÙ† IP Ø¢Ø²Ø§Ø¯ (${autoAssignedApnIp}) Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡ Ø§Ø³Øª`;
    successDiv.style.display = 'block';
    errorDiv.style.display = 'none';
    
    console.log(`âœ… Auto-assigned APN IP: ${autoAssignedApnIp}`);

  } catch (err) {
    console.error('âŒ Failed to auto-assign APN IP:', err);
    inputField.value = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ';
    counter.textContent = 'Ø®Ø·Ø§';
    errorDiv.textContent = `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª IP Ù‡Ø§ÛŒ APN: ${err.message}`;
    errorDiv.style.display = 'block';
    successDiv.style.display = 'none';
    autoAssignedApnIp = null;
  }
}

// ========== AUTO-ASSIGN FIRST FREE TUNNEL200 /31 PAIR ==========
async function autoAssignTunnel200() {
  const hubInput = document.getElementById('autoTun200Hub');
  const branchInput = document.getElementById('autoTun200Branch');
  const counter = document.getElementById('tunnel200Count');
  const errorDiv = document.getElementById('tunnel200-error');
  const successDiv = document.getElementById('tunnel200-success');

  try {
    console.log('ğŸ” Auto-assigning first free Tunnel200 /31 pair...');
    
    hubInput.value = 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...';
    branchInput.value = 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...';
    counter.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...';
    
    const res = await fetch('/api/tunnel200-ips');

    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }

    const pairs = await res.json();
    console.log(`âœ“ Received ${pairs.length} free Tunnel200 /31 pairs from server`);

    if (pairs.length === 0) {
      hubInput.value = 'âŒ Ù‡ÛŒÚ† IP Ø¢Ø²Ø§Ø¯ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª';
      branchInput.value = 'âŒ Ù‡ÛŒÚ† IP Ø¢Ø²Ø§Ø¯ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª';
      counter.textContent = '0';
      errorDiv.textContent = 'âš ï¸ Ù‡ÛŒÚ† Tunnel200 /31 IP Ø¢Ø²Ø§Ø¯ÛŒ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.';
      errorDiv.style.display = 'block';
      successDiv.style.display = 'none';
      autoAssignedTunnel200 = null;
      return;
    }

    // Auto-assign the FIRST free /31 pair
    autoAssignedTunnel200 = pairs[0];
    hubInput.value = autoAssignedTunnel200.hub_ip;
    branchInput.value = autoAssignedTunnel200.branch_ip;
    counter.textContent = `${pairs.length}`;
    
    successDiv.textContent = `âœ… Ø¬ÙØª /31 Ø¢Ø²Ø§Ø¯ (${autoAssignedTunnel200.pair}) Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡ Ø§Ø³Øª`;
    successDiv.style.display = 'block';
    errorDiv.style.display = 'none';
    
    console.log(`âœ… Auto-assigned Tunnel200: HUB=${autoAssignedTunnel200.hub_ip}, Branch=${autoAssignedTunnel200.branch_ip}`);

  } catch (err) {
    console.error('âŒ Failed to auto-assign Tunnel200 IPs:', err);
    hubInput.value = 'âŒ Ø®Ø·Ø§';
    branchInput.value = 'âŒ Ø®Ø·Ø§';
    counter.textContent = 'Ø®Ø·Ø§';
    errorDiv.textContent = `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Tunnel200 IPs: ${err.message}`;
    errorDiv.style.display = 'block';
    successDiv.style.display = 'none';
    autoAssignedTunnel200 = null;
  }
}

// Load branches into datalist
async function loadBranches() {
  try {
    const res = await fetch('/api/branches');
    const branches = await res.json();

    branches.sort((a, b) => {
      if (a.province !== b.province) {
        return a.province.localeCompare(b.province);
      }
      return a.name.localeCompare(b.name);
    });

    allBranches = branches;
    renderBranches(allBranches);

    console.log(`âœ“ Loaded ${branches.length} branches`);
  } catch (err) {
    console.error('Failed to load branches:', err);
    document.getElementById('branchList').innerHTML = '<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</option>';
  }
}

function renderBranches(branches) {
  const datalist = document.getElementById('branchList');
  datalist.innerHTML = '';

  branches.forEach(b => {
    const opt = document.createElement('option');
    opt.value = `${b.name} - [${b.province}] (10.${b.x}.${b.y}.0)`;
    opt.setAttribute('data-x', b.x);
    opt.setAttribute('data-y', b.y);
    opt.setAttribute('data-province', b.province);
    opt.setAttribute('data-name', b.name);
    datalist.appendChild(opt);
  });
}

// Load provinces for LAN IP filter
async function loadLanProvinces() {
  try {
    const res = await fetch('/api/provinces');
    const provinces = await res.json();

    const sel = document.getElementById('lanProvinceFilter');
    sel.innerHTML = '<option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>';

    provinces.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = p;
      sel.appendChild(opt);
    });

    console.log(`âœ“ Loaded ${provinces.length} provinces for LAN IPs`);
  } catch (err) {
    console.error('Failed to load provinces:', err);
  }
}

// Load free LAN IPs from selected province
async function loadFreeLanIps(province) {
  const sel = document.getElementById('freeLanIp');
  const counter = document.getElementById('lanFreeCount');

  if (!province) {
    sel.innerHTML = '<option value="">Ø§Ø¨ØªØ¯Ø§ Ø§Ø³ØªØ§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>';
    sel.disabled = true;
    counter.textContent = '0 Ø¢Ø²Ø§Ø¯';
    return;
  }

  try {
    sel.innerHTML = '<option value="">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option>';
    sel.disabled = true;

    const res = await fetch(`/api/free-lan-ips?province=${encodeURIComponent(province)}`);
    const ips = await res.json();

    sel.innerHTML = '<option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>';

    ips.forEach(ip => {
      const opt = document.createElement('option');
      opt.value = ip.ip;
      opt.textContent = ip.ip;
      sel.appendChild(opt);
    });

    sel.disabled = false;
    counter.textContent = `${ips.length} Ø¢Ø²Ø§Ø¯`;
    console.log(`âœ“ Found ${ips.length} free LAN IPs for ${province}`);
  } catch (err) {
    console.error('Failed to load LAN IPs:', err);
    sel.innerHTML = '<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</option>';
    counter.textContent = '0';
  }
}

// Auto-calculate OSPF Area
document.getElementById('freeLanIp').addEventListener('change', function() {
  const lanIp = this.value;

  if (lanIp) {
    const parts = lanIp.split('.');
    if (parts.length >= 2) {
      const ospfArea = parts[1];
      document.getElementById('ospfArea').value = ospfArea;
      console.log(`âœ“ Auto-calculated OSPF Area: ${ospfArea} from LAN IP: ${lanIp}`);
    }
  } else {
    document.getElementById('ospfArea').value = '';
  }
});

// ========== Handle existing branch selection ==========
document.getElementById('branchName').addEventListener('input', function() {
  const branchInput = this.value.trim();
  const routeNameGroup = document.getElementById('routeNameGroup');
  const routeNameInput = document.getElementById('routeName');

  // Check if user selected from datalist (existing branch)
  const match = branchInput.match(/\(10\.(\d+)\.(\d+)\.0\)/);

  if (match) {
    // EXISTING BRANCH SELECTED
    const lanIp = match[0].replace(/[()]/g, '');
    const x = match[1];
    const y = match[2];

    console.log(`âœ“ Detected existing branch with LAN IP: ${lanIp}`);

    // Extract province from branch input
    const provinceMatch = branchInput.match(/\[([^\]]+)\]/);
    let detectedProvince = null;
    
    if (provinceMatch) {
      detectedProvince = provinceMatch[1];
      console.log(`âœ“ Detected province: ${detectedProvince}`);
    }

    // Find branch in allBranches to get province
    const branchData = allBranches.find(b => 
      `10.${b.x}.${b.y}.0` === lanIp
    );

    if (branchData) {
      selectedBranchData = branchData;
      detectedProvince = branchData.province;
      console.log(`âœ“ Found branch data:`, branchData);
    }

    // Auto-select province
    if (detectedProvince) {
      const provinceSelect = document.getElementById('lanProvinceFilter');
      provinceSelect.value = detectedProvince;
      console.log(`âœ“ Auto-selected province: ${detectedProvince}`);
      
      // Load LAN IPs for this province
      loadFreeLanIps(detectedProvince).then(() => {
        // After loading, select the existing branch's LAN IP
        const lanSelect = document.getElementById('freeLanIp');
        
        let optionExists = false;
        for (let i = 0; i < lanSelect.options.length; i++) {
          if (lanSelect.options[i].value === lanIp) {
            optionExists = true;
            lanSelect.value = lanIp;
            break;
          }
        }

        if (!optionExists) {
          const customOpt = document.createElement('option');
          customOpt.value = lanIp;
          customOpt.textContent = `${lanIp} (Ø´Ø¹Ø¨Ù‡ Ù…ÙˆØ¬ÙˆØ¯ - Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…Ø¬Ø¯Ø¯)`;
          customOpt.style.color = '#fbbf24';
          customOpt.className = 'existing-branch-ip';
          lanSelect.insertBefore(customOpt, lanSelect.firstChild);
          lanSelect.value = lanIp;
          console.log(`âœ“ Added existing branch IP to dropdown: ${lanIp}`);
        }

        document.getElementById('ospfArea').value = x;
        console.log(`âœ“ Auto-calculated OSPF Area: ${x}`);
      });
    }

    // Show Route Name field for existing branches
    routeNameGroup.style.display = 'block';
    routeNameInput.setAttribute('required', 'required');
    console.log('âœ“ Showing Route Name field (Persian branch name detected)');

  } else {
    // NEW BRANCH (user typing manually)
    routeNameGroup.style.display = 'none';
    routeNameInput.removeAttribute('required');
    routeNameInput.value = '';
    selectedBranchData = null;
    console.log('â„¹ï¸ New branch - Route Name field hidden');
  }
});

// LAN Province filter change handler
document.getElementById('lanProvinceFilter').addEventListener('change', function() {
  const province = this.value;
  loadFreeLanIps(province);
});

function lanNetwork(x, y) {
  return "10." + x + "." + y + ".0";
}

// Generate configurations
function generateConfigsSeparated(d) {
  const loop2 = "10.210." + d.x + "." + d.y;
  const lanNet = lanNetwork(d.x, d.y);

  const branchCfg = `!
! ===== Branch Router (${d.branchName}) - APN ØºÛŒØ±Ù…Ø§Ù„ÛŒ =====
!
crypto isakmp policy 101
 encr aes
 authentication pre-share
 group 2
!
crypto isakmp key G!l@n3tIntr@n3t address ${d.hubApnIp}
!
crypto ipsec transform-set GILANETTS esp-aes esp-sha-hmac
!
crypto map GILANET 10 ipsec-isakmp
 set peer ${d.hubApnIp}
 set transform-set GILANETTS
 match address GILANET-ACL
!
interface Loopback2
 ip address ${loop2} 255.255.255.255
!
interface Tunnel200
 description ** APN-INT-HUB **
 ip address ${d.tun200Branch} 255.255.255.254
 ip mtu 1460
 ip nat outside
 ip virtual-reassembly
 ip tcp adjust-mss 1420
 ip ospf hello-interval 100
 ip ospf dead-interval 300
 ip ospf mtu-ignore
 tunnel source ${d.branchApnIp}
 tunnel destination ${d.hubApnIp}
!
interface ${d.wanIface}
 ip address ${d.branchApnIp} 255.255.255.0
 ip virtual-reassembly
 crypto map GILANET
!
router ospf ${d.ospfProcess}
 router-id ${loop2}
 log-adjacency-changes
 network ${d.tun200Branch} 0.0.0.0 area ${d.ospfArea}
 network ${loop2} 0.0.0.0 area ${d.ospfArea}
!
ip nat inside source list intnat interface Loopback2 overload
!
ip access-list extended GILANET-ACL
 permit gre host ${d.branchApnIp} host ${d.hubApnIp}
!
ip access-list extended intnat
 permit ip ${lanNet} 0.0.0.255 10.0.54.0 0.0.0.255
 permit ip ${lanNet} 0.0.0.255 10.0.55.0 0.0.0.255
 permit ip ${lanNet} 0.0.0.255 10.0.68.0 0.0.0.255
 permit ip ${lanNet} 0.0.0.255 10.0.76.0 0.0.0.255
 permit ip ${lanNet} 0.0.0.255 10.0.89.0 0.0.0.255
 permit ip ${lanNet} 0.0.0.255 host 10.0.97.26
 permit ip ${lanNet} 0.0.0.255 host 10.0.192.206
 permit ip ${lanNet} 0.0.0.255 host 10.42.8.129
 permit ip ${lanNet} 0.0.0.255 host 10.42.19.129
!`;

  const hubCfg = `!
! ===== APN-INT-HUB Router =====
!
interface Tunnel${d.hubTunnelId}
 description ** ${d.hubDescription} **
 ip address ${d.tun200Hub} 255.255.255.254
 ip mtu 1460
 ip virtual-reassembly
 ip tcp adjust-mss 1420
 ip ospf hello-interval 100
 ip ospf dead-interval 300
 ip ospf mtu-ignore
 tunnel source ${d.hubApnIp}
 tunnel destination ${d.branchApnIp}
!
router ospf ${d.ospfProcess}
 network ${d.tun200Hub} 0.0.0.0 area ${d.ospfArea}
!`;

  const asrCfg = `!
! ===== ASR1006-WAN-MB =====
ip route ${loop2} 255.255.255.255 ${d.asrNextHop} name ${d.routeName}-APN-INT
!`;

  return { branchCfg, hubCfg, asrCfg };
}

function copyText(id){
  const el = document.getElementById(id);
  if (!el) {
    alert('âŒ Ø®Ø·Ø§: Ø¹Ù†ØµØ± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯');
    return;
  }
  const text = el.textContent || el.innerText;
  
  if (!text || text.trim() === '') {
    alert('âŒ Ø®Ø·Ø§: Ù…ØªÙ†ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
    return;
  }
  
  // Try modern clipboard API first
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      // Find the button and show success
      const btn = el.parentElement.querySelector('.copy-btn');
      if (btn) {
        const originalText = btn.textContent;
        btn.textContent = 'âœ… Ú©Ù¾ÛŒ Ø´Ø¯!';
        btn.style.background = '#10b981';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '';
        }, 2000);
      } else {
        alert('âœ… Ú©Ù¾ÛŒ Ø´Ø¯!');
      }
    }).catch(err => {
      console.error('Clipboard write failed:', err);
      fallbackCopy(text);
    });
  } else {
    fallbackCopy(text);
  }
}

// Fallback copy method for older browsers or when clipboard API fails
function fallbackCopy(text) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.position = 'fixed';
  textArea.style.left = '-9999px';
  textArea.style.top = '0';
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  
  try {
    const successful = document.execCommand('copy');
    if (successful) {
      alert('âœ… Ú©Ù¾ÛŒ Ø´Ø¯!');
    } else {
      alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†');
    }
  } catch (err) {
    console.error('Fallback copy failed:', err);
    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†. Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯.');
  }
  
  document.body.removeChild(textArea);
}

// ========== FORM SUBMIT HANDLER ==========
document.getElementById('configForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const username = localStorage.getItem('currentUser') || localStorage.getItem('username') || sessionStorage.getItem('username');

  if (!username) {
    alert('Ø®Ø·Ø§: Ú©Ø§Ø±Ø¨Ø± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.');
    window.location.href = '/login';
    return;
  }

  const branchInput = document.getElementById('branchName').value.trim();
  const routeNameInput = document.getElementById('routeName').value.trim();
  const lanIp = document.getElementById('freeLanIp').value;
  const province = document.getElementById('lanProvinceFilter').value;
  const apnIp = autoAssignedApnIp;
  const hubDescription = document.getElementById('hubDescription').value.trim();
  const hubTunnelId = document.getElementById('hubTunnelId').value.trim();

  // ========== VALIDATION ==========
  
  if (!branchInput) {
    alert('âš ï¸ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø´Ø¹Ø¨Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    document.getElementById('branchName').focus();
    return;
  }

  if (!province) {
    alert('âš ï¸ Ù„Ø·ÙØ§Ù‹ Ø§Ø³ØªØ§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
    document.getElementById('lanProvinceFilter').focus();
    return;
  }

  if (!lanIp) {
    alert('âš ï¸ Ù„Ø·ÙØ§Ù‹ IP LAN Ø±Ø§ Ø§Ø² Ø§Ø³ØªØ§Ù† Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø¨Ø±Ú¯Ø²ÛŒÙ†ÛŒØ¯');
    document.getElementById('freeLanIp').focus();
    return;
  }

  if (!apnIp) {
    alert('âš ï¸ IP APN Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ®ØµÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.');
    return;
  }

  if (!autoAssignedTunnel200) {
    alert('âš ï¸ Tunnel200 IP pair Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ®ØµÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.');
    return;
  }

  if (!hubTunnelId) {
    alert('âš ï¸ Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Tunnel Ø±ÙˆÛŒ HUB Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    document.getElementById('hubTunnelId').focus();
    return;
  }

  if (!hubDescription) {
    alert('âš ï¸ Ù„Ø·ÙØ§Ù‹ Tunnel Description for HUB Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    document.getElementById('hubDescription').focus();
    return;
  }

  // Parse branch info
  let x, y, branchName, routeName;

  // Get X and Y from LAN IP
  const parts = lanIp.split('.');
  if (parts.length >= 3) {
    x = parts[1];
    y = parts[2];
  }

  // Check if existing branch (has pattern)
  const isExistingBranch = branchInput.match(/\(10\.\d+\.\d+\.0\)/);

  if (isExistingBranch) {
    // EXISTING BRANCH
    branchName = branchInput.split(' - ')[0].trim();
    
    // Route name is MANDATORY for existing branches
    if (!routeNameInput) {
      alert('âš ï¸ Ù„Ø·ÙØ§Ù‹ Route Name (English) Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
      document.getElementById('routeName').focus();
      return;
    }
    routeName = routeNameInput;
    console.log(`âœ“ Existing branch: ${branchName}, Route name: ${routeName}`);
  } else {
    // NEW BRANCH
    branchName = branchInput;
    routeName = branchInput;
    console.log(`âœ“ New branch: ${branchName}`);
  }

  if (!x || !y) {
    alert('âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ X Ùˆ Y Ø§Ø² IP LAN');
    return;
  }

  const ospfArea = document.getElementById('ospfArea').value;

  if (!ospfArea) {
    alert('âš ï¸ OSPF Area Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ IP LAN Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
    return;
  }

  const data = {
    x,
    y,
    branchName,
    routeName,
    wanIface:     document.getElementById('wanIface').value,
    branchApnIp:  apnIp,
    hubApnIp:     FIXED_HUB_APN_IP,
    hubTunnelId:  hubTunnelId,
    tun200Hub:    autoAssignedTunnel200.hub_ip,
    tun200Branch: autoAssignedTunnel200.branch_ip,
    ospfProcess:  FIXED_OSPF_PROCESS,
    ospfArea:     ospfArea,
    asrNextHop:   FIXED_ASR_NEXTHOP,
    hubDescription: hubDescription
  };

  const cfgs = generateConfigsSeparated(data);
  document.getElementById('branchOut').textContent = cfgs.branchCfg;
  document.getElementById('hubOut').textContent    = cfgs.hubCfg;
  document.getElementById('asrOut').textContent    = cfgs.asrCfg;

  document.getElementById('branchSub').textContent = `Ø´Ø¹Ø¨Ù‡: ${branchName} (LAN: 10.${x}.${y}.0/24 | OSPF Area: ${ospfArea}) | APN: ${apnIp} | Tunnel200: ${autoAssignedTunnel200.branch_ip} | Ø±Ø²Ø±Ùˆ ØªÙˆØ³Ø·: ${username}`;
  document.getElementById('hubSub').textContent    = `Tunnel${data.hubTunnelId}: ${hubDescription} â‡„ ${apnIp} (HUB: ${FIXED_HUB_APN_IP}) | Tunnel200: ${autoAssignedTunnel200.hub_ip}`;
  document.getElementById('asrSub').textContent    = `Static route â†’ ${"10.210."+x+"."+y} via ${FIXED_ASR_NEXTHOP} (name: ${routeName}-APN-INT)`;

  document.getElementById('outputs').style.display = 'grid';

  // Reserve Tunnel200 IPs
  console.log('ğŸ”’ Reserving Tunnel200 IPs in database...');
  try {
    const tunRes = await fetch('/api/reserve-tunnel200', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        hub_ip: autoAssignedTunnel200.hub_ip,
        branch_ip: autoAssignedTunnel200.branch_ip,
        branch_name: branchName,
        tunnel_number: data.hubTunnelId,
        username: username
      })
    });
    
    const tunResult = await tunRes.json();
    if (tunResult.status === 'ok') {
      console.log('âœ… Tunnel200 IPs reserved');
    } else {
      console.error('âš ï¸ Failed to reserve Tunnel200 IPs:', tunResult.error);
    }
  } catch (err) {
    console.error('âš ï¸ Error reserving Tunnel200 IPs:', err);
  }

  // Reserve APN and LAN IPs
  console.log('ğŸ”’ Reserving APN and LAN IPs in database...');
  try {
    const res = await fetch('/api/reserve-ips', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username: username,
        branchName: branchName,
        lanIp: lanIp,
        apnIp: apnIp
      })
    });

    const result = await res.json();

    if (result.status === 'ok') {
      console.log('âœ… IPs reserved:', result.updates);
      
      let successMsg = `âœ… Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯!\n\nØ±Ø²Ø±Ùˆ Ø´Ø¯Ù‡ ØªÙˆØ³Ø·: ${username}\n`;
      
      if (isExistingBranch) {
        successMsg += `\nğŸ“Œ Ø´Ø¹Ø¨Ù‡ Ù…ÙˆØ¬ÙˆØ¯: ${branchName}`;
        successMsg += `\nğŸ”¤ Route Name: ${routeName}`;
      } else {
        successMsg += `\nğŸ†• Ù†Ù‚Ø·Ù‡ Ø¬Ø¯ÛŒØ¯: ${branchName}`;
      }
      
      successMsg += `\n\n` + result.updates.join('\n');
      successMsg += `\n\nâœ… Tunnel200 IPs: HUB=${autoAssignedTunnel200.hub_ip}, Branch=${autoAssignedTunnel200.branch_ip}`;
      successMsg += `\n\nØµÙØ­Ù‡ Ø¯Ø± 60 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø§Ø²Ø®ÙˆØ§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯ ØªØ§ IP Ù‡Ø§ÛŒ Ø¢Ø²Ø§Ø¯ Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´ÙˆÙ†Ø¯...`;
      
      alert(successMsg);

      setTimeout(() => {
        location.reload();
      }, 60000);
    } else {
      console.error('âŒ Failed to reserve IPs:', result.error);
      alert('âš ï¸ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯ Ø§Ù…Ø§ IP Ø±Ø²Ø±Ùˆ Ù†Ø´Ø¯:\n' + result.error);
    }
  } catch (err) {
    console.error('âŒ Error reserving IPs:', err);
    alert('âš ï¸ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯ Ø§Ù…Ø§ Ø®Ø·Ø§ Ø¯Ø± Ø±Ø²Ø±Ùˆ IP:\n' + err.message);
  }
});

// Load data on page load
console.log(' Initializing APN-INT Config Generator...');
loadBranches();
loadLanProvinces();
autoAssignApnIp();
autoAssignTunnel200();
</script>
</body>
</html>
