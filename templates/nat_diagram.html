<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NAT Flow Simulator | Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ø¬Ø±ÛŒØ§Ù† NAT</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
:root{
  --bg:#070b14;--bg2:#0d1424;--card:#111827;--card2:rgba(17,24,39,0.9);
  --brd:rgba(255,255,255,0.07);--brd2:rgba(255,255,255,0.12);
  --t1:#e2e8f0;--t2:#94a3b8;--t3:#64748b;
  --cyan:#22d3ee;--blue:#3b82f6;--green:#10b981;
  --amber:#f59e0b;--purple:#8b5cf6;--red:#f43f5e;--pink:#ec4899;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--t1);font-family:'Inter',sans-serif;min-height:100vh;overflow-x:hidden;}

/* HEADER */
.hdr{display:flex;align-items:center;gap:14px;padding:12px 24px;
  background:rgba(7,11,20,0.96);border-bottom:1px solid var(--brd);
  position:sticky;top:0;z-index:100;backdrop-filter:blur(16px);}
.btn-back{color:var(--cyan);text-decoration:none;font-size:12px;padding:5px 12px;
  border:1px solid rgba(34,211,238,0.25);border-radius:8px;transition:all .2s;white-space:nowrap;}
.btn-back:hover{background:rgba(34,211,238,0.08);}
.hdr h1{font-size:18px;font-weight:700;letter-spacing:-.3px;}
.hdr-sub{color:var(--t3);font-size:11px;margin-left:auto;}

/* INPUT PANEL */
.simulator-wrap{max-width:1100px;margin:0 auto;padding:32px 20px 24px;}
.panel-title{text-align:center;margin-bottom:28px;}
.panel-title h2{font-size:22px;font-weight:800;
  background:linear-gradient(135deg,var(--cyan),var(--blue));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.panel-title p{color:var(--t3);font-size:13px;margin-top:6px;}

.flow-input{display:flex;align-items:center;gap:0;
  background:var(--card2);border:1px solid var(--brd2);
  border-radius:24px;padding:24px 28px;
  box-shadow:0 8px 40px rgba(0,0,0,0.4);}

/* ENDPOINT */
.ep{display:flex;flex-direction:column;align-items:center;gap:10px;min-width:160px;}
.ep-icon{width:72px;height:72px;border-radius:18px;display:flex;align-items:center;justify-content:center;}
.ep-icon.pc{background:linear-gradient(135deg,rgba(59,130,246,0.18),rgba(59,130,246,0.06));
  border:2px solid rgba(59,130,246,0.35);box-shadow:0 0 24px rgba(59,130,246,0.12);}
.ep-icon.srv{background:linear-gradient(135deg,rgba(16,185,129,0.18),rgba(16,185,129,0.06));
  border:2px solid rgba(16,185,129,0.35);box-shadow:0 0 24px rgba(16,185,129,0.12);}
.ep-icon svg{width:36px;height:36px;}
.ep label{font-size:11px;color:var(--t2);font-weight:600;letter-spacing:.3px;}
.ep input{width:150px;padding:9px 12px;border-radius:10px;border:1px solid var(--brd2);
  background:rgba(255,255,255,0.04);color:var(--t1);font-size:13px;font-family:'Inter',sans-serif;
  text-align:center;direction:ltr;outline:none;transition:all .2s;}
.ep input:focus{border-color:var(--cyan);box-shadow:0 0 0 3px rgba(34,211,238,0.1);}
.ep .hint{font-size:10px;color:var(--t3);}

/* PIPE */
.pipe{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:0 8px;}
.pipe-track{width:100%;height:2px;border-radius:1px;position:relative;overflow:hidden;}
.pipe-track.inside{background:linear-gradient(90deg,rgba(59,130,246,0.15),rgba(59,130,246,0.5));}
.pipe-track.outside{background:linear-gradient(90deg,rgba(16,185,129,0.5),rgba(16,185,129,0.15));}
.pipe-dot{position:absolute;top:50%;transform:translateY(-50%);
  width:8px;height:8px;border-radius:50%;}
.pipe-dot.blue{background:var(--blue);box-shadow:0 0 6px var(--blue);animation:moveDot 1.8s linear infinite;}
.pipe-dot.green{background:var(--green);box-shadow:0 0 6px var(--green);animation:moveDot 1.8s linear infinite .5s;}
@keyframes moveDot{0%{left:-5%;opacity:0;}5%{opacity:1;}95%{opacity:1;}100%{left:105%;opacity:0;}}
.pipe-lbl{font-size:10px;color:var(--t3);}

/* CENTER */
.center-ctrl{display:flex;flex-direction:column;align-items:center;gap:14px;min-width:240px;}
.router-sel-wrap{display:flex;flex-direction:column;align-items:center;gap:6px;width:100%;}
.router-sel-wrap label{font-size:11px;color:var(--t2);font-weight:500;}
.router-sel-wrap select{width:220px;padding:9px 12px;border-radius:10px;
  border:1px solid var(--brd2);background:var(--card);color:var(--t1);
  font-size:12px;font-family:'Inter',sans-serif;outline:none;cursor:pointer;direction:ltr;}
.router-sel-wrap select:focus{border-color:var(--cyan);}
.proto-row{display:flex;gap:6px;align-items:center;}
.proto-lbl{font-size:11px;color:var(--t3);}
.pb{padding:5px 12px;border-radius:8px;border:1px solid var(--brd);
  background:rgba(255,255,255,0.03);color:var(--t2);font-size:11px;
  cursor:pointer;transition:all .2s;font-family:'Inter',sans-serif;}
.pb.on{background:rgba(34,211,238,0.1);border-color:var(--cyan);color:var(--cyan);}
.sim-btn{padding:13px 32px;border-radius:14px;border:none;
  background:linear-gradient(135deg,var(--cyan) 0%,var(--blue) 100%);
  color:#fff;font-size:14px;font-weight:700;cursor:pointer;
  font-family:'Inter',sans-serif;letter-spacing:.3px;
  box-shadow:0 4px 20px rgba(34,211,238,0.28);
  transition:all .25s;position:relative;overflow:hidden;}
.sim-btn:hover{transform:translateY(-2px);box-shadow:0 8px 32px rgba(34,211,238,0.38);}
.sim-btn:active{transform:translateY(1px);}
.sim-btn .ripple{position:absolute;inset:0;background:rgba(255,255,255,0.1);
  transform:scale(0);border-radius:inherit;animation:ripple .4s ease-out forwards;}
@keyframes ripple{to{transform:scale(2.5);opacity:0;}}

/* RESULTS */
.results{max-width:1100px;margin:0 auto;padding:0 20px 48px;}
.results-header{display:flex;align-items:center;gap:12px;margin-bottom:16px;padding:12px 0;}
.results-header h3{font-size:15px;font-weight:600;}
.results-header p{font-size:12px;color:var(--t2);}
.badge-count{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;
  background:rgba(34,211,238,0.1);color:var(--cyan);border:1px solid rgba(34,211,238,0.2);}

/* EMPTY / LOADING */
.empty-state{text-align:center;padding:64px 24px;}
.empty-icon{font-size:52px;display:block;margin-bottom:16px;}
.empty-state h3{font-size:16px;color:var(--t1);margin-bottom:8px;}
.empty-state p{font-size:13px;color:var(--t3);line-height:1.8;}
.loading-state{text-align:center;padding:48px;}
.spinner{width:36px;height:36px;border:3px solid var(--brd);border-top:3px solid var(--cyan);
  border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 14px;}
@keyframes spin{to{transform:rotate(360deg);}}

/* FLOW CARD */
.flow-card{background:var(--card);border:1px solid var(--brd);border-radius:20px;
  margin-bottom:18px;overflow:hidden;animation:slideIn .35s ease-out both;}
@keyframes slideIn{from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);}}
.fc-head{display:flex;align-items:center;gap:14px;padding:16px 22px;
  border-bottom:1px solid var(--brd);
  background:linear-gradient(90deg,rgba(34,211,238,0.04),transparent);}
.fc-badge{width:40px;height:40px;border-radius:11px;display:flex;align-items:center;
  justify-content:center;font-size:18px;background:rgba(34,211,238,0.08);border:1px solid rgba(34,211,238,0.15);}
.fc-info h3{font-size:14px;font-weight:700;direction:ltr;}
.fc-info p{font-size:11px;color:var(--t3);}
.type-badge{margin-left:auto;padding:4px 12px;border-radius:20px;font-size:10px;font-weight:700;}
.type-badge.dynamic{background:rgba(34,211,238,0.1);color:var(--cyan);border:1px solid rgba(34,211,238,0.2);}
.type-badge.dynamic-pat{background:rgba(139,92,246,0.1);color:var(--purple);border:1px solid rgba(139,92,246,0.2);}
.type-badge.static{background:rgba(244,114,182,0.1);color:var(--pink);border:1px solid rgba(244,114,182,0.2);}

/* VISUAL FLOW */
.vflow{padding:28px 22px 20px;display:flex;align-items:center;gap:0;overflow-x:auto;}
.vnode{display:flex;flex-direction:column;align-items:center;gap:8px;flex-shrink:0;}
.vicon{width:56px;height:56px;border-radius:14px;display:flex;align-items:center;
  justify-content:center;font-size:22px;flex-shrink:0;}
.vicon.pc{background:rgba(59,130,246,0.12);border:2px solid rgba(59,130,246,0.3);}
.vicon.rtr{background:rgba(34,211,238,0.1);border:2px solid rgba(34,211,238,0.25);
  width:68px;height:68px;font-size:26px;border-radius:18px;}
.vicon.inet{background:rgba(16,185,129,0.12);border:2px solid rgba(16,185,129,0.3);}
.vnode-ip{font-size:11px;font-weight:700;direction:ltr;color:var(--t1);}
.vnode-sub{font-size:10px;color:var(--t3);}

/* CONNECTORS */
.vconn{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;
  padding:0 6px;min-width:70px;}
.vtrack{width:100%;height:2px;border-radius:2px;position:relative;overflow:hidden;}
.vtrack.in{background:linear-gradient(90deg,rgba(59,130,246,0.2),var(--blue));}
.vtrack.out{background:linear-gradient(90deg,var(--green),rgba(16,185,129,0.2));}
.vpkt{position:absolute;top:50%;transform:translateY(-50%);
  width:8px;height:8px;border-radius:50%;animation:pktFlow 1.8s linear infinite;}
.vpkt.b{background:var(--blue);box-shadow:0 0 8px var(--blue);}
.vpkt.g{background:var(--green);box-shadow:0 0 8px var(--green);animation-delay:.5s;}
@keyframes pktFlow{0%{left:-5%;opacity:0;}8%{opacity:1;}92%{opacity:1;}100%{left:105%;opacity:0;}}
.vconn-lbl{font-size:10px;color:var(--t2);direction:ltr;white-space:nowrap;font-weight:500;}
.vconn-sub{font-size:9px;color:var(--t3);white-space:nowrap;}

/* NAT BOX */
.nat-transform{border:1px solid rgba(245,158,11,0.25);border-radius:12px;
  background:rgba(245,158,11,0.05);padding:10px 14px;text-align:center;
  margin:0 6px;flex-shrink:0;min-width:150px;}
.nt-title{font-size:9px;color:var(--amber);font-weight:700;margin-bottom:6px;letter-spacing:.5px;}
.nt-ip{font-size:12px;direction:ltr;font-weight:600;}
.nt-arrow{color:var(--amber);font-size:16px;margin:3px 0;animation:pulse 1.2s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:.5;transform:scaleY(.8);}50%{opacity:1;transform:scaleY(1.2);}}
.nt-sub{font-size:10px;color:var(--t3);margin-top:4px;}
.nt-tag{display:inline-block;padding:2px 7px;border-radius:5px;font-size:9px;font-weight:700;margin-top:4px;}
.nt-tag.pat{background:rgba(139,92,246,0.15);color:var(--purple);}
.nt-tag.static{background:rgba(244,114,182,0.15);color:var(--pink);}

/* DETAIL GRID */
.detail-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;padding:0 22px 22px;}
.dbox{background:var(--bg2);border:1px solid var(--brd);border-radius:12px;padding:14px;}
.dbox h4{font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:.6px;
  margin-bottom:10px;display:flex;align-items:center;gap:6px;}
.drow{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:5px;}
.dk{font-size:10px;color:var(--t3);}
.dv{font-size:11px;color:var(--t1);direction:ltr;font-weight:500;word-break:break-all;}
.dv.hl{color:var(--amber);}
.dtag{display:inline-block;padding:2px 7px;border-radius:5px;font-size:9px;font-weight:700;}
.dtag.c{background:rgba(34,211,238,0.1);color:var(--cyan);}
.dtag.g{background:rgba(16,185,129,0.1);color:var(--green);}
.dtag.a{background:rgba(245,158,11,0.1);color:var(--amber);}
.dtag.p{background:rgba(139,92,246,0.1);color:var(--purple);}
.dtag.pk{background:rgba(244,114,182,0.1);color:var(--pink);}
.acl-entries{margin-top:8px;border-top:1px solid var(--brd);padding-top:8px;}
.acl-row{display:flex;align-items:center;gap:6px;margin-bottom:3px;}
.acl-act{font-size:9px;padding:1px 5px;border-radius:4px;font-weight:700;}
.acl-act.permit{background:rgba(16,185,129,0.1);color:var(--green);}
.acl-act.deny{background:rgba(244,67,54,0.1);color:var(--red);}
.acl-net{font-size:10px;color:var(--t2);direction:ltr;}

::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(148,163,184,0.12);border-radius:4px}

@media(max-width:800px){
  .flow-input{flex-direction:column;align-items:center;gap:16px;}
  .pipe{display:none;}
  .detail-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>

<div class="hdr">
  <a href="/network-map" class="btn-back">&#8592; Ù†Ù‚Ø´Ù‡ Ø´Ø¨Ú©Ù‡</a>
  <h1>ğŸ”€ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ø¬Ø±ÛŒØ§Ù† NAT</h1>
  <span class="hdr-sub">BKI NAT Flow Simulator</span>
</div>

<div class="simulator-wrap">
  <div class="panel-title">
    <h2>Ù…Ø³ÛŒØ± Ù¾Ú©Øª NAT Ø±Ø§ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯</h2>
    <p>Ø¢Ø¯Ø±Ø³ IP Ù…Ù†Ø¨Ø¹ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ØªØ§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯ Ù¾Ú©Øª Ú†Ø·ÙˆØ± ØªØ±Ø¬Ù…Ù‡ Ùˆ Ø§Ø² Ú©Ø¬Ø§ Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆØ¯</p>
  </div>

  <div class="flow-input">
    <!-- SOURCE PC -->
    <div class="ep">
      <div class="ep-icon pc">
        <svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="3" width="20" height="14" rx="2"/>
          <path d="M8 21h8M12 17v4"/>
        </svg>
      </div>
      <label>IP Ù…Ù†Ø¨Ø¹ (Source)</label>
      <input id="srcIP" type="text" placeholder="Ù…Ø«Ø§Ù„: 10.0.0.5" dir="ltr" autocomplete="off">
      <span class="hint">Ø¢Ø¯Ø±Ø³ Ø¯Ø§Ø®Ù„ÛŒ / Inside IP</span>
    </div>

    <!-- LEFT PIPE -->
    <div class="pipe">
      <div class="pipe-track inside"><div class="pipe-dot blue"></div></div>
      <span class="pipe-lbl">inside â–¶</span>
    </div>

    <!-- CENTER -->
    <div class="center-ctrl">
      <div class="router-sel-wrap">
        <label>Ø¯Ø³ØªÚ¯Ø§Ù‡ NAT</label>
        <select id="routerSel">
          <option value="all">ğŸŒ Ù‡Ù…Ù‡ Ø±ÙˆØªØ±Ù‡Ø§ (Auto Detect)</option>
        </select>
      </div>
      <div class="proto-row">
        <span class="proto-lbl">Ù¾Ø±ÙˆØªÚ©Ù„:</span>
        <button class="pb on" onclick="setProto('any',this)">Any</button>
        <button class="pb" onclick="setProto('tcp',this)">TCP</button>
        <button class="pb" onclick="setProto('udp',this)">UDP</button>
        <button class="pb" onclick="setProto('icmp',this)">ICMP</button>
      </div>
      <button class="sim-btn" id="simBtn" onclick="simulate()">
        &#9654;&nbsp; Ø´Ø±ÙˆØ¹ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ
      </button>
    </div>

    <!-- RIGHT PIPE -->
    <div class="pipe">
      <div class="pipe-track outside"><div class="pipe-dot green"></div></div>
      <span class="pipe-lbl">â–¶ outside</span>
    </div>

    <!-- DESTINATION SERVER -->
    <div class="ep">
      <div class="ep-icon srv">
        <svg viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="2" width="20" height="8" rx="2"/>
          <rect x="2" y="14" width="20" height="8" rx="2"/>
          <path d="M6 6h.01M6 18h.01"/>
        </svg>
      </div>
      <label>IP Ù…Ù‚ØµØ¯ (Destination)</label>
      <input id="dstIP" type="text" placeholder="8.8.8.8 (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" dir="ltr" autocomplete="off">
      <span class="hint">Ø§ÛŒÙ†ØªØ±Ù†Øª / Destination IP</span>
    </div>
  </div>
</div>

<div class="results" id="results"></div>

<script>
let allDevices = [];
let selectedProto = 'any';

async function loadData() {
  try {
    const r = await fetch('/api/network-map/nat-diagram?_t=' + Date.now());
    const d = await r.json();
    allDevices = d.devices || [];
    populateRouters();
  } catch(e) { console.error('Load failed:', e); }
}

function populateRouters() {
  const sel = document.getElementById('routerSel');
  const sorted = [...allDevices].sort((a,b) => {
    const o={'core-router':0,'core-switch':1,'provincial-router':2};
    return (o[a.category]||3)-(o[b.category]||3);
  });
  sorted.forEach(dev => {
    const opt = document.createElement('option');
    opt.value = dev.hostname;
    const ic={'core-router':'ğŸ”·','provincial-router':'ğŸ“¡','core-switch':'ğŸ”€'}[dev.category]||'ğŸ”Œ';
    opt.textContent = ic+' '+dev.hostname+(dev.label&&dev.label!==dev.hostname?' ('+dev.label+')':'');
    sel.appendChild(opt);
  });
}

function setProto(p,el){
  selectedProto=p;
  document.querySelectorAll('.pb').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
}

function ipToNum(ip){
  const p=ip.trim().split('.');
  if(p.length!==4)return NaN;
  return((+p[0]<<24)|(+p[1]<<16)|(+p[2]<<8)|(+p[3]))>>>0;
}
function isValidIP(ip){
  return/^(\d{1,3}\.){3}\d{1,3}$/.test(ip.trim())&&ip.trim().split('.').every(n=>+n>=0&&+n<=255);
}
function ipInNetwork(testIP,network,wildcard){
  if(!network||network==='any')return true;
  if(network==='host')return false;
  try{
    if(network.startsWith('host '))return testIP.trim()===network.substring(5).trim();
    const t=ipToNum(testIP);
    if(isNaN(t))return false;
    const n=ipToNum(network);
    if(!wildcard||wildcard==='0.0.0.0'||wildcard==='')return t===n;
    const w=ipToNum(wildcard);
    const mask=(~w)>>>0;
    return(t&mask)>>>0===(n&mask)>>>0;
  }catch{return false;}
}
function checkACL(srcIP,entries,proto){
  if(!entries||entries.length===0)return true;
  for(const e of entries){
    if(proto&&proto!=='any'&&e.proto&&e.proto!=='ip'&&e.proto!=='any'&&e.proto!==proto)continue;
    const src=(e.src||'').trim();
    const wild=(e.src_wild||'').trim();
    let ok=false;
    if(src==='any'||src==='')ok=true;
    else if(src.startsWith('host '))ok=srcIP.trim()===src.substring(5).trim();
    else ok=ipInNetwork(srcIP,src,wild);
    if(ok&&e.action==='permit')return true;
  }
  return false;
}

function matchDevice(dev,srcIP,proto){
  const results=[];
  for(const rule of dev.nat_rules){
    if(rule.type==='dynamic'){
      if(!checkACL(srcIP,rule.acl_entries||[],proto))continue;
      let translatedIP='',isPAT=false;
      if(rule.overload_ip){translatedIP=rule.overload_ip;isPAT=true;}
      else if(rule.pool){
        const pool=dev.nat_pools.find(p=>p.name===rule.pool);
        translatedIP=pool?pool.start_ip+' â€“ '+pool.end_ip:'Pool: '+rule.pool;
        isPAT=!!rule.overload;
      }else if(rule.overload_intf){
        const oi=dev.outside_interfaces.find(i=>i.name===rule.overload_intf);
        translatedIP=oi?oi.ip:rule.overload_intf+' IP';
        isPAT=true;
      }else translatedIP='Dynamic Pool';
      const inside=dev.inside_interfaces[0]||{name:'N/A',ip:'',mask:'',description:''};
      let outside=dev.outside_interfaces[0]||{name:'N/A',ip:'',mask:'',description:''};
      if(rule.overload_intf){const oi=dev.outside_interfaces.find(i=>i.name===rule.overload_intf);if(oi)outside=oi;}
      results.push({rule,translatedIP,isPAT,isStatic:false,inside,outside,entries:rule.acl_entries||[]});
    }else if(rule.type==='static'){
      if(!rule.inside_ip||rule.inside_ip!==srcIP.trim())continue;
      const inside=dev.inside_interfaces[0]||{name:'N/A',ip:'',mask:'',description:''};
      const outside=dev.outside_interfaces[0]||{name:'N/A',ip:'',mask:'',description:''};
      results.push({rule,translatedIP:rule.outside_ip||'?',isPAT:false,isStatic:true,inside,outside,entries:[]});
    }
  }
  return results;
}

function simulate(){
  const srcIP=document.getElementById('srcIP').value.trim();
  const dstIP=document.getElementById('dstIP').value.trim();
  const routerSel=document.getElementById('routerSel').value;
  const resDiv=document.getElementById('results');

  if(!srcIP){
    resDiv.innerHTML=`<div class="empty-state"><span class="empty-icon">&#9888;&#65039;</span><h3>IP Ù…Ù†Ø¨Ø¹ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡</h3><p>Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø¢Ø¯Ø±Ø³ IP Ø¯Ø§Ø®Ù„ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p></div>`;
    return;
  }
  if(!isValidIP(srcIP)){
    resDiv.innerHTML=`<div class="empty-state"><span class="empty-icon">&#10060;</span><h3>ÙØ±Ù…Øª IP Ù†Ø§Ø¯Ø±Ø³Øª</h3><p>Ø¢Ø¯Ø±Ø³ IP Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ÙØ±Ù…Øª <strong style="direction:ltr;display:inline-block">x.x.x.x</strong> Ø¨Ø§Ø´Ø¯</p></div>`;
    return;
  }
  resDiv.innerHTML=`<div class="loading-state"><div class="spinner"></div><div style="color:var(--t3);font-size:13px">Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‚ÙˆØ§Ù†ÛŒÙ† NAT Ø¨Ø±Ø§ÛŒ <strong style="color:var(--cyan)">${srcIP}</strong>...</div></div>`;

  const btn=document.getElementById('simBtn');
  const rip=document.createElement('span');rip.className='ripple';btn.appendChild(rip);
  setTimeout(()=>rip.remove(),500);

  setTimeout(()=>{
    const devs=routerSel==='all'?allDevices:allDevices.filter(d=>d.hostname===routerSel);
    const matched=[];
    for(const dev of devs){
      const m=matchDevice(dev,srcIP,selectedProto);
      if(m.length)matched.push({dev,matches:m});
    }
    renderResults(matched,srcIP,dstIP);
  },700);
}

function renderResults(matched,srcIP,dstIP){
  const resDiv=document.getElementById('results');
  const total=matched.reduce((s,r)=>s+r.matches.length,0);
  if(!total){
    resDiv.innerHTML=`<div class="empty-state"><span class="empty-icon">&#128269;</span><h3>Ù‡ÛŒÚ† Ù‚Ø§Ù†ÙˆÙ† NAT Ù…Ø·Ø§Ø¨Ù‚ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3><p>Ø¢Ø¯Ø±Ø³ <strong style="color:var(--cyan);direction:ltr">${srcIP}</strong> Ø¯Ø± Ù‡ÛŒÚ† ACL Ù‚Ø§Ù†ÙˆÙ† NAT Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.<br>Ø§ÛŒÙ† IP Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡ ØªØ¹Ø±ÛŒÙâ€ŒØ´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯.</p></div>`;
    return;
  }
  let html=`<div class="results-header"><span class="badge-count">${total}</span><div><h3>Ù†ØªØ§ÛŒØ¬ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ</h3><p>Ø¨Ø±Ø§ÛŒ <strong style="color:var(--cyan);direction:ltr">${srcIP}</strong>${dstIP?' &#8594; <strong style="color:var(--green);direction:ltr">'+dstIP+'</strong>':''} Ø¯Ø± <strong>${matched.length}</strong> Ø¯Ø³ØªÚ¯Ø§Ù‡</p></div></div>`;
  let delay=0;
  for(const{dev,matches}of matched){for(const m of matches){html+=buildCard(dev,m,srcIP,dstIP,delay);delay+=80;}}
  resDiv.innerHTML=html;
}

function buildCard(dev,match,srcIP,dstIP,delay){
  const{rule,translatedIP,isPAT,isStatic,inside,outside,entries}=match;
  const catLabel={'core-router':'Core Router','provincial-router':'Provincial Router','core-switch':'Core Switch'}[dev.category]||dev.category;
  const catIcon={'core-router':'ğŸ”·','provincial-router':'ğŸ“¡','core-switch':'ğŸ”€'}[dev.category]||'ğŸ”Œ';
  const typeBadge=isStatic?'Static NAT':isPAT?'Dynamic NAT / PAT':'Dynamic NAT';
  const typeClass=isStatic?'static':isPAT?'dynamic-pat':'dynamic';
  const natIP=translatedIP;
  const destLabel=dstIP||'Internet';
  const overloadTag=isPAT?`<span class="nt-tag pat">PAT/Overload</span>`:isStatic?`<span class="nt-tag static">Static</span>`:'';

  let aclHtml='';
  if(entries&&entries.length>0){
    const preview=entries.slice(0,4);
    aclHtml=`<div class="acl-entries">`+preview.map(e=>{
      const src=e.src||'any';const wild=e.src_wild?' '+e.src_wild:'';
      return`<div class="acl-row"><span class="acl-act ${e.action}">${e.action}</span><span class="acl-net">${src}${wild}</span></div>`;
    }).join('')+(entries.length>4?`<div style="font-size:9px;color:var(--t3);margin-top:4px">+${entries.length-4} Ù‚Ø§Ù†ÙˆÙ† Ø¯ÛŒÚ¯Ø±</div>`:'')+`</div>`;
  }

  return`<div class="flow-card" style="animation-delay:${delay}ms">
  <div class="fc-head">
    <div class="fc-badge">${catIcon}</div>
    <div class="fc-info"><h3>${dev.hostname}</h3><p>${catLabel}${dev.label&&dev.label!==dev.hostname?' Â· '+dev.label:''}</p></div>
    <span class="type-badge ${typeClass}">${typeBadge}</span>
  </div>
  <div class="vflow">
    <div class="vnode"><div class="vicon pc">&#128187;</div><div class="vnode-ip">${srcIP}</div><div class="vnode-sub">Source PC</div></div>
    <div class="vconn"><div class="vtrack in"><div class="vpkt b"></div></div><div class="vconn-lbl">${inside.name}</div><div class="vconn-sub">${inside.ip||''}</div><div class="vconn-sub" style="color:rgba(59,130,246,0.6)">inside &#9654;</div></div>
    <div class="vnode">
      <div class="vicon rtr">&#128256;</div>
      <div class="vnode-sub" style="color:var(--cyan);font-weight:600;font-size:11px">${dev.hostname}</div>
      <div class="nat-transform">
        <div class="nt-title">NAT TRANSLATION</div>
        <div class="nt-ip" style="color:var(--blue)">${srcIP}</div>
        <div class="nt-arrow">&#11015;</div>
        <div class="nt-ip" style="color:var(--amber)">${natIP}</div>
        ${rule.acl?`<div class="nt-sub">ACL: ${rule.acl}</div>`:''}
        ${overloadTag}
      </div>
    </div>
    <div class="vconn"><div class="vtrack out"><div class="vpkt g"></div></div><div class="vconn-lbl">${outside.name}</div><div class="vconn-sub">${outside.ip||''}</div><div class="vconn-sub" style="color:rgba(16,185,129,0.6)">&#9654; outside</div></div>
    <div class="vnode"><div class="vicon inet">&#127760;</div><div class="vnode-ip" style="color:var(--green)">${natIP}</div><div class="vnode-sub">${destLabel}</div></div>
  </div>
  <div class="detail-grid">
    <div class="dbox">
      <h4><span style="color:var(--blue)">&#9679;</span> Inside Interface</h4>
      <div class="drow"><span class="dk">Interface</span><span class="dv">${inside.name}</span></div>
      <div class="drow"><span class="dk">IP Address</span><span class="dv">${inside.ip||'â€“'}</span></div>
      <div class="drow"><span class="dk">Subnet Mask</span><span class="dv">${inside.mask||'â€“'}</span></div>
      ${inside.description?`<div class="drow"><span class="dk">Description</span><span class="dv" style="font-size:10px">${inside.description}</span></div>`:''}
    </div>
    <div class="dbox">
      <h4><span style="color:var(--amber)">&#9679;</span> Ù‚Ø§Ù†ÙˆÙ† NAT</h4>
      <div class="drow"><span class="dk">Type</span><span class="dv"><span class="dtag ${isStatic?'pk':isPAT?'p':'c'}">${isStatic?'Static':isPAT?'PAT':'Dynamic'}</span></span></div>
      <div class="drow"><span class="dk">Source IP</span><span class="dv" style="color:var(--blue)">${srcIP}</span></div>
      <div class="drow"><span class="dk">Translated IP</span><span class="dv hl">${natIP}</span></div>
      ${rule.acl?`<div class="drow"><span class="dk">ACL</span><span class="dv">${rule.acl}</span></div>`:''}
      ${rule.pool?`<div class="drow"><span class="dk">NAT Pool</span><span class="dv">${rule.pool}</span></div>`:''}
      ${rule.overload_intf?`<div class="drow"><span class="dk">Overload Intf</span><span class="dv">${rule.overload_intf}</span></div>`:''}
      ${rule.inside_port?`<div class="drow"><span class="dk">Port Fwd</span><span class="dv">:${rule.inside_port} &#8594; :${rule.outside_port}</span></div>`:''}
      ${aclHtml}
    </div>
    <div class="dbox">
      <h4><span style="color:var(--green)">&#9679;</span> Outside Interface</h4>
      <div class="drow"><span class="dk">Interface</span><span class="dv">${outside.name}</span></div>
      <div class="drow"><span class="dk">IP Address</span><span class="dv">${outside.ip||'â€“'}</span></div>
      <div class="drow"><span class="dk">Subnet Mask</span><span class="dv">${outside.mask||'â€“'}</span></div>
      ${outside.description?`<div class="drow"><span class="dk">Description</span><span class="dv" style="font-size:10px">${outside.description}</span></div>`:''}
      <div class="drow"><span class="dk">Exit IP (NAT'd)</span><span class="dv" style="color:var(--green)">${natIP}</span></div>
      <div class="drow"><span class="dk">Destination</span><span class="dv">${destLabel}</span></div>
    </div>
  </div>
</div>`;
}

window.addEventListener('DOMContentLoaded',()=>{
  loadData();
  document.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&(e.target.id==='srcIP'||e.target.id==='dstIP'))simulate();
  });
});
</script>
</body>
</html>
