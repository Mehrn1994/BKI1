<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MPLS/VPLS Config Generator</title>
    <style>
/* ========== THEME SYSTEM ========== */
:root {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-card: rgba(30, 41, 59, 0.8);
    --bg-header: rgba(30, 41, 59, 0.9);
    --text-primary: #e2e8f0;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --border-color: rgba(255, 255, 255, 0.1);
    --shadow-color: rgba(0, 0, 0, 0.3);
    --input-bg: rgba(15, 23, 42, 0.8);
    --input-border: rgba(255, 255, 255, 0.2);
    --card-hover: rgba(255, 255, 255, 0.05);
}

[data-theme="light"] {
    --bg-primary: #f8fafc;
    --bg-secondary: #f1f5f9;
    --bg-card: #ffffff;
    --bg-header: #ffffff;
    --text-primary: #0f172a;
    --text-secondary: #334155;
    --text-muted: #475569;
    --border-color: rgba(0, 0, 0, 0.15);
    --shadow-color: rgba(0, 0, 0, 0.1);
    --input-bg: #ffffff;
    --input-border: rgba(0, 0, 0, 0.2);
    --card-hover: rgba(0, 0, 0, 0.05);
}

body { transition: background 0.3s ease, color 0.3s ease; }

[data-theme="light"] body {
    background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%) !important;
    color: var(--text-primary) !important;
}

[data-theme="light"] .header, [data-theme="light"] header,
[data-theme="light"] .top-bar, [data-theme="light"] .navbar {
    background: var(--bg-header) !important;
    border-color: var(--border-color) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
}

[data-theme="light"] .card, [data-theme="light"] .form-section,
[data-theme="light"] .config-section, [data-theme="light"] .result-section,
[data-theme="light"] .section, [data-theme="light"] .panel,
[data-theme="light"] .main-card, [data-theme="light"] .box {
    background: var(--bg-card) !important;
    border-color: var(--border-color) !important;
    color: var(--text-primary) !important;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06) !important;
}

[data-theme="light"] input, [data-theme="light"] select, [data-theme="light"] textarea {
    background: var(--input-bg) !important;
    border: 1px solid var(--input-border) !important;
    color: #0f172a !important;
}

[data-theme="light"] input::placeholder { color: #64748b !important; }
[data-theme="light"] select option { background: #fff; color: #0f172a; }

[data-theme="light"] label, [data-theme="light"] .form-label,
[data-theme="light"] h1, [data-theme="light"] h2, [data-theme="light"] h3, [data-theme="light"] h4,
[data-theme="light"] .section-title, [data-theme="light"] .title,
[data-theme="light"] .app-title h1, [data-theme="light"] .app-title p {
    color: #0f172a !important;
}

[data-theme="light"] p, [data-theme="light"] span:not(.badge):not(.tag),
[data-theme="light"] div:not(.btn):not(.badge) {
    color: inherit;
}

[data-theme="light"] .hint, [data-theme="light"] .info-text, [data-theme="light"] small,
[data-theme="light"] .description, [data-theme="light"] .help-text,
[data-theme="light"] .form-hint, [data-theme="light"] .note {
    color: #334155 !important;
}

[data-theme="light"] .user-display, [data-theme="light"] .user-info,
[data-theme="light"] .user-name, [data-theme="light"] #currentUser {
    color: #0f172a !important;
}

[data-theme="light"] .badge, [data-theme="light"] .tag, [data-theme="light"] .count {
    color: #fff !important;
}

[data-theme="light"] a:not(.btn):not(button):not(.back-btn):not(.logout-link) {
    color: #2563eb !important;
}

[data-theme="light"] .back-btn, [data-theme="light"] .logout-link {
    color: #dc2626 !important;
}

[data-theme="light"] pre, [data-theme="light"] code, [data-theme="light"] .config-output,
[data-theme="light"] .output-box, [data-theme="light"] .code-block {
    background: #1e293b !important;
    color: #e2e8f0 !important;
}

[data-theme="light"] table { border-color: var(--border-color) !important; }
[data-theme="light"] th, [data-theme="light"] td {
    border-color: var(--border-color) !important;
    color: #0f172a !important;
}
[data-theme="light"] th { background: #f1f5f9 !important; color: #0f172a !important; }
[data-theme="light"] tr:hover { background: #f8fafc !important; }

[data-theme="light"] .success, [data-theme="light"] .alert-success,
[data-theme="light"] .success-box, [data-theme="light"] .ip-reserved {
    background: #dcfce7 !important;
    color: #166534 !important;
    border-color: #86efac !important;
}

[data-theme="light"] .error, [data-theme="light"] .alert-error,
[data-theme="light"] .error-box {
    background: #fee2e2 !important;
    color: #991b1b !important;
    border-color: #fca5a5 !important;
}

[data-theme="light"] .info-box, [data-theme="light"] .notice,
[data-theme="light"] .auto-ip-info {
    background: #eff6ff !important;
    color: #1e40af !important;
    border-color: #93c5fd !important;
}

[data-theme="light"] .btn-primary, [data-theme="light"] button[type="submit"] {
    background: #2563eb !important;
    color: #fff !important;
}

.theme-toggle {
    background: var(--bg-card, rgba(30,41,59,0.8));
    border: 1px solid var(--border-color, rgba(255,255,255,0.1));
    border-radius: 50%;
    width: 36px;
    height: 36px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    margin-left: 10px;
}
.theme-toggle:hover { transform: scale(1.1); }

/* ========== DARK THEME EXPLICIT OVERRIDES ========== */
:root body {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    color: #e2e8f0;
}
:root .card {
    background: rgba(30, 41, 59, 0.8);
    border-color: rgba(255, 255, 255, 0.1);
    color: #e2e8f0;
}
:root h1, :root h2, :root h3, :root h4 { color: #f1f5f9; }
:root label { color: #cbd5e1; }
:root .device-title { color: #f1f5f9; }
:root input, :root select, :root textarea {
    background: rgba(15, 23, 42, 0.8);
    border-color: rgba(255, 255, 255, 0.2);
    color: #e2e8f0;
}
:root input::placeholder { color: #64748b; }
:root pre, :root textarea {
    background: rgba(15, 23, 42, 0.8);
    border-color: rgba(255, 255, 255, 0.15);
    color: #e2e8f0;
}

[data-theme="dark"] label, [data-theme="dark"] .form-label { color: #cbd5e1 !important; }
[data-theme="dark"] h1, [data-theme="dark"] h2, [data-theme="dark"] h3, [data-theme="dark"] h4 { color: #f1f5f9 !important; }
[data-theme="dark"] span { color: inherit; }
[data-theme="dark"] .card {
    background: rgba(30, 41, 59, 0.85) !important;
    border-color: rgba(255, 255, 255, 0.12) !important;
    color: #e2e8f0 !important;
}
[data-theme="dark"] input, [data-theme="dark"] select, [data-theme="dark"] textarea {
    background: rgba(15, 23, 42, 0.9) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    color: #f1f5f9 !important;
}
[data-theme="dark"] input::placeholder { color: #64748b !important; }
[data-theme="dark"] select option { background: #1e293b; color: #e2e8f0; }
[data-theme="dark"] .device-title { color: #f1f5f9 !important; }
[data-theme="dark"] .device-box-header { color: #f1f5f9 !important; }
[data-theme="dark"] .user-info { background: rgba(59, 130, 246, 0.15) !important; color: #93c5fd !important; }
[data-theme="dark"] .tunnel-info { background: rgba(245, 158, 11, 0.12) !important; color: #fcd34d !important; }
[data-theme="dark"] .status-success { background: rgba(16, 185, 129, 0.15) !important; color: #6ee7b7 !important; border-color: rgba(16, 185, 129, 0.3) !important; }
[data-theme="dark"] .status-error { background: rgba(239, 68, 68, 0.15) !important; color: #fca5a5 !important; border-color: rgba(239, 68, 68, 0.3) !important; }
[data-theme="dark"] pre, [data-theme="dark"] textarea { background: rgba(15, 23, 42, 0.9) !important; border-color: rgba(255, 255, 255, 0.15) !important; color: #e2e8f0 !important; }
[data-theme="dark"] .auto-field-item { background: rgba(59, 130, 246, 0.08) !important; border-color: rgba(59, 130, 246, 0.2) !important; }
[data-theme="dark"] .auto-field-label { color: #94a3b8 !important; }
[data-theme="dark"] .auto-field-value { color: #f1f5f9 !important; }

/* ========== END THEME ========== */

/* Auto-fill fields styling */
.auto-fields-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.auto-field-item { background: #f0f7ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 8px 12px; }
.auto-field-label { display: block; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: #64748b; font-weight: 600; margin-bottom: 3px; }
.auto-field-value { display: block; font-size: 14px; font-weight: 700; color: #0f172a; font-family: 'Consolas', 'JetBrains Mono', monospace; }

        body {
            font-family: monospace;
            background: var(--bg-primary, #f5faff);
            color: var(--text-primary, #1e293b);
            margin: 0;
        }
        header { padding: 0; margin: 0; }
        h1 { margin: 0; font-size: 20px; font-weight: bold; color: var(--text-primary, #0f172a); }
        h2 { color: var(--text-primary, #0f172a); }
        .ascii-banner { text-align: center; font-size: 14px; line-height: 1.2; white-space: pre; color: #8b5cf6; margin: 12px 0; font-family: monospace; }
        main {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 16px;
            padding: 16px;
            max-width: 1600px;
            margin: 0 auto;
        }
        .card {
            background: var(--bg-card, #ffffff);
            border: 1px solid var(--border-color, #cbd5e1);
            border-radius: 10px;
            padding: 16px;
            color: var(--text-primary, #0f172a);
        }
        label { display: block; margin-top: 10px; font-size: 12px; font-weight: bold; color: var(--text-secondary, #334155); }
        input, select {
            width: 100%; padding: 8px; margin-top: 4px; border-radius: 6px;
            border: 1px solid var(--input-border, #94a3b8);
            background: var(--input-bg, #f1f5f9);
            color: var(--text-primary, #0f172a);
            box-sizing: border-box;
        }
        button { margin-top: 12px; padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        button.primary { background: #8b5cf6; color: #fff; }
        button.primary:hover { background: #7c3aed; }
        button.primary:disabled { background: #94a3b8; cursor: not-allowed; }
        .reload-btn { background: #64748b; color: #fff; padding: 6px 12px; font-size: 11px; }
        pre, textarea {
            background: var(--input-bg, #f8fafc);
            border: 1px dashed var(--border-color, #94a3b8);
            border-radius: 8px; padding: 14px; white-space: pre; overflow-x: auto;
            max-height: 60vh; font-size: 12px; color: var(--text-primary, #1e293b);
            width: 100%; box-sizing: border-box; font-family: Consolas, monospace;
        }
        textarea { resize: vertical; min-height: 500px; }
        .status-message { padding: 10px; margin: 10px 0; border-radius: 6px; font-size: 13px; }
        .status-success { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .status-error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .user-info { background: #dbeafe; padding: 8px; border-radius: 6px; margin-bottom: 12px; font-size: 12px; color: #1e40af; font-weight: bold; }
        .tunnel-info { background: #fef3c7; padding: 8px; border-radius: 6px; margin-top: 8px; font-size: 11px; color: #92400e; }
        .device-box { margin-bottom: 20px; }
        .device-box-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .device-title { font-size: 13px; font-weight: bold; color: var(--text-primary, #0f172a); }
        .copy-btn { background: #10b981; color: #ecfdf5; border-radius: 6px; padding: 4px 10px; font-size: 11px; margin-top: 0; }
        .copy-btn:hover { background: #059669; }

/* ========== BETTER FONTS ========== */
body { font-size: 16px !important; line-height: 1.6 !important; }
h1 { font-size: 1.8rem !important; font-weight: 700 !important; }
h2 { font-size: 1.4rem !important; font-weight: 700 !important; }
h3 { font-size: 1.2rem !important; font-weight: 600 !important; }
label, .form-label { font-size: 15px !important; font-weight: 600 !important; color: var(--text-primary, inherit) !important; }
input, select, textarea { font-size: 15px !important; padding: 12px 14px !important; }
.hint, .info-text, .help-text, .form-hint, small, .note, .description { font-size: 14px !important; font-weight: 500 !important; }
.btn, button:not(.theme-toggle) { font-size: 15px !important; font-weight: 600 !important; }
pre, code, .config-output, .output-box { font-size: 14px !important; line-height: 1.5 !important; }

[data-theme="light"] label, [data-theme="light"] .form-label,
[data-theme="light"] .section-title, [data-theme="light"] .title,
[data-theme="light"] h1, [data-theme="light"] h2, [data-theme="light"] h3 { color: #0f172a !important; }
[data-theme="light"] .hint, [data-theme="light"] small,
[data-theme="light"] .info-text, [data-theme="light"] .description,
[data-theme="light"] .help-text { color: #334155 !important; }
[data-theme="light"] input, [data-theme="light"] select, [data-theme="light"] textarea {
    color: #0f172a !important; background: #fff !important; border: 1px solid rgba(0,0,0,0.2) !important;
}
[data-theme="light"] input::placeholder { color: #64748b !important; }
    </style>

<script>
(function() {
    var theme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', theme);
})();

function toggleTheme() {
    var current = document.documentElement.getAttribute('data-theme') || 'dark';
    var next = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    var icon = document.getElementById('themeIcon');
    if (icon) icon.textContent = next === 'dark' ? '\u{1F319}' : '\u{2600}\u{FE0F}';
}

document.addEventListener('DOMContentLoaded', function() {
    var icon = document.getElementById('themeIcon');
    if (icon) {
        var theme = localStorage.getItem('theme') || 'dark';
        icon.textContent = theme === 'dark' ? '\u{1F319}' : '\u{2600}\u{FE0F}';
    }
});
</script>
</head>
<body>
    <header>
        <div style="
            max-width:1200px;
            margin:0 auto;
            padding:10px 16px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            background:var(--bg-header, #e2e8f0);
            border-bottom:1px solid var(--border-color, #cbd5e1);
        ">
            <div>
                <span style="font-size:14px; color:var(--text-secondary, #475569);">&#128100; User: </span>
                <span id="currentUser" style="font-size:14px; font-weight:bold; color:var(--text-primary, #0f172a);">Loading...</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme"><span id="themeIcon">&#127769;</span></button>
                <a href="/config-wizard"
                   style="padding:6px 14px; border-radius:6px; background:#3b82f6; color:#ffffff; text-decoration:none; font-size:13px; font-weight:bold;"
                   onmouseover="this.style.background='#2563eb'"
                   onmouseout="this.style.background='#3b82f6'">
                  &#8594; بازگشت به ویزارد
                </a>
                <a href="/"
                   style="padding:6px 14px; border-radius:6px; background:#ef4444; color:#ffffff; text-decoration:none; font-size:13px; font-weight:bold;"
                   onmouseover="this.style.background='#dc2626'"
                   onmouseout="this.style.background='#ef4444'">
                  Back to Menu
                </a>
            </div>
        </div>

        <div style="text-align:center; padding:10px 16px; background:var(--bg-header, #e2e8f0);">
            <h1 style="color:var(--text-primary, inherit);">MPLS / VPLS Config Generator</h1>
            <div class="ascii-banner">
                <pre>Keshavarzi Bank Network - MPLS/VPLS (Mali)</pre>
            </div>
        </div>
    </header>

    <main>
        <section class="card">
            <h2>Inputs</h2>

            <!-- Service Type Selection -->
            <div style="margin:10px 0 16px 0; padding:14px; background:linear-gradient(135deg,rgba(139,92,246,0.08),rgba(59,130,246,0.06)); border:1.5px solid rgba(139,92,246,0.3); border-radius:10px;">
              <label style="font-weight:700; color:#8b5cf6; margin:0 0 8px 0; display:block;">&#127760; Service Type</label>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <label style="display:flex; align-items:center; gap:6px; padding:10px 14px; border:2px solid rgba(139,92,246,0.4); border-radius:8px; cursor:pointer; transition:all 0.3s; font-size:13px; background:rgba(139,92,246,0.08);" id="svcVpls">
                  <input type="radio" name="serviceType" value="VPLS" checked style="accent-color:#8b5cf6;">
                  <span style="font-weight:600;">VPLS</span>
                </label>
                <label style="display:flex; align-items:center; gap:6px; padding:10px 14px; border:2px solid #374151; border-radius:8px; cursor:pointer; transition:all 0.3s; font-size:13px;" id="svcMpls">
                  <input type="radio" name="serviceType" value="MPLS" style="accent-color:#3b82f6;">
                  <span style="font-weight:600;">MPLS</span>
                </label>
              </div>
            </div>

            <!-- Interface-only config checkbox -->
            <div style="margin:10px 0; padding:12px 16px; background:rgba(56,189,248,0.06); border:1.5px solid rgba(56,189,248,0.25); border-radius:10px;">
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:14px;font-weight:600;color:var(--text-primary,#e2e8f0);margin:0;">
                    <input type="checkbox" id="tunnelOnlyConfig" style="width:18px;height:18px;accent-color:#38bdf8;cursor:pointer;" onchange="toggleTunnelOnly()">
                    <span>Only Tunnel/OSPF Config (skip physical interface)</span>
                </label>
                <div style="font-size:12px; color:var(--text-secondary,#94a3b8); margin-top:5px; padding-right:34px;">For branches where physical interface is already configured</div>
            </div>

            <!-- Base Config Checkbox -->
            <div style="margin:10px 0; padding:12px 16px; background:linear-gradient(135deg,rgba(16,185,129,0.08),rgba(6,182,212,0.04)); border:1.5px solid rgba(16,185,129,0.3); border-radius:10px;">
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:14px;font-weight:600;color:var(--text-primary,#e2e8f0);margin:0;">
                    <input type="checkbox" id="includeBaseConfig" style="width:18px;height:18px;accent-color:#10b981;cursor:pointer;">
                    <span style="color:#10b981;">Base Config (AAA/TACACS/SSH/SNMP/NTP)</span>
                </label>
                <div style="font-size:12px; color:var(--text-secondary,#94a3b8); margin-top:5px; padding-right:34px;">Include base configuration template</div>
            </div>

            <!-- Hostname field (shown when Base Config is checked) -->
            <div id="hostnameFieldContainer" style="display:none; margin:10px 0; padding:12px 16px; background:linear-gradient(135deg,rgba(16,185,129,0.04),rgba(6,182,212,0.02)); border:1px solid rgba(16,185,129,0.15); border-radius:10px;">
                <label style="font-size:13px; font-weight:700; color:#10b981;">Hostname</label>
                <input type="text" id="hostnameName" placeholder="e.g. ILM-Mehran">
                <div style="font-size:11px; color:var(--text-muted,#94a3b8); margin-top:3px;">Router hostname for initial configuration</div>
            </div>

            <!-- Branch Selection -->
            <label>Select Branch</label>
            <input id="branchName" type="text" list="branchList"
                   placeholder="Type branch name or select from list..."
                   autocomplete="off">
            <datalist id="branchList"></datalist>

            <!-- Auto-filled fields panel -->
            <div id="autoFieldsPanel" style="display:none; margin:12px 0 16px 0; background:rgba(139,92,246,0.06); border:1px solid rgba(139,92,246,0.2); border-radius:10px; padding:14px 16px;">
                <div style="font-size:11px; text-transform:uppercase; letter-spacing:0.5px; color:#8b5cf6; font-weight:700; margin-bottom:10px;">Auto-filled from branch</div>
                <div class="auto-fields-grid">
                    <div class="auto-field-item">
                        <span class="auto-field-label">Province</span>
                        <span class="auto-field-value" id="autoProvince">-</span>
                    </div>
                    <div class="auto-field-item">
                        <span class="auto-field-label">OSPF Area (X)</span>
                        <span class="auto-field-value" id="autoArea">-</span>
                    </div>
                </div>
            </div>
            <!-- Hidden inputs for config generation -->
            <input type="hidden" id="ospfArea">
            <input type="hidden" id="province">
            <input type="hidden" id="branchX">
            <input type="hidden" id="branchY">

            <!-- ========== AUTO-FILL TUNNEL SOURCE/DESTINATION ========== -->
            <div id="tunnelAutoFillPanel" style="display:none; margin:14px 0; padding:16px; background:linear-gradient(135deg,rgba(16,185,129,0.08),rgba(6,182,212,0.06)); border:1.5px solid rgba(16,185,129,0.3); border-radius:12px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div style="font-size:12px; text-transform:uppercase; letter-spacing:0.5px; color:#10b981; font-weight:700;">&#9889; Auto-Detected Tunnel IPs</div>
                    <div id="tunnelAutoStats" style="font-size:11px; color:var(--text-muted,#94a3b8);"></div>
                </div>

                <!-- Tunnel Destination (HUB IP) - Auto -->
                <div style="margin-bottom:12px; padding:12px; background:rgba(139,92,246,0.06); border:1px solid rgba(139,92,246,0.2); border-radius:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                        <label style="margin:0; font-size:13px; font-weight:700; color:#8b5cf6;">Tunnel Destination (HUB IP)</label>
                        <label style="display:flex; align-items:center; gap:6px; margin:0; cursor:pointer; font-size:12px; color:var(--text-secondary,#94a3b8);">
                            <input type="checkbox" id="overrideTunnelDest" style="width:16px;height:16px;accent-color:#ef4444;cursor:pointer;" onchange="toggleTunnelDestOverride()">
                            <span>&#9998; Manual Override</span>
                        </label>
                    </div>
                    <div id="autoTunnelDestDisplay" style="display:flex; align-items:center; gap:10px;">
                        <span id="autoTunnelDestValue" style="font-size:16px; font-weight:700; color:#10b981; font-family:'Consolas','JetBrains Mono',monospace; background:rgba(16,185,129,0.1); padding:6px 14px; border-radius:6px; border:1px solid rgba(16,185,129,0.2);">-</span>
                        <span id="autoTunnelDestLabel" style="font-size:11px; color:var(--text-muted,#94a3b8);">Hub router IP (auto-detected from province template)</span>
                    </div>
                    <div id="manualTunnelDestInput" style="display:none; margin-top:6px;">
                        <input type="text" id="manualTunnelDest" placeholder="Enter HUB IP manually..." style="border-color:rgba(239,68,68,0.4) !important; background:rgba(239,68,68,0.04) !important;">
                        <div style="font-size:11px; color:#ef4444; margin-top:3px;">&#9888; Manual mode - enter the correct HUB IP for this province</div>
                    </div>
                </div>

                <!-- WAN Interface IP (Tunnel Source) - Auto -->
                <div style="padding:12px; background:rgba(59,130,246,0.06); border:1px solid rgba(59,130,246,0.2); border-radius:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                        <label style="margin:0; font-size:13px; font-weight:700; color:#3b82f6;">WAN Interface IP (Tunnel Source)</label>
                        <label style="display:flex; align-items:center; gap:6px; margin:0; cursor:pointer; font-size:12px; color:var(--text-secondary,#94a3b8);">
                            <input type="checkbox" id="overrideWanIp" style="width:16px;height:16px;accent-color:#ef4444;cursor:pointer;" onchange="toggleWanIpOverride()">
                            <span>&#9998; Manual Override</span>
                        </label>
                    </div>
                    <div id="autoWanIpDisplay" style="display:flex; align-items:center; gap:10px;">
                        <span id="autoWanIpValue" style="font-size:16px; font-weight:700; color:#3b82f6; font-family:'Consolas','JetBrains Mono',monospace; background:rgba(59,130,246,0.1); padding:6px 14px; border-radius:6px; border:1px solid rgba(59,130,246,0.2);">-</span>
                        <span id="autoWanIpLabel" style="font-size:11px; color:var(--text-muted,#94a3b8);">Next available IP from branch subnet (auto-assigned)</span>
                    </div>
                    <div id="manualWanIpInput" style="display:none; margin-top:6px;">
                        <input type="text" id="manualWanIp" placeholder="Enter WAN IP manually..." style="border-color:rgba(239,68,68,0.4) !important; background:rgba(239,68,68,0.04) !important;">
                        <div style="font-size:11px; color:#ef4444; margin-top:3px;">&#9888; Manual mode - ensure this IP is not already in use</div>
                    </div>
                </div>

                <!-- Subnet Info -->
                <div id="tunnelSubnetInfo" style="margin-top:10px; padding:8px 12px; background:rgba(245,158,11,0.06); border:1px solid rgba(245,158,11,0.2); border-radius:6px; font-size:11px; color:var(--text-muted,#94a3b8);">
                    <span>&#128203; Subnet: <strong id="autoSubnetDisplay">-</strong></span>
                    <span style="margin-left:12px;">Used: <strong id="autoUsedCount">-</strong></span>
                    <span style="margin-left:12px;">Free: <strong id="autoFreeCount">-</strong></span>
                </div>
            </div>

            <!-- Fallback: Manual-only fields (shown when no template available) -->
            <div id="manualOnlyFields">
                <label>WAN Interface IP (Tunnel Source)</label>
                <input type="text" id="wanIpManualOnly" placeholder="e.g. 10.126.251.5">
                <div style="font-size:11px; color:var(--text-muted,#94a3b8); margin-top:3px;">IP address on the physical WAN interface - this becomes the tunnel source</div>

                <label>Tunnel Destination (HUB IP)</label>
                <input type="text" id="tunnelDestManualOnly" placeholder="e.g. 10.126.251.1">
                <div style="font-size:11px; color:var(--text-muted,#94a3b8); margin-top:3px;">IP of the HUB/PE router (tunnel destination)</div>
            </div>

            <!-- Hidden fields that hold the final values used in config generation -->
            <input type="hidden" id="wanIp">
            <input type="hidden" id="tunnelDest">

            <!-- Router-ID (hidden - auto-calculated as 10.X.254.Y) -->
            <input type="hidden" id="routerId">

            <!-- Free Tunnel /31 IP Pair (auto-assignment from DB) -->
            <div style="margin:14px 0; padding:14px; background:rgba(6,182,212,0.06); border:1px solid rgba(6,182,212,0.25); border-radius:10px;">
              <label style="font-weight:700; color:#06b6d4; margin:0 0 10px 0; display:block;">&#128640; Tunnel IP Pair (/31)</label>
              <label style="font-size:13px;">Choose a FREE /31 range</label>
              <select id="tunnelSelect"></select>
              <div class="tunnel-info">&#10003; First free tunnel auto-selected</div>
              <button class="reload-btn" onclick="loadVplsTunnels(document.getElementById('province').value)" type="button">&#128260; Reload list</button>

              <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                <div>
                  <label style="font-size:13px;">Tunnel Number (HUB)</label>
                  <input type="number" id="tunnelNumber" placeholder="auto: XY" min="1" max="65535">
                  <div style="font-size:11px; color:var(--text-muted,#94a3b8); margin-top:3px;">Default: <span id="autoTunnelNum" style="font-weight:700; color:#06b6d4;">-</span> (XY from branch) - for HUB only (Branch always uses Tunnel79)</div>
                </div>
                <div>
                  <label style="font-size:13px;">Tunnel Mask</label>
                  <select id="tunnelMask">
                    <option value="255.255.255.254">/31 (default)</option>
                    <option value="255.255.255.252">/30</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- WAN Subnet Mask -->
            <label>Subnet Mask WAN Interface</label>
            <select id="wanSubnetMask">
              <option value="255.255.255.0">/24 - 255.255.255.0 (default)</option>
              <option value="255.255.255.248">/29 - 255.255.255.248</option>
              <option value="255.255.255.252">/30 - 255.255.255.252</option>
              <option value="255.255.255.240">/28 - 255.255.255.240</option>
              <option value="255.255.255.224">/27 - 255.255.255.224</option>
              <option value="255.255.255.192">/26 - 255.255.255.192</option>
              <option value="255.255.255.128">/25 - 255.255.255.128</option>
            </select>

            <!-- Connection Type Selection -->
            <div id="connectionTypeBox" style="margin:16px 0; background:rgba(245,158,11,0.06); border:1px solid rgba(245,158,11,0.25); border-radius:10px; padding:14px;">
              <label style="font-weight:700; color:#f59e0b; margin-bottom:8px; display:block;">&#128268; Connection Type</label>
              <div id="wizardHint" style="display:none; font-size:12px; color:#38bdf8; margin-bottom:10px; padding:8px 12px; background:rgba(56,189,248,0.08); border:1px solid rgba(56,189,248,0.2); border-radius:8px;"></div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:10px;">
                <label style="display:flex; align-items:center; gap:6px; padding:10px 14px; border:2px solid #374151; border-radius:8px; cursor:pointer; transition:all 0.3s; font-size:13px;" id="connDirect" onclick="selectConnectionType('direct')">
                  <input type="radio" name="connectionType" value="direct" checked style="accent-color:#f59e0b;">
                  <span style="font-weight:600;">Direct Port</span>
                </label>
                <label style="display:flex; align-items:center; gap:6px; padding:10px 14px; border:2px solid #374151; border-radius:8px; cursor:pointer; transition:all 0.3s; font-size:13px;" id="conn4esw" onclick="selectConnectionType('4esw')">
                  <input type="radio" name="connectionType" value="4esw" style="accent-color:#f59e0b;">
                  <span style="font-weight:600;">4ESW Module (VLAN)</span>
                </label>
                <label style="display:flex; align-items:center; gap:6px; padding:10px 14px; border:2px solid #374151; border-radius:8px; cursor:pointer; transition:all 0.3s; font-size:13px;" id="connGshdsl" onclick="selectConnectionType('gshdsl')">
                  <input type="radio" name="connectionType" value="gshdsl" style="accent-color:#10b981;">
                  <span style="font-weight:600;">G.SHDSL (ATM+BVI)</span>
                </label>
                <label style="display:flex; align-items:center; gap:6px; padding:10px 14px; border:2px solid #374151; border-radius:8px; cursor:pointer; transition:all 0.3s; font-size:13px;" id="connAdsl" onclick="selectConnectionType('adsl')">
                  <input type="radio" name="connectionType" value="adsl" style="accent-color:#8b5cf6;">
                  <span style="font-weight:600;">1ADSL (ATM+BVI)</span>
                </label>
              </div>

              <!-- Direct Port Options -->
              <div id="directPortOptions">
                <label style="font-size:13px;">&#128204; WAN Interface Port</label>
                <input type="text" id="directPortName" placeholder="FastEthernet0/1" value="FastEthernet0/1">
                <div style="font-size:11px; color:#94a3b8; margin-top:3px;">Physical port connected to WAN</div>
              </div>

              <!-- 4ESW Module Options -->
              <div id="eswOptions" style="display:none;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                  <div>
                    <label style="font-size:13px;">VLAN Number</label>
                    <input type="number" id="eswVlan" placeholder="100" min="2" max="4094">
                  </div>
                  <div>
                    <label style="font-size:13px;">4ESW Port</label>
                    <input type="text" id="eswPort" placeholder="FastEthernet0/0/0">
                  </div>
                </div>
              </div>

              <!-- G.SHDSL Module Options -->
              <div id="gshdslOptions" style="display:none;">
                <div style="padding:8px 12px; background:rgba(16,185,129,0.06); border:1px solid rgba(16,185,129,0.2); border-radius:8px; margin-bottom:10px;">
                  <div style="font-size:12px; color:#10b981; font-weight:600; margin-bottom:4px;">G.SHDSL Module - ATM + BVI</div>
                  <div style="font-size:11px; color:#94a3b8;">controller DSL + ATM + bridge-group + BVI config generated</div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                  <div>
                    <label style="font-size:13px;">G.SHDSL Slot</label>
                    <select id="gshdslSlot">
                      <option value="0/0/0">Slot 0 (DSL 0/0/0)</option>
                      <option value="0/1/0">Slot 1 (DSL 0/1/0)</option>
                    </select>
                  </div>
                  <div>
                    <label style="font-size:13px;">Bridge-Group Number</label>
                    <input type="number" id="gshdslBridgeGroup" placeholder="1" value="1" min="1" max="10">
                  </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px;">
                  <div>
                    <label style="font-size:13px;">PVC (VPI/VCI)</label>
                    <input type="text" id="gshdslPvc" placeholder="0/35" value="0/35">
                  </div>
                  <div>
                    <label style="font-size:13px;">Bandwidth (CBR)</label>
                    <input type="text" id="gshdslCbr" placeholder="512" value="512">
                  </div>
                </div>
              </div>

              <!-- 1ADSL Module Options -->
              <div id="adslOptions" style="display:none;">
                <div style="padding:8px 12px; background:rgba(139,92,246,0.06); border:1px solid rgba(139,92,246,0.2); border-radius:8px; margin-bottom:10px;">
                  <div style="font-size:12px; color:#8b5cf6; font-weight:600; margin-bottom:4px;">1ADSL Module - ATM + BVI</div>
                  <div style="font-size:11px; color:#94a3b8;">ATM + bridge-group + BVI config generated</div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                  <div>
                    <label style="font-size:13px;">1ADSL Slot</label>
                    <select id="adslSlot">
                      <option value="0/0/0">Slot 0 (ATM0/0/0)</option>
                      <option value="0/1/0">Slot 1 (ATM0/1/0)</option>
                    </select>
                  </div>
                  <div>
                    <label style="font-size:13px;">Bridge-Group Number</label>
                    <input type="number" id="adslBridgeGroup" placeholder="1" value="1" min="1" max="10">
                  </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px;">
                  <div>
                    <label style="font-size:13px;">PVC (VPI/VCI)</label>
                    <input type="text" id="adslPvc" placeholder="0/35" value="0/35">
                  </div>
                  <div>
                    <label style="font-size:13px;">Encapsulation</label>
                    <select id="adslEncap">
                      <option value="aal5snap">AAL5SNAP</option>
                      <option value="aal5mux">AAL5MUX PPPoE</option>
                    </select>
                  </div>
                </div>
              </div>

            </div>

            <!-- Branch English name -->
            <label>Branch Name (English)</label>
            <input type="text" id="branchNameEn" placeholder="e.g. KhomeyniShahr">

            <div id="statusMessage"></div>

            <button class="primary" id="generateBtn">Generate Configs</button>
        </section>

        <section class="card">
            <h2>Generated Config</h2>

            <div class="device-box">
                <div class="device-box-header">
                    <span class="device-title">Branch Router</span>
                    <button class="copy-btn" onclick="copyConfig('branchConfig')">Copy</button>
                </div>
                <textarea id="branchConfig" readonly>Branch configuration will appear here...</textarea>
            </div>

            <div class="device-box">
                <div class="device-box-header">
                    <span class="device-title">HUB Router</span>
                    <button class="copy-btn" onclick="copyConfig('hubConfig')">Copy</button>
                </div>
                <textarea id="hubConfig" readonly>HUB configuration will appear here...</textarea>
            </div>
        </section>
    </main>

    <script>
        // Session timeout: 8 hours
        const SESSION_TIMEOUT = 8 * 60 * 60 * 1000;
        (function() {
            const sessionStart = localStorage.getItem('sessionStart');
            if (sessionStart && (Date.now() - parseInt(sessionStart)) > SESSION_TIMEOUT) {
                localStorage.clear(); sessionStorage.clear();
                alert('Session expired. Please login again.');
                location.href = '/login';
            }
        })();

        let currentUsername = localStorage.getItem('currentUser') ||
                              localStorage.getItem('username') ||
                              sessionStorage.getItem('username') ||
                              'unknown';
        document.getElementById('currentUser').textContent = currentUsername;
        if (currentUsername === 'unknown') { location.href = '/login'; }

        function copyConfig(id) {
            const el = document.getElementById(id);
            el.select();
            document.execCommand('copy');
        }

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = 'status-message ' + (isError ? 'status-error' : 'status-success');
            statusDiv.textContent = message;
            setTimeout(() => { statusDiv.textContent = ''; statusDiv.className = ''; }, 5000);
        }

        // ==================== PROVINCE MAPPING ====================
        const provinceMapping = {
            '\u062a\u0647\u0631\u0627\u0646 \u0628\u0632\u0631\u06af': { en: 'Tehran', abbr: 'TEHB' },
            '\u062a\u0647\u0631\u0627\u0646': { en: 'Tehran', abbr: 'TEH' },
            '\u0627\u0644\u0628\u0631\u0632': { en: 'Alborz', abbr: 'KRJ' },
            '\u0622\u0630\u0631\u0628\u0627\u06cc\u062c\u0627\u0646 \u0634\u0631\u0642\u06cc': { en: 'East Azerbaijan', abbr: 'AZSH' },
            '\u0622\u0630\u0631\u0628\u0627\u06cc\u062c\u0627\u0646 \u063a\u0631\u0628\u06cc': { en: 'West Azerbaijan', abbr: 'AZGH' },
            '\u06a9\u0631\u062f\u0633\u062a\u0627\u0646': { en: 'Kurdistan', abbr: 'KRD' },
            '\u0627\u0635\u0641\u0647\u0627\u0646': { en: 'Isfahan', abbr: 'ESF' },
            '\u062e\u0631\u0627\u0633\u0627\u0646 \u0631\u0636\u0648\u06cc': { en: 'Razavi Khorasan', abbr: 'KHR' },
            '\u0641\u0627\u0631\u0633': { en: 'Fars', abbr: 'FRS' },
            '\u06a9\u0631\u0645\u0627\u0646': { en: 'Kerman', abbr: 'KRM' },
            '\u062e\u0648\u0632\u0633\u062a\u0627\u0646': { en: 'Khuzestan', abbr: 'KHZ' },
            '\u0644\u0631\u0633\u062a\u0627\u0646': { en: 'Lorestan', abbr: 'LOR' },
            '\u06af\u06cc\u0644\u0627\u0646': { en: 'Gilan', abbr: 'GIL' },
            '\u06af\u0644\u0633\u062a\u0627\u0646': { en: 'Golestan', abbr: 'GLS' },
            '\u0645\u0627\u0632\u0646\u062f\u0631\u0627\u0646': { en: 'Mazandaran', abbr: 'MAZ' },
            '\u0633\u06cc\u0633\u062a\u0627\u0646 \u0648 \u0628\u0644\u0648\u0686\u0633\u062a\u0627\u0646': { en: 'Sistan and Baluchestan', abbr: 'SNB' },
            '\u06cc\u0632\u062f': { en: 'Yazd', abbr: 'YZD' },
            '\u0632\u0646\u062c\u0627\u0646': { en: 'Zanjan', abbr: 'ZNJ' },
            '\u0633\u0645\u0646\u0627\u0646': { en: 'Semnan', abbr: 'SMN' },
            '\u0645\u0631\u06a9\u0632\u06cc': { en: 'Markazi', abbr: 'MRZ' },
            '\u0647\u0645\u062f\u0627\u0646': { en: 'Hamadan', abbr: 'HMD' },
            '\u0642\u0632\u0648\u06cc\u0646': { en: 'Qazvin', abbr: 'QZV' },
            '\u0642\u0645': { en: 'Qom', abbr: 'QOM' },
            '\u0627\u0631\u062f\u0628\u06cc\u0644': { en: 'Ardabil', abbr: 'ARD' },
            '\u0627\u06cc\u0644\u0627\u0645': { en: 'Ilam', abbr: 'ILM' },
            '\u0628\u0648\u0634\u0647\u0631': { en: 'Bushehr', abbr: 'BSH' },
            '\u0686\u0647\u0627\u0631\u0645\u062d\u0627\u0644 \u0648 \u0628\u062e\u062a\u06cc\u0627\u0631\u06cc': { en: 'Chaharmahal and Bakhtiari', abbr: 'CHB' },
            '\u0647\u0631\u0645\u0632\u06af\u0627\u0646': { en: 'Hormozgan', abbr: 'HMZ' },
            '\u06a9\u0631\u0645\u0627\u0646\u0634\u0627\u0647': { en: 'Kermanshah', abbr: 'KRMSH' },
            '\u06a9\u0647\u06af\u06cc\u0644\u0648\u06cc\u0647 \u0648 \u0628\u0648\u06cc\u0631\u0627\u062d\u0645\u062f': { en: 'Kohgiluyeh and Boyer-Ahmad', abbr: 'KHB' },
            '\u062e\u0631\u0627\u0633\u0627\u0646 \u0634\u0645\u0627\u0644\u06cc': { en: 'North Khorasan', abbr: 'KHSH' },
            '\u062e\u0631\u0627\u0633\u0627\u0646 \u062c\u0646\u0648\u0628\u06cc': { en: 'South Khorasan', abbr: 'KHRJ' }
        };

        let selectedBranchData = null;
        let currentTunnelTemplate = null;  // Stores the current auto-fill template data

        // ==================== TUNNEL AUTO-FILL FUNCTIONS ====================
        async function loadTunnelTemplate(provinceAbbr, serviceType, branchY) {
            /**
             * Fetch tunnel template for a province and service type.
             * Auto-fills WAN IP (tunnel source) and Tunnel Destination (hub IP).
             */
            try {
                const url = `/api/tunnel-template?province_abbr=${encodeURIComponent(provinceAbbr)}&service_type=${encodeURIComponent(serviceType)}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.available) {
                    currentTunnelTemplate = data;

                    // Show auto-fill panel, hide manual-only fields
                    document.getElementById('tunnelAutoFillPanel').style.display = 'block';
                    document.getElementById('manualOnlyFields').style.display = 'none';

                    // Set Tunnel Destination (HUB IP)
                    document.getElementById('autoTunnelDestValue').textContent = data.hub_ip;
                    document.getElementById('autoTunnelDestLabel').textContent =
                        `Hub IP for ${serviceType} in ${provinceAbbr} (${data.branch_subnet})`;

                    // Set WAN IP based on branch Y value (4th octet = Y from LAN IP)
                    const subnetPrefix = data.branch_subnet.replace('.0/24', '');
                    const computedWanIp = subnetPrefix + '.' + branchY;
                    data.computed_wan_ip = computedWanIp;

                    document.getElementById('autoWanIpValue').textContent = computedWanIp;
                    document.getElementById('autoWanIpValue').style.color = '#3b82f6';
                    document.getElementById('autoWanIpLabel').textContent =
                        `Based on branch LAN Y=${branchY} \u2192 ${subnetPrefix}.${branchY}`;

                    // Update subnet stats
                    document.getElementById('autoSubnetDisplay').textContent = data.branch_subnet;
                    document.getElementById('autoUsedCount').textContent = data.used_count;
                    document.getElementById('autoFreeCount').textContent = data.remaining;
                    document.getElementById('tunnelAutoStats').textContent =
                        `${serviceType} | ${data.used_count} used / ${data.remaining} free`;

                    // Sync to hidden fields (unless override is active)
                    syncTunnelIpFields();

                    console.log(`Tunnel template loaded: ${provinceAbbr}/${serviceType} - Hub: ${data.hub_ip}, Next: ${data.next_free_ip}`);
                } else {
                    // No template available - show manual-only fields
                    currentTunnelTemplate = null;
                    document.getElementById('tunnelAutoFillPanel').style.display = 'none';
                    document.getElementById('manualOnlyFields').style.display = 'block';
                    console.log(`No tunnel template for ${provinceAbbr}: ${data.message}`);
                }
            } catch (err) {
                console.error('Error loading tunnel template:', err);
                currentTunnelTemplate = null;
                document.getElementById('tunnelAutoFillPanel').style.display = 'none';
                document.getElementById('manualOnlyFields').style.display = 'block';
            }
        }

        function syncTunnelIpFields() {
            /**
             * Sync the visible auto/manual values to the hidden fields used by config generation.
             */
            const wanIpField = document.getElementById('wanIp');
            const tunnelDestField = document.getElementById('tunnelDest');

            // WAN IP
            if (document.getElementById('overrideWanIp').checked) {
                wanIpField.value = document.getElementById('manualWanIp').value.trim();
            } else if (currentTunnelTemplate && currentTunnelTemplate.computed_wan_ip) {
                wanIpField.value = currentTunnelTemplate.computed_wan_ip;
            } else {
                // Fallback to manual-only field
                wanIpField.value = document.getElementById('wanIpManualOnly').value.trim();
            }

            // Tunnel Destination
            if (document.getElementById('overrideTunnelDest').checked) {
                tunnelDestField.value = document.getElementById('manualTunnelDest').value.trim();
            } else if (currentTunnelTemplate && currentTunnelTemplate.hub_ip) {
                tunnelDestField.value = currentTunnelTemplate.hub_ip;
            } else {
                tunnelDestField.value = document.getElementById('tunnelDestManualOnly').value.trim();
            }
        }

        function toggleTunnelDestOverride() {
            const isOverride = document.getElementById('overrideTunnelDest').checked;
            document.getElementById('autoTunnelDestDisplay').style.display = isOverride ? 'none' : 'flex';
            document.getElementById('manualTunnelDestInput').style.display = isOverride ? 'block' : 'none';
            syncTunnelIpFields();
        }

        function toggleWanIpOverride() {
            const isOverride = document.getElementById('overrideWanIp').checked;
            document.getElementById('autoWanIpDisplay').style.display = isOverride ? 'none' : 'flex';
            document.getElementById('manualWanIpInput').style.display = isOverride ? 'block' : 'none';
            syncTunnelIpFields();
        }

        // Sync on manual input change
        document.addEventListener('input', function(e) {
            if (['manualWanIp', 'manualTunnelDest', 'wanIpManualOnly', 'tunnelDestManualOnly'].includes(e.target.id)) {
                syncTunnelIpFields();
            }
        });

        // ==================== LOAD BRANCHES ====================
        async function loadBranches() {
            try {
                const res = await fetch('/api/branches');
                const branches = await res.json();
                const datalist = document.getElementById('branchList');
                datalist.innerHTML = '';
                branches.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = `${b.name} - [${b.province}] (10.${b.x}.${b.y}.0)`;
                    datalist.appendChild(opt);
                });
                console.log(`Loaded ${branches.length} branches`);
            } catch (err) {
                console.error('Error loading branches:', err);
            }
        }

        // ==================== LOAD FREE VPLS TUNNELS ====================
        async function loadVplsTunnels(province) {
            try {
                let url = '/api/vpls-tunnels';
                if (province) {
                    url += '?province=' + encodeURIComponent(province);
                }
                const res = await fetch(url);
                const data = await res.json();
                const sel = document.getElementById('tunnelSelect');
                sel.innerHTML = '';

                if (data.length === 0) {
                    sel.innerHTML = '<option value="">No free tunnel IPs for this province</option>';
                    return;
                }

                data.forEach((r, i) => {
                    const o = document.createElement('option');
                    o.value = JSON.stringify(r);
                    o.text = `${r.ip_address} ${i === 0 ? '\u2190 Selected' : ''}`;
                    sel.add(o);
                });

                sel.selectedIndex = 0;
                console.log(`Loaded ${data.length} free VPLS tunnel IPs for province: ${province || 'all'}`);
            } catch (err) {
                console.error('Error loading VPLS tunnels:', err);
                const sel = document.getElementById('tunnelSelect');
                sel.innerHTML = '<option value="">Error loading tunnels</option>';
            }
        }

        // ==================== BRANCH SELECTION HANDLER ====================
        document.getElementById('branchName').addEventListener('input', function() {
            const val = this.value.trim();
            const match = val.match(/\[([^\]]+)\]\s*\(10\.(\d+)\.(\d+)\.0\)/);
            if (match) {
                const provincePersian = match[1];
                const x = match[2];
                const y = match[3];
                const prov = provinceMapping[provincePersian] || { en: provincePersian, abbr: provincePersian };

                selectedBranchData = { x, y, provincePersian, provinceEn: prov.en, provinceAbbr: prov.abbr };

                document.getElementById('ospfArea').value = x;
                document.getElementById('province').value = prov.en;
                document.getElementById('branchX').value = x;
                document.getElementById('branchY').value = y;

                document.getElementById('autoProvince').textContent = prov.en + ' (' + prov.abbr + ')';
                document.getElementById('autoArea').textContent = 'Area ' + x;

                // Auto-generate tunnel number as XY (e.g. X=3,Y=14 → 314, X=12,Y=1 → 1201)
                const yPad = parseInt(y) < 10 ? '0' + y : y;
                const autoTunNum = x + yPad;
                document.getElementById('autoTunnelNum').textContent = autoTunNum;
                // Only auto-fill if user hasn't manually entered a value
                const tunnelNumEl = document.getElementById('tunnelNumber');
                if (!tunnelNumEl.dataset.manual) {
                    tunnelNumEl.value = autoTunNum;
                }

                // Auto-fill Router-ID as 10.X.254.Y (hidden field)
                const autoRouterId = `10.${x}.254.${y}`;
                document.getElementById('routerId').value = autoRouterId;

                // Load tunnel IPs filtered by this province
                loadVplsTunnels(prov.en);

                // Load tunnel source/dest template for this province
                const svcType = document.querySelector('input[name="serviceType"]:checked').value;
                loadTunnelTemplate(prov.abbr, svcType, y);

                document.getElementById('autoFieldsPanel').style.display = 'block';
            }
        });

        // Mark tunnel number as manually edited when user changes it
        document.getElementById('tunnelNumber').addEventListener('input', function() {
            this.dataset.manual = 'true';
        });

        // Router-ID is now auto-calculated (hidden field), no manual edit needed

        // ==================== SERVICE TYPE TOGGLE ====================
        document.querySelectorAll('input[name="serviceType"]').forEach(r => {
            r.addEventListener('change', function() {
                const val = this.value;
                document.getElementById('svcVpls').style.borderColor = val === 'VPLS' ? 'rgba(139,92,246,0.4)' : '#374151';
                document.getElementById('svcVpls').style.background = val === 'VPLS' ? 'rgba(139,92,246,0.08)' : '';
                document.getElementById('svcMpls').style.borderColor = val === 'MPLS' ? 'rgba(59,130,246,0.4)' : '#374151';
                document.getElementById('svcMpls').style.background = val === 'MPLS' ? 'rgba(59,130,246,0.08)' : '';

                // Re-load tunnel template when service type changes (VPLS/MPLS may use different hubs)
                if (selectedBranchData && selectedBranchData.provinceAbbr) {
                    loadTunnelTemplate(selectedBranchData.provinceAbbr, val, selectedBranchData.y);
                }
            });
        });

        // ==================== CONNECTION TYPE HANDLER ====================
        function selectConnectionType(type) {
            document.getElementById('directPortOptions').style.display = type === 'direct' ? 'block' : 'none';
            document.getElementById('eswOptions').style.display = type === '4esw' ? 'block' : 'none';
            document.getElementById('gshdslOptions').style.display = type === 'gshdsl' ? 'block' : 'none';
            document.getElementById('adslOptions').style.display = type === 'adsl' ? 'block' : 'none';

            const types = {direct: '#f59e0b', '4esw': '#f59e0b', gshdsl: '#10b981', adsl: '#8b5cf6'};
            ['connDirect', 'conn4esw', 'connGshdsl', 'connAdsl'].forEach(id => {
                const el = document.getElementById(id);
                const t = el.querySelector('input[type=radio]').value;
                el.style.borderColor = t === type ? (types[type] || '#f59e0b') : '#374151';
                el.style.background = t === type ? `rgba(${type === 'gshdsl' ? '16,185,129' : type === 'adsl' ? '139,92,246' : '245,158,11'},0.08)` : '';
                el.querySelector('input[type=radio]').checked = t === type;
            });
        }

        // Read wizard config and hide non-selected connection types
        (function readWizardConfig() {
            try {
                const wc = JSON.parse(localStorage.getItem('wizardConfig') || '{}');
                const connType = wc.copper_connection;
                const moduleType = wc.copper_module_type;
                const modemType = wc.copper_modem_type;
                const hint = document.getElementById('wizardHint');
                const connLabels = {connDirect: 'direct', conn4esw: '4esw', connGshdsl: 'gshdsl', connAdsl: 'adsl'};

                function hideOtherConnTypes(activeType) {
                    // Map internal type to element IDs
                    const typeToId = {direct: 'connDirect', '4esw': 'conn4esw', gshdsl: 'connGshdsl', adsl: 'connAdsl'};
                    Object.entries(typeToId).forEach(([t, id]) => {
                        const el = document.getElementById(id);
                        if (el) el.style.display = (t === activeType) ? 'flex' : 'none';
                    });
                }

                if (connType === 'Module') {
                    if (moduleType === 'G.SHDSL') {
                        selectConnectionType('gshdsl');
                        hideOtherConnTypes('gshdsl');
                        if (hint) { hint.style.display = 'block'; hint.textContent = 'ویزارد: ماژول G.SHDSL انتخاب شده'; }
                        return;
                    } else if (moduleType === '1ADSL') {
                        selectConnectionType('adsl');
                        hideOtherConnTypes('adsl');
                        if (hint) { hint.style.display = 'block'; hint.textContent = 'ویزارد: ماژول 1ADSL انتخاب شده'; }
                        return;
                    } else if (moduleType === '4ESW') {
                        selectConnectionType('4esw');
                        hideOtherConnTypes('4esw');
                        if (hint) { hint.style.display = 'block'; hint.textContent = 'ویزارد: ماژول 4ESW انتخاب شده'; }
                        return;
                    }
                } else if (connType === 'Modem') {
                    if (modemType === '4ESW_VLAN') {
                        selectConnectionType('4esw');
                        hideOtherConnTypes('4esw');
                        if (hint) { hint.style.display = 'block'; hint.textContent = 'ویزارد: مودم به 4ESW VLAN'; }
                        return;
                    } else if (modemType === 'Direct_Port') {
                        selectConnectionType('direct');
                        hideOtherConnTypes('direct');
                        if (hint) { hint.style.display = 'block'; hint.textContent = 'ویزارد: اتصال مستقیم به پورت'; }
                        return;
                    }
                }
            } catch (e) { /* no wizard data */ }
            selectConnectionType('direct');
        })();

        // Toggle tunnel-only mode
        function toggleTunnelOnly() {
            const checked = document.getElementById('tunnelOnlyConfig').checked;
            const connBox = document.getElementById('connectionTypeBox');
            if (connBox) connBox.style.display = checked ? 'none' : 'block';
        }

        // Toggle hostname field when Base Config checkbox changes
        document.getElementById('includeBaseConfig').addEventListener('change', function() {
            document.getElementById('hostnameFieldContainer').style.display = this.checked ? 'block' : 'none';
        });

        // ==================== GENERATE CONFIG ====================
        document.getElementById('generateBtn').addEventListener('click', async function() {
            // Sync auto/manual IP values to hidden fields before reading them
            syncTunnelIpFields();

            const generateBtn = document.getElementById('generateBtn');
            const svcType = document.querySelector('input[name="serviceType"]:checked').value;
            const routerId = document.getElementById('routerId').value.trim();
            const wanIp = document.getElementById('wanIp').value.trim();
            const tunnelDest = document.getElementById('tunnelDest').value.trim();
            const area = document.getElementById('ospfArea').value.trim();
            const bx = document.getElementById('branchX').value.trim();
            const by = document.getElementById('branchY').value.trim();
            const wanMask = document.getElementById('wanSubnetMask').value;
            const branchNameEn = document.getElementById('branchNameEn').value.trim();

            const tunnelNum = document.getElementById('tunnelNumber').value.trim();
            const tunnelMask = document.getElementById('tunnelMask').value;

            // Parse tunnel IP from dropdown
            const tunnelSelectValue = document.getElementById('tunnelSelect').value;
            let tunnelIpLocal = '';
            let tunnelIpRemote = '';
            let tunnelData = null;

            if (tunnelSelectValue) {
                try {
                    tunnelData = JSON.parse(tunnelSelectValue);
                    tunnelIpLocal = tunnelData.branch_ip || '';
                    tunnelIpRemote = tunnelData.hub_ip || '';
                } catch(e) {}
            }

            // Validation
            if (!wanIp) {
                showStatus('Please enter WAN Interface IP (Tunnel Source)!', true);
                return;
            }
            if (!tunnelDest) {
                showStatus('Please enter Tunnel Destination (HUB IP)!', true);
                return;
            }
            if (!area) {
                showStatus('Please select a branch to set OSPF Area!', true);
                return;
            }
            if (!tunnelNum) {
                showStatus('Please enter Tunnel Number!', true);
                return;
            }
            if (!tunnelIpLocal || !tunnelIpRemote) {
                showStatus('Please select a free /31 Tunnel IP pair!', true);
                return;
            }

            // Reserve tunnel IP in database
            if (tunnelData && tunnelData.id) {
                generateBtn.disabled = true;
                generateBtn.textContent = 'Reserving tunnel IP...';

                try {
                    const res = await fetch('/api/reserve-vpls-tunnel', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            id: tunnelData.id,
                            tunnel_name: 'Tunnel' + tunnelNum,
                            description: branchNameEn ? `${svcType}-${branchNameEn}` : svcType,
                            province: document.getElementById('province').value || '',
                            branch_name: branchNameEn || '',
                            username: currentUsername,
                            wan_ip: wanIp,
                            tunnel_dest: tunnelDest
                        })
                    });
                    const result = await res.json();
                    if (result.status === 'ok') {
                        showStatus(`Tunnel IP ${tunnelData.ip_address} reserved by ${currentUsername}!`);
                        loadVplsTunnels();
                    } else {
                        showStatus('Reserve failed: ' + (result.error || 'Unknown'), true);
                        generateBtn.disabled = false;
                        generateBtn.textContent = 'Generate Configs';
                        return;
                    }
                } catch (err) {
                    showStatus('Error: ' + err.message, true);
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Generate Configs';
                    return;
                }
            }

            const tunnelOnly = document.getElementById('tunnelOnlyConfig').checked;
            const connType = document.querySelector('input[name="connectionType"]:checked').value;
            const branchDesc = `** ${svcType} **`;
            const hubDesc = branchNameEn ? `** ${svcType} - ${branchNameEn} **` : `** ${svcType} **`;

            // ========== Interface Config ==========
            let ifaceConfig = '';
            let natInterface = 'Loopback0';

            if (!tunnelOnly) {
            if (connType === 'direct') {
                const portName = document.getElementById('directPortName').value.trim() || 'FastEthernet0/1';
                ifaceConfig = `!
! ===== WAN Interface (Direct - ${portName}) =====
!
interface ${portName}
 description ${branchDesc}
 ip address ${wanIp} ${wanMask}
 ip access-group SERIAL_IN in
 ip virtual-reassembly
 ip policy route-map nachi-worm
 duplex auto
 speed auto
 no shutdown
!`;
            } else if (connType === '4esw') {
                const vlanNum = document.getElementById('eswVlan').value.trim();
                const eswPort = document.getElementById('eswPort').value.trim() || 'FastEthernet0/0/0';
                if (!vlanNum) { showStatus('Please enter VLAN number!', true); return; }

                ifaceConfig = `!
! ===== 4ESW Module + VLAN ${vlanNum} =====
!
end
!
vlan database
vlan ${vlanNum}
exit
!
conf t
!
interface ${eswPort}
 switchport access vlan ${vlanNum}
!
interface Vlan${vlanNum}
 description ${branchDesc}
 ip address ${wanIp} ${wanMask}
 ip access-group SERIAL_IN in
 ip virtual-reassembly
 ip policy route-map nachi-worm
 no shutdown
!`;
            } else if (connType === 'gshdsl') {
                const slot = document.getElementById('gshdslSlot').value;
                const bg = document.getElementById('gshdslBridgeGroup').value.trim() || '1';
                const pvc = document.getElementById('gshdslPvc').value.trim() || '0/35';
                const cbr = document.getElementById('gshdslCbr').value.trim() || '512';
                const atmIface = `ATM${slot}`;
                const pvcParts = pvc.split('/');
                const pvcVpi = pvcParts[0] || '0';
                const pvcVci = pvcParts[1] || '35';
                natInterface = 'BVI' + bg;

                ifaceConfig = `!
! ===== G.SHDSL Module (${slot}) - ATM + Bridge-Group ${bg} + BVI${bg} =====
!
controller DSL ${slot}
 mode atm
 line-term cpe
 line-mode 2-wire line-zero
 dsl-mode shdsl symmetric annex B
 line-rate auto
!
interface ${atmIface}
 description ** ${svcType} **
 no ip address
 no atm ilmi-keepalive
 bridge-group ${bg}
 bridge-group ${bg} spanning-disabled
 pvc ${pvcVpi}/${pvcVci}
  cbr ${cbr}
  encapsulation aal5snap
 !
!
bridge irb
bridge ${bg} protocol ieee
bridge ${bg} route ip
!
interface BVI${bg}
 description ${branchDesc}
 ip address ${wanIp} ${wanMask}
 ip access-group SERIAL_IN in
 ip virtual-reassembly
 ip policy route-map nachi-worm
!`;
            } else if (connType === 'adsl') {
                const slot = document.getElementById('adslSlot').value;
                const bg = document.getElementById('adslBridgeGroup').value.trim() || '1';
                const pvc = document.getElementById('adslPvc').value.trim() || '0/35';
                const encap = document.getElementById('adslEncap').value;
                const atmIface = `ATM${slot}`;
                const pvcParts = pvc.split('/');
                const pvcVpi = pvcParts[0] || '0';
                const pvcVci = pvcParts[1] || '35';
                natInterface = 'BVI' + bg;

                ifaceConfig = `!
! ===== 1ADSL Module (${slot}) - ATM + Bridge-Group ${bg} + BVI${bg} =====
!
interface ${atmIface}
 description ** ${svcType} **
 no ip address
 no atm ilmi-keepalive
 bridge-group ${bg}
 bridge-group ${bg} spanning-disabled
 pvc ${pvcVpi}/${pvcVci}
  encapsulation ${encap}
 !
!
bridge irb
bridge ${bg} protocol ieee
bridge ${bg} route ip
!
interface BVI${bg}
 description ${branchDesc}
 ip address ${wanIp} ${wanMask}
 ip access-group SERIAL_IN in
 ip virtual-reassembly
 ip policy route-map nachi-worm
!`;
            }
            } // end if (!tunnelOnly)

            // ========== SERIAL_IN ACL ==========
            let aclConfig = '';
            if (bx && by && !tunnelOnly) {
                aclConfig = `!
! ===== Access Lists =====
!
ip access-list extended SERIAL_IN
 permit icmp any any
 deny   udp any any eq tftp
 deny   udp any any eq 135
 deny   udp any any eq netbios-ns
 deny   udp any any eq netbios-dgm
 deny   udp any any eq netbios-ss
 deny   udp any any eq snmp
 deny   udp any any eq snmptrap
 deny   tcp any any eq 135
 deny   tcp any any eq 139
 deny   tcp any any eq 445
 deny   tcp any any eq 593
 deny   tcp any any eq 4444
 deny   tcp any any eq 1433
 deny   tcp any any eq 4786
 permit ip 10.30.42.0 0.0.0.255 any
 permit ip host 91.240.180.40 any
 permit ip host 91.240.181.1 any
!
ip access-list extended ETHERNET_IN
 deny   tcp any any range 135 139
 deny   tcp any any eq 445
 deny   udp any any range 135 netbios-ss
 deny   udp any any eq 1434
 deny   udp any any eq 1433
 deny   tcp any any eq 1026
 deny   tcp any any eq 4444
 deny   udp any any eq 445
 permit ip 10.${bx}.${by}.0 0.0.0.255 192.168.65.0 0.0.0.255
 permit ip 10.${bx}.${by}.0 0.0.0.255 192.168.72.0 0.0.0.255
 permit udp 10.${bx}.${by}.0 0.0.0.255 224.0.0.0 0.0.0.255
 permit ip 10.${bx}.${by}.0 0.0.0.255 10.${bx}.${by}.0 0.0.0.255
 permit ip 10.${bx}.${by}.0 0.0.0.255 10.${bx}.0.0 0.0.7.255
 permit ip 10.${bx}.${by}.0 0.0.0.255 10.0.0.0 0.0.255.255
 permit ip 10.${bx}.${by}.0 0.0.0.255 10.30.42.0 0.0.0.255
 permit ip 10.${bx}.${by}.0 0.0.0.255 host 91.240.180.40
 permit ip 10.${bx}.${by}.0 0.0.0.255 host 91.240.181.1
!
ip access-list standard OSPF-PERMIT
 permit 10.${bx}.0.0 0.0.255.255
 permit 10.0.0.0 0.0.255.255
 permit 10.30.42.0 0.0.0.255
!`;
            }

            // ========== Tunnel + OSPF Config ==========
            let tunnelConfig = `!
! ===== ${svcType} Tunnel Configuration =====
!
interface Loopback0
 ip address ${routerId} 255.255.255.255
!
interface Tunnel79
 description ${branchDesc}
 ip address ${tunnelIpLocal} ${tunnelMask}
 ip mtu 1360
 ip tcp adjust-mss 1320
 keepalive 10 3
 tunnel source ${wanIp}
 tunnel destination ${tunnelDest}
!
router ospf 1
 router-id ${routerId}
 network ${tunnelIpLocal} 0.0.0.0 area ${area}
 network ${routerId} 0.0.0.0 area ${area}
!
do wr`;

            // ========== Build Final Branch Config ==========
            let branchCfg = '';
            if (ifaceConfig) branchCfg += ifaceConfig + '\n';
            if (aclConfig) branchCfg += aclConfig + '\n';
            branchCfg += tunnelConfig;

            // ========== Base Config ==========
            if (document.getElementById('includeBaseConfig').checked && bx && by) {
                const hostname = document.getElementById('hostnameName').value.trim();
                const hostnameLine = hostname ? `\nhostname ${hostname}\n!` : '';
                const baseConfig = `!
! ===== Base Config =====
!${hostnameLine}
service timestamps debug datetime msec localtime
service timestamps log datetime msec localtime
service password-encryption
!
aaa new-model
aaa authentication login CACS group tacacs+ local
aaa authentication enable default group tacacs+ enable
aaa authorization console
aaa authorization config-commands
aaa authorization exec CACS group tacacs+ local
aaa authorization commands 0 CACS group tacacs+ local
aaa authorization commands 1 CACS group tacacs+ local
aaa authorization commands 2 CACS group tacacs+ local
aaa authorization commands 3 CACS group tacacs+ local
aaa authorization commands 15 CACS group tacacs+ local
aaa accounting exec CACS start-stop group tacacs+
aaa accounting commands 0 CACS start-stop group tacacs+
aaa accounting commands 1 CACS start-stop group tacacs+
aaa accounting commands 2 CACS start-stop group tacacs+
aaa accounting commands 3 CACS start-stop group tacacs+
aaa accounting commands 15 CACS start-stop group tacacs+
!
clock timezone Tehran 3 30
ip cef
no ip domain lookup
ip domain name agri-bank.com
!
username bkiadmin privilege 15 secret 5 $1$hGC0$.zYwqSMN0zrKSP/NazjgM0
!
ip ssh time-out 120
ip ssh version 2
ip ssh port 2001 rotary 1
crypto key generate rsa
768
!
track 5 ip route 10.0.0.0 255.255.0.0 reachability
!
interface FastEthernet0/0
 ip address 10.${bx}.${by}.5 255.255.255.0
 ip access-group ETHERNET_IN in
 duplex auto
 speed auto
 standby 1 ip 10.${bx}.${by}.1
 standby 1 timers 1 3
 standby 1 preempt
 standby 1 track 5 decrement 25
!
router ospf 1
 network 10.${bx}.${by}.5 0.0.0.0 area ${bx}
!
ip access-list standard SNMP-READ
 permit 10.0.50.0 0.0.1.255
ip access-list standard SNMP-WRITE
 permit 10.0.51.49
 permit 10.0.51.48
 permit 10.0.51.50
ip access-list standard TELNET_ACCESS
 permit 10.${bx}.254.1
 permit 10.${bx}.251.1
 permit 10.${bx}.12.6 0.0.0.1
 permit 10.0.50.0 0.0.1.255
 permit 10.30.42.0 0.0.0.255
!
logging 10.0.51.63
access-list 199 permit icmp any any echo
access-list 199 permit icmp any any echo-reply
snmp-server group LMS v3 priv read myview write myview access SNMP-WRITE
snmp-server group NMS v3 priv access SNMP-READ
snmp-server view myview mib-2 included
snmp-server view myview system included
snmp-server view myview cisco included
snmp-server ifindex persist
!
route-map nachi-worm permit 10
 match ip address 199
 match length 92 92
 set interface Null0
!
tacacs-server host 10.0.51.56
tacacs-server host 10.0.51.57
tacacs-server directed-request
tacacs-server key 7 08005F0046485647
!
banner motd ^C
        ===
       -+ +-
       | | |
    <--\\ | /-->
   ##| ||||| |##
  ###| |+++| |###
 /____\\\\ | //____\\ ********************************************************
   <###\\|||/###>                  Keshavarzi Bank Network
    +====+====+     WARNING: Access is restricted to authorized users only.
    | WAN-BKI |     Unauthorized access is a violation of state , civil and
    +===+=+===+                       criminal laws.
        +=+        ********************************************************
^C
!
privilege interface level 3 shutdown
privilege interface level 3 no shutdown
privilege interface level 3 no
privilege configure level 3 interface
privilege exec level 3 traceroute
privilege exec level 3 ping
privilege exec level 3 configure terminal
privilege exec level 3 configure
privilege exec level 3 reload
privilege exec level 3 terminal monitor
privilege exec level 3 terminal
privilege exec all level 3 show running-config
privilege exec level 3 show
!
line con 0
 authorization exec CACS
 login authentication CACS
line aux 0
 no exec
line vty 0 4
 access-class TELNET_ACCESS in
 privilege level 15
 authorization exec CACS
 login authentication CACS
 transport input ssh
 transport output ssh
line vty 5 15
 access-class TELNET_ACCESS in
 privilege level 15
 authorization exec CACS
 login authentication CACS
 transport input ssh
 transport output ssh
!
scheduler allocate 20000 1000
ntp authentication-key 1 md5 070E265E47441B041919 7
ntp authenticate
ntp trusted-key 1
ntp source Loopback0
ntp master 5
ntp update-calendar
ntp server 10.0.51.27
!
! ===== End Base Config =====
!`;
                branchCfg = baseConfig + '\n' + branchCfg;
            }

            // ========== HUB Config ==========
            const hubCfg = `!
! ===== HUB ${svcType} Config for Branch (10.${bx}.${by}.0) =====
!
interface Tunnel${tunnelNum}
 description ${hubDesc}
 ip address ${tunnelIpRemote} ${tunnelMask}
 ip mtu 1360
 ip tcp adjust-mss 1320
 keepalive 10 3
 tunnel source ${tunnelDest}
 tunnel destination ${wanIp}
!
router ospf 1
 network ${tunnelIpRemote} 0.0.0.0 area ${area}
!
ip route 10.${bx}.${by}.0 255.255.255.0 ${tunnelIpLocal}
!
ip prefix-list ${svcType}-Branch permit 10.${bx}.${by}.0/24
!
do wr`;

            document.getElementById('branchConfig').value = branchCfg;
            document.getElementById('hubConfig').value = hubCfg;

            generateBtn.disabled = false;
            generateBtn.textContent = 'Generate Configs';
            showStatus(`${svcType} configuration generated successfully!`);
            console.log(`${svcType} config generated for branch 10.${bx}.${by}.0`);
        });

        // Load branches on page load (tunnels load when branch is selected)
        loadBranches();
        // Show hint in tunnel dropdown until branch is selected
        document.getElementById('tunnelSelect').innerHTML = '<option value="">Select a branch first to load tunnel IPs</option>';
    </script>

{% include 'chat_widget.html' %}
</body>
</html>
